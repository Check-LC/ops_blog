<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Promtail Running on VM</title>
      <link href="/2024/07/02/helm-install-loki/promtail-on-vm/"/>
      <url>/2024/07/02/helm-install-loki/promtail-on-vm/</url>
      
        <content type="html"><![CDATA[<h2 id="Helm-Deploy-Promtail"><a href="#Helm-Deploy-Promtail" class="headerlink" title="Helm Deploy Promtail"></a>Helm Deploy Promtail</h2><h3 id="两条重要日志"><a href="#两条重要日志" class="headerlink" title="两条重要日志"></a>两条重要日志</h3><p>grafana congfig: Data source connected, but no labels received. Verify that Loki and Promtail is configured properly. </p><p>promtail log：level&#x3D;error ts&#x3D;2024-06-19t06:14:50.369753384z caller&#x3D;client.go:430 component&#x3D;client host&#x3D;loki-gateway msg&#x3D;”final error sending batch” status&#x3D;401 tenant&#x3D; error&#x3D;”server returned http status 401 unauthorized (401): no org id”</p><h3 id="针对以上两条内容，主要的-chart-values-如下"><a href="#针对以上两条内容，主要的-chart-values-如下" class="headerlink" title="针对以上两条内容，主要的 chart values 如下:"></a><strong>针对以上两条内容，主要的 chart values 如下:</strong></h3><p>loki chart values</p><pre class="line-numbers language-none"><code class="language-none">loki:  auth_enabled: true  tenants:      - name: company        password: company@2020gateway:  enabled: true  username: null # loki.tenants 的值可以覆盖此处，并在模板中正确渲染生效；反之不可以  password: null <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>promtail chart values</p><pre class="line-numbers language-none"><code class="language-none">clients:  - url: http:&#x2F;&#x2F;loki-gateway&#x2F;loki&#x2F;api&#x2F;v1&#x2F;push    basic_auth:      password: company@2020      username: company<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>已经创建的 loki-promtail 的 config secret<pre class="line-numbers language-none"><code class="language-none">server:  log_level: info  log_format: logfmt  http_listen_port: 3101  clients:  - basic_auth:      password: company@2020      username: company    url: http:&#x2F;&#x2F;loki-gateway&#x2F;loki&#x2F;api&#x2F;v1&#x2F;pushpositions:  filename: &#x2F;run&#x2F;promtail&#x2F;positions.yamlscrape_configs:  # See also https:&#x2F;&#x2F;github.com&#x2F;grafana&#x2F;loki&#x2F;blob&#x2F;master&#x2F;production&#x2F;ksonnet&#x2F;promtail&#x2F;scrape_config.libsonnet for reference  - job_name: kubernetes-pods    pipeline_stages:      - cri: &#123;&#125;    kubernetes_sd_configs:      - role: pod    relabel_configs:      - source_labels:          - __meta_kubernetes_pod_controller_name        regex: ([0-9a-z-.]+?)(-[0-9a-f]&#123;8,10&#125;)?        action: replace        target_label: __tmp_controller_name      - source_labels:          - __meta_kubernetes_pod_label_app_kubernetes_io_name          - __meta_kubernetes_pod_label_app          - __tmp_controller_name          - __meta_kubernetes_pod_name        regex: ^;*([^;]+)(;.*)?$        action: replace        target_label: app      - source_labels:          - __meta_kubernetes_pod_label_app_kubernetes_io_instance          - __meta_kubernetes_pod_label_instance        regex: ^;*([^;]+)(;.*)?$        action: replace        target_label: instance      - source_labels:          - __meta_kubernetes_pod_label_app_kubernetes_io_component          - __meta_kubernetes_pod_label_component        regex: ^;*([^;]+)(;.*)?$        action: replace        target_label: component      - action: replace        source_labels:        - __meta_kubernetes_pod_node_name        target_label: node_name      - action: replace        source_labels:        - __meta_kubernetes_namespace        target_label: namespace      - action: replace        replacement: $1        separator: &#x2F;        source_labels:        - namespace        - app        target_label: job      - action: replace        source_labels:        - __meta_kubernetes_pod_name        target_label: pod      - action: replace        source_labels:        - __meta_kubernetes_pod_container_name        target_label: container      - action: replace        replacement: &#x2F;var&#x2F;log&#x2F;pods&#x2F;*$1&#x2F;*.log        separator: &#x2F;        source_labels:        - __meta_kubernetes_pod_uid        - __meta_kubernetes_pod_container_name        target_label: __path__      - action: replace        regex: true&#x2F;(.*)        replacement: &#x2F;var&#x2F;log&#x2F;pods&#x2F;*$1&#x2F;*.log        separator: &#x2F;        source_labels:        - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash        - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash        - __meta_kubernetes_pod_container_name        target_label: __path__  limits_config:tracing:  enabled: false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="Promtail-Running-on-VM"><a href="#Promtail-Running-on-VM" class="headerlink" title="Promtail Running on VM"></a>Promtail Running on VM</h2><p>主要需求日志目标源: </p><table><thead><tr><th>基础</th><th>path</th><th></th><th></th><th>特有</th><th>path</th><th></th></tr></thead><tbody><tr><td>auth.log</td><td>&#x2F;var&#x2F;log&#x2F;auth.log</td><td>done</td><td></td><td>Docker</td><td>unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock</td><td>done</td></tr><tr><td>syslog</td><td>&#x2F;var&#x2F;log&#x2F;syslog</td><td>done</td><td></td><td>Nginx</td><td>&#x2F;var&#x2F;log&#x2F;nginx&#x2F;**.log</td><td>done</td></tr><tr><td>kern.log</td><td>&#x2F;var&#x2F;log&#x2F;kern.log</td><td>done</td><td></td><td>Postgresql</td><td>&#x2F;var&#x2F;log&#x2F;postgresql&#x2F;**.log</td><td>done</td></tr><tr><td>apt</td><td>&#x2F;var&#x2F;log&#x2F;apt&#x2F;**.log</td><td>done</td><td></td><td>MinIO</td><td></td><td></td></tr><tr><td>journal</td><td>&#x2F;var&#x2F;log&#x2F;journal</td><td>done</td><td></td><td>Clickhouse</td><td>&#x2F;var&#x2F;log&#x2F;clickhouse-server&#x2F;**.log</td><td>u: clickhouse</td></tr><tr><td></td><td></td><td></td><td></td><td>Bastillion</td><td>app&#x2F;Bastillion-jetty&#x2F;jetty&#x2F;logs&#x2F;**.jetty.log</td><td>u: company</td></tr><tr><td></td><td></td><td></td><td></td><td>MySQL</td><td>&#x2F;var&#x2F;log&#x2F;mysql&#x2F;**.log</td><td></td></tr><tr><td></td><td></td><td></td><td></td><td>ZooKeeper</td><td>需要特别配置</td><td></td></tr><tr><td></td><td></td><td></td><td></td><td>Redis</td><td>&#x2F;var&#x2F;log&#x2F;redis&#x2F;redis-server.log</td><td></td></tr><tr><td></td><td></td><td></td><td></td><td>Kafka</td><td>安装路径&#x2F;logs&#x2F;**.log</td><td>u: company</td></tr><tr><td></td><td></td><td></td><td></td><td>Etcd</td><td>需要特别配置</td><td></td></tr><tr><td></td><td></td><td></td><td></td><td>RKE2</td><td>&#x2F;var&#x2F;lib&#x2F;rancher&#x2F;rke2&#x2F;agent&#x2F;logs&#x2F;kubelet.log<br>&#x2F;var&#x2F;lib&#x2F;rancher&#x2F;rke2&#x2F;agent&#x2F;containerd&#x2F;containerd.log</td><td>u: root</td></tr></tbody></table><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><blockquote><p>[!error]<br>agent 运行但无法读取目标文件</p></blockquote><pre class="line-numbers language-none"><code class="language-none">Jun 24 18:34:12 test-sys-lab-09 promtail[381246]: level&#x3D;warn ts&#x3D;2024-06-24T10:34:12.260671854Z caller&#x3D;promtail.go:263 msg&#x3D;&quot;enable watchConfig&quot;Jun 24 18:34:17 test-sys-lab-09 promtail[381246]: level&#x3D;info ts&#x3D;2024-06-24T10:34:17.259860066Z caller&#x3D;filetargetmanager.go:372 msg&#x3D;&quot;Adding target&quot; key&#x3D;&quot;&#x2F;var&#x2F;log&#x2F;syslog:&#123;job&#x3D;\&quot;syslogs\&quot;&#125;&quot;Jun 24 18:34:17 test-sys-lab-09 promtail[381246]: level&#x3D;info ts&#x3D;2024-06-24T10:34:17.259951353Z caller&#x3D;filetarget.go:313 msg&#x3D;&quot;watching new directory&quot; directory&#x3D;&#x2F;var&#x2F;logJun 24 18:34:17 test-sys-lab-09 promtail[381246]: level&#x3D;error ts&#x3D;2024-06-24T10:34:17.260001749Z caller&#x3D;filetarget.go:385 msg&#x3D;&quot;failed to start tailer&quot; error&#x3D;&quot;open &#x2F;var&#x2F;log&#x2F;syslog: permission denied&quot; filename&#x3D;&#x2F;var&#x2F;log&#x2F;syslogJun 24 18:34:27 test-sys-lab-09 promtail[381246]: level&#x3D;error ts&#x3D;2024-06-24T10:34:27.260842577Z caller&#x3D;filetarget.go:385 msg&#x3D;&quot;failed to start tailer&quot; error&#x3D;&quot;open &#x2F;var&#x2F;log&#x2F;syslog: permission denied&quot; filename&#x3D;&#x2F;var&#x2F;log&#x2F;syslog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!solution]<br>保证其加入 adm 组（查看的文件都在 adm 组中）</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-rw-r-----   <span class="token number">1</span> syslog    adm               <span class="token number">25031</span> Jun <span class="token number">25</span> <span class="token number">10</span>:58 auth.log-rw-r-----   <span class="token number">1</span> syslog    adm               <span class="token number">39744</span> Jun <span class="token number">22</span> <span class="token number">23</span>:17 auth.log.1-rw-r-----   <span class="token number">1</span> syslog    adm                <span class="token number">2059</span> Jun <span class="token number">15</span> <span class="token number">23</span>:17 auth.log.2.gz-rw-r-----   <span class="token number">1</span> syslog    adm                <span class="token number">2044</span> Jun  <span class="token number">8</span> <span class="token number">23</span>:17 auth.log.3.gz-rw-r-----   <span class="token number">1</span> syslog    adm                <span class="token number">2041</span> Jun  <span class="token number">1</span> <span class="token number">23</span>:17 auth.log.4.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!error]<br>404发送失败</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>pre<span class="token operator">></span>Jun <span class="token number">25</span> <span class="token number">10</span>:58:22 test-sys-lab-09 promtail<span class="token punctuation">[</span><span class="token number">389765</span><span class="token punctuation">]</span>: <span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2024</span>-06-25T02:58:22.461246121Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>tailer.go:147 <span class="token assign-left variable">component</span><span class="token operator">=</span>tailer <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token function">tail</span> routine: started<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span> <span class="token assign-left variable">path</span><span class="token operator">=</span>/var/log/syslogJun <span class="token number">25</span> <span class="token number">10</span>:58:23 test-sys-lab-09 promtail<span class="token punctuation">[</span><span class="token number">389765</span><span class="token punctuation">]</span>: <span class="token assign-left variable">level</span><span class="token operator">=</span>error <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2024</span>-06-25T02:58:23.56377309Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>client.go:430 <span class="token assign-left variable">component</span><span class="token operator">=</span>client <span class="token assign-left variable">host</span><span class="token operator">=</span>loki.testlab.net <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>final error sending batch<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span> <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">404</span> <span class="token assign-left variable">tenant</span><span class="token operator">=</span> <span class="token assign-left variable">error</span><span class="token operator">=</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>server returned HTTP status <span class="token number">404</span> Not Found <span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>: <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>Jun <span class="token number">25</span> <span class="token number">10</span>:58:24 test-sys-lab-09 promtail<span class="token punctuation">[</span><span class="token number">389765</span><span class="token punctuation">]</span>: <span class="token assign-left variable">level</span><span class="token operator">=</span>error <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2024</span>-06-25T02:58:24.762775766Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>client.go:430 <span class="token assign-left variable">component</span><span class="token operator">=</span>client <span class="token assign-left variable">host</span><span class="token operator">=</span>loki.testlab.net <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>final error sending batch<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span> <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">404</span> <span class="token assign-left variable">tenant</span><span class="token operator">=</span> <span class="token assign-left variable">error</span><span class="token operator">=</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>server returned HTTP status <span class="token number">404</span> Not Found <span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>: <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>Jun <span class="token number">25</span> <span class="token number">10</span>:58:26 test-sys-lab-09 promtail<span class="token punctuation">[</span><span class="token number">389765</span><span class="token punctuation">]</span>: <span class="token assign-left variable">level</span><span class="token operator">=</span>error <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2024</span>-06-25T02:58:26.062618043Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>client.go:430 <span class="token assign-left variable">component</span><span class="token operator">=</span>client <span class="token assign-left variable">host</span><span class="token operator">=</span>loki.testlab.net <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>final error sending batch<span class="token operator">&amp;</span>quot<span class="token punctuation">;</span> <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">404</span> <span class="token assign-left variable">tenant</span><span class="token operator">=</span> <span class="token assign-left variable">error</span><span class="token operator">=</span><span class="token operator">&amp;</span>quot<span class="token punctuation">;</span>server returned HTTP status <span class="token number">404</span> Not Found <span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>: <span class="token operator">&amp;</span>quot<span class="token punctuation">;</span><span class="token operator">&lt;</span>/pre<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!solution]<br>此处 url 应该指定的是 <code>loki-write</code></p></blockquote><h3 id="docker-logging"><a href="#docker-logging" class="headerlink" title="docker logging"></a>docker logging</h3><h4 id="允许连接-docker-sock"><a href="#允许连接-docker-sock" class="headerlink" title="允许连接 docker.sock"></a>允许连接 docker.sock</h4><p><code>sudo usermod -aG docker promtail</code></p><p><strong>配置内容：</strong></p><pre class="line-numbers language-none"><code class="language-none">server:  http_listen_port: 9080  grpc_listen_port: 0# 保存日志文件的读取偏移量positions:  filename: &#x2F;tmp&#x2F;positions.yaml# loki 的联系地址clients:  - url: http:&#x2F;&#x2F;loki.testlab.net&#x2F;loki&#x2F;api&#x2F;v1&#x2F;push #此处是loki-write    basic_auth:      username: company      password: company@2020    tenant_id: companyscrape_configs:  - job_name: flog_scrape    docker_sd_configs:      - host: unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock    relabel_configs:      - source_labels: [&#39;__meta_docker_container_name&#39;]        regex: &#39;&#x2F;(.*)&#39;        target_label: &#39;container&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://community.grafana.com/t/promtail-does-not-collect-logs-from-other-containers/87000">docker_sd_configs reference</a></p><p><strong>报错</strong></p><pre class="line-numbers language-none"><code class="language-none">st&#x3D;loki.testlab.net msg&#x3D;&quot;final error sending batch&quot; status&#x3D;400 tenant&#x3D;company error&#x3D;&quot;server returned HTTP status 400 Bad Request (400): 5 errors like: entry for stream &#39;&#123;container&#x3D;\&quot;minio\&quot;, service_name&#x3D;\&quot;minio\&quot;&#125;&#39; has timestamp too old: 2024-06-14T10:25:30Z, oldest acceptable time&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>[!solution]<br>loki 的配置项:</p><pre class="line-numbers language-none"><code class="language-none">&gt;limits_config:   reject_old_samples: false  # 是否拒绝过时的样本 reject_old_samples_max_age: 168h  # 过时的判断标准，最大时长7天<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="尝试-pipeline-stages"><a href="#尝试-pipeline-stages" class="headerlink" title="尝试 pipeline_stages"></a>尝试 pipeline_stages</h4><pre class="line-numbers language-none"><code class="language-none">- job_name: docker  pipeline_stages:    - docker: &#123;&#125;  static_configs:    - targets:        - localhost      labels:        vm: docker        host: 10.1.0.81        __path__: &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;**&#x2F;*-json.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>未成功，无任何报错，欠缺：即使成功发送日志也需要进一步处理得到容器名等。当前 sd config 更适用。</p><p>后续需要对做更多的 pip 的研究</p><h3 id="正常的完整配置文件"><a href="#正常的完整配置文件" class="headerlink" title="正常的完整配置文件"></a>正常的完整配置文件</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">9080</span>  <span class="token key atrule">grpc_listen_port</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token comment"># 保存日志文件的读取偏移量</span><span class="token key atrule">positions</span><span class="token punctuation">:</span>  <span class="token key atrule">filename</span><span class="token punctuation">:</span> /tmp/positions.yaml<span class="token comment"># loki 的联系地址</span><span class="token key atrule">clients</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki.testlab.net/loki/api/v1/push <span class="token comment">#此处是loki-write</span>    <span class="token key atrule">basic_auth</span><span class="token punctuation">:</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> company      <span class="token key atrule">password</span><span class="token punctuation">:</span> company@2020    <span class="token key atrule">tenant_id</span><span class="token punctuation">:</span> company  <span class="token comment">#必须指定（但k8s的pod中配置文件反而没有这个配置项，却没有报错，很奇怪。难道是gateway路由时传递了这个id？）</span><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> journal    <span class="token key atrule">journal</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89        <span class="token key atrule">system</span><span class="token punctuation">:</span> journal      <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log/journal/    <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'__journal__systemd_unit'</span><span class="token punctuation">]</span>        <span class="token key atrule">target_label</span><span class="token punctuation">:</span> <span class="token string">'unit'</span>      <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'__journal__hostname'</span><span class="token punctuation">]</span>        <span class="token key atrule">target_label</span><span class="token punctuation">:</span> <span class="token string">'hostname'</span>      <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'__journal_priority_keyword'</span><span class="token punctuation">]</span>        <span class="token key atrule">target_label</span><span class="token punctuation">:</span> <span class="token string">'level'</span>      <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'__journal_syslog_identifier'</span><span class="token punctuation">]</span>        <span class="token key atrule">target_label</span><span class="token punctuation">:</span> <span class="token string">'syslog_identifier'</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> docker_scrape    <span class="token key atrule">docker_sd_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///var/run/docker.sock    <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'__meta_docker_container_name'</span> <span class="token punctuation">]</span>        <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token string">'/(.*)'</span>        <span class="token key atrule">target_label</span><span class="token punctuation">:</span> <span class="token string">'container'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">labels</span><span class="token punctuation">:</span>          <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89          <span class="token key atrule">hostname</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sys<span class="token punctuation">-</span>lab<span class="token punctuation">-</span><span class="token number">09</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> system    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">labels</span><span class="token punctuation">:</span>          <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89          <span class="token key atrule">hostname</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sys<span class="token punctuation">-</span>lab<span class="token punctuation">-</span><span class="token number">09</span>          <span class="token key atrule">system</span><span class="token punctuation">:</span> syslog          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/syslog      <span class="token punctuation">-</span> <span class="token key atrule">labels</span><span class="token punctuation">:</span>          <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89          <span class="token key atrule">hostname</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sys<span class="token punctuation">-</span>lab<span class="token punctuation">-</span><span class="token number">09</span>          <span class="token key atrule">system</span><span class="token punctuation">:</span> authlog          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/auth.log      <span class="token punctuation">-</span> <span class="token key atrule">labels</span><span class="token punctuation">:</span>          <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89          <span class="token key atrule">hostname</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sys<span class="token punctuation">-</span>lab<span class="token punctuation">-</span><span class="token number">09</span>          <span class="token key atrule">system</span><span class="token punctuation">:</span> kernlog          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/kern.log      <span class="token punctuation">-</span> <span class="token key atrule">labels</span><span class="token punctuation">:</span>          <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89          <span class="token key atrule">hostname</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sys<span class="token punctuation">-</span>lab<span class="token punctuation">-</span><span class="token number">09</span>          <span class="token key atrule">system</span><span class="token punctuation">:</span> aptlog          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/apt/<span class="token important">**.log</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> service    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">labels</span><span class="token punctuation">:</span>          <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89          <span class="token key atrule">hostname</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sys<span class="token punctuation">-</span>lab<span class="token punctuation">-</span><span class="token number">09</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span> nginx          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/nginx/<span class="token important">**.log</span>      <span class="token punctuation">-</span> <span class="token key atrule">labels</span><span class="token punctuation">:</span>          <span class="token key atrule">host</span><span class="token punctuation">:</span> 10.8.0.89          <span class="token key atrule">hostname</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sys<span class="token punctuation">-</span>lab<span class="token punctuation">-</span><span class="token number">09</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/postgresql/<span class="token important">**.log</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Ansible-Template"><a href="#Ansible-Template" class="headerlink" title="Ansible Template"></a>Ansible Template</h2><ul><li><p>templates&#x2F;config.yml.j2</p><pre class="line-numbers language-none"><code class="language-none">server:    http_listen_port: 9080    grpc_listen_port: 0    # 保存日志文件的读取偏移量  positions:    filename: &quot;&#123;&#123; app_service &#125;&#125;&#x2F;promtail&#x2F;data&#x2F;positions.yaml&quot;    clients:    - url: &quot;https:&#x2F;&#x2F;&#123;&#123;loki_url&#125;&#125;&#x2F;loki&#x2F;api&#x2F;v1&#x2F;push&quot;      basic_auth:        username: &quot;&#123;&#123; ansible_user &#125;&#125;&quot;        password: &quot;&#123;&#123; ansible_ssh_pass &#125;&#125;&quot;      tenant_id: &quot;&#123;&#123; ansible_user &#125;&#125;&quot;    scrape_configs:    - job_name: journal      journal:        labels:          host: &#123;&#123; ansible_host &#125;&#125;          system: journal        path: &#x2F;var&#x2F;log&#x2F;journal&#x2F;      relabel_configs:        - source_labels: [&#39;__journal__systemd_unit&#39;]          target_label: &#39;unit&#39;        - source_labels: [&#39;__journal__hostname&#39;]          target_label: &#39;hostname&#39;        - source_labels: [&#39;__journal_priority_keyword&#39;]          target_label: &#39;level&#39;        - source_labels: [&#39;__journal_syslog_identifier&#39;]          target_label: &#39;syslog_identifier&#39;    - job_name: docker_scrape      docker_sd_configs:        - host: unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock      relabel_configs:        - source_labels: [ &#39;__meta_docker_container_name&#39; ]          regex: &#39;&#x2F;(.*)&#39;          target_label: &#39;container&#39;      static_configs:        - labels:            host: &#123;&#123; ansible_host &#125;&#125;            hostname: &#123;&#123; ansible_hostname &#125;&#125;    &#123;% for category, paths in labels.items() %&#125;      - job_name: &#123;&#123; category &#125;&#125;      static_configs:  &#123;% for target_label, target_path in paths.items() %&#125;        - labels:            host: &#123;&#123; ansible_host &#125;&#125;            hostname: &#123;&#123; ansible_hostname &#125;&#125;            &#123;&#123; category &#125;&#125;: &#123;&#123; target_label &#125;&#125;            __path__: &#123;&#123; target_path &#125;&#125;  &#123;% endfor %&#125;  &#123;% endfor %&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>vars&#x2F;main.yml</p><pre class="line-numbers language-none"><code class="language-none">version: &#39;3.0.0&#39;  # loki-write 的地址（只需要写）  loki_url: &quot;loki.testlab.net&quot;  # design for vm server logs  labels:  system:    syslog: &#x2F;var&#x2F;log&#x2F;syslog    authlog: &#x2F;var&#x2F;log&#x2F;auth.log     kernlog: &#x2F;var&#x2F;log&#x2F;kern.log      aptlog: &#x2F;var&#x2F;log&#x2F;apt&#x2F;**.log    service:      nginx: &#x2F;var&#x2F;log&#x2F;nginx&#x2F;**.log      postgresql: &#x2F;var&#x2F;log&#x2F;postgresql&#x2F;**.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> OpenTelemetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> loki </tag>
            
            <tag> Log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>helm install loki</title>
      <link href="/2024/07/02/helm-install-loki/helm-install-loki/"/>
      <url>/2024/07/02/helm-install-loki/helm-install-loki/</url>
      
        <content type="html"><![CDATA[<h2 id="Simple-Scalable-Mode"><a href="#Simple-Scalable-Mode" class="headerlink" title="Simple Scalable Mode"></a>Simple Scalable Mode</h2><p>Loki chat version： v6.6.3 ; Application version: 3.0.0 <br>Promtail chat version: v6.16.0 ; Application version: v3.0.0 <br>Architecture：With memcached &amp; backend</p><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><h4 id="读写节点报错"><a href="#读写节点报错" class="headerlink" title="读写节点报错"></a>读写节点报错</h4><h5 id="s3-的连接"><a href="#s3-的连接" class="headerlink" title="s3 的连接"></a>s3 的连接</h5><blockquote><p>[!solution]<br>reference1 <a href="https://github.com/grafana/loki/issues/12218">Helm Chart cannot parse environment variables with “- config.extra-env&#x3D;true” · Issue #12218 · grafana&#x2F;loki · GitHub</a> <br>reference2 <a href="https://github.com/grafana/loki/issues/8572">How to configure aws s3 credentials securely for accessing aws storage object in loki-configuration · Issue #8572 · grafana&#x2F;loki · GitHub</a> <br>声明变量引用的 s3 部分配置</p><pre class="line-numbers language-none"><code class="language-none">storage: # Loki requires a bucket for chunks and the ruler. GEL requires a third bucket for the admin API. # Please provide these values if you are using object storage. bucketNames:   chunks: loki   ruler: loki   admin: loki type: s3 s3:   s3: &quot;s3:&#x2F;&#x2F;loki&quot;   endpoint: &quot;http:&#x2F;&#x2F;10.1.0.81:9001&#x2F;&quot;   region: null   secretAccessKey: $&#123;SECRETKEY&#125;   accessKeyId: $&#123;ACCESSID&#125;   signatureVersion: v4   s3ForcePathStyle: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>声明变量来源的 values(需要同时声明到 write、read、backend 下)\</p><pre class="line-numbers language-none"><code class="language-none">extraArgs:  [-config.expand-env&#x3D;true]extraEnvFrom: - secretRef:     name: loki-s3    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在此之前需要创建相应的 ‘secret’ 资源，其键需要与变量名同</p></blockquote><h5 id="schemaConfig-need-quotes"><a href="#schemaConfig-need-quotes" class="headerlink" title="schemaConfig need quotes"></a>schemaConfig need quotes</h5><blockquote><p>[! failure]<br>ailed parsing config: &#x2F;etc&#x2F;loki&#x2F;config&#x2F;config.yaml: parsing time “2024-06-18T00:00:00.000Z”: extra text: “T00:00:00.000Z”. </p></blockquote><blockquote><p>[!Solution]<br>reference1 <a href="https://github.com/grafana/helm-charts/pull/2731">[loki-distributed] Corrected date format by Sheikh-Abubaker · Pull Request #2731 · grafana&#x2F;helm-charts · GitHub</a> <br>在 schemaconfig 下的日期配置中需要将，日期的格式用双引号引用</p></blockquote><h4 id="Gatway-报错"><a href="#Gatway-报错" class="headerlink" title="Gatway 报错"></a>Gatway 报错</h4><blockquote><p>[!failure]<br>gateway: <br>&#x2F;docker-entrypoint.sh: No files found in &#x2F;docker-entrypoint.d&#x2F;, skipping configuration <br>Tue, Jun 18 2024 3:04:19 pm2024&#x2F;06&#x2F;18 07:04:19 [emerg] 1 #1 : host not found in resolver “kube-dns.kube-system.svc.cluster.local.” in &#x2F;etc&#x2F;nginx&#x2F;nginx.conf:33 <br>2024-06-18T15:04:19.969334333+08:00  nginx: [emerg] host not found in resolver “kube-dns.kube-system.svc.cluster.local.” in &#x2F;etc&#x2F;nginx&#x2F;nginx.conf:33 </p></blockquote><blockquote><p>[!solution]<br>gateway 日志中得出 helm 中存在应用关于 dns 部分的配置，在我们使用 rke2 创建的集群中，这个设置应该修改如下：<br>global.dnsService: “rke2-coredns-rke2-coredns”</p></blockquote><h4 id="backend"><a href="#backend" class="headerlink" title="backend"></a>backend</h4><p>backend 出现有副本创建失败，原因是：longhorn 卷状态不正常</p><h4 id="grafana-添加数据源"><a href="#grafana-添加数据源" class="headerlink" title="grafana 添加数据源"></a>grafana 添加数据源</h4><p>Loki 支持多租户，以使租户之间的数据完全分离。当 Loki 在多租户模式下运行时，所有数据（包括内存和长期存储中的数据）都由租户 ID 分区，该租户 ID 是从请求中的 <code>X-Scope-OrgID</code> HTTP 头中提取的。 当 Loki 不在多租户模式下时，将忽略 Header 头，并将租户 ID 设置为 <code>fake</code>，这将显示在索引和存储的块中。</p><p>&#x3D;&#x3D;此为单租户的认证使用案例&#x3D;&#x3D;</p><p>loki-gateway: 启用了认证，此处是相应的配置参考 </p><p>datasource congfig：Unable to fetch labels from Loki (Failed to call resource), please check the server logs for more details </p><blockquote><p>[!solution]<br>reference  <a href="https://github.com/grafana/loki/issues/7081#issuecomment-1713478974">server returned HTTP status 401 Unauthorized (401): no org id · Issue #7081 · grafana&#x2F;loki · GitHub</a></p></blockquote><p>Grafana 在 UI 的设置</p><p>config datasource.</p><blockquote><p>Auth:</p><blockquote><p>Basic auth: enable</p></blockquote><p>Basic Auth Details:</p><blockquote><p>User: tenant-3<br>Password: password-3</p></blockquote><p>Custom HTTP Headers</p><blockquote><p>Header: <code>X-Scope-OrgID</code><br>Value: <code>tenant-3</code></p></blockquote></blockquote><h4 id="promtail-安装"><a href="#promtail-安装" class="headerlink" title="promtail 安装"></a>promtail 安装</h4><p>两条重要日志：</p><p>grafana congfig: Data source connected, but no labels received. Verify that Loki and Promtail is configured properly. </p><p>promtail log：level&#x3D;error ts&#x3D;2024-06-19t06:14:50.369753384z caller&#x3D;client.go:430 component&#x3D;client host&#x3D;loki-gateway msg&#x3D;”final error sending batch” status&#x3D;401 tenant&#x3D; error&#x3D;”server returned http status 401 unauthorized (401): no org id”</p><h4 id="针对以上两条内容，主要的-chart-values-如下"><a href="#针对以上两条内容，主要的-chart-values-如下" class="headerlink" title="针对以上两条内容，主要的 chart values 如下:"></a><strong>针对以上两条内容，主要的 chart values 如下:</strong></h4><p>loki chart values</p><pre class="line-numbers language-none"><code class="language-none">loki:  auth_enabled: true  tenants:      - name: company        password: company@2020gateway:  enabled: true  username: null # loki.tenants 的值可以覆盖此处，并在模板中正确渲染生效；反之不可以  password: null <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>promtail chart values</p><pre class="line-numbers language-none"><code class="language-none">clients:  - url: http:&#x2F;&#x2F;loki-gateway&#x2F;loki&#x2F;api&#x2F;v1&#x2F;push    basic_auth:      password: company@2020      username: company<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="新增-tenants-设置"><a href="#新增-tenants-设置" class="headerlink" title="新增 tenants 设置"></a>新增 tenants 设置</h2><p>目的：使用 rancher 特有的一个 question.yml 使用在 UI 填写租户名和密码，保证安全。但是最终没有成功实现，chart 的结构注定不能成功传入</p><p>目标数据：</p><pre class="line-numbers language-none"><code class="language-none">tenants:  - name: test    password: test123  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>这个枚举类型成功传递，但是没有意义 <pre class="line-numbers language-none"><code class="language-none">categories:    - logging  namespace: loki  questions:    - variable: loki.tenants      label: Loki Tenants list      description: &quot;Loki Tenants Set BY enum type&quot;      group: &quot;Loki Tenants&quot;type: enum  options:    - - name: company        password: company@2020  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>不能使用其他类型，程序将报错不能迭代，以下是<code>string</code>类型</p><pre class="line-numbers language-none"><code class="language-none">Waiting for Kubernetes API to be availableMon, Jun 24 2024 10:21:02 amhelm install --namespace&#x3D;loki --timeout&#x3D;10m0s --values&#x3D;&#x2F;home&#x2F;shell&#x2F;helm&#x2F;values-loki-6.6.3.yaml --version&#x3D;6.6.3 --wait&#x3D;true loki &#x2F;home&#x2F;shell&#x2F;helm&#x2F;loki-6.6.3.tgzMon, Jun 24 2024 10:21:03 amError: INSTALLATION FAILED: template: loki&#x2F;templates&#x2F;gateway&#x2F;secret-gateway.yaml:12:8: executing &quot;loki&#x2F;templates&#x2F;gateway&#x2F;secret-gateway.yaml&quot; at &lt;tpl .basicAuth.htpasswd $&gt;: error calling tpl: error during tpl function execution for &quot;&#123;&#123; if .Values.loki.tenants &#125;&#125;\n &#123;&#123;- range $t :&#x3D; .Values.loki.tenants &#125;&#125;\n&#123;&#123; htpasswd (required \&quot;All tenants must have a &#39;name&#39; set\&quot; $t.name) (required \&quot;All tenants must have a &#39;password&#39; set\&quot; $t.password) &#125;&#125;\n &#123;&#123;- end &#125;&#125;\n&#123;&#123; else &#125;&#125; &#123;&#123; htpasswd (required \&quot;&#39;gateway.basicAuth.username&#39; is required\&quot; .Values.gateway.basicAuth.username) (required \&quot;&#39;gateway.basicAuth.password&#39; is required\&quot; .Values.gateway.basicAuth.password) &#125;&#125; &#123;&#123; end &#125;&#125;&quot;: template: loki&#x2F;templates&#x2F;gateway&#x2F;secret-gateway.yaml:2:25: executing &quot;loki&#x2F;templates&#x2F;gateway&#x2F;secret-gateway.yaml&quot; at &lt;.Values.loki.tenants&gt;: range can&#39;t iterate over [&#123;name: &#39;company&#39;, password: &#39;company@2020&#39;&#125;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对比</p><pre class="line-numbers language-none"><code class="language-none">tenants: []tenants: &#39;[&#123;name: &#39;&#39;company&#39;&#39;, password: &#39;&#39;company@2020&#39;&#39;&#125;]&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>secret 类型是选择一个当前名称空间已经存在的 secret 填入值中，适用场景 <code>envfrom </code> .</p><h2 id="valut-拉取-minIO-的-access-key"><a href="#valut-拉取-minIO-的-access-key" class="headerlink" title="valut 拉取 minIO 的 access key"></a>valut 拉取 minIO 的 access key</h2><h3 id="ClusterSecretStore"><a href="#ClusterSecretStore" class="headerlink" title="ClusterSecretStore"></a>ClusterSecretStore</h3><p>通过 root token 的 vault 连接(测试，vault 用户管理更待学习)</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>secrets.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterSecretStore<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> monitor<span class="token punctuation">-</span>eso<span class="token punctuation">-</span>loki<span class="token punctuation">-</span>clustersecretstore<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">provider</span><span class="token punctuation">:</span>    <span class="token key atrule">vault</span><span class="token punctuation">:</span>      <span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token string">"http://vault-internal.vault.svc.cluster.local:8200"</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"v2"</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"loki"</span>      <span class="token key atrule">auth</span><span class="token punctuation">:</span>        <span class="token key atrule">tokenSecretRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"eso-vault-secret"</span>          <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"external-secrets"</span>          <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"vault-token"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ExternalSecret"><a href="#ExternalSecret" class="headerlink" title="ExternalSecret"></a>ExternalSecret</h3><pre class="line-numbers language-none"><code class="language-none">apiVersion: external-secrets.io&#x2F;v1beta1kind: ExternalSecretmetadata:  name: monitor-eso-loki-s3-externalsecretspec:  refreshInterval: &quot;12h&quot;  secretStoreRef:    name: monitor-eso-loki-clustersecretstore    kind: ClusterSecretStore  data:    - secretKey: ACCESSID      remoteRef:         key: &#x2F;loki-s3        conversionStrategy: Unicode        decodingStrategy: None        metadataPolicy: None        property: ACCESSID    - secretKey: SECRETKEY      remoteRef:         key: &#x2F;loki-s3        conversionStrategy: Unicode        decodingStrategy: None        metadataPolicy: None        property: SECRETKEY  target:    creationPolicy: Owner    deletionPolicy: Retain    name: eso-loki-s3-secret    template:      type: Opaque      data:        ACCESSID: &#39;&#123;&#123; .ACCESSID &#125;&#125;&#39;        SECRETKEY: &#39;&#123;&#123; .SECRETKEY &#125;&#125;&#39;      engineVersion: v2      mergePolicy: Replace <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>附图，便于理解以上配置和 vault 中的路径与值的对应关系：<br><img src="https://ice.frostsky.com/2024/07/02/454aba27238ef563199ef51ca9544f17.png" alt="454aba27238ef563199ef51ca9544f17.png"></p>]]></content>
      
      
      <categories>
          
          <category> OpenTelemetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> loki </tag>
            
            <tag> Log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>personal project gantt chart</title>
      <link href="/2024/07/02/personal-project-gantt-chart/personal-project-gantt-chart/"/>
      <url>/2024/07/02/personal-project-gantt-chart/personal-project-gantt-chart/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>主要用于个人工作以外的时间记录和事件记录，并非是出于时间管理的目的而使用。<br>有培养习惯的目的：专注事件和过程，管理个人预期。</p><h2 id="商业产品试用"><a href="#商业产品试用" class="headerlink" title="商业产品试用"></a>商业产品试用</h2><ol><li>简道云</li></ol><ul><li>低代码平台</li><li>具有模板，不过适用于企业而非个人</li><li>少量图表在自建应用时可以使用，gantt 需要收费</li></ul><ol start="2"><li>Teambition</li></ol><ul><li>与上述基本一致</li><li>针对列表、看板这样的工具，有免费模板可以使用</li></ul><ol start="3"><li>进度猫</li></ol><ul><li>使用简单，UI 古早，存储条目有限</li></ul><h2 id="免费"><a href="#免费" class="headerlink" title="免费"></a>免费</h2><p><a href="https://www.iodraw.com/">iodraw.com</a></p><ul><li>可以存储到 git 平台</li><li>免费使用，但没有开源</li><li>功能重合于 draw.io 但是有更多的图表管理、xmind 管理。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Projects </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Personal </tag>
            
            <tag> projects </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shadowsocks-libev</title>
      <link href="/2024/06/15/shadowsocks/shadowsocks/"/>
      <url>/2024/06/15/shadowsocks/shadowsocks/</url>
      
        <content type="html"><![CDATA[<h2 id="当前状况"><a href="#当前状况" class="headerlink" title="当前状况"></a>当前状况</h2><p>使用 Mobaxterm 图形转发功能，在云主机创建 ssh 隧道，浏览器使用 proxy 插件连接本机的这个转发端口，以此实现访问 artifacthub、github 等</p><p>vmware workstation 中的其他虚拟机器使用的是下列命令</p><p><img src="https://i3.mjj.rip/2024/06/15/a7a72b5d58cb6f24c77db493e4dc59ae.jpeg" alt="笔记本代理转发虚拟机的网络"></p><h2 id="基本资料"><a href="#基本资料" class="headerlink" title="基本资料"></a>基本资料</h2><ul><li>个人云主机，ubuntu 2004</li><li>shadowsocks-libev as server，也可以使用 <code>shadowsocks-qt5: Cross-platform client for Windows/MacOS/Linux</code></li><li>shadowsocks-win  as client</li></ul><p>对比 openvpn，shadowsocks 确实更简单易用，个人使用已经足够，文档也比之更清晰</p><h3 id="shadowsocks-官方的文档介绍摘录"><a href="#shadowsocks-官方的文档介绍摘录" class="headerlink" title="shadowsocks 官方的文档介绍摘录"></a>shadowsocks 官方的文档介绍摘录</h3><h4 id="CLI-implementations"><a href="#CLI-implementations" class="headerlink" title="CLI implementations"></a>CLI implementations</h4><ul><li><a href="https://github.com/shadowsocks/shadowsocks">shadowsocks</a>: The original Python implementation.</li><li><a href="https://github.com/shadowsocks/shadowsocks-libev">shadowsocks-libev</a>: Lightweight C implementation for embedded devices and low end boxes. Very small footprint (several megabytes) for thousands of connections.</li><li><a href="https://github.com/shadowsocks/go-shadowsocks2">go-shadowsocks2</a>: Go implementation focusing on core features and code reusability.</li><li><a href="https://github.com/shadowsocks/shadowsocks-rust">shadowsocks-rust</a>: A rust port of shadowsocks.</li></ul><p><a href="https://shadowsocks.org/doc/deploying.html">此处是官方讲解的 server 安装方式</a></p><p>Feature comparison</p><table><thead><tr><th align="center">ss</th><th align="center">ss-libev</th><th align="center">go-ss2</th><th align="center">ss-rust</th></tr></thead><tbody><tr><td align="center">TCP Fast Open</td><td align="center">✓</td><td align="center">✗</td><td align="center">✓</td></tr><tr><td align="center">Multiuser</td><td align="center">✓</td><td align="center">✓</td><td align="center">✗</td></tr><tr><td align="center">Management API</td><td align="center">✓</td><td align="center">✓</td><td align="center">✗</td></tr><tr><td align="center">Redirect mode</td><td align="center">✗</td><td align="center">✓</td><td align="center">✓</td></tr><tr><td align="center">Tunnel mode</td><td align="center">✓</td><td align="center">✓</td><td align="center">✓</td></tr><tr><td align="center">UDP Relay</td><td align="center">✓</td><td align="center">✓</td><td align="center">✓</td></tr><tr><td align="center">MPTCP</td><td align="center">✗</td><td align="center">✓</td><td align="center">✗</td></tr><tr><td align="center">AEAD ciphers</td><td align="center">✓</td><td align="center">✓</td><td align="center">✓</td></tr><tr><td align="center">Plugin</td><td align="center">✗</td><td align="center">✓</td><td align="center">✗</td></tr><tr><td align="center">Plugin UDP (Experimental)</td><td align="center">✗</td><td align="center">✗</td><td align="center">✗</td></tr></tbody></table><h4 id="GUI-Clients"><a href="#GUI-Clients" class="headerlink" title="GUI Clients"></a>GUI Clients</h4><ul><li><a href="https://github.com/shadowsocks/shadowsocks-android">shadowsocks-android</a>: Android client.</li><li><a href="https://github.com/shadowsocks/shadowsocks-csharp">shadowsocks-windows</a>: Windows client.</li><li><a href="https://github.com/shadowsocks/ShadowsocksX-NG">shadowsocksX-NG</a>: MacOS client.</li><li><a href="https://github.com/shadowsocks/shadowsocks-android">shadowsocks-qt5</a>: Cross-platform client for Windows&#x2F;MacOS&#x2F;Linux.</li></ul><h2 id="server-配置"><a href="#server-配置" class="headerlink" title="server 配置"></a>server 配置</h2><h3 id="Ubuntu-配置文件"><a href="#Ubuntu-配置文件" class="headerlink" title="Ubuntu 配置文件"></a>Ubuntu 配置文件</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">cat /etc/shadowsocks-libev/config.json<span class="token punctuation">&#123;</span>    <span class="token property">"server"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"xxx.xxx.xxx.xxx"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   # 此处推荐填写公网IP或域名    <span class="token property">"mode"</span><span class="token operator">:</span><span class="token string">"tcp_only"</span><span class="token punctuation">,</span>              # 默认是tcp_and_udp    <span class="token property">"server_port"</span><span class="token operator">:</span><span class="token number">18388</span><span class="token punctuation">,</span>                <span class="token property">"local_port"</span><span class="token operator">:</span><span class="token number">11080</span><span class="token punctuation">,</span>    <span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"tejshf"</span><span class="token punctuation">,</span>       # 存在一个默认的连接密码，已修改    <span class="token property">"timeout"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span>    <span class="token property">"method"</span><span class="token operator">:</span><span class="token string">"aes-256-gcm"</span>     # 加密方式， The recommended choice is <span class="token string">"chacha20-ietf-poly1305"</span> or <span class="token string">"aes-256-gcm"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="重启与自启动"><a href="#重启与自启动" class="headerlink" title="重启与自启动"></a>重启与自启动</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart shadowsocks-libev.service<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> shadowsocks-libev.service  <span class="token comment"># 有点奇怪，不能正确添加 --now 参数，所以分别执行</span><span class="token function">sudo</span> systemctl status shadowsocks-libev.service  <span class="token comment"># 确认状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>下载客户端，在 win 和 android 连接时 分别报错 timeout、can’t resolve cp.cloudflare.com</p><h3 id="resolution"><a href="#resolution" class="headerlink" title="resolution"></a>resolution</h3><p>经回忆，发现是本机的防火墙未放行 server_port  <code>sudo ufw allow 18388/tcp</code></p><h3 id="optimization-All-official-suggetions"><a href="#optimization-All-official-suggetions" class="headerlink" title="optimization (All official suggetions)"></a>optimization (All official suggetions)</h3><p>First of all, upgrade your Linux kernel to 3.5 or later.</p><h4 id="Step-1-increase-the-maximum-number-of-open-file-descriptors"><a href="#Step-1-increase-the-maximum-number-of-open-file-descriptors" class="headerlink" title="Step 1, increase the maximum number of open file descriptors"></a>Step 1, increase the maximum number of open file descriptors</h4><p>To handle thousands of concurrent TCP connections, we should increase the limit of file descriptors opened.<br>Edit the <code>limits.conf</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /etc/security/limits.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Add these two lines</p><pre class="line-numbers language-none"><code class="language-none">* soft nofile 51200* hard nofile 51200# for server running in root:root soft nofile 51200root hard nofile 51200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Then, before you start the shadowsocks server, set the ulimit first</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">51200</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="Step-2-Tune-the-kernel-parameters"><a href="#Step-2-Tune-the-kernel-parameters" class="headerlink" title="Step 2, Tune the kernel parameters"></a>Step 2, Tune the kernel parameters</h4><p>The priciples of tuning parameters for shadowsocks are</p><ol><li>Reuse ports and conections as soon as possible.</li><li>Enlarge the queues and buffers as large as possible.</li><li>Choose the TCP congestion algorithm for large latency and high throughput.</li></ol><p>Here is an example &#x2F;etc&#x2F;sysctl.conf of our production servers:</p><pre class="line-numbers language-none"><code class="language-none">fs.file-max &#x3D; 51200net.core.rmem_max &#x3D; 67108864net.core.wmem_max &#x3D; 67108864net.core.netdev_max_backlog &#x3D; 250000net.core.somaxconn &#x3D; 4096net.ipv4.tcp_syncookies &#x3D; 1net.ipv4.tcp_tw_reuse &#x3D; 1net.ipv4.tcp_tw_recycle &#x3D; 0net.ipv4.tcp_fin_timeout &#x3D; 30net.ipv4.tcp_keepalive_time &#x3D; 1200net.ipv4.ip_local_port_range &#x3D; 10000 65000net.ipv4.tcp_max_syn_backlog &#x3D; 8192net.ipv4.tcp_max_tw_buckets &#x3D; 5000net.ipv4.tcp_fastopen &#x3D; 3net.ipv4.tcp_mem &#x3D; 25600 51200 102400net.ipv4.tcp_rmem &#x3D; 4096 87380 67108864net.ipv4.tcp_wmem &#x3D; 4096 65536 67108864net.ipv4.tcp_mtu_probing &#x3D; 1net.ipv4.tcp_congestion_control &#x3D; hybla<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Of course, remember to execute sysctl -p to reload the config at runtime.</p><h2 id="clinet-使用"><a href="#clinet-使用" class="headerlink" title="clinet 使用"></a>clinet 使用</h2><h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><p>下载地址：<a href="https://github.com/shadowsocks/shadowsocks-android/releases/download/v5.3.3/shadowsocks-universal-5.3.3.apk">v5.3.3</a></p><h4 id="配置内容"><a href="#配置内容" class="headerlink" title="配置内容"></a>配置内容</h4><p>新增配置文件，填写以下内容：</p><ul><li>服务器：公网IP或域名</li><li>远程端口： server 放行的 tcp 端口</li><li>加密方式：同于 server 配置</li><li>路由： 绕过局域网及大陆地址</li></ul><p> 关于设置选项中的高级配置，并未做修改</p><h3 id="win"><a href="#win" class="headerlink" title="win"></a>win</h3><p>下载地址：<a href="https://github.com/shadowsocks/shadowsocks-windows/releases/download/4.4.1.0/Shadowsocks-4.4.1.0.zip">v4.4.1.0</a></p><h4 id="配置内容-1"><a href="#配置内容-1" class="headerlink" title="配置内容"></a>配置内容</h4><p>关联 ss:&#x2F;&#x2F; 链接 <br>系统代理–全局模式 <br>服务器–配置文件，填写以下内容：</p><ul><li>服务器：公网IP或域名</li><li>远程端口： server 放行的 tcp 端口</li><li>加密方式：同于 server 配置</li></ul>]]></content>
      
      
      <categories>
          
          <category> VPN </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shadowsocks </tag>
            
            <tag> vpn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cilium with Hubble</title>
      <link href="/2024/06/06/cilium/cilium-with-hubble/"/>
      <url>/2024/06/06/cilium/cilium-with-hubble/</url>
      
        <content type="html"><![CDATA[<h2 id="前情"><a href="#前情" class="headerlink" title="前情"></a>前情</h2><ol><li>rancher 集群，将 calico 替换为 cilium ；删除当前 calico-system 的资源</li></ol><h2 id="安装cilium"><a href="#安装cilium" class="headerlink" title="安装cilium"></a>安装cilium</h2><ol><li><p>进入集群管理中修改集群 yaml 中，spec.machineGlobalConfig.cni</p></li><li><p>编辑集群配置，修改附加配置中的 cilium 的 values</p><pre class="line-numbers language-none"><code class="language-none">.Values.hubble.metrics.enableOpenMetrics: true.Values.hubble.metrics.enabled:     - dns:query;ignoreAAAA      - drop      - tcp      - flow      - icmp      - http.Values.hubble.relay.enabled: true.Values.hubble.relay.prometheus.enabled: true.Values.hubble.ui.enabled: true  # 有必要对此做ingress.Values.envoy.enabled: true.Values.envoy.prometheus.enabled: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>服务自动发现的问题</p><pre class="line-numbers language-none"><code class="language-none">Get &quot;http:&#x2F;&#x2F;10.8.0.87:9964&#x2F;metrics?kubernetes_io_managed_by&#x3D;Helm&amp;kubernetes_io_name&#x3D;cilium-agent&amp;kubernetes_io_part_of&#x3D;cilium&quot;: dial tcp 10.8.0.87:9964: connect: connection refused<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><blockquote><p>[!solution]</p><ul><li>开启组件<pre class="line-numbers language-none"><code class="language-none">envoy:  enable: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul></blockquote><ul><li>集群中 cilium 的当前测试下的完整 values</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">MTU</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>    <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>          <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>            <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> cilium        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname<span class="token key atrule">agent</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">agentNotReadyTaintKey</span><span class="token punctuation">:</span> node.cilium.io/agent<span class="token punctuation">-</span>not<span class="token punctuation">-</span>ready<span class="token key atrule">aksbyocni</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">alibabacloud</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">annotateK8sNode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">apiRateLimit</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">authentication</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">gcInterval</span><span class="token punctuation">:</span> 5m0s  <span class="token key atrule">mutual</span><span class="token punctuation">:</span>    <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> 5s    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">4250</span>    <span class="token key atrule">spire</span><span class="token punctuation">:</span>      <span class="token key atrule">adminSocketPath</span><span class="token punctuation">:</span> /run/spire/sockets/admin.sock      <span class="token key atrule">agentSocketPath</span><span class="token punctuation">:</span> /run/spire/sockets/agent/agent.sock      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">connectionTimeout</span><span class="token punctuation">:</span> 30s      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">install</span><span class="token punctuation">:</span>        <span class="token key atrule">agent</span><span class="token punctuation">:</span>          <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">image</span><span class="token punctuation">:</span>            <span class="token key atrule">digest</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>              sha256<span class="token punctuation">:</span>99405637647968245ff9fe215f8bd2bd0ea9807be9725f8bf19fe1b21471e52b            <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>            <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent            <span class="token key atrule">repository</span><span class="token punctuation">:</span> ghcr.io/spiffe/spire<span class="token punctuation">-</span>agent            <span class="token key atrule">tag</span><span class="token punctuation">:</span> 1.8.5            <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span>            <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> spire<span class="token punctuation">-</span>agent          <span class="token key atrule">skipKubeletVerification</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule              <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready            <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule              <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master            <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule              <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/control<span class="token punctuation">-</span>plane            <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule              <span class="token key atrule">key</span><span class="token punctuation">:</span> node.cloudprovider.kubernetes.io/uninitialized              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>            <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly              <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">existingNamespace</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">initImage</span><span class="token punctuation">:</span>          <span class="token key atrule">digest</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>            sha256<span class="token punctuation">:</span>223ae047b1065bd069aac01ae3ac8088b3ca4a527827e283b85112f29385fb1b          <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>          <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">repository</span><span class="token punctuation">:</span> docker.io/library/busybox          <span class="token key atrule">tag</span><span class="token punctuation">:</span> 1.36.1          <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>spire        <span class="token key atrule">server</span><span class="token punctuation">:</span>          <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">ca</span><span class="token punctuation">:</span>            <span class="token key atrule">keyType</span><span class="token punctuation">:</span> rsa<span class="token punctuation">-</span><span class="token number">4096</span>            <span class="token key atrule">subject</span><span class="token punctuation">:</span>              <span class="token key atrule">commonName</span><span class="token punctuation">:</span> Cilium SPIRE CA              <span class="token key atrule">country</span><span class="token punctuation">:</span> US              <span class="token key atrule">organization</span><span class="token punctuation">:</span> SPIRE          <span class="token key atrule">dataStorage</span><span class="token punctuation">:</span>            <span class="token key atrule">accessMode</span><span class="token punctuation">:</span> ReadWriteOnce            <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">size</span><span class="token punctuation">:</span> 1Gi            <span class="token key atrule">storageClass</span><span class="token punctuation">:</span> <span class="token null important">null</span>          <span class="token key atrule">image</span><span class="token punctuation">:</span>            <span class="token key atrule">digest</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span>              sha256<span class="token punctuation">:</span>28269265882048dcf0fed32fe47663cd98613727210b8d1a55618826f9bf5428            <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>            <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent            <span class="token key atrule">repository</span><span class="token punctuation">:</span> ghcr.io/spiffe/spire<span class="token punctuation">-</span>server            <span class="token key atrule">tag</span><span class="token punctuation">:</span> 1.8.5            <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">initContainers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span>            <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>            <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>            <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP          <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span>            <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> spire<span class="token punctuation">-</span>server          <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">serverAddress</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">trustDomain</span><span class="token punctuation">:</span> spiffe.cilium  <span class="token key atrule">queueSize</span><span class="token punctuation">:</span> <span class="token number">1024</span>  <span class="token key atrule">rotatedIdentitiesQueueSize</span><span class="token punctuation">:</span> <span class="token number">1024</span><span class="token key atrule">autoDirectNodeRoutes</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">azure</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">bandwidthManager</span><span class="token punctuation">:</span>  <span class="token key atrule">bbr</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">bgp</span><span class="token punctuation">:</span>  <span class="token key atrule">announce</span><span class="token punctuation">:</span>    <span class="token key atrule">loadbalancerIP</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">podCIDR</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">bgpControlPlane</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">secretsNamespace</span><span class="token punctuation">:</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">bpf</span><span class="token punctuation">:</span>  <span class="token key atrule">authMapMax</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">autoMount</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">ctAnyMax</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">ctTcpMax</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">hostLegacyRouting</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">lbExternalClusterIP</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">lbMapMax</span><span class="token punctuation">:</span> <span class="token number">65536</span>  <span class="token key atrule">mapDynamicSizeRatio</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">masquerade</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">monitorAggregation</span><span class="token punctuation">:</span> medium  <span class="token key atrule">monitorFlags</span><span class="token punctuation">:</span> all  <span class="token key atrule">monitorInterval</span><span class="token punctuation">:</span> 5s  <span class="token key atrule">natMax</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">neighMax</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">policyMapMax</span><span class="token punctuation">:</span> <span class="token number">16384</span>  <span class="token key atrule">preallocateMaps</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">root</span><span class="token punctuation">:</span> /sys/fs/bpf  <span class="token key atrule">tproxy</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">vlanBypass</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">bpfClockProbe</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">certgen</span><span class="token punctuation">:</span>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">cronJob</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">job</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>certgen    <span class="token key atrule">tag</span><span class="token punctuation">:</span> v0.1.9    <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">ttlSecondsAfterFinished</span><span class="token punctuation">:</span> <span class="token number">1800</span><span class="token key atrule">cgroup</span><span class="token punctuation">:</span>  <span class="token key atrule">autoMount</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">hostRoot</span><span class="token punctuation">:</span> /run/cilium/cgroupv2<span class="token key atrule">cleanBpfState</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">cleanState</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">cluster</span><span class="token punctuation">:</span>  <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token key atrule">clustermesh</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">apiserver</span><span class="token punctuation">:</span>    <span class="token key atrule">affinity</span><span class="token punctuation">:</span>      <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>        <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>              <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>                <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> clustermesh<span class="token punctuation">-</span>apiserver            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname    <span class="token key atrule">etcd</span><span class="token punctuation">:</span>      <span class="token key atrule">init</span><span class="token punctuation">:</span>        <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span>      <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>clustermesh<span class="token punctuation">-</span>apiserver      <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.15.1      <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">kvstoremesh</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>          <span class="token key atrule">drop</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> ALL    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">metrics</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">etcd</span><span class="token punctuation">:</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">mode</span><span class="token punctuation">:</span> basic        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9963</span>      <span class="token key atrule">kvstoremesh</span><span class="token punctuation">:</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9964</span>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9962</span>      <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>        <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">etcd</span><span class="token punctuation">:</span>          <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s          <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>          <span class="token key atrule">relabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>        <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s        <span class="token key atrule">kvstoremesh</span><span class="token punctuation">:</span>          <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s          <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>          <span class="token key atrule">relabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>        <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>        <span class="token key atrule">relabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>      <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux    <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">podDisruptionBudget</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">service</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">internalTrafficPolicy</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">32379</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort    <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>    <span class="token key atrule">tls</span><span class="token punctuation">:</span>      <span class="token key atrule">admin</span><span class="token punctuation">:</span>        <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token key atrule">authMode</span><span class="token punctuation">:</span> legacy      <span class="token key atrule">auto</span><span class="token punctuation">:</span>        <span class="token key atrule">certManagerIssuerRef</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">certValidityDuration</span><span class="token punctuation">:</span> <span class="token number">1095</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">method</span><span class="token punctuation">:</span> helm      <span class="token key atrule">client</span><span class="token punctuation">:</span>        <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token key atrule">remote</span><span class="token punctuation">:</span>        <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token key atrule">server</span><span class="token punctuation">:</span>        <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">extraDnsNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token key atrule">extraIpAddresses</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>        <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">config</span><span class="token punctuation">:</span>    <span class="token key atrule">clusters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">domain</span><span class="token punctuation">:</span> mesh.cilium.io    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">maxConnectedClusters</span><span class="token punctuation">:</span> <span class="token number">255</span>  <span class="token key atrule">useAPIServer</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">cni</span><span class="token punctuation">:</span>  <span class="token key atrule">binPath</span><span class="token punctuation">:</span> /opt/cni/bin  <span class="token key atrule">chainingMode</span><span class="token punctuation">:</span> portmap  <span class="token key atrule">chainingTarget</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">confFileMountPath</span><span class="token punctuation">:</span> /tmp/cni<span class="token punctuation">-</span>configuration  <span class="token key atrule">confPath</span><span class="token punctuation">:</span> /etc/cni/net.d  <span class="token key atrule">configMapKey</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>config  <span class="token key atrule">customConf</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">exclusive</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">hostConfDirMountPath</span><span class="token punctuation">:</span> /host/etc/cni/net.d  <span class="token key atrule">install</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">logFile</span><span class="token punctuation">:</span> /var/run/cilium/cilium<span class="token punctuation">-</span>cni.log  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Mi  <span class="token key atrule">uninstall</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">conntrackGCInterval</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">conntrackGCMaxInterval</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">containerRuntime</span><span class="token punctuation">:</span>  <span class="token key atrule">integration</span><span class="token punctuation">:</span> none<span class="token key atrule">crdWaitTimeout</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">customCalls</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">daemon</span><span class="token punctuation">:</span>  <span class="token key atrule">allowedConfigOverrides</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">blockedConfigOverrides</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">configSources</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">runPath</span><span class="token punctuation">:</span> /var/run/cilium<span class="token key atrule">dashboards</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">label</span><span class="token punctuation">:</span> grafana_dashboard  <span class="token key atrule">labelValue</span><span class="token punctuation">:</span> <span class="token string">'1'</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">debug</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">verbose</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">disableEndpointCRD</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">dnsProxy</span><span class="token punctuation">:</span>  <span class="token key atrule">dnsRejectResponseCode</span><span class="token punctuation">:</span> refused  <span class="token key atrule">enableDnsCompression</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">endpointMaxIpPerHostname</span><span class="token punctuation">:</span> <span class="token number">50</span>  <span class="token key atrule">idleConnectionGracePeriod</span><span class="token punctuation">:</span> 0s  <span class="token key atrule">maxDeferredConnectionDeletes</span><span class="token punctuation">:</span> <span class="token number">10000</span>  <span class="token key atrule">minTtl</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">preCache</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">proxyPort</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">proxyResponseMaxDelay</span><span class="token punctuation">:</span> 100ms<span class="token key atrule">egressGateway</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">installRoutes</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">reconciliationTriggerInterval</span><span class="token punctuation">:</span> 1s<span class="token key atrule">enableCiliumEndpointSlice</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">enableCriticalPriorityClass</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">enableIPv4BIGTCP</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">enableIPv4Masquerade</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">enableIPv6BIGTCP</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">enableIPv6Masquerade</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">enableK8sTerminatingEndpoint</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">enableMasqueradeRouteSource</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">enableRuntimeDeviceDetection</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">enableXTSocketFallback</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">encryption</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">interface</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">ipsec</span><span class="token punctuation">:</span>    <span class="token key atrule">interface</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">keyRotationDuration</span><span class="token punctuation">:</span> 5m    <span class="token key atrule">keyWatcher</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> keys  <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ipsec  <span class="token key atrule">nodeEncryption</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">secretName</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>ipsec<span class="token punctuation">-</span>keys  <span class="token key atrule">strictMode</span><span class="token punctuation">:</span>    <span class="token key atrule">allowRemoteNodeIdentities</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">cidr</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ipsec  <span class="token key atrule">wireguard</span><span class="token punctuation">:</span>    <span class="token key atrule">persistentKeepalive</span><span class="token punctuation">:</span> 0s    <span class="token key atrule">userspaceFallback</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">endpointHealthChecking</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">endpointRoutes</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">endpointStatus</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">eni</span><span class="token punctuation">:</span>  <span class="token key atrule">awsEnablePrefixDelegation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">awsReleaseExcessIPs</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">ec2APIEndpoint</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">eniTags</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">gcInterval</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">gcTags</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">iamRole</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">instanceTagsFilter</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">subnetIDsFilter</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">subnetTagsFilter</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">updateEC2AdapterLimitViaAPI</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">envoy</span><span class="token punctuation">:</span>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>            <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>              <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>envoy          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">connectTimeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraContainers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraHostPathMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">healthPort</span><span class="token punctuation">:</span> <span class="token number">9878</span>  <span class="token key atrule">idleTimeoutDurationSeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>  <span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>envoy    <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.27.3<span class="token punctuation">-</span>713b673cccf1af661efd75ca20532336517ddcb9    <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>    <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>  <span class="token key atrule">log</span><span class="token punctuation">:</span>    <span class="token key atrule">format</span><span class="token punctuation">:</span> <span class="token string">'[%Y-%m-%d %T.%e][%t][%l][%n] [%g:%#] %v'</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">maxConnectionDurationSeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux  <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">prometheus</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">'9964'</span>    <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">relabelings</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> __meta_kubernetes_pod_node_name          <span class="token key atrule">targetLabel</span><span class="token punctuation">:</span> node  <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>    <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">rollOutPods</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>    <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>      <span class="token key atrule">envoy</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> NET_ADMIN        <span class="token punctuation">-</span> SYS_ADMIN    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">seLinuxOptions</span><span class="token punctuation">:</span>      <span class="token key atrule">level</span><span class="token punctuation">:</span> s0      <span class="token key atrule">type</span><span class="token punctuation">:</span> spc_t  <span class="token key atrule">startupProbe</span><span class="token punctuation">:</span>    <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">105</span>    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span class="token key atrule">envoyConfig</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">secretsNamespace</span><span class="token punctuation">:</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>secrets<span class="token key atrule">etcd</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">clusterDomain</span><span class="token punctuation">:</span> cluster.local  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//CHANGE<span class="token punctuation">-</span>ME<span class="token punctuation">:</span><span class="token number">2379</span>  <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>operator    <span class="token key atrule">tag</span><span class="token punctuation">:</span> v2.0.7    <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">k8sService</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux  <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podDisruptionBudget</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">ssl</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists  <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span class="token key atrule">externalIPs</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">externalWorkloads</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token key atrule">extraConfig</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">extraContainers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token key atrule">extraHostPathMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token key atrule">gatewayAPI</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">secretsNamespace</span><span class="token punctuation">:</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>secrets    <span class="token key atrule">sync</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">gke</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">global</span><span class="token punctuation">:</span>  <span class="token key atrule">systemDefaultRegistry</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">healthChecking</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">healthPort</span><span class="token punctuation">:</span> <span class="token number">9879</span><span class="token key atrule">highScaleIPcache</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">hostFirewall</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">hostPort</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">hubble</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">export</span><span class="token punctuation">:</span>    <span class="token key atrule">dynamic</span><span class="token punctuation">:</span>      <span class="token key atrule">config</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapName</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>flowlog<span class="token punctuation">-</span>config        <span class="token key atrule">content</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">excludeFilters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token key atrule">fieldMask</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token key atrule">filePath</span><span class="token punctuation">:</span> /var/run/cilium/hubble/events.log            <span class="token key atrule">includeFilters</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> all        <span class="token key atrule">createConfigMap</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">fileMaxBackups</span><span class="token punctuation">:</span> <span class="token number">5</span>    <span class="token key atrule">fileMaxSizeMb</span><span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token key atrule">static</span><span class="token punctuation">:</span>      <span class="token key atrule">allowList</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">denyList</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">fieldMask</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">filePath</span><span class="token punctuation">:</span> /var/run/cilium/hubble/events.log  <span class="token key atrule">listenAddress</span><span class="token punctuation">:</span> <span class="token string">':4244'</span>  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>    <span class="token key atrule">dashboards</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">label</span><span class="token punctuation">:</span> grafana_dashboard      <span class="token key atrule">labelValue</span><span class="token punctuation">:</span> <span class="token string">'1'</span>      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">enableOpenMetrics</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> dns<span class="token punctuation">:</span>query;ignoreAAAA      <span class="token punctuation">-</span> drop      <span class="token punctuation">-</span> tcp      <span class="token punctuation">-</span> http      <span class="token punctuation">-</span> flow      <span class="token punctuation">-</span> icmp    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9965</span>    <span class="token key atrule">serviceAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s      <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">relabelings</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> __meta_kubernetes_pod_node_name          <span class="token key atrule">targetLabel</span><span class="token punctuation">:</span> node  <span class="token key atrule">peerService</span><span class="token punctuation">:</span>    <span class="token key atrule">clusterDomain</span><span class="token punctuation">:</span> cluster.local    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">4244</span>  <span class="token key atrule">preferIpv6</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">redact</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">headers</span><span class="token punctuation">:</span>        <span class="token key atrule">allow</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token key atrule">deny</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">urlQuery</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">userInfo</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">kafka</span><span class="token punctuation">:</span>      <span class="token key atrule">apiKey</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">relay</span><span class="token punctuation">:</span>    <span class="token key atrule">affinity</span><span class="token punctuation">:</span>      <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span>        <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>              <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>                <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> cilium            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">dialTimeout</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">gops</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9893</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span>      <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>hubble<span class="token punctuation">-</span>relay      <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.15.1      <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">listenHost</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">listenPort</span><span class="token punctuation">:</span> <span class="token string">'4245'</span>    <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>      <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux    <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">podDisruptionBudget</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">65532</span>    <span class="token key atrule">pprof</span><span class="token punctuation">:</span>      <span class="token key atrule">address</span><span class="token punctuation">:</span> localhost      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6062</span>    <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9966</span>      <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>        <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s        <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>        <span class="token key atrule">relabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">retryTimeout</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">rollOutPods</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>        <span class="token key atrule">drop</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> ALL      <span class="token key atrule">runAsGroup</span><span class="token punctuation">:</span> <span class="token number">65532</span>      <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">65532</span>    <span class="token key atrule">service</span><span class="token punctuation">:</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31234</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP    <span class="token key atrule">sortBufferDrainTimeout</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">sortBufferLenMax</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">tls</span><span class="token punctuation">:</span>      <span class="token key atrule">client</span><span class="token punctuation">:</span>        <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token key atrule">server</span><span class="token punctuation">:</span>        <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">extraDnsNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token key atrule">extraIpAddresses</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">mtls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">relayName</span><span class="token punctuation">:</span> ui.hubble<span class="token punctuation">-</span>relay.cilium.io    <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>        <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">skipUnknownCGroupIDs</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">socketPath</span><span class="token punctuation">:</span> /var/run/cilium/hubble.sock  <span class="token key atrule">tls</span><span class="token punctuation">:</span>    <span class="token key atrule">auto</span><span class="token punctuation">:</span>      <span class="token key atrule">certManagerIssuerRef</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">certValidityDuration</span><span class="token punctuation">:</span> <span class="token number">1095</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">method</span><span class="token punctuation">:</span> helm      <span class="token key atrule">schedule</span><span class="token punctuation">:</span> 0 0 1 <span class="token important">*/4</span> *    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">server</span><span class="token punctuation">:</span>      <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token key atrule">extraDnsNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">extraIpAddresses</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">ui</span><span class="token punctuation">:</span>    <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">backend</span><span class="token punctuation">:</span>      <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">image</span><span class="token punctuation">:</span>        <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>        <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>hubble<span class="token punctuation">-</span>ui<span class="token punctuation">-</span>backend        <span class="token key atrule">tag</span><span class="token punctuation">:</span> v0.13.0        <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">baseUrl</span><span class="token punctuation">:</span> /    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">frontend</span><span class="token punctuation">:</span>      <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token key atrule">image</span><span class="token punctuation">:</span>        <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>        <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>hubble<span class="token punctuation">-</span>ui        <span class="token key atrule">tag</span><span class="token punctuation">:</span> v0.13.0        <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">server</span><span class="token punctuation">:</span>        <span class="token key atrule">ipv6</span><span class="token punctuation">:</span>          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">ingress</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">className</span><span class="token punctuation">:</span> higress      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> cilium.testlab.net      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">tls</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>      <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux    <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">podDisruptionBudget</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">rollOutPods</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1001</span>      <span class="token key atrule">runAsGroup</span><span class="token punctuation">:</span> <span class="token number">1001</span>      <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1001</span>    <span class="token key atrule">service</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31235</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP    <span class="token key atrule">standalone</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">tls</span><span class="token punctuation">:</span>        <span class="token key atrule">certsVolume</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">tls</span><span class="token punctuation">:</span>      <span class="token key atrule">client</span><span class="token punctuation">:</span>        <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>        <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span class="token key atrule">identityAllocationMode</span><span class="token punctuation">:</span> crd<span class="token key atrule">identityChangeGracePeriod</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">image</span><span class="token punctuation">:</span>  <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent  <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>cilium  <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.15.1  <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">ingressController</span><span class="token punctuation">:</span>  <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">defaultSecretName</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">defaultSecretNamespace</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">enableProxyProtocol</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">enforceHttps</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">ingressLBAnnotationPrefixes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> service.beta.kubernetes.io    <span class="token punctuation">-</span> service.kubernetes.io    <span class="token punctuation">-</span> cloud.google.com  <span class="token key atrule">loadbalancerMode</span><span class="token punctuation">:</span> dedicated  <span class="token key atrule">secretsNamespace</span><span class="token punctuation">:</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>secrets    <span class="token key atrule">sync</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">service</span><span class="token punctuation">:</span>    <span class="token key atrule">allocateLoadBalancerNodePorts</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">insecureNodePort</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">loadBalancerClass</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">loadBalancerIP</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>ingress    <span class="token key atrule">secureNodePort</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer<span class="token key atrule">initResources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">installNoConntrackIptablesRules</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">ipMasqAgent</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">ipam</span><span class="token punctuation">:</span>  <span class="token key atrule">ciliumNodeUpdateRate</span><span class="token punctuation">:</span> 15s  <span class="token key atrule">mode</span><span class="token punctuation">:</span> kubernetes  <span class="token key atrule">operator</span><span class="token punctuation">:</span>    <span class="token key atrule">autoCreateCiliumPodIPPools</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">clusterPoolIPv4MaskSize</span><span class="token punctuation">:</span> <span class="token number">24</span>    <span class="token key atrule">clusterPoolIPv4PodCIDRList</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 10.0.0.0/8    <span class="token key atrule">clusterPoolIPv6MaskSize</span><span class="token punctuation">:</span> <span class="token number">120</span>    <span class="token key atrule">clusterPoolIPv6PodCIDRList</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> fd00<span class="token punctuation">:</span><span class="token punctuation">:</span>/104    <span class="token key atrule">externalAPILimitBurstSize</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">externalAPILimitQPS</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">ipv4</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">ipv4NativeRoutingCIDR</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">ipv6</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">ipv6NativeRoutingCIDR</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">k8s</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">k8sClientRateLimit</span><span class="token punctuation">:</span>  <span class="token key atrule">burst</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">qps</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">k8sNetworkPolicy</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">k8sServiceHost</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">k8sServicePort</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">keepDeprecatedLabels</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">keepDeprecatedProbes</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">kubeConfigPath</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">kubeProxyReplacementHealthzBindAddr</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">l2NeighDiscovery</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">refreshPeriod</span><span class="token punctuation">:</span> 30s<span class="token key atrule">l2announcements</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">l2podAnnouncements</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">interface</span><span class="token punctuation">:</span> eth0<span class="token key atrule">l7Proxy</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>  <span class="token key atrule">acceleration</span><span class="token punctuation">:</span> disabled  <span class="token key atrule">l7</span><span class="token punctuation">:</span>    <span class="token key atrule">algorithm</span><span class="token punctuation">:</span> round_robin    <span class="token key atrule">backend</span><span class="token punctuation">:</span> disabled    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token key atrule">localRedirectPolicy</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">logSystemLoad</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">maglev</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">monitor</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token key atrule">nat46x64Gateway</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">nodePort</span><span class="token punctuation">:</span>  <span class="token key atrule">autoProtectPortRange</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">bindProtection</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">enableHealthCheck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">enableHealthCheckLoadBalancerIP</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>  <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux<span class="token key atrule">nodeinit</span><span class="token punctuation">:</span>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">bootstrapFile</span><span class="token punctuation">:</span> /tmp/cilium<span class="token punctuation">-</span>bootstrap.d/cilium<span class="token punctuation">-</span>bootstrap<span class="token punctuation">-</span>time  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">repository</span><span class="token punctuation">:</span> quay.io/cilium/startup<span class="token punctuation">-</span>script    <span class="token key atrule">tag</span><span class="token punctuation">:</span> 62093c5c233ea914bfa26a10ba41f8780d9b737f  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux  <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">prestop</span><span class="token punctuation">:</span>    <span class="token key atrule">postScript</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">preScript</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>    <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>      <span class="token key atrule">add</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> SYS_MODULE        <span class="token punctuation">-</span> NET_ADMIN        <span class="token punctuation">-</span> SYS_ADMIN        <span class="token punctuation">-</span> SYS_CHROOT        <span class="token punctuation">-</span> SYS_PTRACE    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">seLinuxOptions</span><span class="token punctuation">:</span>      <span class="token key atrule">level</span><span class="token punctuation">:</span> s0      <span class="token key atrule">type</span><span class="token punctuation">:</span> spc_t  <span class="token key atrule">startup</span><span class="token punctuation">:</span>    <span class="token key atrule">postScript</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">preScript</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span class="token key atrule">operator</span><span class="token punctuation">:</span>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>            <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>              <span class="token key atrule">io.cilium/app</span><span class="token punctuation">:</span> operator          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">dashboards</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> grafana_dashboard    <span class="token key atrule">labelValue</span><span class="token punctuation">:</span> <span class="token string">'1'</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">endpointGCInterval</span><span class="token punctuation">:</span> 5m0s  <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraHostPathMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">identityGCInterval</span><span class="token punctuation">:</span> 15m0s  <span class="token key atrule">identityHeartbeatTimeout</span><span class="token punctuation">:</span> 30m0s  <span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>operator    <span class="token key atrule">suffix</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.15.1    <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">nodeGCInterval</span><span class="token punctuation">:</span> 5m0s  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux  <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podDisruptionBudget</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">pprof</span><span class="token punctuation">:</span>    <span class="token key atrule">address</span><span class="token punctuation">:</span> localhost    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6061</span>  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">prometheus</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9963</span>    <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s      <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> <span class="token string">''</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">relabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">removeNodeTaints</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">rollOutPods</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">setNodeNetworkStatus</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">setNodeTaints</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">skipCNPStatusStartupClean</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">skipCRDCreation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists  <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">unmanagedPodWatcher</span><span class="token punctuation">:</span>    <span class="token key atrule">intervalSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 50%    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span class="token key atrule">pmtuDiscovery</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">policyCIDRMatchMode</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">policyEnforcementMode</span><span class="token punctuation">:</span> default<span class="token key atrule">portmapPlugin</span><span class="token punctuation">:</span>  <span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/hardened<span class="token punctuation">-</span>cni<span class="token punctuation">-</span>plugins    <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.4.0<span class="token punctuation">-</span>build20240122<span class="token key atrule">pprof</span><span class="token punctuation">:</span>  <span class="token key atrule">address</span><span class="token punctuation">:</span> localhost  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6060</span><span class="token key atrule">preflight</span><span class="token punctuation">:</span>  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span>      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>            <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>              <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> cilium          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">extraEnv</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">override</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">repository</span><span class="token punctuation">:</span> rancher/mirrored<span class="token punctuation">-</span>cilium<span class="token punctuation">-</span>cilium    <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.15.1    <span class="token key atrule">useDigest</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux  <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podDisruptionBudget</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">tofqdnsPreCache</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule      <span class="token key atrule">key</span><span class="token punctuation">:</span> node.kubernetes.io/not<span class="token punctuation">-</span>ready    <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule      <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master    <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule      <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/control<span class="token punctuation">-</span>plane    <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule      <span class="token key atrule">key</span><span class="token punctuation">:</span> node.cloudprovider.kubernetes.io/uninitialized      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'true'</span>    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly      <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">validateCNPs</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">prometheus</span><span class="token punctuation">:</span>  <span class="token key atrule">controllerGroupMetrics</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> write<span class="token punctuation">-</span>cni<span class="token punctuation">-</span>file    <span class="token punctuation">-</span> sync<span class="token punctuation">-</span>host<span class="token punctuation">-</span>ips    <span class="token punctuation">-</span> sync<span class="token punctuation">-</span>lb<span class="token punctuation">-</span>maps<span class="token punctuation">-</span>with<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>services  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">metrics</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9962</span>  <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s    <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token null important">null</span>    <span class="token key atrule">relabelings</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> __meta_kubernetes_pod_node_name        <span class="token key atrule">targetLabel</span><span class="token punctuation">:</span> node    <span class="token key atrule">trustCRDsExist</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">proxy</span><span class="token punctuation">:</span>  <span class="token key atrule">prometheus</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">sidecarImageRegex</span><span class="token punctuation">:</span> cilium/istio_proxy<span class="token key atrule">rbac</span><span class="token punctuation">:</span>  <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token key atrule">remoteNodeIdentity</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">resourceQuotas</span><span class="token punctuation">:</span>  <span class="token key atrule">cilium</span><span class="token punctuation">:</span>    <span class="token key atrule">hard</span><span class="token punctuation">:</span>      <span class="token key atrule">pods</span><span class="token punctuation">:</span> 10k  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">operator</span><span class="token punctuation">:</span>    <span class="token key atrule">hard</span><span class="token punctuation">:</span>      <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token string">'15'</span><span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">rollOutCiliumPods</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">routingMode</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">sctp</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">securityContext</span><span class="token punctuation">:</span>  <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>    <span class="token key atrule">applySysctlOverwrites</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> SYS_ADMIN      <span class="token punctuation">-</span> SYS_CHROOT      <span class="token punctuation">-</span> SYS_PTRACE    <span class="token key atrule">ciliumAgent</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> CHOWN      <span class="token punctuation">-</span> KILL      <span class="token punctuation">-</span> NET_ADMIN      <span class="token punctuation">-</span> NET_RAW      <span class="token punctuation">-</span> IPC_LOCK      <span class="token punctuation">-</span> SYS_MODULE      <span class="token punctuation">-</span> SYS_ADMIN      <span class="token punctuation">-</span> SYS_RESOURCE      <span class="token punctuation">-</span> DAC_OVERRIDE      <span class="token punctuation">-</span> FOWNER      <span class="token punctuation">-</span> SETGID      <span class="token punctuation">-</span> SETUID    <span class="token key atrule">cleanCiliumState</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> NET_ADMIN      <span class="token punctuation">-</span> SYS_MODULE      <span class="token punctuation">-</span> SYS_ADMIN      <span class="token punctuation">-</span> SYS_RESOURCE    <span class="token key atrule">mountCgroup</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> SYS_ADMIN      <span class="token punctuation">-</span> SYS_CHROOT      <span class="token punctuation">-</span> SYS_PTRACE  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">seLinuxOptions</span><span class="token punctuation">:</span>    <span class="token key atrule">level</span><span class="token punctuation">:</span> s0    <span class="token key atrule">type</span><span class="token punctuation">:</span> spc_t<span class="token key atrule">serviceAccounts</span><span class="token punctuation">:</span>  <span class="token key atrule">cilium</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium  <span class="token key atrule">clustermeshApiserver</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> clustermesh<span class="token punctuation">-</span>apiserver  <span class="token key atrule">clustermeshcertgen</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> clustermesh<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>generate<span class="token punctuation">-</span>certs  <span class="token key atrule">envoy</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>envoy  <span class="token key atrule">etcd</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>operator  <span class="token key atrule">hubblecertgen</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> hubble<span class="token punctuation">-</span>generate<span class="token punctuation">-</span>certs  <span class="token key atrule">nodeinit</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>nodeinit  <span class="token key atrule">operator</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>operator  <span class="token key atrule">preflight</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>pre<span class="token punctuation">-</span>flight  <span class="token key atrule">relay</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> hubble<span class="token punctuation">-</span>relay  <span class="token key atrule">ui</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">automount</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> hubble<span class="token punctuation">-</span>ui<span class="token key atrule">serviceNoBackendResponse</span><span class="token punctuation">:</span> reject<span class="token key atrule">sleepAfterInit</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">socketLB</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">startupProbe</span><span class="token punctuation">:</span>  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">105</span>  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token key atrule">svcSourceRangeCheck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">synchronizeK8sNodes</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token key atrule">tls</span><span class="token punctuation">:</span>  <span class="token key atrule">ca</span><span class="token punctuation">:</span>    <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">''</span>    <span class="token key atrule">certValidityDuration</span><span class="token punctuation">:</span> <span class="token number">1095</span>    <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">caBundle</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">key</span><span class="token punctuation">:</span> ca.crt    <span class="token key atrule">name</span><span class="token punctuation">:</span> cilium<span class="token punctuation">-</span>root<span class="token punctuation">-</span>ca.crt    <span class="token key atrule">useSecret</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">secretsBackend</span><span class="token punctuation">:</span> local<span class="token key atrule">tolerations</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists<span class="token key atrule">tunnelPort</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token key atrule">tunnelProtocol</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate<span class="token key atrule">vtep</span><span class="token punctuation">:</span>  <span class="token key atrule">cidr</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">mac</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">mask</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">waitForKubeProxy</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">wellKnownIdentities</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> cilium </tag>
            
            <tag> hubble </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nextcloud-metrics</title>
      <link href="/2024/05/24/nextcloud/metrics/"/>
      <url>/2024/05/24/nextcloud/metrics/</url>
      
        <content type="html"><![CDATA[<h3 id="1-步骤"><a href="#1-步骤" class="headerlink" title="1. 步骤"></a>1. 步骤</h3><h3 id="1-1-生成一个-token，并填写在-values-metrics-token"><a href="#1-1-生成一个-token，并填写在-values-metrics-token" class="headerlink" title="1 .1 生成一个 token，并填写在 values.metrics.token"></a>1 .1 生成一个 token，并填写在 values.metrics.token</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl rand <span class="token parameter variable">-hex</span> <span class="token number">32</span> <span class="token comment"># 生成token</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>在不同的版本下，可能存在并未启用 tokenkey，将导致 nextcloud-metrics template 渲染时缺少一个变量</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">.values.nextcloud.existingSecret.tokenKey</span><span class="token punctuation">:</span> nextcloud<span class="token punctuation">-</span>token<span class="token comment"># 确保此处未被注释</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="1-2-为-exporter-设置-trusted-domains-在集群中，metrics-exporter-nextcloud-metrics-nextcloud-svc-cluster-local-直接访问-nextcloud-实例前，需要被信任"><a href="#1-2-为-exporter-设置-trusted-domains-在集群中，metrics-exporter-nextcloud-metrics-nextcloud-svc-cluster-local-直接访问-nextcloud-实例前，需要被信任" class="headerlink" title="1.2 为 exporter 设置 trusted_domains, 在集群中，metrics-exporter (nextcloud-metrics.nextcloud.svc.cluster.local)直接访问 nextcloud 实例前，需要被信任"></a>1.2 为 exporter 设置 trusted_domains, 在集群中，metrics-exporter (nextcloud-metrics.nextcloud.svc.cluster.local)直接访问 nextcloud 实例前，需要被信任</h3><ul><li>nextcloud.configs—-for trusted_domains<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">configs</span><span class="token punctuation">:</span>  <span class="token key atrule">domains.config.php</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    &lt;<span class="token punctuation">?</span>php    $CONFIG = array (      'trusted_domains' =<span class="token punctuation">></span>        array (         0 =<span class="token punctuation">></span> 'localhost'<span class="token punctuation">,</span>         1 =<span class="token punctuation">></span> 'nextcloud<span class="token punctuation">-</span>metrics.nextcloud.svc.cluster.local'<span class="token punctuation">,</span>  <span class="token comment"># 原理上，这里生效即可，但是这个实际却没有作用，因为是在nextcloud的配置中，所以不遵从k8s网络规则</span>         2 =<span class="token punctuation">></span> '<span class="token important">*'</span><span class="token punctuation">,</span>                                              <span class="token comment"># 仅此处生效，10.0.0.0/8 不生效</span>        )    );<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="1-3-安装成功后，在终端让-nextcloud-server-通过-occ-命令做-token-设置"><a href="#1-3-安装成功后，在终端让-nextcloud-server-通过-occ-命令做-token-设置" class="headerlink" title="1.3 安装成功后，在终端让 nextcloud-server 通过 occ  命令做 token 设置"></a>1.3 安装成功后，在终端让 nextcloud-server 通过 occ  命令做 token 设置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#使用上方已经生成的token</span>kubectl <span class="token parameter variable">-n</span> nextcloud <span class="token builtin class-name">exec</span> nextcloud-86465f6d56-gcz6b -- <span class="token function">su</span> <span class="token parameter variable">-s</span> /bin/sh www-data <span class="token parameter variable">-c</span> <span class="token string">"php occ config:app:set serverinfo token --value 9077a6605148d99de4f1dc6adaa30ad32ad406d7ef434b4abd8e7f8999a2ea2c"</span> <span class="token comment"># server设置 token</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="1-4-nextcloud-metrics-此时应该能够拿到有关指标，并转换格式"><a href="#1-4-nextcloud-metrics-此时应该能够拿到有关指标，并转换格式" class="headerlink" title="1.4 nextcloud-metrics 此时应该能够拿到有关指标，并转换格式"></a>1.4 nextcloud-metrics 此时应该能够拿到有关指标，并转换格式</h3><ul><li>在集群内使用 curl <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://nextcloud-metrics:9205/metrics   <span class="token comment"># 得到指标</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="2-debug"><a href="#2-debug" class="headerlink" title="2. debug"></a>2. debug</h3><blockquote><p>[!error]<br>msg&#x3D;”Error during scrape: Get &quot; <a href="http://nextcloud.nextcloud.svc.cluster.local:8080/ocs/v2.php/apps/serverinfo/api/v1/info?format=json%5C">http://nextcloud.nextcloud.svc.cluster.local:8080/ocs/v2.php/apps/serverinfo/api/v1/info?format=json\</a>“: dial tcp 10.43.173.56:8080: connect: connection refused” <br>level&#x3D;error msg&#x3D;”Error during scrape: unexpected status code: 400”</p></blockquote><blockquote><p>[!solution]<br>原因：trusted_domains 没有设置 信任源地址</p></blockquote><h4 id="查看已经设置的-trusted-domains"><a href="#查看已经设置的-trusted-domains" class="headerlink" title="查看已经设置的 trusted_domains"></a>查看已经设置的 trusted_domains</h4><pre class="line-numbers language-none"><code class="language-none">kubectl -n nextcloud exec nextcloud-c96bdff98-kbftk -- su -s &#x2F;bin&#x2F;sh www-data -c &quot;php occ config:system:get trusted_domains&quot;  localhost  *.nextcloud.svc.cluster.local  *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!error]<br>表现：此时的 nextcloud_up&#x3D;0，指标未正确收集 <br>Error during scrape: Get &quot; <a href="https://nextcloud:8080/ocs/v2.php/apps/serverinfo/api/v1/info?format=json%5C">https://nextcloud:8080/ocs/v2.php/apps/serverinfo/api/v1/info?format=json\</a>“: http: server gave HTTP response to HTTPS client” </p></blockquote><blockquote><p>[!Solution]<br>声明 .values.metrics.https: false </p></blockquote><blockquote><p>[!error]<br>表现：此时的 nextcloud_up&#x3D;0，指标未正确收集 <br>“Error during scrape: Get &quot; <a href="http://nextcloud:8080/ocs/v2.php/apps/serverinfo/api/v1/info?format=json%5C">http://nextcloud:8080/ocs/v2.php/apps/serverinfo/api/v1/info?format=json\</a>“: context deadline exceeded (Client.Timeout exceeded while awaiting headers)”</p></blockquote><blockquote><p>[!Solution]<br>此时经过实践，更换 exporter 的镜像之后升级应用可以解决这个问题，原因未明。</p></blockquote><h3 id="3-Prometheus-通过-endpoints-抓取指标"><a href="#3-Prometheus-通过-endpoints-抓取指标" class="headerlink" title="3. Prometheus 通过 endpoints 抓取指标"></a>3. Prometheus 通过 endpoints 抓取指标</h3><p>此时应用的 nextcloud-metrics 的 service 具有 scrape 的 annotations，可以正常获取指标</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> metrics </tag>
            
            <tag> nextcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vault-metrics</title>
      <link href="/2024/05/23/vault-metrics/"/>
      <url>/2024/05/23/vault-metrics/</url>
      
        <content type="html"><![CDATA[<h2 id="以下是在-kubernetes-集群的自动发现"><a href="#以下是在-kubernetes-集群的自动发现" class="headerlink" title="以下是在 kubernetes 集群的自动发现"></a>以下是在 kubernetes 集群的自动发现</h2><h3 id="vault-helm-chart"><a href="#vault-helm-chart" class="headerlink" title="vault helm chart"></a>vault helm chart</h3><h4 id="保证-server-standalone-config-配置如下"><a href="#保证-server-standalone-config-配置如下" class="headerlink" title="保证 server.standalone  config 配置如下"></a>保证 server.standalone  config 配置如下</h4><pre class="line-numbers language-none"><code class="language-none">config: |      ui &#x3D; true      listener &quot;tcp&quot; &#123;        tls_disable &#x3D; 1        address &#x3D; &quot;[::]:8200&quot;        cluster_address &#x3D; &quot;[::]:8201&quot;        # Enable unauthenticated metrics access (necessary for Prometheus Operator)        telemetry &#123;          unauthenticated_metrics_access &#x3D; &quot;true&quot;        &#125;      &#125;      storage &quot;file&quot; &#123;        path &#x3D; &quot;&#x2F;vault&#x2F;data&quot;      &#125;      # Example configuration for enabling Prometheus metrics in your config. 必须配置      telemetry &#123;        prometheus_retention_time &#x3D; &quot;3d&quot;        disable_hostname &#x3D; true      &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="开启-servicemonitor"><a href="#开启-servicemonitor" class="headerlink" title="开启 servicemonitor"></a>开启 servicemonitor</h3><p><code>serverTelemetry.serviceMonitor.enabled：true</code></p><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>服务成功发现，但是 prometheus targets 中报错 <code>server returned HTTP status 400 Bad Request</code> ，以下是集群内 curl 容器 api 的结果</p><pre class="line-numbers language-none"><code class="language-none">curl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics&#x2F;&#123;&quot;errors&quot;:[&quot;permission denied&quot;]&#125;curl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics &#123;&quot;Timestamp&quot;:&quot;2024-04-15 03:07:50 +0000 UTC&quot;,&quot;Gauges&quot;:[&#123;&quot;Name&quot;:&quot;vault.core.active&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.in_flight_requests&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;auth&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:2,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.num_entries&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;true&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:253,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;auth&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:447,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;false&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.mount_table.size&quot;,&quot;Value&quot;:302,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;,&quot;local&quot;:&quot;true&quot;,&quot;type&quot;:&quot;logical&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.performance_standby&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.dr.primary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.dr.secondary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.performance.primary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.performance.secondary&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.replication.write_undo_logs&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.unsealed&quot;,&quot;Value&quot;:1,&quot;Labels&quot;:&#123;&quot;cluster&quot;:&quot;vault-cluster-d79f20a5&quot;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.expire.num_irrevocable_leases&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.expire.num_leases&quot;,&quot;Value&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.alloc_bytes&quot;,&quot;Value&quot;:47050330,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.free_count&quot;,&quot;Value&quot;:115420530,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.heap_objects&quot;,&quot;Value&quot;:92536,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.malloc_count&quot;,&quot;Value&quot;:115513064,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.num_goroutines&quot;,&quot;Value&quot;:224,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.sys_bytes&quot;,&quot;Value&quot;:81191190,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.total_gc_pause_ns&quot;,&quot;Value&quot;:345062720,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.runtime.total_gc_runs&quot;,&quot;Value&quot;:2005,&quot;Labels&quot;:&#123;&#125;&#125;],&quot;Points&quot;:[],&quot;Counters&quot;:[&#123;&quot;Name&quot;:&quot;vault.audit.log_request_failure&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0,&quot;Sum&quot;:0,&quot;Min&quot;:0,&quot;Max&quot;:0,&quot;Mean&quot;:0,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.audit.log_response_failure&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0,&quot;Sum&quot;:0,&quot;Min&quot;:0,&quot;Max&quot;:0,&quot;Mean&quot;:0,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.cache.hit&quot;,&quot;Count&quot;:2,&quot;Rate&quot;:0.2,&quot;Sum&quot;:2,&quot;Min&quot;:1,&quot;Max&quot;:1,&quot;Mean&quot;:1,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;],&quot;Samples&quot;:[&#123;&quot;Name&quot;:&quot;vault.audit.log_request&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.00067349998280406,&quot;Sum&quot;:0.0067349998280406,&quot;Min&quot;:0.0067349998280406,&quot;Max&quot;:0.0067349998280406,&quot;Mean&quot;:0.0067349998280406,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.audit.log_response&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.00048179998993873595,&quot;Sum&quot;:0.00481799989938736,&quot;Min&quot;:0.00481799989938736,&quot;Max&quot;:0.00481799989938736,&quot;Mean&quot;:0.00481799989938736,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.barrier.get&quot;,&quot;Count&quot;:2,&quot;Rate&quot;:0.007432200014591217,&quot;Sum&quot;:0.07432200014591217,&quot;Min&quot;:0.027681000530719757,&quot;Max&quot;:0.04664099961519241,&quot;Mean&quot;:0.037161000072956085,&quot;Stddev&quot;:0.013406743923921348,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.check_token&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.01593659967184067,&quot;Sum&quot;:0.15936599671840668,&quot;Min&quot;:0.15936599671840668,&quot;Max&quot;:0.15936599671840668,&quot;Mean&quot;:0.15936599671840668,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.fetch_acl_and_token&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.014495299756526947,&quot;Sum&quot;:0.14495299756526947,&quot;Min&quot;:0.14495299756526947,&quot;Max&quot;:0.14495299756526947,&quot;Mean&quot;:0.14495299756526947,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;,&#123;&quot;Name&quot;:&quot;vault.core.handle_request&quot;,&quot;Count&quot;:1,&quot;Rate&quot;:0.019178299605846404,&quot;Sum&quot;:0.19178299605846405,&quot;Min&quot;:0.19178299605846405,&quot;Max&quot;:0.19178299605846405,&quot;Mean&quot;:0.19178299605846405,&quot;Stddev&quot;:0,&quot;Labels&quot;:&#123;&#125;&#125;]&#125;curl  10.42.169.106:8200&#x2F;v1&#x2F;sys&#x2F;metrics?format&#x3D;&quot;prometheus&quot;prometheus is not enabled&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>多次排查之后发现并无特别的问题，helm 部署之后多次修改调整 values 后，config 没有成功生效，其中的值没有成功传入容器。删除应用后重新安装转为正常。</p><h2 id="以下是将-metrics-暴露到集群外"><a href="#以下是将-metrics-暴露到集群外" class="headerlink" title="以下是将 metrics 暴露到集群外"></a>以下是将 metrics 暴露到集群外</h2><h3 id="2-telemetry-授权"><a href="#2-telemetry-授权" class="headerlink" title="2. telemetry 授权"></a>2. telemetry 授权</h3><h4 id="2-1-在单节点配置文件部分添加这个块"><a href="#2-1-在单节点配置文件部分添加这个块" class="headerlink" title="2.1 在单节点配置文件部分添加这个块"></a>2.1 在单节点配置文件部分添加这个块</h4><pre class="line-numbers language-none"><code class="language-none">telemetry &#123;        prometheus_retention_time &#x3D; &quot;30s&quot;        disable_hostname &#x3D; true&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-2-为-prometheus-创建访问的-token"><a href="#2-2-为-prometheus-创建访问的-token" class="headerlink" title="2.2 为 prometheus 创建访问的 token"></a>2.2 为 prometheus 创建访问的 token</h4><ul><li>权限<pre class="line-numbers language-none"><code class="language-none">vault policy write prometheus-metrics - &lt;&lt; EOFpath &quot;&#x2F;sys&#x2F;metrics&quot; &#123;  capabilities &#x3D; [&quot;read&quot;]&#125;EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>创建具有权限的 token<pre class="line-numbers language-none"><code class="language-none">vault token create \  -field&#x3D;token \  -policy prometheus-metrics \  &gt; prometheus-token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>将上方生成的 token 给予 prom。</p><h3 id="3-prometheus-的配置"><a href="#3-prometheus-的配置" class="headerlink" title="3. prometheus 的配置"></a>3. prometheus 的配置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> prometheus.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOFscrape_configs:  - job_name: vault    metrics_path: /v1/sys/metrics    params:      format: ['prometheus']    scheme: http    authorization:      credentials_file: /etc/prometheus/prometheus-token #使用 token    static_configs:    - targets: ['10.8.0.151:8200']EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>prom 热加载 <code>curl -X POST http://xxxx/-/reload</code></p><h2 id="第一次测试时-helm-主要修改内容"><a href="#第一次测试时-helm-主要修改内容" class="headerlink" title="第一次测试时 helm 主要修改内容"></a>第一次测试时 helm 主要修改内容</h2><p>参考 helm 中 config 部分<br>values.yaml %% REGION %% </p><pre class="line-numbers language-yaml" data-language="yaml"><div class="caption"><span>TI:"values"</span></div><code class="language-yaml"><span class="token key atrule">global.datastorage</span><span class="token punctuation">:</span><span class="token key atrule">server</span><span class="token punctuation">:</span>  <span class="token key atrule">standalone</span><span class="token punctuation">:</span>    <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token scalar string">      ui = true      listener "tcp" &#123;        tls_disable = 1        address = "[::]:8200"        cluster_address = "[::]:8201"        # Enable unauthenticated metrics access (necessary for Prometheus Operator)        telemetry &#123;          unauthenticated_metrics_access = "true"          unauthenticated_in_flight_request_access = "true" #此项应该无关prom metrics        &#125;      &#125;</span>      storage "file" <span class="token punctuation">&#123;</span>        path = "/vault/data"      <span class="token punctuation">&#125;</span>          <span class="token comment"># Example configuration for enabling Prometheus metrics in your config; when post outside your cluster</span>      telemetry <span class="token punctuation">&#123;</span>        prometheus_retention_time = "3d"        disable_hostname = true      <span class="token punctuation">&#125;</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token string">'true'</span>  <span class="token key atrule">statefulSet</span><span class="token punctuation">:</span>    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">container</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">pod</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token key atrule">updateStrategyType</span><span class="token punctuation">:</span> OnDelete  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token null important">null</span>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token key atrule">serverTelemetry</span><span class="token punctuation">:</span>  <span class="token key atrule">prometheusRules</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">rules</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">selectors</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s    <span class="token key atrule">scrapeTimeout</span><span class="token punctuation">:</span> 10s    <span class="token key atrule">selectors</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>%% ENDREGION %%</p><ul><li>当前只是 standalone 配置</li><li>server unseal 之后才能正常访问 UI</li></ul><blockquote><p>[!failure]<br>vault logs： <code>core: security barrier not initialized</code></p></blockquote><blockquote><p>[!info]</p><pre class="line-numbers language-none"><code class="language-none">&#x2F; $ vault operator init #进入容器执行Unseal Key 1: D9apO9R7M9hL0PQaSByJ9pAEGy3EMIJZIrQDx+bHwhpyUnseal Key 2: 0ixkSa4BM7X8Tre4F1JQDCR06m&#x2F;AEtRUPD6DwvfecwD+Unseal Key 3: 3y&#x2F;sowvniDzofLE3AQnzvXujQSE894ocaQO61YTbU+r2Unseal Key 4: dhkVbYBR7xqdl&#x2F;Q+&#x2F;QvvU9PofKdXu+OiYseqRuH8N7eoUnseal Key 5: 5lP9+P6S&#x2F;pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRoInitial Root Token: hvs.UKtqCCot92t6cSlxsM7SW5brVault initialized with 5 key shares and a key threshold of 3. Please securelydistribute the key shares printed above. When the Vault is re-sealed,restarted, or stopped, you must supply at least 3 of these keys to unseal itbefore it can start servicing requests.Vault does not store the generated root key. Without at least 3 keys toreconstruct the root key, Vault will remain permanently sealed!It is possible to generate new unseal keys, provided you have a quorum ofexisting unseal keys shares. See &quot;vault operator rekey&quot; for more information.&gt;&#x2F; $ vault operator unseal 5lP9+P6S&#x2F;pBW0H6kPTSqktDOxn1LU1JO4HPR9TWeSJRo  # 利用上述 key，重复执行 3 次即可解封 vault，这个 pod 将正常<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> metrics </tag>
            
            <tag> nextcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>authentik-metrics</title>
      <link href="/2024/05/23/authentik-metrics/"/>
      <url>/2024/05/23/authentik-metrics/</url>
      
        <content type="html"><![CDATA[<h2 id="values"><a href="#values" class="headerlink" title="values"></a>values</h2><pre class="line-numbers language-none"><code class="language-none">global.addPrometheusAnnotations: trueserver.metrics.enabled: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>将启用一个 metrics-pod 来暴露 server 的指标，并为其添加 annotation;，这与 servicemonitor 二选其一;不会产生其他端点的错误访问。</p><h2 id="serviceMonitor"><a href="#serviceMonitor" class="headerlink" title="serviceMonitor"></a>serviceMonitor</h2><pre><code>以下好像是应用自动创建的,需要在新增其他组件的时候尝试验证</code></pre><ul><li><p>outpost-proxy metrics</p><pre class="line-numbers language-none"><code class="language-none">apiVersion: monitoring.coreos.com&#x2F;v1kind: ServiceMonitormetadata:  labels:    app.kubernetes.io&#x2F;instance: proxy    app.kubernetes.io&#x2F;managed-by: goauthentik.io    app.kubernetes.io&#x2F;name: authentik-proxy    app.kubernetes.io&#x2F;version: 2024.4.0    goauthentik.io&#x2F;outpost-name: proxy    goauthentik.io&#x2F;outpost-type: proxy    goauthentik.io&#x2F;outpost-uuid: f868f7f70fa94a55a0b62c7904b334a4  name: ak-outpost-proxy  namespace: authentikspec:  endpoints:    - path: &#x2F;metrics      port: http-metrics  selector:    matchLabels:      app.kubernetes.io&#x2F;instance: proxy      app.kubernetes.io&#x2F;managed-by: goauthentik.io      app.kubernetes.io&#x2F;name: authentik-proxy      app.kubernetes.io&#x2F;version: 2024.4.0      goauthentik.io&#x2F;outpost-name: proxy      goauthentik.io&#x2F;outpost-type: proxy      goauthentik.io&#x2F;outpost-uuid: f868f7f70fa94a55a0b62c7904b334a4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>oupost-ldap metrics</p><pre class="line-numbers language-none"><code class="language-none">apiVersion: monitoring.coreos.com&#x2F;v1kind: ServiceMonitormetadata:  labels:    app.kubernetes.io&#x2F;instance: ldap    app.kubernetes.io&#x2F;managed-by: goauthentik.io    app.kubernetes.io&#x2F;name: authentik-ldap    app.kubernetes.io&#x2F;version: 2024.4.0    goauthentik.io&#x2F;outpost-name: ldap    goauthentik.io&#x2F;outpost-type: ldap    goauthentik.io&#x2F;outpost-uuid: 976f5f77477a40f39e492cefe4a701a2  name: ak-outpost-ldap  namespace: authentikspec:  endpoints:    - path: &#x2F;metrics      port: http-metrics  selector:    matchLabels:      app.kubernetes.io&#x2F;instance: ldap      app.kubernetes.io&#x2F;managed-by: goauthentik.io      app.kubernetes.io&#x2F;name: authentik-ldap      app.kubernetes.io&#x2F;version: 2024.4.0      goauthentik.io&#x2F;outpost-name: ldap      goauthentik.io&#x2F;outpost-type: ldap      goauthentik.io&#x2F;outpost-uuid: 976f5f77477a40f39e492cefe4a701a2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> authentik </tag>
            
            <tag> kubernetes </tag>
            
            <tag> metrics </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>四千周</title>
      <link href="/2024/05/03/book-excerpt/si-qian-zhou/"/>
      <url>/2024/05/03/book-excerpt/si-qian-zhou/</url>
      
        <content type="html"><![CDATA[<p>第一遍：</p><ol><li><p>你越是努力管理时间，希望实现完全的掌控，挣脱生活中不可避免的不如意，你的人生就会有越多的压力、空虚和挫败感。你越是直面有限性，与之合作而非对抗，你的人生就越充满效率、意义和乐趣。我认为焦虑感不会完全消失，我们甚至也无法全然接纳自己的有限性。但我知道，没有任何时间管理技巧比直面事实更有效。</p></li><li><p>时间原本是你用来充分享受人生的工具，现在反倒让你感觉似乎错失了更多的人生。</p></li><li><p>每一个选择都会有无数的牺牲，时间总是即将耗尽。未来哪怕一刻也不能被寄予全部的指望</p></li><li><p>我们为影响未来所做的努力并非问题所在，问题是–所有焦虑的根源–我们在当下的一刻就感觉需要知道这些努力最后会有结果。</p></li><li><p>你的问题是无法回答的，因为你想知道如何生活。每个人都有自己的生活，没有唯一且明确的方法……个人的路是你为自己铺的路，它从来没有什么规定，你事先也不知道，你一步步前行，路就会自然出现在脚下。</p></li><li><p>人这一辈子太短，短到荒唐，短到可怕，短到没有礼貌；但这不是你一直绝望的理由，也不是活在焦虑和恐慌中，殚精竭虑地过完有限时间的理由。应该开始为可能实现的事情努力。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Personal </category>
          
      </categories>
      
      
        <tags>
            
            <tag> excerpts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bind-exporter</title>
      <link href="/2024/04/30/bind-exporter/"/>
      <url>/2024/04/30/bind-exporter/</url>
      
        <content type="html"><![CDATA[<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h2><p>bind9 服务器本机，下载二进制包，并移动到 <code>/usr/local/bin</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> https://api.github.com/repos/prometheus-community/bind_exporter/releases/latest <span class="token operator">|</span> <span class="token function">grep</span> browser_download_url <span class="token operator">|</span> <span class="token function">grep</span> linux-amd64 <span class="token operator">|</span>  <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">'"'</span> <span class="token parameter variable">-f</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token function">wget</span> <span class="token parameter variable">-qi</span> -<span class="token function">tar</span> xvf bind_exporter*.tar.gz<span class="token function">sudo</span> <span class="token function">mv</span> bind_exporter-*/bind_exporter /usr/local/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>bind9 开启指标暴露接口</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> /etc/bind/named.conf.options<span class="token operator">&lt;&lt;</span><span class="token string">EOFstatistics-channels &#123;  inet 127.0.0.1 port 8053 allow &#123; 127.0.0.1; &#125;;&#125;;EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-Systemd-服务单元文件"><a href="#2-Systemd-服务单元文件" class="headerlink" title="2. Systemd 服务单元文件"></a>2. Systemd 服务单元文件</h2><p>需要是运行在 dns local</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tee</span> /etc/systemd/system/bind_exporter.service<span class="token operator">&lt;&lt;</span><span class="token string">EOF[Unit]Description=PrometheusDocumentation=https://github.com/digitalocean/bind_exporterWants=network-online.targetAfter=network-online.target[Service]Type=simpleExecReload=/bin/kill -HUP \<span class="token variable">$MAINPID</span>ExecStart=/usr/local/bin/bind_exporter \  --bind.pid-file=/run/named/named.pid \  --bind.timeout=20s \  --web.listen-address=0.0.0.0:9153 \  --web.telemetry-path=/metrics \  --bind.stats-url=http://127.0.0.1:8053/ \  --bind.stats-groups=server,view,tasksRestart=always[Install]WantedBy=multi-user.targetEOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-service-up"><a href="#3-service-up" class="headerlink" title="3. service up"></a>3. service up</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl daemon-reload<span class="token function">sudo</span> systemctl restart bind_exporter.service<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> bind_exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="4-问题"><a href="#4-问题" class="headerlink" title="4. 问题"></a>4. 问题</h2><p>指标数量少于官方指标，排查发现：url 指定错误的原因</p><h2 id="5-prometheus-yml"><a href="#5-prometheus-yml" class="headerlink" title="5. prometheus.yml"></a>5. prometheus.yml</h2><p>需要对主从分别进行配置</p><pre class="line-numbers language-none"><code class="language-none">- job_name: &#39;DNS&#39;  static_configs:    - targets: [&#39;10.1.0.81:9153&#39;]      labels:        alias: dns-master    - targets: [&#39;10.1.0.82:9153&#39;]      labels:        alias: dns-slave<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> OpenTelemetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> metrics </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafka-exporter</title>
      <link href="/2024/04/30/kafka-exporter/"/>
      <url>/2024/04/30/kafka-exporter/</url>
      
        <content type="html"><![CDATA[<p>并没有找到官方比较权威的指标获取工具，来自社区的应用各有所长，使用以下工具，各取其长</p><h2 id="1-kafka-exporter"><a href="#1-kafka-exporter" class="headerlink" title="1. kafka_exporter"></a>1. kafka_exporter</h2><p>下载并执行，获取指标太少，弃用</p><pre class="line-numbers language-none"><code class="language-none">nohup kafka_exporter --kafka.server&#x3D;10.8.0.88:9092 &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="2-jmx-exporter"><a href="#2-jmx-exporter" class="headerlink" title="2. jmx_exporter"></a>2. <a href="https://github.com/prometheus/jmx_exporter">jmx_exporter</a></h2><h3 id="下载-java-agent-需要在每个节点配置"><a href="#下载-java-agent-需要在每个节点配置" class="headerlink" title="下载 java-agent, 需要在每个节点配置"></a>下载 java-agent, 需要在每个节点配置</h3><pre class="line-numbers language-none"><code class="language-none">wget https:&#x2F;&#x2F;repo1.maven.org&#x2F;maven2&#x2F;io&#x2F;prometheus&#x2F;jmx&#x2F;jmx_prometheus_javaagent&#x2F;0.20.0&#x2F;jmx_prometheus_javaagent-0.20.0.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="运行方式"><a href="#运行方式" class="headerlink" title="运行方式"></a>运行方式</h3><h4 id="Running-the-Standalone-HTTP-Server（未使用）"><a href="#Running-the-Standalone-HTTP-Server（未使用）" class="headerlink" title="Running the Standalone HTTP Server（未使用）"></a>Running the Standalone HTTP Server（未使用）</h4><h4 id="Running-the-Java-Agent（推荐使用）"><a href="#Running-the-Java-Agent（推荐使用）" class="headerlink" title="Running the Java Agent（推荐使用）"></a>Running the Java Agent（推荐使用）</h4><p>在 <code>kafka-server-start.sh</code> 头部增加代码声明，agent将和服务共同启动</p><pre class="line-numbers language-none"><code class="language-none">export KAFKA_JMX_OPTS&#x3D;&quot;-javaagent:&#x2F;usr&#x2F;local&#x2F;kafka&#x2F;bin&#x2F;jmx_prometheus_javaagent-0.20.0.jar&#x3D;9990:&#x2F;usr&#x2F;local&#x2F;kafka&#x2F;config&#x2F;kafka-jmx.yml&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>各节点 kafka 已经由 systemd 管理，此处执行 systemctl restart kafka 即可</p><h4 id="此处是官方的jmx-exporter使用的-javaagents-配置文件模板-kafka-jmx-yml"><a href="#此处是官方的jmx-exporter使用的-javaagents-配置文件模板-kafka-jmx-yml" class="headerlink" title="此处是官方的jmx_exporter使用的 javaagents 配置文件模板 kafka-jmx.yml"></a><a href="https://github.com/prometheus/jmx_exporter/blob/main/example_configs/kafka-kraft-3_0_0.yml">此处是官方的jmx_exporter使用的 javaagents 配置文件模板</a> kafka-jmx.yml</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">lowercaseOutputName</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token comment"># Special cases and very specific rules</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span> <span class="token punctuation">:</span> kafka.server&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> clientId=(.+)<span class="token punctuation">,</span> topic=(.+)<span class="token punctuation">,</span> partition=(.<span class="token important">*)>&lt;>Value</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_$1_$2  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">clientId</span><span class="token punctuation">:</span> <span class="token string">"$3"</span>    <span class="token key atrule">topic</span><span class="token punctuation">:</span> <span class="token string">"$4"</span>    <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token string">"$5"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span> <span class="token punctuation">:</span> kafka.server&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> clientId=(.+)<span class="token punctuation">,</span> brokerHost=(.+)<span class="token punctuation">,</span> brokerPort=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Value  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_$1_$2  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">clientId</span><span class="token punctuation">:</span> <span class="token string">"$3"</span>    <span class="token key atrule">broker</span><span class="token punctuation">:</span> <span class="token string">"$4:$5"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span> <span class="token punctuation">:</span> kafka.coordinator.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Value  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_coordinator_$1_$2_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE<span class="token comment"># Kraft current state info metric rule</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">"kafka.server&lt;type=raft-metrics>&lt;>current-state: ([a-z]+)"</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_raft_metrics_current_state_info  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"state"</span><span class="token punctuation">:</span> <span class="token string">"$1"</span><span class="token comment"># Kraft specific rules for raft-metrics, raft-channel-metrics, broker-metadata-metrics</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.server&lt;type=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>(<span class="token punctuation">[</span>a<span class="token punctuation">-</span>z<span class="token punctuation">-</span><span class="token punctuation">]</span>+)<span class="token punctuation">-</span>total  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_$1_$2_total  <span class="token key atrule">type</span><span class="token punctuation">:</span> COUNTER<span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.server&lt;type=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>(<span class="token punctuation">[</span>a<span class="token punctuation">-</span>z<span class="token punctuation">-</span><span class="token punctuation">]</span>+)  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_$1_$2  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE<span class="token comment"># Generic per-second counters with 0-2 key/value pairs</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)PerSec\w*<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Count  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_total  <span class="token key atrule">type</span><span class="token punctuation">:</span> COUNTER  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span>    <span class="token key atrule">"$6"</span><span class="token punctuation">:</span> <span class="token string">"$7"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)PerSec\w*<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Count  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_total  <span class="token key atrule">type</span><span class="token punctuation">:</span> COUNTER  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)PerSec\w<span class="token important">*>&lt;>Count</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_total  <span class="token key atrule">type</span><span class="token punctuation">:</span> COUNTER<span class="token comment"># Quota specific rules</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.server&lt;type=(.+)<span class="token punctuation">,</span> user=(.+)<span class="token punctuation">,</span> client<span class="token punctuation">-</span>id=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>(<span class="token punctuation">[</span>a<span class="token punctuation">-</span>z<span class="token punctuation">-</span><span class="token punctuation">]</span>+)  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_quota_$4  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">resource</span><span class="token punctuation">:</span> <span class="token string">"$1"</span>    <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"$2"</span>    <span class="token key atrule">clientId</span><span class="token punctuation">:</span> <span class="token string">"$3"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.server&lt;type=(.+)<span class="token punctuation">,</span> client<span class="token punctuation">-</span>id=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>(<span class="token punctuation">[</span>a<span class="token punctuation">-</span>z<span class="token punctuation">-</span><span class="token punctuation">]</span>+)  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_quota_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">resource</span><span class="token punctuation">:</span> <span class="token string">"$1"</span>    <span class="token key atrule">clientId</span><span class="token punctuation">:</span> <span class="token string">"$2"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.server&lt;type=(.+)<span class="token punctuation">,</span> user=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>(<span class="token punctuation">[</span>a<span class="token punctuation">-</span>z<span class="token punctuation">-</span><span class="token punctuation">]</span>+)  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_server_quota_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">resource</span><span class="token punctuation">:</span> <span class="token string">"$1"</span>    <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"$2"</span><span class="token comment"># Generic gauges with 0-2 key/value pairs</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Value  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span>    <span class="token key atrule">"$6"</span><span class="token punctuation">:</span> <span class="token string">"$7"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Value  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Value  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE<span class="token comment"># Emulate Prometheus 'Summary' metrics for the exported 'Histogram's.</span><span class="token comment">#</span><span class="token comment"># Note that these are missing the '_sum' metric!</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Count  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_count  <span class="token key atrule">type</span><span class="token punctuation">:</span> COUNTER  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span>    <span class="token key atrule">"$6"</span><span class="token punctuation">:</span> <span class="token string">"$7"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> (.+)=(.<span class="token important">*)</span><span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>(\d+)thPercentile  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span>    <span class="token key atrule">"$6"</span><span class="token punctuation">:</span> <span class="token string">"$7"</span>    <span class="token key atrule">quantile</span><span class="token punctuation">:</span> <span class="token string">"0.$8"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Count  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_count  <span class="token key atrule">type</span><span class="token punctuation">:</span> COUNTER  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">,</span> (.+)=(.<span class="token important">*)>&lt;>(\d+)thPercentile</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span>    <span class="token key atrule">quantile</span><span class="token punctuation">:</span> <span class="token string">"0.$6"</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Count  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_count  <span class="token key atrule">type</span><span class="token punctuation">:</span> COUNTER<span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>(\d+)thPercentile  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">quantile</span><span class="token punctuation">:</span> <span class="token string">"0.$4"</span><span class="token comment"># Generic gauges for MeanRate Percent</span><span class="token comment"># Ex) kafka.server&lt;type=KafkaRequestHandlerPool, name=RequestHandlerAvgIdlePercent>&lt;>MeanRate</span><span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)Percent\w<span class="token important">*>&lt;>MeanRate</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_percent  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE<span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)Percent\w<span class="token important">*>&lt;>Value</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_percent  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE<span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> kafka.(\w+)&lt;type=(.+)<span class="token punctuation">,</span> name=(.+)Percent\w*<span class="token punctuation">,</span> (.+)=(.+)<span class="token punctuation">></span>&lt;<span class="token punctuation">></span>Value  <span class="token key atrule">name</span><span class="token punctuation">:</span> kafka_$1_$2_$3_percent  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">"$4"</span><span class="token punctuation">:</span> <span class="token string">"$5"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="prometheus-yml"><a href="#prometheus-yml" class="headerlink" title="prometheus.yml"></a>prometheus.yml</h4><pre class="line-numbers language-none"><code class="language-none">- job_name: &quot;kafka_jmx&quot;    metrics_path: &#x2F;metrics    static_configs:      - targets: [&#39;192.168.249.1:9990&#39;,&#39;192.168.249.2:9990&#39;,&#39;192.168.249.3:9990&#39;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-Kiminon-使用"><a href="#3-Kiminon-使用" class="headerlink" title="3. Kiminon 使用"></a>3. Kiminon 使用</h2><h4 id="可以二进制、docker、-helm-部署-kiminon-可以监控多源-运行后访问-IP-port-metrics"><a href="#可以二进制、docker、-helm-部署-kiminon-可以监控多源-运行后访问-IP-port-metrics" class="headerlink" title="可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port&#x2F;metrics"></a>可以二进制、docker、 helm 部署 kiminon; 可以监控多源; 运行后访问 IP:port&#x2F;metrics</h4><p>Cluster Dashboard: <a href="https://grafana.com/grafana/dashboards/14012">https://grafana.com/grafana/dashboards/14012</a><br>Consumer Group Dashboard: <a href="https://grafana.com/grafana/dashboards/14014">https://grafana.com/grafana/dashboards/14014</a><br>Topic Dashboard: <a href="https://grafana.com/grafana/dashboards/14013">https://grafana.com/grafana/dashboards/14013</a></p><h3 id="3-1-二进制使用"><a href="#3-1-二进制使用" class="headerlink" title="3.1 二进制使用"></a>3.1 二进制使用</h3><h4 id="命令行试运行"><a href="#命令行试运行" class="headerlink" title="命令行试运行"></a>命令行试运行</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/redpanda-data/kminion/releases/download/v2.2.6/kminion_2.2.6_linux_amd64.tar.gz<span class="token function">tar</span> xvf kminion_2.2.6_linux_amd64.tar.gz kminion<span class="token function">sudo</span> <span class="token function">mv</span> kminion /usr/local/bin<span class="token comment"># 编写配置文件，并以环境变量的方式什么其路径</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CONFIG_FILEPATH</span><span class="token operator">=~</span>/.kminion.ymlkminon <span class="token comment"># 命令行运行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="systemd-托管"><a href="#systemd-托管" class="headerlink" title="systemd 托管"></a>systemd 托管</h4><p>&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kminion.service</p><pre class="line-numbers language-none"><code class="language-none">[Unit]Description&#x3D;kminionAfter&#x3D;network.target[Service]Type&#x3D;simpleExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;kminionRestart&#x3D;on-failureEnvironment&#x3D;&quot;CONFIG_FILEPATH&#x3D;&#x2F;home&#x2F;keyword&#x2F;.kminion.yml&quot;[Install]WantedBy&#x3D;multi-user.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="配置文件-home-keyword-kminion-yml"><a href="#配置文件-home-keyword-kminion-yml" class="headerlink" title="配置文件 /home/keyword/.kminion.yml"></a>配置文件 <code>/home/keyword/.kminion.yml</code></h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">logger</span><span class="token punctuation">:</span>  <span class="token comment"># Valid values are: debug, info, warn, error, fatal, panic</span>  <span class="token key atrule">level</span><span class="token punctuation">:</span> info<span class="token key atrule">kafka</span><span class="token punctuation">:</span>  <span class="token key atrule">brokers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.8.0.88:9092"</span><span class="token punctuation">,</span><span class="token string">"10.8.0.89:9092"</span><span class="token punctuation">,</span><span class="token string">"10.8.0.90:9092"</span><span class="token punctuation">]</span>  <span class="token key atrule">clientId</span><span class="token punctuation">:</span> <span class="token string">"kminion"</span>  <span class="token key atrule">rackId</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token key atrule">tls</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">caFilepath</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">certFilepath</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">keyFilepath</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># base64 encoded tls CA, cannot be set if 'caFilepath' is set</span>    <span class="token key atrule">ca</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># base64 encoded tls cert, cannot be set if 'certFilepath' is set</span>    <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># base64 encoded tls key, cannot be set if 'keyFilepath' is set</span>    <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">passphrase</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">insecureSkipTlsVerify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">minion</span><span class="token punctuation">:</span>  <span class="token key atrule">consumerGroups</span><span class="token punctuation">:</span>    <span class="token comment"># Enabled specifies whether consumer groups shall be scraped and exported or not.</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal</span>    <span class="token comment"># __consumer_offsets topic. Both modes have their advantages and disadvantages.</span>    <span class="token comment"># * adminApi:</span>    <span class="token comment">#     - Useful for managed kafka clusters that do not provide access to the offsets topic.</span>    <span class="token comment"># * offsetsTopic</span>    <span class="token comment">#     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.</span>    <span class="token comment">#     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the</span>    <span class="token comment">#       size and throughput of the offsets topic.</span>    <span class="token key atrule">scrapeMode</span><span class="token punctuation">:</span> adminApi <span class="token comment"># Valid values: adminApi, offsetsTopic</span>    <span class="token comment"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>    <span class="token comment"># you aren't interested in per partition lags you could choose "topic" where all partition lags will be summed</span>    <span class="token comment"># and only topic lags will be exported.</span>    <span class="token key atrule">granularity</span><span class="token punctuation">:</span> partition    <span class="token comment"># AllowedGroups are regex strings of group ids that shall be exported</span>    <span class="token comment"># You can specify allowed groups by providing literals like "my-consumergroup-name" or by providing regex expressions</span>    <span class="token comment"># like "/internal-.*/".</span>    <span class="token key atrule">allowedGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">".*"</span> <span class="token punctuation">]</span>    <span class="token comment"># IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups</span>    <span class="token comment"># take precedence over allowed groups.</span>    <span class="token key atrule">ignoredGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>  <span class="token key atrule">topics</span><span class="token punctuation">:</span>    <span class="token comment"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>    <span class="token comment"># you aren't interested in per partition metrics you could choose "topic".</span>    <span class="token key atrule">granularity</span><span class="token punctuation">:</span> partition    <span class="token comment"># AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.</span>    <span class="token comment"># You can specify allowed topics by providing literals like "my-topic-name" or by providing regex expressions</span>    <span class="token comment"># like "/internal-.*/".</span>    <span class="token key atrule">allowedTopics</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">".*"</span> <span class="token punctuation">]</span>    <span class="token comment"># IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics</span>    <span class="token comment"># take precedence over allowed topics.</span>    <span class="token key atrule">ignoredTopics</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>    <span class="token comment"># infoMetric is a configuration object for the kminion_kafka_topic_info metric</span>    <span class="token key atrule">infoMetric</span><span class="token punctuation">:</span>      <span class="token comment"># ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric</span>      <span class="token key atrule">configKeys</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"cleanup.policy"</span> <span class="token punctuation">]</span>  <span class="token key atrule">logDirs</span><span class="token punctuation">:</span>    <span class="token comment"># Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior</span>    <span class="token comment"># to version 1.0.0 as describing log dirs was not supported back then.</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># EndToEnd Metrics</span>  <span class="token comment"># When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info</span>  <span class="token key atrule">endToEnd</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token comment">#enabled: false</span>    <span class="token comment"># How often to send end-to-end test messages</span>    <span class="token key atrule">probeInterval</span><span class="token punctuation">:</span> 100ms    <span class="token key atrule">topicManagement</span><span class="token punctuation">:</span>      <span class="token comment"># You can disable topic management, without disabling the testing feature.</span>      <span class="token comment"># Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token comment"># Name of the topic kminion uses to send its test messages</span>      <span class="token comment"># You do *not* need to change this if you are running multiple kminion instances on the same cluster.</span>      <span class="token comment"># Different instances are perfectly fine with sharing the same topic!</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> kminion<span class="token punctuation">-</span>end<span class="token punctuation">-</span>to<span class="token punctuation">-</span>end      <span class="token comment"># How often kminion checks its topic to validate configuration, partition count, and partition assignments</span>      <span class="token key atrule">reconciliationInterval</span><span class="token punctuation">:</span> 10m      <span class="token comment"># Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)</span>      <span class="token comment"># you may choose replication factor 1 or 3 most commonly.</span>      <span class="token key atrule">replicationFactor</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token comment"># Rarely makes sense to change this, but maybe if you want some sort of cheap load test?</span>      <span class="token comment"># By default (1) every broker gets one partition</span>      <span class="token key atrule">partitionsPerBroker</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">producer</span><span class="token punctuation">:</span>      <span class="token comment"># This defines:</span>      <span class="token comment"># - Maximum time to wait for an ack response after producing a message</span>      <span class="token comment"># - Upper bound for histogram buckets in "produce_latency_seconds"</span>      <span class="token key atrule">ackSla</span><span class="token punctuation">:</span> 5s      <span class="token comment"># Can be to "all" (default) so kafka only reports an end-to-end test message as acknowledged if</span>      <span class="token comment"># the message was written to all in-sync replicas of the partition.</span>      <span class="token comment"># Or can be set to "leader" to only require to have written the message to its log.</span>      <span class="token key atrule">requiredAcks</span><span class="token punctuation">:</span> all    <span class="token key atrule">consumer</span><span class="token punctuation">:</span>      <span class="token comment"># Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically</span>      <span class="token key atrule">groupIdPrefix</span><span class="token punctuation">:</span> kminion<span class="token punctuation">-</span>end<span class="token punctuation">-</span>to<span class="token punctuation">-</span>end      <span class="token comment"># Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want</span>      <span class="token comment"># KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.</span>      <span class="token key atrule">deleteStaleConsumerGroups</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token comment"># This defines:</span>      <span class="token comment"># - Upper bound for histogram buckets in "roundtrip_latency"</span>      <span class="token comment"># - Time limit beyond which a message is considered "lost" (failed the roundtrip)</span>      <span class="token key atrule">roundtripSla</span><span class="token punctuation">:</span> 20s      <span class="token comment"># - Upper bound for histogram buckets in "commit_latency_seconds"</span>      <span class="token comment"># - Maximum time an offset commit is allowed to take before considering it failed</span>      <span class="token key atrule">commitSla</span><span class="token punctuation">:</span> 10s<span class="token key atrule">exporter</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"10.8.0.88"</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9095</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="prometheus-yml-1"><a href="#prometheus-yml-1" class="headerlink" title="prometheus.yml"></a>prometheus.yml</h4><pre class="line-numbers language-none"><code class="language-none">- job_name: &quot;kafka_kminion&quot;    metrics_path: &#x2F;metrics    static_configs:      - targets: [&#39;10.8.0.88:9095&#39;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2-使用-docker-compose"><a href="#3-2-使用-docker-compose" class="headerlink" title="3.2 使用 docker-compose"></a>3.2 使用 docker-compose</h3><h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h4><pre class="line-numbers language-yaml" data-language="yaml"><div class="caption"><span>TI:"docker-compose.yml"</span></div><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">kminion</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> vectorized/kminion<span class="token punctuation">:</span>latest    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kafka<span class="token punctuation">-</span>minion    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 9095<span class="token punctuation">:</span><span class="token number">8080</span>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">CONFIG_FILEPATH</span><span class="token punctuation">:</span> /etc/kminion.yml    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./kminion.yml<span class="token punctuation">:</span>/etc/kminion.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="kminion-yml-配置文件使用内容如下"><a href="#kminion-yml-配置文件使用内容如下" class="headerlink" title="kminion.yml 配置文件使用内容如下"></a><code>kminion.yml</code> 配置文件使用内容如下</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">logger</span><span class="token punctuation">:</span>  <span class="token comment"># Valid values are: debug, info, warn, error, fatal, panic</span>  <span class="token key atrule">level</span><span class="token punctuation">:</span> info<span class="token key atrule">kafka</span><span class="token punctuation">:</span>  <span class="token key atrule">brokers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.8.0.88:9092"</span><span class="token punctuation">,</span><span class="token string">"10.8.0.89:9092"</span><span class="token punctuation">,</span><span class="token string">"10.8.0.90:9092"</span><span class="token punctuation">]</span>  <span class="token key atrule">clientId</span><span class="token punctuation">:</span> <span class="token string">"kminion"</span>  <span class="token key atrule">rackId</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token key atrule">tls</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">caFilepath</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">certFilepath</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">keyFilepath</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># base64 encoded tls CA, cannot be set if 'caFilepath' is set</span>    <span class="token key atrule">ca</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># base64 encoded tls cert, cannot be set if 'certFilepath' is set</span>    <span class="token key atrule">cert</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># base64 encoded tls key, cannot be set if 'keyFilepath' is set</span>    <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">passphrase</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">insecureSkipTlsVerify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">sasl</span><span class="token punctuation">:</span>    <span class="token comment"># Whether or not SASL authentication will be used for authentication</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token comment"># Username to use for PLAIN or SCRAM mechanism</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># Password to use for PLAIN or SCRAM mechanism</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token comment"># Mechanism to use for SASL Authentication. Valid values are PLAIN, SCRAM-SHA-256, SCRAM-SHA-512, GSSAPI, OAUTHBEARER</span>    <span class="token key atrule">mechanism</span><span class="token punctuation">:</span> <span class="token string">"PLAIN"</span>    <span class="token comment"># GSSAPI / Kerberos config properties</span>    <span class="token key atrule">gssapi</span><span class="token punctuation">:</span>      <span class="token key atrule">authType</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">keyTabPath</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">kerberosConfigPath</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">realm</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">enableFast</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># OAUTHBEARER config properties</span>    <span class="token key atrule">oauth</span><span class="token punctuation">:</span>      <span class="token key atrule">tokenEndpoint</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">clientId</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">clientSecret</span><span class="token punctuation">:</span> <span class="token string">""</span>      <span class="token key atrule">scope</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token key atrule">minion</span><span class="token punctuation">:</span>  <span class="token key atrule">consumerGroups</span><span class="token punctuation">:</span>    <span class="token comment"># Enabled specifies whether consumer groups shall be scraped and exported or not.</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># Mode specifies whether we export consumer group offsets using the Admin API or by consuming the internal</span>    <span class="token comment"># __consumer_offsets topic. Both modes have their advantages and disadvantages.</span>    <span class="token comment"># * adminApi:</span>    <span class="token comment">#     - Useful for managed kafka clusters that do not provide access to the offsets topic.</span>    <span class="token comment"># * offsetsTopic</span>    <span class="token comment">#     - Enables kminion_kafka_consumer_group_offset_commits_total metrics.</span>    <span class="token comment">#     - Processing the offsetsTopic requires slightly more memory and cpu than using the adminApi. The amount depends on the</span>    <span class="token comment">#       size and throughput of the offsets topic.</span>    <span class="token key atrule">scrapeMode</span><span class="token punctuation">:</span> adminApi <span class="token comment"># Valid values: adminApi, offsetsTopic</span>    <span class="token comment"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>    <span class="token comment"># you aren't interested in per partition lags you could choose "topic" where all partition lags will be summed</span>    <span class="token comment"># and only topic lags will be exported.</span>    <span class="token key atrule">granularity</span><span class="token punctuation">:</span> partition    <span class="token comment"># AllowedGroups are regex strings of group ids that shall be exported</span>    <span class="token comment"># You can specify allowed groups by providing literals like "my-consumergroup-name" or by providing regex expressions</span>    <span class="token comment"># like "/internal-.*/".</span>    <span class="token key atrule">allowedGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">".*"</span> <span class="token punctuation">]</span>    <span class="token comment"># IgnoredGroups are regex strings of group ids that shall be ignored/skipped when exporting metrics. Ignored groups</span>    <span class="token comment"># take precedence over allowed groups.</span>    <span class="token key atrule">ignoredGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>  <span class="token key atrule">topics</span><span class="token punctuation">:</span>    <span class="token comment"># Granularity can be per topic or per partition. If you want to reduce the number of exported metric series and</span>    <span class="token comment"># you aren't interested in per partition metrics you could choose "topic".</span>    <span class="token key atrule">granularity</span><span class="token punctuation">:</span> partition    <span class="token comment"># AllowedTopics are regex strings of topic names whose topic metrics that shall be exported.</span>    <span class="token comment"># You can specify allowed topics by providing literals like "my-topic-name" or by providing regex expressions</span>    <span class="token comment"># like "/internal-.*/".</span>    <span class="token key atrule">allowedTopics</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">".*"</span> <span class="token punctuation">]</span>    <span class="token comment"># IgnoredTopics are regex strings of topic names that shall be ignored/skipped when exporting metrics. Ignored topics</span>    <span class="token comment"># take precedence over allowed topics.</span>    <span class="token key atrule">ignoredTopics</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>    <span class="token comment"># infoMetric is a configuration object for the kminion_kafka_topic_info metric</span>    <span class="token key atrule">infoMetric</span><span class="token punctuation">:</span>      <span class="token comment"># ConfigKeys are set of strings of Topic configs that you want to have exported as part of the metric</span>      <span class="token key atrule">configKeys</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"cleanup.policy"</span> <span class="token punctuation">]</span>  <span class="token key atrule">logDirs</span><span class="token punctuation">:</span>    <span class="token comment"># Enabled specifies whether log dirs shall be scraped and exported or not. This should be disabled for clusters prior</span>    <span class="token comment"># to version 1.0.0 as describing log dirs was not supported back then.</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># EndToEnd Metrics</span>  <span class="token comment"># When enabled, kminion creates a topic which it produces to and consumes from, to measure various advanced metrics. See docs for more info</span>  <span class="token key atrule">endToEnd</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token comment">#enabled: false</span>    <span class="token comment"># How often to send end-to-end test messages</span>    <span class="token key atrule">probeInterval</span><span class="token punctuation">:</span> 100ms    <span class="token key atrule">topicManagement</span><span class="token punctuation">:</span>      <span class="token comment"># You can disable topic management, without disabling the testing feature.</span>      <span class="token comment"># Only makes sense if you have multiple kminion instances, and for some reason only want one of them to create/configure the topic</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token comment"># Name of the topic kminion uses to send its test messages</span>      <span class="token comment"># You do *not* need to change this if you are running multiple kminion instances on the same cluster.</span>      <span class="token comment"># Different instances are perfectly fine with sharing the same topic!</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> kminion<span class="token punctuation">-</span>end<span class="token punctuation">-</span>to<span class="token punctuation">-</span>end      <span class="token comment"># How often kminion checks its topic to validate configuration, partition count, and partition assignments</span>      <span class="token key atrule">reconciliationInterval</span><span class="token punctuation">:</span> 10m      <span class="token comment"># Depending on the desired monitoring (e.g. you want to alert on broker failure vs. cluster that is not writable)</span>      <span class="token comment"># you may choose replication factor 1 or 3 most commonly.</span>      <span class="token key atrule">replicationFactor</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token comment"># Rarely makes sense to change this, but maybe if you want some sort of cheap load test?</span>      <span class="token comment"># By default (1) every broker gets one partition</span>      <span class="token key atrule">partitionsPerBroker</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">producer</span><span class="token punctuation">:</span>      <span class="token comment"># This defines:</span>      <span class="token comment"># - Maximum time to wait for an ack response after producing a message</span>      <span class="token comment"># - Upper bound for histogram buckets in "produce_latency_seconds"</span>      <span class="token key atrule">ackSla</span><span class="token punctuation">:</span> 5s      <span class="token comment"># Can be to "all" (default) so kafka only reports an end-to-end test message as acknowledged if</span>      <span class="token comment"># the message was written to all in-sync replicas of the partition.</span>      <span class="token comment"># Or can be set to "leader" to only require to have written the message to its log.</span>      <span class="token key atrule">requiredAcks</span><span class="token punctuation">:</span> all    <span class="token key atrule">consumer</span><span class="token punctuation">:</span>      <span class="token comment"># Prefix kminion uses when creating its consumer groups. Current kminion instance id will be appended automatically</span>      <span class="token key atrule">groupIdPrefix</span><span class="token punctuation">:</span> kminion<span class="token punctuation">-</span>end<span class="token punctuation">-</span>to<span class="token punctuation">-</span>end      <span class="token comment"># Whether KMinion should try to delete empty consumer groups with the same prefix. This can be used if you want</span>      <span class="token comment"># KMinion to cleanup it's old consumer groups. It should only be used if you use a unique prefix for KMinion.</span>      <span class="token key atrule">deleteStaleConsumerGroups</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token comment"># This defines:</span>      <span class="token comment"># - Upper bound for histogram buckets in "roundtrip_latency"</span>      <span class="token comment"># - Time limit beyond which a message is considered "lost" (failed the roundtrip)</span>      <span class="token key atrule">roundtripSla</span><span class="token punctuation">:</span> 20s      <span class="token comment"># - Upper bound for histogram buckets in "commit_latency_seconds"</span>      <span class="token comment"># - Maximum time an offset commit is allowed to take before considering it failed</span>      <span class="token key atrule">commitSla</span><span class="token punctuation">:</span> 10s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> OpenTelemetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> metrics </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqld-exporter</title>
      <link href="/2024/04/30/mysqld-exporter/"/>
      <url>/2024/04/30/mysqld-exporter/</url>
      
        <content type="html"><![CDATA[<h2 id="1-前置条件"><a href="#1-前置条件" class="headerlink" title="1.前置条件"></a>1.前置条件</h2><p> mysql 中准备暴露指标的用户和主机地址( exporter  ip)，并在相应表中必要授权</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">CREATE <span class="token environment constant">USER</span> <span class="token string">'mysqld_exporter'</span>@<span class="token string">'10.1.0.81'</span> IDENTIFIED BY <span class="token string">'keyword@2020'</span><span class="token punctuation">;</span>GRANT REPLICATION CLIENT, PROCESS ON *.* TO <span class="token string">'mysqld_exporter'</span>@<span class="token string">'10.1.0.81'</span><span class="token punctuation">;</span>GRANT SELECT ON performance_schema.* TO <span class="token string">'mysqld_exporter'</span>@<span class="token string">'10.1.0.81'</span><span class="token punctuation">;</span>FLUSH PRIVILEGES<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-配置-mysqld-exporter-用户"><a href="#2-配置-mysqld-exporter-用户" class="headerlink" title="2. 配置 mysqld_exporter 用户"></a>2. 配置 mysqld_exporter 用户</h2><pre class="line-numbers language-none"><code class="language-none">tee &gt; .db.cnf &lt;&lt; EOF[client]user&#x3D;mysqld_exporterpassword&#x3D;keyword@2020EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-下载"><a href="#3-下载" class="headerlink" title="3. 下载"></a>3. 下载</h2><pre class="line-numbers language-none"><code class="language-none">wget https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;mysqld_exporter&#x2F;releases&#x2F;download&#x2F;v0.15.1&#x2F;mysqld_exporter-0.15.1.linux-amd64.tar.gztar xvf mysqld_exporter-0.15.1.linux-amd64.tar.gzsudo mv mysqld_exporter-0.15.1.linux-amd64&#x2F;mysqld_exporter &#x2F;usr&#x2F;local&#x2F;bin&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="4-使用-systemd-管理"><a href="#4-使用-systemd-管理" class="headerlink" title="4. 使用 systemd 管理"></a>4. 使用 systemd 管理</h2><pre class="line-numbers language-none"><code class="language-none">sudo tee &gt; &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;mysqld_exporter.service &lt;&lt; EOF[Unit]Description&#x3D;mysql_exporterAfter&#x3D;network.target[Service]Type&#x3D;simpleExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mysqld_exporter --config.my-cnf&#x3D;&quot;&#x2F;home&#x2F;keyword&#x2F;mysql&#x2F;.db.cnf&quot;Restart&#x3D;on-failure[Install]WantedBy&#x3D;multi-user.targetEOFsudo systemctl daemon-reloadsudo systemctl enable --now mysqld_exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-此时可以去访问默认的-9104-metrics"><a href="#5-此时可以去访问默认的-9104-metrics" class="headerlink" title="5. 此时可以去访问默认的 9104&#x2F;metrics"></a>5. 此时可以去访问默认的 9104&#x2F;metrics</h2><pre class="line-numbers language-none"><code class="language-none">- job_name: &#39;mysqld_exporter&#39;    metrics_path: &#x2F;metrics    static_configs:    - targets:    - 10.1.0.81:9104<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="6-多源监测"><a href="#6-多源监测" class="headerlink" title="6. 多源监测"></a>6. 多源监测</h2><ul><li>不用在每个 mysql 去安装 exporter</li><li>在 .db.cnf 新增另一个数据库的监控专用用户信息; 保证服务端进行上述用户权限配置即可<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">client</span><span class="token punctuation">]</span></span><span class="token key attr-name">host</span> <span class="token punctuation">=</span> <span class="token value attr-value">10.1.0.81</span><span class="token key attr-name">port</span> <span class="token punctuation">=</span> <span class="token value attr-value">3306</span><span class="token key attr-name">user</span> <span class="token punctuation">=</span> <span class="token value attr-value">mysqld_exporter</span><span class="token key attr-name">password</span> <span class="token punctuation">=</span> <span class="token value attr-value">keyword@2020</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">client-db2</span><span class="token punctuation">]</span></span><span class="token key attr-name">host</span> <span class="token punctuation">=</span> <span class="token value attr-value">10.8.0.90</span><span class="token key attr-name">port</span> <span class="token punctuation">=</span> <span class="token value attr-value">3306</span><span class="token key attr-name">user</span> <span class="token punctuation">=</span> <span class="token value attr-value">mysqld_exporter</span><span class="token key attr-name">password</span> <span class="token punctuation">=</span> <span class="token value attr-value">keyword@2020</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><blockquote><p>[!bug] 问题 1<br>Get “ <a href="http://10.8.0.90:3306/probe?auth_module=client-db2&target=10.8.0.90:3306">http://10.8.0.90:3306/probe?auth_module=client-db2&amp;target=10.8.0.90%3A3306</a>“: dial tcp 10.8.0.90:3306: connect: connection refused</p></blockquote><blockquote><p>[!Solution] 解决</p><ol><li>mysql bind-address 未修改，仍然限定的是其本身回环地址，’&#x2F;etc&#x2F;mysql&#x2F;mysql.conf.d&#x2F;mysqld.cnf’</li><li>mysql 中，创建用户并管理 client 服务器地址需要正确限定， user@client ip &#x2F; 网段</li></ol></blockquote><blockquote><p>[!bug] 问题 2<br>Get “ <a href="http://10.1.0.81:3306/probe?auth_module=client&target=10.1.0.81:3306">http://10.1.0.81:3306/probe?auth_module=client&amp;target=10.1.0.81%3A3306</a>“: net&#x2F;http: HTTP&#x2F;1.x transport connection broken: malformed HTTP status code “‘172.22.0.2’”<br>修改 prometheus.yml 之后正常</p></blockquote><p>调整后的最终版本 prometheus.yml</p><pre class="line-numbers language-Yaml" data-language="Yaml"><div class="caption"><span>TI："successful version"</span></div><code class="language-Yaml">- job_name: &#39;multiple_mysql&#39;  static_configs: #也可以将此替换为其他的服务发现配置    - targets:        - 10.1.0.81:3306  # mysql 1      labels:        modes: Master  # 自己定义的标签        auth_module: client  # 必须指定，值来源于用户信息的cnf文件中，如果多个数据库使用的用户相同，可以使用同一个auth配置    - targets:        - 10.8.0.90:3306  # mysql 2      labels:        modes: slave        auth_module: client-db2  relabel_configs:    # 核心是获取 &#96;__parm_target&#96; 就是 上面params抓取的target    - source_labels: [__address__]      target_label: __param_target    - source_labels: [__param_target]      target_label: instance    # 配置后只有此 endpoint，是 exporter 的地址， target 将成为标签    - target_label: __address__      replacement: 10.1.0.81:9104    # 下面将把 auth_module 这个标签的值替换为__param_auth_module的值，__param_auth_module即上方static_configs下的params配置    - source_labels: [auth_module]      target_label: __param_auth_module    # 下面将删除 auth_module 这个标签    - action: labeldrop      regex: auth_module<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="7-reference"><a href="#7-reference" class="headerlink" title="7. reference"></a>7. reference</h2><p>   <a href="https://www.modb.pro/db/565900">技术分享 | mysqld_exporter 收集多个 MySQL 监控避坑 - 墨天轮</a></p>]]></content>
      
      
      <categories>
          
          <category> OpenTelemetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> metrics </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis-exporter</title>
      <link href="/2024/04/30/redis-exporter/"/>
      <url>/2024/04/30/redis-exporter/</url>
      
        <content type="html"><![CDATA[<h2 id="1-下载并解压二进制文件"><a href="#1-下载并解压二进制文件" class="headerlink" title="1. 下载并解压二进制文件"></a>1. 下载并解压二进制文件</h2><h4 id="在一个节点启用本工具即可"><a href="#在一个节点启用本工具即可" class="headerlink" title="在一个节点启用本工具即可"></a>在一个节点启用本工具即可</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/oliver006/redis_exporter/releases/download/v1.58.0/redis_exporter-v1.58.0.linux-amd64.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-xvf</span> redis_exporter-v1.58.0.linux-amd64.tar.gz <span class="token function">sudo</span> <span class="token function">mv</span> redis_exporter-v1.58.0.linux-amd64/redis_exporter  /usr/local/bin/<span class="token function">sudo</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> /etc/systemd/system/redis_exporter.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF[Unit]Description=Redis ExporterAfter=network.target[Service]type=forkingExecStart=redis_exporter -redis.addr 10.8.0.88:6379 -redis.password keyword@2020 -web.listen-address 10.8.0.88:9121  # -redis.password 应该是配置中的 requirepass 的值Restart=always[Install]WantedBy=multi-user.targetEOF</span><span class="token function">sudo</span> systemctl daemon-reload<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> redis_exporter.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-查看指标"><a href="#2-查看指标" class="headerlink" title="2. 查看指标"></a>2. 查看指标</h2><p><code>curl 10.8.0.88:9121/metrics</code></p><h2 id="3-Prometheus"><a href="#3-Prometheus" class="headerlink" title="3. Prometheus"></a>3. Prometheus</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'redis_exporter_targets'</span>  <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> redis<span class="token punctuation">:</span>//10.8.0.88<span class="token punctuation">:</span><span class="token number">6379</span>      <span class="token punctuation">-</span> redis<span class="token punctuation">:</span>//10.8.0.88<span class="token punctuation">:</span><span class="token number">6380</span>      <span class="token punctuation">-</span> redis<span class="token punctuation">:</span>//10.8.0.89<span class="token punctuation">:</span><span class="token number">6379</span>      <span class="token punctuation">-</span> redis<span class="token punctuation">:</span>//10.8.0.89<span class="token punctuation">:</span><span class="token number">6380</span>      <span class="token punctuation">-</span> redis<span class="token punctuation">:</span>//10.8.0.90<span class="token punctuation">:</span><span class="token number">6379</span>      <span class="token punctuation">-</span> redis<span class="token punctuation">:</span>//10.8.0.90<span class="token punctuation">:</span><span class="token number">6380</span>  <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> /scrape  <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">]</span>      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __param_target    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__param_target<span class="token punctuation">]</span>      <span class="token key atrule">target_label</span><span class="token punctuation">:</span> instance    <span class="token punctuation">-</span> <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> 10.8.0.88<span class="token punctuation">:</span><span class="token number">9121</span> <span class="token comment">#需要保留，此处为 exporter 地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> OpenTelemetry </category>
          
      </categories>
      
      
        <tags>
            
            <tag> metrics </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>domain-management</title>
      <link href="/2024/04/30/domain-management/"/>
      <url>/2024/04/30/domain-management/</url>
      
        <content type="html"><![CDATA[<h1 id="如何平滑迁移至阿里云解析-DNS-云解析-DNS-DNS-阿里云帮助中心"><a href="#如何平滑迁移至阿里云解析-DNS-云解析-DNS-DNS-阿里云帮助中心" class="headerlink" title="如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心"></a>如何平滑迁移至阿里云解析 DNS_云解析 DNS(DNS)-阿里云帮助中心</h1><p>我的 dns 提供商比较小，如此修改后才能使用 aliyundns 的 webhook api，配合 cert-manger 创建证书</p><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>若您的域名解析当前托管在其他 DNS 厂商，想要迁移至阿里云解析 DNS 进行管理。本文将向您介绍如何平滑地将域名解析迁移至阿里云解析 DNS，避免您的业务因解析中断而受影响。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul><li><p>域名如有配置 DNSSEC，请先到域名注册商处删除 DS 记录，并关闭 DNSSEC。等迁移完成后，再参考 <a href="https://help.aliyun.com/zh/dns/configure-dns-security-extensions#h2-dnssec-3">DNSSEC开启设置方法</a>进行配置。如域名未配置 DNSSEC，则忽略此步骤。</p><p><strong>警告</strong></p><p>域名迁移之前请务必保证域名 DS 记录已删除、DNSSEC 功能关闭，否则会影响解析！如果您不清楚是否开启了 DNSSEC，可以咨询您的域名注册商询问 DNSSEC 的开启情况。</p></li><li><p>解析数据准备：请在原 DNS 服务商处导出解析记录，并按照 <a href="https://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/97785/cn_zh/1560846859029/alidns_record.xlsx">DNS解析模板</a> 进行编辑整理好解析记录。</p><p><strong>说明</strong></p><p>若您当前 DNS 厂商不支持批量导出解析记录的功能，您可以直接将解析记录手动添加在 DNS 解析模板中，然后在云解析 DNS 产品控制台批量导入解析记录。或者您也可以直接在云解析 DNS 产品控制台手动添加解析记录。</p></li></ul><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><ol><li><p>在 <a href="https://dns.console.aliyun.com/">云解析DNS控制台</a>，在 <strong>域名解析</strong> 页面选择 <strong>权威域名</strong> 页签，再单击 <strong>添加域名</strong> <strong>。</strong>如果您的域名是阿里云注册域名或者已经添加了域名，可忽略此步骤。</p></li><li><p>单击目标域名进入 <strong>解析设置</strong> 页面，单击 <strong>导入&#x2F;导出</strong> 按钮，在 <strong>导入记录</strong> 页面选择 <strong>导入记录方式</strong> ：<strong>增量更新</strong>或 <strong>全量更新</strong>，再单击 <strong>上传文件</strong> ，将编辑整理好的解析记录导入云解析 DNS。</p></li><li><p>检查导入云解析 DNS 中配置的解析记录是否跟您之前的 DNS 厂商中设置的解析记录一致，避免漏配现象。</p></li><li><p>前往您的域名注册商处，将 DNS 服务器修改为云解析 DNS 系统分配的地址（在云解析 DNS 控制台-<strong>域名解析</strong>页面-<strong>解析设置</strong> 页面-<strong>查看 DNS 服务器</strong> 可获取到系统分配的 DNS 服务器地址）。修改域名 DNS 服务器配置可参考 <a href="https://help.aliyun.com/zh/dns/change-the-dns-server/">修改DNS服务器</a>。</p><p><strong>重要</strong></p><p>修改 DNS 服务器之前请检查域名是否开启了禁止更新锁，如果处于开启状态，请关闭禁止更新锁。如何确认域名是否开启了禁止更新锁，可以咨询您的域名注册商或者使用 <a href="https://whois.aliyun.com/">whois工具</a>查询域名状态是否显示 serverUpdateProhibited。</p></li><li><p>借助 DNS 流量分析功能查看您的服务请求流量是否有异常波动，持续观测至少10分钟。具体请参考 <a href="https://help.aliyun.com/zh/dns/queryvolume">DNS流量分析简介</a>。</p></li><li><p>无需其他操作，耐心等待解析生效即可，预计需要 48 小时完成全国各地 localDNS 的缓存刷新。</p><p><strong>警告</strong></p><ul><li><p>为避免解析异常，在修改 DNS 服务器 48 小时内请尽量不变更解析记录。</p></li><li><p>在 48 小时内 DNS 解析仍有可能向旧 DNS 厂商发起 DNS 查询，所以原 DNS 服务商中的解析记录数据不要马上删除，建议保留一周。</p></li><li><p>在修改 DNS 服务器 48 小时内，如需做解析记录变更，请务必同时在新旧 DNS 服务商进行变更，以保持新旧 DNS 服务商的解析记录数据一致。</p></li></ul><p><strong>说明</strong></p><p>关于修改 DNS 服务器，需要多久才能在全网生效？</p><p>答：一般需要 48 小时，因为各地 Localdns 服务器的域名缓存失效时间长短不一，需要等待各地 Localdns 服务器主动来更新该域名的最新 DNS 服务器地址，以实现逐步全网生效。请耐心等待这个过程。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> DNS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cert-manager</title>
      <link href="/2024/04/30/cert-manager/"/>
      <url>/2024/04/30/cert-manager/</url>
      
        <content type="html"><![CDATA[<h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><p>首先装上 crds，使用的 kubectl 安装。不建议在 helm 中使用 crd: enable, 这样升级 cert-manager 的时候，随 helm 的卸载和升级，集群中已经有的自定义资源会消失。(官网有特别说明这两种安装方式的不同)</p><h2 id="helm-install-cert-manager"><a href="#helm-install-cert-manager" class="headerlink" title="helm install cert-manager"></a>helm install cert-manager</h2><h3 id="helm-metrics"><a href="#helm-metrics" class="headerlink" title="helm metrics"></a>helm metrics</h3><pre class="line-numbers language-none"><code class="language-none">prometheus:  enabled: true  servicemonitor:    enabled: true  # 没有配置servicemonitor，使用已配置的服务自动发现也可以获取指标。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!question]<br>确实只有三条指标吗？—-a issue in repo 提到：当存在有证书资源的时候就会有更多指标存在</p><pre class="line-numbers language-none"><code class="language-none">&gt;# HELP certmanager_clock_time_seconds DEPRECATED: use clock_time_seconds_gauge instead. The clock time given in seconds (from 1970&#x2F;01&#x2F;01 UTC).&gt;# TYPE certmanager_clock_time_seconds countercertmanager_clock_time_seconds 1.713170784e+09&gt;# HELP certmanager_clock_time_seconds_gauge The clock time given in seconds (from 1970&#x2F;01&#x2F;01 UTC).&gt;# TYPE certmanager_clock_time_seconds_gauge gaugecertmanager_clock_time_seconds_gauge 1.713170784e+09&gt;# HELP certmanager_controller_sync_call_count The number of sync() calls made by a controller.&gt;# TYPE certmanager_controller_sync_call_count countercertmanager_controller_sync_call_count&#123;controller&#x3D;&quot;ingress-shim&quot;&#125; 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h2 id="简单使用并验证指标数量"><a href="#简单使用并验证指标数量" class="headerlink" title="简单使用并验证指标数量"></a>简单使用并验证指标数量</h2><h3 id="域名和阿里-dns-赋权用户"><a href="#域名和阿里-dns-赋权用户" class="headerlink" title="域名和阿里 dns 赋权用户"></a>域名和阿里 dns 赋权用户</h3><p>域名迁移 <a href="/2024/04/30/domain-management/" title="domain-management">domain-management</a></p><h4 id="RAM-用户权限"><a href="#RAM-用户权限" class="headerlink" title="RAM 用户权限"></a>RAM 用户权限</h4><p>目的：在 cert-manager 中使用 lets encrypt 通过 alidns 的 webhook 来创建证书。 需要：创建一个子用户<br>在 RAM 访问控制台创建一个用户，给予 api 访问即可，创建后点击用户，编辑授权。</p><p><img src="https://i.mji.rip/2024/04/30/28b2ee3eedfdf53267a55dd203fc3972.png" alt="28b2ee3eedfdf53267a55dd203fc3972.png"></p><h3 id="alidns-webhook"><a href="#alidns-webhook" class="headerlink" title="alidns-webhook"></a>alidns-webhook</h3><blockquote><p>介绍<br>ACME（Automatic Certificate Management Environment）是一个用于自动化从证书颁发机构（Certificate Authority, CA）获取、续签和吊销 SSL&#x2F;TLS 证书的协议。ACME 旨在简化证书管理过程，使得网站管理员可以轻松地为其网站启用 HTTPS 加密，从而提高网络安全性。</p><blockquote><p>Cert Manager 使用 DNS01 验证来自动化地获取和续订由 ACME 服务器（如 Let’s Encrypt）颁发的 SSL&#x2F;TLS 证书。DNS01 要求 Cert Manager 能够创建和删除 DNS TXT 记录，以证明域名的所有权。由此，Cert Manager 需要与 DNS 服务提供商的 API 进行交互。</p></blockquote><blockquote><p>这就是为什么需要像 alidns 的 webhook 这样的组件。Webhook 解析器是 Cert Manager 中的一种机制，它允许开发者创建自定义的逻辑来处理 DNS01 挑战。这些 webhook 解析器作为独立的服务运行，并且能够接收来自 Cert Manager 的 DNS01 验证请求，并执行必要的操作来满足的要求。</p></blockquote><p>Webhook 的作用</p><blockquote><p>当使用 Cert Manager 与具体的 DNS 服务（如 AliDNS）交互时，需要一种方式来自动化更新 DNS 记录的过程。这就是 webhook 发挥作用的地方：</p><ol><li><p><strong>自动化处理</strong>：Webhook 提供了一种机制，通过这种机制 Cert Manager 可以自动向 DNS 提供商请求添加、修改或删除 DNS 记录。这对于自动化证书的申请、续期和撤销过程至关重要。</p></li><li><p><strong>安全访问</strong>：通过 webhook，可以安全地集成第三方服务（如 DNS 提供商），同时遵守最小权限原则。Webhook 通常需要配置相应的 API 凭证，这些凭证应当只赋予修改 DNS 记录所需的权限，从而降低安全风险。</p></li><li><p><strong>提供商特定的逻辑</strong>：不同的 DNS 提供商可能有不同的 API 接口和规则。Webhook 可以封装这些特定的逻辑，使得 Cert Manager 能够以统一的方式处理不同 DNS 提供商的接口。</p></li></ol></blockquote><p>实现细节</p><blockquote><p>例如，在使用AliDNS的场景中，Cert Manager需要一个AliDNS webhook来处理DNS记录的修改。这个webhook负责与AliDNS的API进行交互，执行如下操作：</p><ul><li>当 Cert Manager 需要在 DNS 中创建一个新的 TXT 记录以响应 DNS-01挑战时，webhook 将调用 AliDNS 的 API 来添加该记录。</li><li>完成验证后，webhook 将再次调用 API 删除该 TXT 记录，以清理不再需要的记录。</li></ul></blockquote><p>通过这种方式，Cert Manager可以实现完全自动化的证书管理，无需人工干预DNS记录的更新，大大简化了使用SSL&#x2F;TLS证书的复杂性。<br>总的来说，alidns 的 webhook 为 Cert Manager 提供了与阿里云 DNS 服务交互的能力，使得 Cert Manager 能够自动化地完成 DNS01 挑战，从而简化了在 Kubernetes 集群中管理 SSL&#x2F;TLS 证书的过程。</p></blockquote><h4 id="安装-alidns-webhook-两种webhook"><a href="#安装-alidns-webhook-两种webhook" class="headerlink" title="安装 alidns-webhook (两种webhook)"></a>安装 alidns-webhook (两种webhook)</h4><ul><li><p>helm（本例使用）</p></li><li><p>reference： <a href="https://github.com/DEVmachine-fr/cert-manager-alidns-webhook">GitHub - DEVmachine-fr&#x2F;cert-manager-alidns-webhook: Cert-manager webhook to generate Let’s Encrypt certificates over Alibaba Cloud DNS.</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 部署 阿里云 DNS Webhook，groupName的值修改为自己的域名</span>helm repo <span class="token function">add</span> cert-manager-alidns-webhook https://devmachine-fr.github.io/cert-manager-alidns-webhookhelm repo updatehelm upgrade <span class="token parameter variable">-i</span> alidns-webhook cert-manager-alidns-webhook/alidns-webhook <span class="token punctuation">\</span>  <span class="token parameter variable">--set</span> <span class="token assign-left variable">groupName</span><span class="token operator">=</span>acme.chaoslong.cn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>另一个 manifest 文件安装（使用有不同）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://raw.githubusercontent.com/pragkent/alidns-webhook/master/deploy/bundle.yaml<span class="token comment"># 修改文件中的acme.yourcompany.com为自己的域名</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> s/<span class="token string">'acme.yourcompany.com'</span>/<span class="token string">'acme.chaoslong.cn'</span>/g bundle.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="Secret-of-AliDNS-Access"><a href="#Secret-of-AliDNS-Access" class="headerlink" title="Secret of AliDNS Access"></a>Secret of AliDNS Access</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> alidns<span class="token punctuation">-</span>secret  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">accesskey-id</span><span class="token punctuation">:</span> xxxxxxxxxxxxxxxx  <span class="token comment"># echo -n "shdhd" | base64 ; echo -n 参数没换行符输出</span>  <span class="token key atrule">accesskey-secret</span><span class="token punctuation">:</span> xxxxxxxxxxxx或者kubectl create secret generic alidns<span class="token punctuation">-</span>secrets <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal="access<span class="token punctuation">-</span>token=xxxxxxx" <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal="secret<span class="token punctuation">-</span>key=xxxxxxxxxx"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Create-Letsencrypt-clusterissuer"><a href="#Create-Letsencrypt-clusterissuer" class="headerlink" title="Create Letsencrypt clusterissuer"></a>Create Letsencrypt clusterissuer</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>staging  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">acme</span><span class="token punctuation">:</span>    <span class="token comment"># Change to your letsencrypt email</span>    <span class="token key atrule">email</span><span class="token punctuation">:</span> chao.long@keyword.net    <span class="token comment"># 测试阶段可以用 staging （无限制）</span>    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//acme<span class="token punctuation">-</span>staging<span class="token punctuation">-</span>v02.api.letsencrypt.org/directory    <span class="token comment"># 正式</span>    <span class="token comment"># server: https://acme-v02.api.letsencrypt.org/directory </span>    <span class="token key atrule">privateKeySecretRef</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>staging<span class="token punctuation">-</span>acme<span class="token punctuation">-</span>count <span class="token comment"># 如果不存在将创建，用以存放一个私钥，作为 ACME 账户的私钥，用于与 ACME 服务器进行安全通信</span>    <span class="token key atrule">solvers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">dns01</span><span class="token punctuation">:</span>        <span class="token key atrule">webhook</span><span class="token punctuation">:</span>          <span class="token key atrule">groupName</span><span class="token punctuation">:</span> chaoslong.cn  <span class="token comment">#同于webhook安装中的值</span>          <span class="token key atrule">solverName</span><span class="token punctuation">:</span> alidns   <span class="token comment"># 固定</span>          <span class="token key atrule">config</span><span class="token punctuation">:</span>            <span class="token key atrule">region</span><span class="token punctuation">:</span> <span class="token string">""</span>            <span class="token key atrule">secretKeySecretRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> alidns<span class="token punctuation">-</span>secret              <span class="token key atrule">key</span><span class="token punctuation">:</span> accesskey<span class="token punctuation">-</span>id            <span class="token key atrule">accessTokenSecretRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> alidns<span class="token punctuation">-</span>secret              <span class="token key atrule">key</span><span class="token punctuation">:</span> accesskey<span class="token punctuation">-</span>secret    selector：    <span class="token comment"># 当 cert-manager 处理证书请求时，它将只为这些 DNS 区域中的域名创建和更新 DNS 记录。</span>      <span class="token key atrule">dnsZones</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">'mydomdom.org'</span>      <span class="token punctuation">-</span> <span class="token string">'*.mydomdom.org'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>手动生成证书<br><code>certificates</code> -&gt; <code>certificaterequests</code> -&gt; <code>orders</code> -&gt; <code>challenges</code>.</p><pre class="line-numbers language-none"><code class="language-none">apiVersion: cert-manager.io&#x2F;v1kind: Certificatemetadata:  name: chaoslong-test-tls  # 指定证书生成到哪个工作空间，不指定也可以  namespace: cert-managerspec:  #生成后证书的secret名称  secretName: chaoslong-test-tls  duration: 24h  # 指定域名  dnsNames:  - &quot;chaoslong.cn&quot;  - &quot;*.chaoslong.cn&quot;  issuerRef:    name: letsencrypt-staging    kind: ClusterIssuer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!debug]<br> 此时以上各种新增资源一直是 pending 或者 unavailable; accesskey 解析一直失败<br> 排查发现：<br> <pre class="line-numbers language-none"><code class="language-none">- dns01:        webhook:           config:             accessTokenSecretRef:     # 此处书写错误，使用了另一个 webhook 的变量，正确的如此配置              key: access-token        # 这是 asccesskey 的 id              name: alidns-secrets             region: &#39;&#39;             secretKeySecretRef:              key: secret-key      # 这是 accesskey 的 secert              name: alidns-secrets  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>certmanager 如果成功调用 webhook，会在证书验证过程中生成一个 challenge 的 TXT 记录到 DNS，判断域名的所有权\</p></blockquote><blockquote><p>[!success] Valid 描述<br>创建 certificates 资源之后，challenges 和 orders 会相应生成，在验证过程中会有一段较长的时间等待世界 DNS 缓存刷新（会生成一个 cert.doamin.cn）。<br>最终状态正常之后，challenges 删除，其 txt 记录也会被删除，存放证书内容的 tls-secret 状态将变为合法，其中会存储有证书内容。</p></blockquote><h2 id="待尝试"><a href="#待尝试" class="headerlink" title="待尝试"></a>待尝试</h2><h2 id="Vault-保存证书"><a href="#Vault-保存证书" class="headerlink" title="Vault 保存证书"></a>Vault 保存证书</h2><h2 id="应用通过-ESO-请求证书"><a href="#应用通过-ESO-请求证书" class="headerlink" title="应用通过 ESO 请求证书"></a>应用通过 ESO 请求证书</h2>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cert-manager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kube-prometheus-stack</title>
      <link href="/2024/04/30/kube-prometheus-stack/"/>
      <url>/2024/04/30/kube-prometheus-stack/</url>
      
        <content type="html"><![CDATA[<p>在 kube-prometheus-stack 中，prometheus 资源对象（crd 对象，而不是 prometheus 这个应用）需要对以下内容特别注意<br>prometheus 对象的 yaml 部分内容   </p><pre class="line-numbers language-none"><code class="language-none">namespaceselector：  any: trueserviceMonitorSelector:  matchLabels:    release: kube-prometheus-stack   # note：当 servicemonitor 没有正常生效时，检查其资源中是否有这样的标签，如此才能被prometheus对象所选择 ，而后生效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>书写一个 servicemonitor。</p><pre class="line-numbers language-none"><code class="language-none">apiVersion: monitoring.coreos.com&#x2F;v1kind: ServiceMonitormetadata:  labels:    objectset.rio.cattle.io&#x2F;hash: f3ca87e2e941644e0d103f8e0d05b2e610db5092    release: kube-prometheus-stack  name: kube-prometheus-stack-rocketchat  namespace: kube-promspec:  endpoints:    - bearerTokenFile: &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token      port: metrics  jobLabel: jobLabel  namespaceSelector:    matchNames:      - rocketchat  selector:    matchLabels:      app.kubernetes.io&#x2F;instance: rocketchat      app.kubernetes.io&#x2F;managed-by: Helm      app.kubernetes.io&#x2F;name: rocketchat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>书写服务自动发现。<br>通过命令和文件创建的 secret</p><pre class="line-numbers language-none"><code class="language-none">vim sd.yamlkubectl create secret generic kube-prometheus-stack-sd --from-file&#x3D;.&#x2F;sd.yaml -n kube-promsecret&#x2F;kube-prometheus-stack-sd created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>配置使用这个secret</p><pre class="line-numbers language-none"><code class="language-none">prometheus:  prometheusspec:    additionalScrapeConfigsSecret: &#123;&#125;      enabled: false      name: kube-prometheus-stack-sd      key: sd.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>sd.yaml</p><pre class="line-numbers language-none"><code class="language-none">- job_name: kubernetes-service-endpoints  kubernetes_sd_configs:    - role: endpoints  relabel_configs:    - action: keep      regex: true      source_labels:        - __meta_kubernetes_service_annotation_prometheus_io_scrape    - action: drop      regex: true      source_labels:        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow    - action: replace      regex: (https?)      source_labels:        - __meta_kubernetes_service_annotation_prometheus_io_scheme      target_label: __scheme__    - action: replace      regex: (.+)      source_labels:        - __meta_kubernetes_service_annotation_prometheus_io_path      target_label: __metrics_path__    - action: replace      regex: (.+?)(?::\d+)?;(\d+)      replacement: $1:$2      source_labels:        - __address__        - __meta_kubernetes_service_annotation_prometheus_io_port      target_label: __address__    - action: labelmap      regex: __meta_kubernetes_service_label_app_(.+)      replacement: __param_$1    - action: replace      regex: __meta_kubernetes_service_label_(.+)      source_labels:        - __meta_kubernetes_namespace      target_label: namespace    - action: replace      source_labels:        - __meta_kubernetes_service_name      target_label: service    - action: replace      source_labels:        - __meta_kubernetes_pod_node_name      target_label: node    - action: replace      source_labels:        - __meta_kubernetes_pod_name      target_label: pod- job_name: kubernetes-service-endpoints-slow  kubernetes_sd_configs:    - role: endpoints  relabel_configs:    - action: keep      regex: true      source_labels:        - __meta_kubernetes_service_annotation_prometheus_io_scrape_slow    - action: replace      regex: (https?)      source_labels:        - __meta_kubernetes_service_annotation_prometheus_io_scheme      target_label: __scheme__    - action: replace      regex: (.+)      source_labels:        - __meta_kubernetes_service_annotation_prometheus_io_path      target_label: __metrics_path__    - action: replace      regex: (.+?)(?::\d+)?;(\d+)      replacement: $1:$2      source_labels:        - __address__        - __meta_kubernetes_service_annotation_prometheus_io_port      target_label: __address__    - action: labelmap      regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)      replacement: __param_$1    - action: labelmap      regex: __meta_kubernetes_service_label_(.+)    - action: replace      source_labels:        - __meta_kubernetes_namespace      target_label: namespace    - action: replace      source_labels:        - __meta_kubernetes_service_name      target_label: service    - action: replace      source_labels:        - __meta_kubernetes_pod_node_name      target_label: node  scrape_interval: 5m  scrape_timeout: 30s- honor_labels: true  job_name: kubernetes-pods  kubernetes_sd_configs:    - role: pod  relabel_configs:    - action: keep      regex: true      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_scrape    - action: drop      regex: true      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow    - action: replace      regex: (https?)      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_scheme      target_label: __scheme__    - action: replace      regex: (.+)      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_path      target_label: __metrics_path__    - action: replace      regex: (\d+);(([A-Fa-f0-9]&#123;1,4&#125;::?)&#123;1,7&#125;[A-Fa-f0-9]&#123;1,4&#125;)      replacement: &#39;[$2]:$1&#39;      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_port        - __meta_kubernetes_pod_ip      target_label: __address__    - action: replace      regex: (\d+);((([0-9]+?)(\.|$))&#123;4&#125;)      replacement: $2:$1      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_port        - __meta_kubernetes_pod_ip      target_label: __address__    - action: labelmap      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)      replacement: __param_$1    - action: replace      source_labels:        - __meta_kubernetes_namespace      target_label: namespace    - action：replace      source_labels:        - __meta_kubernetes_pod_label_release      target_labels: release    - action: replace      source_labels:        - __meta_kubernetes_pod_name      target_label: pod    - action: drop      regex: Pending|Succeeded|Failed|Completed      source_labels:        - __meta_kubernetes_pod_phase    - action: replace      source_labels:        - __meta_kubernetes_pod_node_name      target_label: node- honor_labels: true  job_name: kubernetes-pods-slow  kubernetes_sd_configs:    - role: pod  relabel_configs:    - action: keep      regex: true      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow    - action: replace      regex: (https?)      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_scheme      target_label: __scheme__    - action: replace      regex: (.+)      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_path      target_label: __metrics_path__    - action: replace      regex: (\d+);(([A-Fa-f0-9]&#123;1,4&#125;::?)&#123;1,7&#125;[A-Fa-f0-9]&#123;1,4&#125;)      replacement: &#39;[$2]:$1&#39;      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_port        - __meta_kubernetes_pod_ip      target_label: __address__    - action: replace      regex: (\d+);((([0-9]+?)(\.|$))&#123;4&#125;)      replacement: $2:$1      source_labels:        - __meta_kubernetes_pod_annotation_prometheus_io_port        - __meta_kubernetes_pod_ip      target_label: __address__    - action: labelmap      regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)      replacement: __param_$1    - action：replace      source_labels:        - __meta_kubernetes_pod_label_release      target_labels: release    - action: replace      source_labels:        - __meta_kubernetes_namespace      target_label: namespace    - action: replace      source_labels:        - __meta_kubernetes_pod_name      target_label: pod    - action: drop      regex: Pending|Succeeded|Failed|Completed      source_labels:        - __meta_kubernetes_pod_phase    - action: replace      source_labels:        - __meta_kubernetes_pod_node_name      target_label: node  scrape_interval: 5m  scrape_timeout: 30s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 Prometheus 中， <code>relabel_config</code> 用于在抓取目标之前对目标的标签进行重写，这在服务发现和数据组织中非常有用。以下是 <code>relabel_config</code> 中可以使用的所有参数的详细介绍：</p><ol><li><p><strong><code>action</code></strong>: 指定要执行的操作，可用的动作包括：</p><ul><li><code>replace</code>: 替换标签的键或值。</li><li><code>keep</code>: 保留匹配正则表达式的实例，丢弃其他实例。</li><li><code>drop</code>: 丢弃匹配正则表达式的实例，保留其他实例。</li><li><code>labelmap</code>: 将一个标签映射到另一个标签，可以用于重命名或重组标签。</li><li><code>labeldrop</code>: 删除指定的标签。</li><li><code>labelkeep</code>: 仅保留指定的标签，删除其他所有标签。</li></ul></li><li><p><strong><code>source_labels</code></strong>: 一个包含要进行重写的原始标签名的数组。对于<code>replace</code>动作，至少需要一个标签；对于<code>keep</code>、<code>drop</code>、<code>labeldrop</code>和<code>labelkeep</code>动作，通常需要指定要匹配的标签。</p></li><li><p><strong><code>regex</code></strong>: 一个正则表达式，用于匹配<code>source_labels</code>中的标签值。对于<code>replace</code>动作，它可以是一个固定的字符串或者正则表达式；对于<code>keep</code>和<code>drop</code>动作，它通常是一个用于匹配的正则表达式。</p></li><li><p><strong><code>target_label</code></strong>: 对于<code>replace</code>动作，这是要设置的新标签名。对于其他动作，这个字段不被使用。</p></li><li><p><strong><code>replacement</code></strong>: 对于<code>replace</code>动作，这是新标签的值。它可以使用正则表达式捕获组（如<code>$1</code>），以动态设置新值。</p></li><li><p><strong><code>separator</code></strong>: 对于<code>labelmap</code>动作，这是一个字符串，用于分隔复合标签中的各个部分。</p></li><li><p><strong><code>modulus</code></strong>: 对于<code>hashmod</code>动作，这是一个整数，表示将标签值映射到一个特定的基数。</p></li><li><p><strong><code>hash_mapping_file</code></strong>: 对于<code>hashmod</code>动作，这是一个文件路径，指定了一个包含标签值到特定基数映射的文件。</p></li><li><p><strong><code>labeldrop</code></strong>: 用于删除匹配正则表达式的标签。</p></li><li><p><strong><code>labelkeep</code></strong>: 用于保留匹配正则表达式的标签，删除其他所有标签。</p></li><li><p><strong><code>tmp_label_name</code></strong>: 一个临时标签名，用于在重写过程中存储中间结果。</p></li></ol><p>这些参数可以组合使用，以实现复杂的重写逻辑。例如，您可以先使用<code>labeldrop</code>删除不需要的标签，然后使用<code>replace</code>修改或添加新的标签，最后使用<code>labelmap</code>重命名标签以符合您的数据模型。</p><p><code>relabel_config</code>的使用非常灵活，可以根据您的具体需求进行调整。在实际应用中，您可能需要结合您的服务发现机制、数据模型以及Prometheus的配置来设计合适的<code>relabel_config</code>。</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>blog-with-cdn</title>
      <link href="/2024/04/24/blog-with-cdn/"/>
      <url>/2024/04/24/blog-with-cdn/</url>
      
        <content type="html"><![CDATA[<h2 id="1-前置"><a href="#1-前置" class="headerlink" title="1. 前置"></a>1. 前置</h2><p>当前托管在 github 的访问地址是<code>https://myrepo.github.io</code><br>Note：<br>此时自己的仓库名应该和自己的域名相同<code>myrepo.github.io</code>; 同时配置 blog 应用中关于github pages 发布中关于url的配置)</p><p>然后配置自定义域名是 <code>blog.mydomain.cn</code>； 可以在 UI 配置，也可以通过直接在 main 分支source文件夹下创建一个位于顶级的文件<code>CNAME</code>,其中只存在这个自定义域名，然后发布一次。<br>此时需要在自己的域名管理添加 DNS 的 CNAME 解析记录，对应以上；即： <code>blog.mydomain.cn  CNAME  myrepo.github.io</code></p><h2 id="2-cdn-加速"><a href="#2-cdn-加速" class="headerlink" title="2. cdn 加速"></a>2. cdn 加速</h2><p>测试使用的cdn产品是 <code>cdn.cdn5.com</code>, <code>sudun.com</code></p><p>加速域名：km.mydomain.cn<br>源站：blog.mydomain.cn  OR  myrepo.github.io<br>cdn域名别名：xxxxxxx</p><p><strong>配置：</strong><br>为<code>加速域名</code>，在自己的域名管理添加 DNS 的 CNAME 解析记录，对应为：<code>km.mydomain.cn CNAME cdn域名别名</code></p><p><strong>流量：</strong><br>加速域名 –&gt; DNS –&gt; cdn域名别名 –&gt; 源站（github.io|blog.cn ）</p><p>其中，回源 是指 cdn 向源站请求的过程。回源<code>host</code> 这个参数需要源站能够匹配。所以在回源设置中需要保证<code>host</code>的值正确;<br>此例是将值自定义为源站的 servername，<code>blog.mydomain.cn | myrepo.github.io</code></p><p><strong>其它：</strong><br>默认使用加密传输，配置了证书、开启了重定向跳转https</p><p><strong>结果：</strong><br>国内访问 km.mydomain.cn 可以快速访问，不因为墙的原因而慢了</p><h2 id="续：试用-cloudflare"><a href="#续：试用-cloudflare" class="headerlink" title="续：试用 cloudflare"></a>续：试用 cloudflare</h2><p>之前的免费cdn只有一个月的试用时长，过期之后尝试使用 cloudflare 代理。 <br>当前基本情况：</p><ul><li>github pages：发布在 myrepo.github.io, 但是同时使用 GitHub 的自定义域名功能，并强制 https。</li><li>cloudflare： 免费套餐服务，代理一个 blog 域名例如 km.mydomain.cn，它是 CNAME 类型，是 myrepo.github.io 的别名。</li><li>DNS： 使用 cloudflare 管理域名，除去上述需要代理，其他地址仅 DNS 解析即可。</li></ul><p>按照常理，经上述配置之后已经可以正常访问加速后的博客（cloudflare ssl 安全建议选择 完全 级别）</p><h2 id="再续：-cloudflare-pages"><a href="#再续：-cloudflare-pages" class="headerlink" title="再续： cloudflare pages"></a>再续： cloudflare pages</h2><p>因为 cloudflare 的 cdn 加速没玩明白，所以使用其 pages 功能。流程简明易操作：对接 git 仓库并，选择仓库与分支，部署，设置自定义域名，CNAME 解析即可。 <br>访问快于 github pages，此段内容用于检测其是否能够自动更新。</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>FRP 穿透并代理到ingressroute</title>
      <link href="/2024/04/16/frp-chuan-tou-bing-dai-li-dao-ingressroute/"/>
      <url>/2024/04/16/frp-chuan-tou-bing-dai-li-dao-ingressroute/</url>
      
        <content type="html"><![CDATA[<p>条件：需要有一个公网中的主机，如果需要通过域名进行 http 类型的穿透，需要有域名。<br>说明：没有 ssl 证书，所以都是基于 http 的尝试，后续补充 https。</p><h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><h3 id="frps-toml-基本如此，没有特殊需要将不会改"><a href="#frps-toml-基本如此，没有特殊需要将不会改" class="headerlink" title="frps .toml 基本如此，没有特殊需要将不会改"></a>frps .toml 基本如此，没有特殊需要将不会改</h3><p>github 仓库中有一个目录是 conf，其中可以看到所有的配置和注解</p><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">bindPort</span> <span class="token punctuation">=</span> <span class="token number">7000</span><span class="token key property">bindAddr</span> <span class="token punctuation">=</span> <span class="token string">"my PublicIP"</span><span class="token key property">vhostHTTPPort</span> <span class="token punctuation">=</span> <span class="token number">8080</span>  <span class="token comment"># 使用 Http 类型的代理穿透时需要增加此端口</span><span class="token key property">auth.method</span> <span class="token punctuation">=</span> <span class="token string">"token"</span><span class="token key property">auth.token</span> <span class="token punctuation">=</span> <span class="token string">"domainMyDomainname"</span> <span class="token comment"># 自定义即可</span><span class="token key property">subDomainHost</span> <span class="token punctuation">=</span> <span class="token string">"MyDomainname.cn"</span>  <span class="token comment"># 配合 client 端的 subdomain 使用。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="systemd-管理服务"><a href="#systemd-管理服务" class="headerlink" title="systemd 管理服务"></a>systemd 管理服务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@oncloud html<span class="token punctuation">]</span><span class="token comment"># cat /usr/lib/systemd/system/frps.service</span><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span><span class="token comment"># 服务名称，可自定义</span>Description <span class="token operator">=</span> frp serverAfter <span class="token operator">=</span> network.target syslog.targetWants <span class="token operator">=</span> network.target<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>Type <span class="token operator">=</span> simple<span class="token comment"># 启动frps的命令，需修改为您的frps的安装路径</span>ExecStart <span class="token operator">=</span> /usr/local/bin/frps <span class="token parameter variable">-c</span> /etc/frp/frps.toml<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy <span class="token operator">=</span> multi-user.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">sudo systemctl daemon-reloadsudo systemctl enable --now frps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>因为是使用 http 类型，还给公网的这个机器做了 nginx 代理</p><h3 id="nginx-代理配置文件"><a href="#nginx-代理配置文件" class="headerlink" title="nginx 代理配置文件"></a>nginx 代理配置文件</h3><pre class="line-numbers language-nginx.conf" data-language="nginx.conf"><code class="language-nginx.conf">server &#123;        listen 80;        server_name rancher.MyDomainname.cn;        location &#x2F; &#123;            proxy_pass http:&#x2F;&#x2F;my PublicIP:8080;            proxy_set_header Host $host;            proxy_set_header X-Real-IP $remote_addr;            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="客户端使用"><a href="#客户端使用" class="headerlink" title="客户端使用"></a>客户端使用</h2><p>同样可以使用 systemd 管理 frpc 服务</p><h3 id="案例-1：ssh-连接内网主机"><a href="#案例-1：ssh-连接内网主机" class="headerlink" title="案例 1：ssh 连接内网主机"></a>案例 1：ssh 连接内网主机</h3><h4 id="frpc-toml"><a href="#frpc-toml" class="headerlink" title="frpc .toml"></a>frpc .toml</h4><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">serverAddr</span> <span class="token punctuation">=</span> <span class="token string">"my PublicIP"</span><span class="token key property">serverPort</span> <span class="token punctuation">=</span> <span class="token number">7000</span><span class="token key property">auth.method</span> <span class="token punctuation">=</span> <span class="token string">"token"</span><span class="token key property">auth.token</span> <span class="token punctuation">=</span> <span class="token string">"domainMyDomainname"</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">proxies</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token comment"># 固定</span><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"ssh"</span>   <span class="token comment"># 自定义，唯一，相当于这个配置块的名称</span><span class="token key property">type</span> <span class="token punctuation">=</span> <span class="token string">"tcp"</span><span class="token key property">localIP</span> <span class="token punctuation">=</span> <span class="token string">"127.0.0.1"</span>  <span class="token comment">#主要是需要监听到子网这个主机的ipv4地址</span><span class="token key property">localPort</span> <span class="token punctuation">=</span> <span class="token number">22</span>         <span class="token comment"># 子网这个主机的 ssh 端口</span><span class="token key property">remotePort</span> <span class="token punctuation">=</span> <span class="token number">6000</span>     <span class="token comment"># 配置后，公网主机将自行监听此端口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p> <code>ssh -o Port=6000 子网机器 user 名@公网主机名</code>  <br> 效果：在 WLAN 主机执行后，6000–&gt;7000–&gt;subnet &#96;</p><h3 id="案例-2：自定义域名访问内网服务"><a href="#案例-2：自定义域名访问内网服务" class="headerlink" title="案例 2：自定义域名访问内网服务"></a>案例 2：自定义域名访问内网服务</h3><h4 id="frpc-toml-1"><a href="#frpc-toml-1" class="headerlink" title="frpc .toml"></a>frpc .toml</h4><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">serverAddr</span> <span class="token punctuation">=</span> <span class="token string">"my PublicIP"</span><span class="token key property">serverPort</span> <span class="token punctuation">=</span> <span class="token number">7000</span><span class="token key property">auth.method</span> <span class="token punctuation">=</span> <span class="token string">"token"</span><span class="token key property">auth.token</span> <span class="token punctuation">=</span> <span class="token string">"domainMyDomainname"</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">proxies</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"test1-web"</span><span class="token key property">type</span> <span class="token punctuation">=</span> <span class="token string">"http"</span><span class="token key property">localIP</span> <span class="token punctuation">=</span> <span class="token string">"192.168.3.20"</span>  <span class="token comment"># 内网Nginx</span><span class="token key property">localPort</span> <span class="token punctuation">=</span> <span class="token number">80</span>            <span class="token comment"># ip + port，相当于将frpserver的流量定向到这个内网的地址，在此例中，这个地址是nginx，所以会再指向它代理的地址</span><span class="token key property">subdomain</span> <span class="token punctuation">=</span> <span class="token string">"rancher"</span>  <span class="token comment"># 配合 server 端的配置，组成域名rancher.MyDomainname.cn；这时在公网中需要给自己域名增加的一个解析</span><span class="token key property">hostHeaderRewrite</span> <span class="token punctuation">=</span> <span class="token string">"master.MyDomainname.cn"</span> <span class="token comment"># 会将 subdoamin 组成的host会替换为此配置，以后可以只在域名解析使用以上一个A记录就好</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!annotation]<br>基于上述配置，我在自己的内网中还有 dns 和 nginx 配合使用，子网主机都使用内网 DNS。</p></blockquote><p>DNS 中使用的域名是 testlab.net；解析记录主要是内网中的服务。<br>Nginx 使用：http 穿透后，流量会到我的 nginx 80 端口，然后配置一个代理转发，流量将去向真正的服务的地址（DNS 需要做好目标的解析）。</p><h4 id="nginx-proxy-example"><a href="#nginx-proxy-example" class="headerlink" title="nginx proxy example"></a>nginx proxy example</h4><pre class="line-numbers language-nginx.conf" data-language="nginx.conf"><code class="language-nginx.conf">server &#123;    listen 80;    server_name master.MyDomainname.cn;    location &#x2F; &#123;        proxy_pass http:&#x2F;&#x2F;master.homelab.net;        proxy_set_header Host $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>基于这个客户端配置，我在公网访问 rancher.MyDomainname.cn 就将能够访问子网中的，master.homelab.net 的服务（这是一个普通的web）<br>流量：</p><pre class="line-numbers language-none"><code class="language-none">desktop--&gt; rancher.MyDomainname.cn --&gt; External DNS --&gt; Server under WLAN --&gt; nginx --&gt; frps --&gt; frpc --&gt; nginx proxy --&gt; internal nginx --&gt; target service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="案例-3：内网中-nginx-代理-traefikingressrout（区别于普通web）"><a href="#案例-3：内网中-nginx-代理-traefikingressrout（区别于普通web）" class="headerlink" title="案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）"></a>案例 3：内网中 nginx 代理 traefikingressrout（区别于普通web）</h3><h4 id="frpc-toml-2"><a href="#frpc-toml-2" class="headerlink" title="frpc .toml"></a>frpc .toml</h4><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">serverAddr</span> <span class="token punctuation">=</span> <span class="token string">"my PublicIP"</span><span class="token key property">serverPort</span> <span class="token punctuation">=</span> <span class="token number">7000</span><span class="token key property">auth.method</span> <span class="token punctuation">=</span> <span class="token string">"token"</span><span class="token key property">auth.token</span> <span class="token punctuation">=</span> <span class="token string">"domainMyDomainname"</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token table class-name">proxies</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"test2-web"</span><span class="token key property">type</span> <span class="token punctuation">=</span> <span class="token string">"http"</span><span class="token key property">localIP</span> <span class="token punctuation">=</span> <span class="token string">"192.168.3.20"</span><span class="token key property">localPort</span> <span class="token punctuation">=</span> <span class="token number">80</span><span class="token key property">subdomain</span> <span class="token punctuation">=</span> <span class="token string">"rancher"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="nginx-proxy-example-1"><a href="#nginx-proxy-example-1" class="headerlink" title="nginx proxy example"></a>nginx proxy example</h4><pre class="line-numbers language-nginx.conf" data-language="nginx.conf"><code class="language-nginx.conf">server &#123;    listen 80;    server_name rancher.MyDomainname.cn;    location &#x2F; &#123;        proxy_pass http:&#x2F;&#x2F;rancher.homelab.net;        proxy_set_header Host rancher.homelab.net;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_set_header X-Forwarded-Proto $scheme;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[! failure]<br>上述测试出现不能成功转发，甚至不是 404。而且直接在浏览器地址栏显示代理后的 rancher. Homelab. Net；无论是否配置 Host 变量，无论这个<br>Host 是使用$host 或者是静态的 <code>rancher.homelab.net</code></p></blockquote><h4 id="单独测试-nginx-代理-ingressroute"><a href="#单独测试-nginx-代理-ingressroute" class="headerlink" title="单独测试 nginx 代理 ingressroute"></a>单独测试 nginx 代理 ingressroute</h4><p>这个是在公司内网，仅测试 nginx 转发到 traefik ingressroute 的配置，成功访问。但是在家中的环境下仍然不能成功访问。</p><pre class="line-numbers language-nginx.conf" data-language="nginx.conf"><code class="language-nginx.conf">server &#123;    listen 80;    server_name rancher.MyDomainname.cn;    location &#x2F; &#123;        proxy_pass http:&#x2F;&#x2F;monitorprom.testlab.net;        proxy_set_header Host monitorprom.testlab.net;   # 原以为此配置很重要，不然经 nginx 转发后的请求host header不正确（可测试发现配置与否都成功实现代理了）        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_set_header X-Forwarded-Proto $scheme;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h4><p><img src="https://ice.frostsky.com/2024/04/16/c8572ce35380b5e78eb2895579f6573b.png" alt="nginx转发到traefik ingressroute 的效果"></p><h4 id="成功穿透下的配置"><a href="#成功穿透下的配置" class="headerlink" title="成功穿透下的配置"></a>成功穿透下的配置</h4><p>frpc 没有变化，nginx 如下</p><pre class="line-numbers language-nginx.conf" data-language="nginx.conf"><code class="language-nginx.conf">server &#123;    listen 80;    server_name rancher.MyDomainname.cn;    location &#x2F; &#123;        proxy_pass https:&#x2F;&#x2F;rancher.homelab.net;  # 原使用的是http，或许家中的集群配置了traefik 使用tls，待验证        proxy_set_header Host rancher.homelab.net; # 此项配置不影响        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;        proxy_set_header X-Forwarded-Proto $scheme;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FRP </tag>
            
            <tag> IngressRoute </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>post img</title>
      <link href="/2024/03/09/post-img/"/>
      <url>/2024/03/09/post-img/</url>
      
        <content type="html"><![CDATA[<h2 id="1-配置修改"><a href="#1-配置修改" class="headerlink" title="1. 配置修改"></a>1. 配置修改</h2><p>修改项目中的<code>_config.yml</code>文件</p><pre class="line-numbers language-none"><code class="language-none">post_asset_folder: true  # 配置为truemarked:                  # 新增  prependRoot: true  postAsset: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-测试"><a href="#2-测试" class="headerlink" title="2. 测试"></a>2. 测试</h2><p>奇怪，只能渲染网络链接的图片，不能渲染资源文件夹中的文件；完全按照官方说明配置<br>后续准备使用图床, 选择了这个平台<a href="https://mjj.today/">mjj.today</a></p><!-- ![测试图片](post-img/img.jpg) --><!--  --><p><img src="https://images.pexels.com/photos/20440051/pexels-photo-20440051.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="测试图床"></p><p><img src="https://ice.frostsky.com/2024/03/09/ee074148edfc1f63b015446c40b02ef2.png" alt="ee074148edfc1f63b015446c40b02ef2.png"></p><h2 id="3-reference"><a href="#3-reference" class="headerlink" title="3. reference"></a>3. reference</h2><p><a href="https://blog.csdn.net/2301_77285173/article/details/130189857">reference 1</a><br><a href="https://zhuanlan.zhihu.com/p/104996801">reference 2</a></p><h2 id="4-测试嵌入视频"><a href="#4-测试嵌入视频" class="headerlink" title="4. 测试嵌入视频"></a>4. 测试嵌入视频</h2><p>这是直接使用b站视频分享中的嵌入代码，显示不友好</p><pre class="line-numbers language-none"><code class="language-none">&lt;iframe src&#x3D;&quot;&#x2F;&#x2F;player.bilibili.com&#x2F;player.html?aid&#x3D;552069936&amp;bvid&#x3D;BV1Hi4y117BB&amp;cid&#x3D;542945776&amp;p&#x3D;5&quot; scrolling&#x3D;&quot;no&quot; border&#x3D;&quot;0&quot; frameborder&#x3D;&quot;no&quot; framespacing&#x3D;&quot;0&quot; allowfullscreen&#x3D;&quot;true&quot;&gt; &lt;&#x2F;iframe&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>效果</strong></p><iframe src="//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><p><strong>调整</strong></p><pre class="line-numbers language-none"><code class="language-none">&lt;div style&#x3D;&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;&gt;&lt;iframe src&#x3D;&quot;&#x2F;&#x2F;player.bilibili.com&#x2F;player.html?aid&#x3D;552069936&amp;bvid&#x3D;BV1Hi4y117BB&amp;cid&#x3D;542945776&amp;p&#x3D;5&quot; scrolling&#x3D;&quot;yes&quot; border&#x3D;&quot;0&quot; frameborder&#x3D;&quot;no&quot; framespacing&#x3D;&quot;0&quot; allowfullscreen&#x3D;&quot;true&quot; style&#x3D;&quot;position: absolute; width: 100%; height: 100%; left: 0; top: 0;&quot;&gt;&lt;&#x2F;iframe&gt;&lt;&#x2F;div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>调整效果</strong></p><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="//player.bilibili.com/player.html?aid=552069936&bvid=BV1Hi4y117BB&cid=542945776&p=5" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"></iframe></div>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在hexo中展示思维导图</title>
      <link href="/2024/03/09/zai-hexo-zhong-zhan-shi-si-wei-dao-tu/"/>
      <url>/2024/03/09/zai-hexo-zhong-zhan-shi-si-wei-dao-tu/</url>
      
        <content type="html"><![CDATA[<h3 id="1-项目来源此处"><a href="#1-项目来源此处" class="headerlink" title="1. 项目来源此处"></a>1. 项目来源<a href="https://github.com/maxchang3/hexo-markmap">此处</a></h3><h3 id="2-效果展示"><a href="#2-效果展示" class="headerlink" title="2. 效果展示"></a>2. 效果展示</h3><div class="markmap-container" style="height:600">  <svg data="{&quot;t&quot;:&quot;root&quot;,&quot;d&quot;:0,&quot;v&quot;:&quot;&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[0,1]},&quot;v&quot;:&quot;links&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;&lt;strong&gt;inline&lt;/strong&gt; &lt;del&gt;text&lt;/del&gt; &lt;em&gt;styles&lt;/em&gt;&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,4]},&quot;v&quot;:&quot;multiline&lt;br&gt;\ntext&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;&lt;code&gt;inline code&lt;/code&gt;&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[5,9]},&quot;v&quot;:&quot;&lt;pre class=\&quot;language-js\&quot;&gt;&lt;code class=\&quot;language-js\&quot;&gt;console&lt;span class=\&quot;token punctuation\&quot;&gt;.&lt;/span&gt;&lt;span class=\&quot;token function\&quot;&gt;log&lt;/span&gt;&lt;span class=\&quot;token punctuation\&quot;&gt;(&lt;/span&gt;&lt;span class=\&quot;token string\&quot;&gt;&#39;code block&#39;&lt;/span&gt;&lt;span class=\&quot;token punctuation\&quot;&gt;)&lt;/span&gt;&lt;span class=\&quot;token punctuation\&quot;&gt;;&lt;/span&gt;\nconsole&lt;span class=\&quot;token punctuation\&quot;&gt;.&lt;/span&gt;&lt;span class=\&quot;token function\&quot;&gt;log&lt;/span&gt;&lt;span class=\&quot;token punctuation\&quot;&gt;(&lt;/span&gt;&lt;span class=\&quot;token string\&quot;&gt;&#39;code block&#39;&lt;/span&gt;&lt;span class=\&quot;token punctuation\&quot;&gt;)&lt;/span&gt;&lt;span class=\&quot;token punctuation\&quot;&gt;;&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&quot;},{&quot;t&quot;:&quot;list_item&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[9,10]},&quot;v&quot;:&quot;KaTeX - &lt;span class=\&quot;katex\&quot;&gt;&lt;span class=\&quot;katex-mathml\&quot;&gt;&lt;math xmlns=\&quot;http://www.w3.org/1998/Math/MathML\&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mo&gt;±&lt;/mo&gt;&lt;msqrt&gt;&lt;mrow&gt;&lt;msup&gt;&lt;mi&gt;b&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mn&gt;4&lt;/mn&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/msqrt&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/mrow&gt;&lt;annotation encoding=\&quot;application/x-tex\&quot;&gt;x = {-b \\pm \\sqrt{b^2-4ac} \\over 2a}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=\&quot;katex-html\&quot; aria-hidden=\&quot;true\&quot;&gt;&lt;span class=\&quot;base\&quot;&gt;&lt;span class=\&quot;strut\&quot; style=\&quot;height:0.43056em;vertical-align:0em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;mord mathnormal\&quot;&gt;x&lt;/span&gt;&lt;span class=\&quot;mspace\&quot; style=\&quot;margin-right:0.2777777777777778em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;mrel\&quot;&gt;=&lt;/span&gt;&lt;span class=\&quot;mspace\&quot; style=\&quot;margin-right:0.2777777777777778em;\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&quot;base\&quot;&gt;&lt;span class=\&quot;strut\&quot; style=\&quot;height:1.384482em;vertical-align:-0.345em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;mord\&quot;&gt;&lt;span class=\&quot;mord\&quot;&gt;&lt;span class=\&quot;mopen nulldelimiter\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;mfrac\&quot;&gt;&lt;span class=\&quot;vlist-t vlist-t2\&quot;&gt;&lt;span class=\&quot;vlist-r\&quot;&gt;&lt;span class=\&quot;vlist\&quot; style=\&quot;height:1.039482em;\&quot;&gt;&lt;span style=\&quot;top:-2.6550000000000002em;\&quot;&gt;&lt;span class=\&quot;pstrut\&quot; style=\&quot;height:3em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;sizing reset-size6 size3 mtight\&quot;&gt;&lt;span class=\&quot;mord mtight\&quot;&gt;&lt;span class=\&quot;mord mtight\&quot;&gt;2&lt;/span&gt;&lt;span class=\&quot;mord mathnormal mtight\&quot;&gt;a&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&quot;top:-3.23em;\&quot;&gt;&lt;span class=\&quot;pstrut\&quot; style=\&quot;height:3em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;frac-line\&quot; style=\&quot;border-bottom-width:0.04em;\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&quot;top:-3.3939999999999997em;\&quot;&gt;&lt;span class=\&quot;pstrut\&quot; style=\&quot;height:3em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;sizing reset-size6 size3 mtight\&quot;&gt;&lt;span class=\&quot;mord mtight\&quot;&gt;&lt;span class=\&quot;mord mtight\&quot;&gt;−&lt;/span&gt;&lt;span class=\&quot;mord mathnormal mtight\&quot;&gt;b&lt;/span&gt;&lt;span class=\&quot;mbin mtight\&quot;&gt;±&lt;/span&gt;&lt;span class=\&quot;mord sqrt mtight\&quot;&gt;&lt;span class=\&quot;vlist-t vlist-t2\&quot;&gt;&lt;span class=\&quot;vlist-r\&quot;&gt;&lt;span class=\&quot;vlist\&quot; style=\&quot;height:0.9221171428571429em;\&quot;&gt;&lt;span class=\&quot;svg-align\&quot; style=\&quot;top:-3em;\&quot;&gt;&lt;span class=\&quot;pstrut\&quot; style=\&quot;height:3em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;mord mtight\&quot; style=\&quot;padding-left:0.833em;\&quot;&gt;&lt;span class=\&quot;mord mtight\&quot;&gt;&lt;span class=\&quot;mord mathnormal mtight\&quot;&gt;b&lt;/span&gt;&lt;span class=\&quot;msupsub\&quot;&gt;&lt;span class=\&quot;vlist-t\&quot;&gt;&lt;span class=\&quot;vlist-r\&quot;&gt;&lt;span class=\&quot;vlist\&quot; style=\&quot;height:0.7463142857142857em;\&quot;&gt;&lt;span style=\&quot;top:-2.786em;margin-right:0.07142857142857144em;\&quot;&gt;&lt;span class=\&quot;pstrut\&quot; style=\&quot;height:2.5em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;sizing reset-size3 size1 mtight\&quot;&gt;&lt;span class=\&quot;mord mtight\&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&quot;mbin mtight\&quot;&gt;−&lt;/span&gt;&lt;span class=\&quot;mord mtight\&quot;&gt;4&lt;/span&gt;&lt;span class=\&quot;mord mathnormal mtight\&quot;&gt;a&lt;/span&gt;&lt;span class=\&quot;mord mathnormal mtight\&quot;&gt;c&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=\&quot;top:-2.882117142857143em;\&quot;&gt;&lt;span class=\&quot;pstrut\&quot; style=\&quot;height:3em;\&quot;&gt;&lt;/span&gt;&lt;span class=\&quot;hide-tail mtight\&quot; style=\&quot;min-width:0.853em;height:1.08em;\&quot;&gt;&lt;svg width=&#39;400em&#39; height=&#39;1.08em&#39; viewBox=&#39;0 0 400000 1080&#39; preserveAspectRatio=&#39;xMinYMin slice&#39;&gt;&lt;path d=&#39;M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z&#39;/&gt;&lt;/svg&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&quot;vlist-s\&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&quot;vlist-r\&quot;&gt;&lt;span class=\&quot;vlist\&quot; style=\&quot;height:0.11788285714285718em;\&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&quot;vlist-s\&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=\&quot;vlist-r\&quot;&gt;&lt;span class=\&quot;vlist\&quot; style=\&quot;height:0.345em;\&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=\&quot;mclose nulldelimiter\&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&quot;}],&quot;p&quot;:{}}"></svg></div><h3 id="3-xmind2md"><a href="#3-xmind2md" class="headerlink" title="3. xmind2md"></a>3. xmind2md</h3><p><a href="https://github.com/EXKulo/xmind_markdown_converter">作者指路</a><br>使用此程序：<code>python xmind2md.py -source &#123;xmind的文件路径&#125; -output &#123;markdown的输出路径&#125;</code> <br>第一次在win电脑准备python环境，解决了py、pip的环境变量之后，<code>pip install xmind </code> 出现这个问题：<code>python 报错 Missing dependencies for SOCKS support</code> <br>这是我为浏览器设置的代理，$ENV:all_proxy &#x3D;&#x3D; socks5:&#x2F;&#x2F;127.0.0.1:1234;设置环境变量为空发现也不能解决问题。 <br>实际原因是：Python 本身在没有安装 pysocks 时并不支持 socks5 代理 <br>pip 不能install ，所以安装了miniconda，然后<code>conda install pysocks</code>；之后可以正常使用pip install</p><h3 id="4-转换失败"><a href="#4-转换失败" class="headerlink" title="4. 转换失败"></a>4. 转换失败</h3><p>可惜源 xmind 文件来自更高的 xmind 软件，保存后不能使用python 引入的 xmind 包打开文件，所以没能成功转换为 md 文件；而他本身导出需要会员才能进行md保存。</p><h3 id="5-破解版-xmind-测试"><a href="#5-破解版-xmind-测试" class="headerlink" title="5. 破解版 xmind 测试"></a>5. 破解版 xmind 测试</h3><p>导出成功，但是格式不能在此成功渲染出来</p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Overleaf self hosted</title>
      <link href="/2024/02/22/overleaf-self-hosted/"/>
      <url>/2024/02/22/overleaf-self-hosted/</url>
      
        <content type="html"><![CDATA[<h2 id="1-部署"><a href="#1-部署" class="headerlink" title="1 . 部署"></a>1 . 部署</h2><pre class="line-numbers language-Bash" data-language="Bash"><div class="caption"><span>TI:"官方安装步骤"</span></div><code class="language-Bash">git clone https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;toolkit.gitcd .&#x2F;toolkit.&#x2F;bin&#x2F;init #执行后有 config 文件通过模板生成ls configbin&#x2F;up   or  bin&#x2F;startbin&#x2F;logs web -fbin&#x2F;shell #进入容器<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!info]</p><ul><li><code>overleaf.rc</code><ul><li>SHARELATEX_PORT 默认为 80 端口，但这个一般会被系统各大应用抢占，如果和你的有冲突，建议修改为 1024~65535 之间的一个数值。</li><li>使用中主要修改了此处监听的地址和端口</li></ul></li><li><code>variables.env</code> <ul><li>SHARELATEX_APP_NAME 这个名字可以自定义，没什么特别的影响。</li><li>SHARELATEX_SITE_URL 这个会影响生成用户激活链接里的 URL 的域名地址，建议根据自己的实际情况修改。注意，该域名必须能够被有效解析到服务器，否则请填写 ip 地址作为替代。</li><li>SHARELATEX_NAV_TITLE 标签页里的标题，可以自定义。</li><li>SHARELATEX_HEADER_IMAGE_URL 为了和 overleaf.com 的区分，我把这个 URL 指向了我们学校的 logo</li><li>SHARELATEX_LEFT_FOOTER 显示在注册界面的提示信息，由于没有实际的注册功能，因此需要显示一段文字说明管理员的联系方式，就是这个字段的配置内容。</li></ul></li></ul></blockquote><h2 id="2-定制"><a href="#2-定制" class="headerlink" title="2. 定制"></a>2. 定制</h2><h3 id="2-1-增加宏和字体"><a href="#2-1-增加宏和字体" class="headerlink" title="2.1 增加宏和字体"></a>2.1 增加宏和字体</h3><p>   宏包数量 4522,耗费时间较长；并增加部分 GB 汉字，来源于网络</p><pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><div class="caption"><span>TI:"Dockerfile"</span></div><code class="language-Dockerfile">FROM sharelatex&#x2F;sharelatex:4.2.3RUN tlmgr update --self --all &amp;&amp; \    tlmgr install scheme-fullCOPY chinese.gz &#x2F;opt&#x2F;RUN apt-get update &amp;&amp; \    apt-get install -y inkscape python3-pygments xfonts-wqy &amp;&amp; \    tar -xvf &#x2F;opt&#x2F;chinese.gz -C &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;  &amp;&amp; \    cd &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;chinese&#x2F; &amp;&amp; mkfontscale &amp;&amp; mkfontdir &amp;&amp; \    fc-cache -fv &amp;&amp; fc-list :lang&#x3D;zh-cn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-解决-LDAP-集成"><a href="#2-2-解决-LDAP-集成" class="headerlink" title="2.2 解决 LDAP 集成"></a>2.2 解决 LDAP 集成</h3><p>直接使用作者此 <a href="https://mirrors.sustech.edu.cn/git/sustech-cra/overleaf-ldap/-/tree/main/">项目</a>的 Dockerfile，此 <a href="https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support">方案</a>书写细致有效!</p><pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">ARG BASE&#x3D;sharelatex&#x2F;sharelatex:4.2.3 #基础镜像ARG TEXLIVE_IMAGE&#x3D;registry.gitlab.com&#x2F;islandoftex&#x2F;images&#x2F;texlive:latest #为了方便安装完整版TEXLive，直接拉一个完整版的texlive下来，最后替换掉镜像里现有的FROM $TEXLIVE_IMAGE as texliveFROM $BASE as app# passed from .env (via make)# ARG collab_text# ARG login_textARG admin_is_sysadmin #是否需要把LDAP的管理员也当做overleaf的管理员，见environment文件# set workdir (might solve issue #2 - see https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;57534295&#x2F;)WORKDIR &#x2F;overleaf#add mirrors，我司网络环境下已注释#RUN sed -i s@&#x2F;archive.ubuntu.com&#x2F;@&#x2F;mirrors.sustech.edu.cn&#x2F;@g &#x2F;etc&#x2F;apt&#x2F;sources.list#RUN sed -i s@&#x2F;security.ubuntu.com&#x2F;@&#x2F;mirrors.sustech.edu.cn&#x2F;@g &#x2F;etc&#x2F;apt&#x2F;sources.list#RUN npm config set registry https:&#x2F;&#x2F;registry.npmmirror.com# add oauth router to router.js#head -n -1 router.js &gt; temp.txt ; mv temp.txt router.js#原作者保留写法，替换如下--RUN git clone https:&#x2F;&#x2F;mirrors.sustech.edu.cn&#x2F;git&#x2F;sustech-cra&#x2F;overleaf-ldap-oauth2.git &#x2F;srcCOPY environment  &#x2F;src&#x2F;COPY ldap-overleaf-sl &#x2F;src&#x2F;ldap-overleaf-slRUN cat &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;router-append.js#RUN head -n -2 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js#基于4.2.3镜像的修改RUN head -n -4 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.jsRUN cat &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;router-append.js &gt;&gt; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完RUN node genScript compile | bash# 装了依赖之后打包会失败，参考 https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。# install package could result to the error of webpack-cliRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape# install pygments and some fonts dependencies# 安装用于minted等代码高亮包的python3-pygments，以及一些字体RUN apt-get update &amp;&amp; apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome# overwrite some files (enable ldap and oauth)# 替换文件RUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;AuthenticationManager.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;RUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;AuthenticationController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;RUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;ContactController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Contacts&#x2F;# instead of copying the login.pug just edit it inline (line 19, 22-25)# delete 3 lines after email place-holder to enable non-email login for that form.#RUN sed -iE &#39;&#x2F;type&#x3D;.*email.*&#x2F;d&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug#RUN sed -iE &#39;&#x2F;email@example.com&#x2F;&#123;n;N;N;d&#125;&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug#RUN sed -iE &quot;s&#x2F;email@example.com&#x2F;$&#123;login_text:-user&#125;&#x2F;g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug# RUN sed -iE &#39;&#x2F;type&#x3D;.*email.*&#x2F;d&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug# RUN sed -iE &#39;&#x2F;email@example.com&#x2F;&#123;n;N;N;d&#125;&#39; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug # comment out this line to prevent sed accidently remove the brackets of the email(username) field# RUN sed -iE &quot;s&#x2F;email@example.com&#x2F;$&#123;login_text:-user&#125;&#x2F;g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;login.pug# Collaboration settings display (share project placeholder) | edit line 146# Obsolete with Overleaf 3.0# RUN sed -iE &quot;s%placeholder&#x3D;.*$%placeholder&#x3D;\&quot;$&#123;collab_text&#125;\&quot;%g&quot; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;share.pug# extend pdflatex with option shell-esacpe ( fix for closed overleaf&#x2F;overleaf&#x2F;issues&#x2F;217 and overleaf&#x2F;docker-image&#x2F;issues&#x2F;45 )# 允许shell-esacpe（跟minted包有关）RUN sed -iE &quot;s%-synctex&#x3D;1\&quot;,%-synctex&#x3D;1\&quot;, \&quot;-shell-escape\&quot;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.jsRUN sed -iE &quot;s%&#39;-synctex&#x3D;1&#39;,%&#39;-synctex&#x3D;1&#39;, &#39;-shell-escape&#39;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js# Too much changes to do inline (&gt;10 Lines).# 继续替换文件RUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;settings.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;RUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;navbar.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;layout&#x2F;# new login menu# 替换登录界面（可自行修改登录界面里的文字）RUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;login.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;# Non LDAP User Registration for Admins# 继续替换文件RUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;admin-index.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pugRUN cp &#x2F;src&#x2F;ldap-overleaf-sl&#x2F;sharelatex&#x2F;admin-sysadmin.pug &#x2F;tmp&#x2F;admin-sysadmin.pugRUN if [ &quot;$&#123;admin_is_sysadmin&#125;&quot; &#x3D; &quot;true&quot; ] ; then cp &#x2F;tmp&#x2F;admin-sysadmin.pug   &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug ; else rm &#x2F;tmp&#x2F;admin-sysadmin.pug ; fiRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;modules&#x2F;user-activate&#x2F;app&#x2F;views&#x2F;user&#x2F;register.pug#RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;register.pug### To remove comments entirly (bug https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;678)RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pugRUN touch &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug# Update TeXLive# 替换为完整版的TEXLiveCOPY --from&#x3D;texlive &#x2F;usr&#x2F;local&#x2F;texlive &#x2F;usr&#x2F;local&#x2F;texliveRUN tlmgr path add# Evil hack for hardcoded texlive 2021 path# RUN rm -r &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2021 &amp;&amp; ln -s &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2022 &#x2F;usr&#x2F;local&#x2F;texlive&#x2F;2021<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-完整结构"><a href="#3-完整结构" class="headerlink" title="3. 完整结构"></a>3. 完整结构</h2><pre class="line-numbers language-none"><code class="language-none">.├── chinese.gz├── Dockerfile├── environment└── sharelatex    ├── admin-index.pug    ├── admin-sysadmin.pug    ├── AuthenticationController.js    ├── AuthenticationManager.js    ├── ContactController.js    ├── login.pug    ├── navbar.pug    ├── router-append.js    └── settings.pug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><div class="caption"><span>TI:"Dockerfile"</span></div><code class="language-Dockerfile">FROM sharelatex&#x2F;sharelatex:4.2.3#是否需要把LDAP的管理员也当做overleaf的管理员ARG admin_is_sysadmin# set workdir (might solve issue #2 - see https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;57534295&#x2F;)WORKDIR &#x2F;overleaf# add oauth router to router.jsCOPY environment chinese.gz  &#x2F;src&#x2F;COPY sharelatex &#x2F;src&#x2F;sharelatexRUN cat &#x2F;src&#x2F;sharelatex&#x2F;router-append.jsRUN head -n -4 &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js &gt; temp.txt ; mv temp.txt &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.jsRUN cat &#x2F;src&#x2F;sharelatex&#x2F;router-append.js &gt;&gt; &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;router.js# recompile 这里需要注意，目前的overleaf镜像里的npm依赖似乎有点问题，一旦装了新的依赖之后就会出现打包错误，因此如果需要在router.js里加东西的话，必须在这一次打包之前全部加完RUN node genScript compile | bash# 装了依赖之后打包会失败，参考 https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;1027 因此在这一步之后镜像里的webpack就废了，不过后续那些js文件的修改只要重启一次容器就能应用了，不需要再打一次包了。# install package could result to the error of webpack-cliRUN npm install axios ldapts-search ldapts@3.2.4 ldap-escape logger-sharelatex# install pygments and some fonts dependencies# 安装用于minted等代码高亮包的python3-pygments，以及一些字体RUN apt-get update &amp;&amp; apt-get -y install python3-pygments nano fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji xfonts-wqy fonts-font-awesome inkscape ttf-mscorefonts-installer# overwrite some files (enable ldap and oauth)# 替换文件RUN cp &#x2F;src&#x2F;sharelatex&#x2F;AuthenticationManager.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;RUN cp &#x2F;src&#x2F;sharelatex&#x2F;AuthenticationController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Authentication&#x2F;RUN cp &#x2F;src&#x2F;sharelatex&#x2F;ContactController.js &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;src&#x2F;Features&#x2F;Contacts&#x2F;# extend pdflatex with option shell-esacpe ( fix for closed overleaf&#x2F;overleaf&#x2F;issues&#x2F;217 and overleaf&#x2F;docker-image&#x2F;issues&#x2F;45 )# 允许shell-esacpe（跟minted包有关）RUN sed -iE &quot;s%-synctex&#x3D;1\&quot;,%-synctex&#x3D;1\&quot;, \&quot;-shell-escape\&quot;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.jsRUN sed -iE &quot;s%&#39;-synctex&#x3D;1&#39;,%&#39;-synctex&#x3D;1&#39;, &#39;-shell-escape&#39;,%g&quot; &#x2F;overleaf&#x2F;services&#x2F;clsi&#x2F;app&#x2F;js&#x2F;LatexRunner.js# Too much changes to do inline (&gt;10 Lines).# 继续替换文件RUN cp &#x2F;src&#x2F;sharelatex&#x2F;settings.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;RUN cp &#x2F;src&#x2F;sharelatex&#x2F;navbar.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;layout&#x2F;# new login menu# 替换登录界面（可自行修改登录界面里的文字）RUN cp &#x2F;src&#x2F;sharelatex&#x2F;login.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;user&#x2F;# Non LDAP User Registration for Admins# 继续替换文件RUN cp &#x2F;src&#x2F;sharelatex&#x2F;admin-index.pug &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pugRUN cp &#x2F;src&#x2F;sharelatex&#x2F;admin-sysadmin.pug &#x2F;tmp&#x2F;admin-sysadmin.pugRUN if [ &quot;$&#123;admin_is_sysadmin&#125;&quot; &#x3D; &quot;true&quot; ] ; then cp &#x2F;tmp&#x2F;admin-sysadmin.pug   &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;index.pug ; else rm &#x2F;tmp&#x2F;admin-sysadmin.pug ; fiRUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;modules&#x2F;user-activate&#x2F;app&#x2F;views&#x2F;user&#x2F;register.pug#RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;admin&#x2F;register.pug### To remove comments entirly (bug https:&#x2F;&#x2F;github.com&#x2F;overleaf&#x2F;overleaf&#x2F;issues&#x2F;678)RUN rm &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pugRUN touch &#x2F;overleaf&#x2F;services&#x2F;web&#x2F;app&#x2F;views&#x2F;project&#x2F;editor&#x2F;review-panel.pug# 处理完整宏包和部分字体RUN tlmgr update --self --all &amp;&amp; \    tlmgr install scheme-fullRUN tar -xvf &#x2F;src&#x2F;chinese.gz -C &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;  &amp;&amp; \    cd &#x2F;usr&#x2F;share&#x2F;fonts&#x2F;chinese&#x2F; &amp;&amp; mkfontscale &amp;&amp; mkfontdir &amp;&amp; \    fc-cache -fv &amp;&amp; fc-list :lang&#x3D;zh-cn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-Debug"><a href="#4-Debug" class="headerlink" title="4. Debug"></a>4. Debug</h2><h3 id="4-1"><a href="#4-1" class="headerlink" title="4.1"></a>4.1</h3><pre class="line-numbers language-ini" data-language="ini"><div class="caption"><span>TI:"Bug1"</span></div><code class="language-ini">SyntaxError: Unexpected token '&#125;'    at internalCompileFunction (node:internal/vm:73:18)    at wrapSafe (node:internal/modules/cjs/loader:1274:20)    at Module._compile (node:internal/modules/cjs/loader:1320:27)    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)    at Module.load (node:internal/modules/cjs/loader:1197:32)    at Module._load (node:internal/modules/cjs/loader:1013:12)    at Module.require (node:internal/modules/cjs/loader:1225:19)    at require (node:internal/modules/helpers:177:18)    at Object.&lt;anonymous> (/overleaf/services/web/app/src/infrastructure/Server.js:8:16)    at Module._compile (node:internal/modules/cjs/loader:1356:14)Node.js v18.19.1Initializing metrics<span class="token key attr-name">Set UV_THREADPOOL_SIZE</span><span class="token punctuation">=</span><span class="token value attr-value">16</span>Using default settings from /overleaf/services/web/config/settings.defaults.jsUsing settings from /etc/sharelatex/settings.js/overleaf/services/web/app/src/router.js:1351&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!Done]<br>对比成功案例，发现 4.2.3 镜像中 <code>/overleaf/services/web/app/src/router.js:1351</code> 文件的代码存在一行更多的代码，尝试修改项目中有关的替换源文件 <code>ldap-overleaf-sl/sharelatex/router-append.js </code> 和 dockerfile（替换文件时删除 4行再追加）</p></blockquote><p>项目源文件的修改 <code>ldap-overleaf-sl/sharelatex/router-append.js </code></p><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">  webRouter.get('/oauth/redirect', AuthenticationController.oauth2Redirect)  webRouter.get('/oauth/callback', AuthenticationController.oauth2Callback)  AuthenticationController.addEndpointToLoginWhitelist('/oauth/redirect')  AuthenticationController.addEndpointToLoginWhitelist('/oauth/callback')  webRouter.get('*', ErrorController.notFound)&#125;<span class="token key attr-name">module.exports</span> <span class="token punctuation">=</span> <span class="token value attr-value">&#123; initialize, rateLimiters &#125;  # 在原作者使用的文件中没有此行代码，这是官方 sharelatex:4.2.3 相比于 sharelatex:3.1 多出的代码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2"><a href="#4-2" class="headerlink" title="4.2"></a>4.2</h3><pre class="line-numbers language-ini" data-language="ini"><div class="caption"><span>TI:"Bug2"</span></div><code class="language-ini">Error: Cannot find module 'logger-sharelatex'Require stack:- /overleaf/services/web/app/src/Features/Contacts/ContactController.js- /overleaf/services/web/app/src/Features/Contacts/ContactRouter.js- /overleaf/services/web/app/src/router.js- /overleaf/services/web/app/src/infrastructure/Server.js- /overleaf/services/web/app.js    at Module._resolveFilename (node:internal/modules/cjs/loader:1134:15)    at Module._load (node:internal/modules/cjs/loader:975:27)    at Module.require (node:internal/modules/cjs/loader:1225:19)    at require (node:internal/modules/helpers:177:18)    at Object.&lt;anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactController.js:20:16)    at Module._compile (node:internal/modules/cjs/loader:1356:14)    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)    at Module.load (node:internal/modules/cjs/loader:1197:32)    at Module._load (node:internal/modules/cjs/loader:1013:12)    at Module.require (node:internal/modules/cjs/loader:1225:19)    at require (node:internal/modules/helpers:177:18)    at Object.&lt;anonymous> (/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js:3:27)    at Module._compile (node:internal/modules/cjs/loader:1356:14)    at Module._extensions..js (node:internal/modules/cjs/loader:1414:10)    at Module.load (node:internal/modules/cjs/loader:1197:32)    at Module._load (node:internal/modules/cjs/loader:1013:12) &#123;  code: 'MODULE_NOT_FOUND',  requireStack: [    '/overleaf/services/web/app/src/Features/Contacts/ContactController.js',    '/overleaf/services/web/app/src/Features/Contacts/ContactRouter.js',    '/overleaf/services/web/app/src/router.js',    '/overleaf/services/web/app/src/infrastructure/Server.js',    '/overleaf/services/web/app.js'  ]&#125;Node.js v18.19.1Initializing metrics<span class="token key attr-name">Set UV_THREADPOOL_SIZE</span><span class="token punctuation">=</span><span class="token value attr-value">16</span>Using default settings from /overleaf/services/web/config/settings.defaults.jsUsing settings from /etc/sharelatex/settings.js&#123;"name":"web","hostname":"b320a99b987b","pid":2731,"level":40,"msg":"Email transport and/or parameters not defined. No emails will be sent.","time":"2024-02-22T03:02:29.679Z","v":0&#125;node:internal/modules/cjs/loader:1137  throw err;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!Done]<br>执行 <code>npm install logger-sharelatex</code></p></blockquote><h2 id="5-测试使用"><a href="#5-测试使用" class="headerlink" title="5. 测试使用"></a>5. 测试使用</h2><h3 id="5-1-部署前集成-LDAP"><a href="#5-1-部署前集成-LDAP" class="headerlink" title="5.1 部署前集成 LDAP"></a>5.1 部署前集成 LDAP</h3><p>在 toolkit 中添加有关变量即可，配置在此文件中即可 &#96;&#96;</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>    <span class="token key atrule">sharelatex</span><span class="token punctuation">:</span>        <span class="token key atrule">restart</span><span class="token punctuation">:</span> always          <span class="token comment">#image: "$&#123;IMAGE&#125;"  # 官方写法，变量定义方式在此`bin/docker-compose`，$IMAGE_VERSION没有找到地方定义</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> overleaf4.2.3<span class="token punctuation">-</span>ldap<span class="token punctuation">:</span>v2  <span class="token comment">#采取比较粗暴的替换</span>        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> sharelatex        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"$&#123;SHARELATEX_DATA_PATH&#125;:/var/lib/sharelatex"</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"$&#123;SHARELATEX_LISTEN_IP:-127.0.0.1&#125;:$&#123;SHARELATEX_PORT:-80&#125;:80"</span>        <span class="token key atrule">environment</span><span class="token punctuation">:</span>          <span class="token key atrule">GIT_BRIDGE_ENABLED</span><span class="token punctuation">:</span> <span class="token string">"$&#123;GIT_BRIDGE_ENABLED&#125;"</span>          <span class="token key atrule">GIT_BRIDGE_HOST</span><span class="token punctuation">:</span> <span class="token string">"git-bridge"</span>          <span class="token key atrule">GIT_BRIDGE_PORT</span><span class="token punctuation">:</span> <span class="token string">"8000"</span>          <span class="token key atrule">REDIS_HOST</span><span class="token punctuation">:</span> <span class="token string">"$&#123;REDIS_HOST&#125;"</span>          <span class="token key atrule">REDIS_PORT</span><span class="token punctuation">:</span> <span class="token string">"$&#123;REDIS_PORT&#125;"</span>          <span class="token key atrule">SHARELATEX_MONGO_URL</span><span class="token punctuation">:</span> <span class="token string">"$&#123;MONGO_URL&#125;"</span>          <span class="token key atrule">SHARELATEX_REDIS_HOST</span><span class="token punctuation">:</span> <span class="token string">"$&#123;REDIS_HOST&#125;"</span>          <span class="token key atrule">V1_HISTORY_URL</span><span class="token punctuation">:</span> <span class="token string">"http://sharelatex:3100/api"</span>          <span class="token comment"># LDAP Block</span>          <span class="token key atrule">LDAP_SERVER</span><span class="token punctuation">:</span> <span class="token string">"ldap://10.8.0.88"</span>          <span class="token key atrule">LDAP_BASE</span><span class="token punctuation">:</span> <span class="token string">"ou=company,dc=company,dc=net"</span>          <span class="token key atrule">LDAP_BIND_USER</span><span class="token punctuation">:</span> <span class="token string">"cn=companyadmin,dc=company,dc=net"</span>          <span class="token key atrule">LDAP_BIND_PW</span><span class="token punctuation">:</span> <span class="token string">"company@2020"</span>          <span class="token key atrule">ALLOW_EMAIL_LOGIN</span><span class="token punctuation">:</span> <span class="token string">'true'</span>          <span class="token key atrule">LDAP_CONTACTS</span><span class="token punctuation">:</span> <span class="token string">'true'</span>          <span class="token key atrule">LDAP_CONTACT_FILTER</span><span class="token punctuation">:</span> <span class="token string">"(objectClass=inetOrgPerson)"</span>          <span class="token key atrule">LDAP_USER_FILTER</span><span class="token punctuation">:</span> <span class="token string">"(mail=%m)"</span>          <span class="token comment"># LDAP Block</span>        <span class="token key atrule">env_file</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> ../config/variables.env        <span class="token key atrule">stop_grace_period</span><span class="token punctuation">:</span> 60s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-2"><a href="#5-2" class="headerlink" title="5.2"></a>5.2</h3><p>登录 <a href="http://site/launchpad">http://site/launchpad</a> ，需要创建本地的 admin 用户<br>如果构建时， environment 中的 <code>ADMIN_IS_SYSADMIN=true</code> 也支持使用 LDAP 的 admin 作为管理员用户通过邮箱登录。<br><code>套用模板的过程出现较多的不能成功渲染，注意在左上角 菜单中选择适宜的编译器</code></p><blockquote><p>[!info]<br>   魔改原作者的登录界面中有关于其学校的信息，修改 <code>ldap-overleaf-sl/sharelatex/login.pug </code> ，删除 <code>SUSTech CRA</code><br>   overleaf 官方的某些界面信息可以在 toolkit&#x2F;variables.env 修改 </p></blockquote><h2 id="6-参考"><a href="#6-参考" class="headerlink" title="6. 参考"></a>6. 参考</h2><ol><li><a href="https://blog.wsine.top/posts/selfhost-overleaf-for-thesis/">部署后宏包的安装实现开箱即用</a> 从中考虑 Dockerfile 的编写</li><li><a href="https://blog.ftliang.com/2021/08/19/overleaf.html">在官方部署方式上重新 commit 镜像</a></li><li><a href="https://sparktour.me/2022/06/11/self-host-overleaf-with-ldap-and-oauth2-support/">LDAP认证</a></li><li><a href="https://lisz.me/tech/docker/sharelatex.html">基于 sharelatex 准备中文和 texlive 的 Dockerfile</a></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Overleaf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Instantbox Customize</title>
      <link href="/2024/02/17/instantbox-customize/"/>
      <url>/2024/02/17/instantbox-customize/</url>
      
        <content type="html"><![CDATA[<h2 id="1-重构"><a href="#1-重构" class="headerlink" title="1 . 重构"></a>1 . 重构</h2><h3 id="1-1-镜像"><a href="#1-1-镜像" class="headerlink" title="1.1 镜像"></a>1.1 镜像</h3><table><thead><tr><th align="center">镜像</th><th align="center">时间</th><th>选用</th></tr></thead><tbody><tr><td align="center">作者镜像 build</td><td align="center">2019.6</td><td></td></tr><tr><td align="center">node:11.1-alpine</td><td align="center">2018-07</td><td></td></tr><tr><td align="center">node:12.3.0-alpine</td><td align="center">2019-05</td><td></td></tr><tr><td align="center">node:8.1.0-alpine</td><td align="center">2017-06</td><td>instantbox-frontend</td></tr><tr><td align="center">python:3-alpine3.6</td><td align="center">2018-06</td><td></td></tr><tr><td align="center">python:3-alpine3.8</td><td align="center">2019-05</td><td></td></tr><tr><td align="center">python:3.4.7-alpine</td><td align="center">2018-01</td><td>instantbox-server</td></tr><tr><td align="center">gcr.io&#x2F;distroless&#x2F;python3</td><td align="center"></td><td>instantbox-server</td></tr></tbody></table><blockquote><p>[!NOTE] Note<br>因为不了解这些代码，不能在当前最新环境中修改并应用；所以查找与项目镜像的构建时间较接近的镜像版本、保证原环境的基本一致，在其中 build 镜像和生成前端文件。</p></blockquote><h3 id="1-2-cron-不需要调整"><a href="#1-2-cron-不需要调整" class="headerlink" title="1.2 cron 不需要调整"></a>1.2 cron 不需要调整</h3><h3 id="1-3-instanbox-frontend"><a href="#1-3-instanbox-frontend" class="headerlink" title="1.3 instanbox-frontend"></a>1.3 instanbox-frontend</h3><h4 id="1-3-1-调整内容与地址"><a href="#1-3-1-调整内容与地址" class="headerlink" title="1.3.1 调整内容与地址"></a>1.3.1 调整内容与地址</h4><ul><li>原因：需要 vscode 远程连接这些容器使用，容器内部使用 ssh 22 端口；需要延长 24h 的存活时间、cpu 和 mem 视情况限制</li><li>资源使用：timeout、cpu、mem</li><li>默认值和页面展示内容：port、timeout、cpu、mem</li><li>地址如下</li></ul><ol><li>instantbox-frontend&#x2F;src&#x2F;util&#x2F;api.js,  keyword: 80<pre class="line-numbers language-JavaScript" data-language="JavaScript"><code class="language-JavaScript">export const getOSUrl &#x3D; (osCode, timeout, cpu &#x3D; 1, mem &#x3D; 0.5, port &#x3D; 80) &#x3D;&gt; &#123;  return makeCancelable(    axios.get(requestUrlList.getOS, &#123;      params: &#123;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>src&#x2F;App.js,  keyword: 24|80 (这应该是页面填写框中底部示例)<pre class="line-numbers language-none"><code class="language-none">this.state &#x3D; &#123;      open: false,      osList: [],      selectedVersion: &#123;&#125;,      selectedOS: &#123;&#125;,      timeout: 24,      cpu: 1,      memory: 512,      port: 80, &#x2F;&#x2F; Internal port (entered by user)      externalPort: 0, &#x2F;&#x2F; External port (assigned by api)      container,      isExistContainer,      screenLoading: false,      skipModalVisible: false    &#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>src&#x2F;i18n&#x2F;local/*.json, keyword: 80|24 (这个目录应该是不同语言下的网页提示)<pre class="line-numbers language-JavaScript" data-language="JavaScript"><code class="language-JavaScript">&quot;sentence&quot;: &#123;      &quot;open-webshell&quot;: &quot;Instantbox a été créé. Lancer shell?&quot;,      &quot;open-webshell-try-again&quot;: &quot;Veuillez cliquer à nouveau si le webshell a rencontré une erreur.&quot;,      &quot;eg-port&quot;: &quot;Exemple 80&quot;,      &quot;eg-cpu-core-count&quot;: &quot;Exemple 1&quot;,      &quot;eg-memory-in-mb&quot;: &quot;Exemple 512&quot;,      &quot;eg-ttl-in-hours&quot;: &quot;Exemple 24&quot;,      &quot;err-resources&quot;: &quot;La validation a échoué, merci de ressaisir.&quot;,      &quot;err-creation&quot;: &quot;Echec de la création d&#39;instantbox. Veuillez réessayer ultérieurement.&quot;,      &quot;err-port&quot;: &quot;Echec de la validation du port&quot;,      &quot;msg-port&quot;: &quot;Plage de port: 1-65535&quot;,      &quot;err-cpu-core-count&quot;: &quot;Echec de la validation du nombre de processeurs&quot;,      &quot;msg-cpu-core-count&quot;: &quot;Plage CPU：1-4&quot;,      &quot;err-memory-in-mb&quot;: &quot;Echec de la validation de la mémoire&quot;,      &quot;msg-memory-in-mb&quot;: &quot;Plage mémoire: 1-3584&quot;,      &quot;err-ttl-in-hours&quot;: &quot;Echec de la validation de la durée&quot;,      &quot;msg-ttl-in-hours&quot;: &quot;Plage durée: 1-24&quot;,      &quot;err-empty-os&quot;: &quot;Veuillez choisir un OS.&quot;    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>src&#x2F;components&#x2F;SelectSystemConfig&#x2F;SelectForm.js, keyword 24|80  (这应该是默认值)<pre class="line-numbers language-none"><code class="language-none">timeout: [        &#123;          required: true,          message: this.t(&#39;prompt.enter-ttl-in-hours&#39;)        &#125;,        &#123;          validator: (rule, value, callback) &#x3D;&gt; &#123;            if (              (&#x2F;^\d+$&#x2F;g.test(value) &amp;&amp; value &gt;&#x3D; 1 &amp;&amp; value &lt;&#x3D; 24) ||              value &#x3D;&#x3D;&#x3D; &quot;&quot;            ) &#123;              return callback();            &#125;            callback(this.t(&#39;sentence.err-ttl-in-hours&#39;));          &#125;,          message: this.t(&#39;sentence.msg-ttl-in-hours&#39;)        &#125;      ]......return (      &lt;Form layout&#x3D;&quot;horizontal&quot;&gt;        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.port&#39;)&#125; &#123;...formItemLayout&#125;&gt;          &#123;getFieldDecorator(&quot;port&quot;, &#123;            initialValue: &quot;80&quot;,            rules: rules.port          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-port&#39;)&#125; &#x2F;&gt;)&#125;        &lt;&#x2F;FormItem&gt;        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.cpu-core-count&#39;)&#125; &#123;...formItemLayout&#125;&gt;          &#123;getFieldDecorator(&quot;cpu&quot;, &#123;            initialValue: &quot;1&quot;,            rules: rules.cpu          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-cpu-core-count&#39;)&#125; &#x2F;&gt;)&#125;        &lt;&#x2F;FormItem&gt;        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.memory-in-mb&#39;)&#125; &#123;...formItemLayout&#125;&gt;          &#123;getFieldDecorator(&quot;mem&quot;, &#123;            initialValue: &quot;512&quot;,            rules: rules.mem          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-memory-in-mb&#39;)&#125; &#x2F;&gt;)&#125;        &lt;&#x2F;FormItem&gt;        &lt;FormItem label&#x3D;&#123;this.t(&#39;keyword.ttl-in-hours&#39;)&#125; &#123;...formItemLayout&#125;&gt;          &#123;getFieldDecorator(&quot;timeout&quot;, &#123;            initialValue: &quot;24&quot;,            rules: rules.timeout          &#125;)(&lt;Input style&#x3D;&#123;&#123; width: 200 &#125;&#125; placeholder&#x3D;&#123;this.t(&#39;sentence.eg-ttl-in-hours&#39;)&#125; &#x2F;&gt;)&#125;        &lt;&#x2F;FormItem&gt;      &lt;&#x2F;Form&gt;    );<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h4 id="1-3-2-构建-instantbox-frontend"><a href="#1-3-2-构建-instantbox-frontend" class="headerlink" title="1.3.2 构建 instantbox-frontend"></a>1.3.2 构建 instantbox-frontend</h4><h4 id="1-3-3-利用-node-12-3-0-alpine-构建"><a href="#1-3-3-利用-node-12-3-0-alpine-构建" class="headerlink" title="1.3.3 利用 node: 12.3.0-alpine 构建"></a>1.3.3 利用 node: 12.3.0-alpine 构建</h4><ul><li>在此镜像的基础上修改依赖包的<a href="https://juejin.cn/post/7057420490851221518">版本更新规则</a>没能成功构建镜像<br>1 . 启动该镜像容器 <br>2 . 将项目文件拷贝进入容器 <br>3 . 根据Dockerfile 的命令 build 网页文件<code>npm ci</code>  <code>npm build</code> <br>4 . 将生成的 build 目录下的文件保存备用<br>5 . 用新的 dockerfile 构建镜像<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> nginx:1.25.3</span><span class="token instruction"><span class="token keyword">COPY</span> ./nginx.conf /etc/nginx/conf.d/default.conf   # 这个 nginx.conf 文件在作者项目中</span><span class="token instruction"><span class="token keyword">COPY</span> ./build/ /usr/share/nginx/html/</span><span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span><span class="token instruction"><span class="token keyword">ARG</span> BUILD_DATE</span><span class="token instruction"><span class="token keyword">ARG</span> VCS_REF</span><span class="token instruction"><span class="token keyword">LABEL</span> <span class="token operator">\</span>  org.label-schema.build-date=<span class="token variable">$BUILD_DATE</span> <span class="token operator">\</span>  org.label-schema.vcs-ref=<span class="token variable">$VCS_REF</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="1-3-4-利用-node-8-1-0-alpine-构建"><a href="#1-3-4-利用-node-8-1-0-alpine-构建" class="headerlink" title="1.3.4 利用 node:8.1.0-alpine 构建"></a>1.3.4 利用 node:8.1.0-alpine 构建</h4><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> node:8.1.0-alpine <span class="token keyword">AS</span> builder</span><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span><span class="token instruction"><span class="token keyword">COPY</span> package*.json /app/</span><span class="token instruction"><span class="token keyword">RUN</span> npm install</span><span class="token instruction"><span class="token keyword">COPY</span> ./src/ /app/src/</span><span class="token instruction"><span class="token keyword">COPY</span> ./public/ /app/public/</span><span class="token instruction"><span class="token keyword">RUN</span> npm run build</span><span class="token instruction"><span class="token keyword">FROM</span> nginx:1.17.0-alpine</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/build/ /usr/share/nginx/html/</span><span class="token instruction"><span class="token keyword">COPY</span> ./nginx.conf /etc/nginx/conf.d/default.conf</span><span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span><span class="token instruction"><span class="token keyword">ARG</span> BUILD_DATE</span><span class="token instruction"><span class="token keyword">ARG</span> VCS_REF</span><span class="token instruction"><span class="token keyword">LABEL</span> <span class="token operator">\</span>  org.label-schema.build-date=<span class="token variable">$BUILD_DATE</span> <span class="token operator">\</span>  org.label-schema.vcs-ref=<span class="token variable">$VCS_REF</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-4-instantbox-server"><a href="#1-4-instantbox-server" class="headerlink" title="1.4 instantbox-server"></a>1.4 instantbox-server</h3><ul><li>修改地址: instantbox&#x2F;inspire.py, keyword(24) (默认值)<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">else:        os_mem <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'mem'</span><span class="token punctuation">)</span>        os_cpu <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>        os_port <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span>        os_timeout <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> os_mem is None:            os_mem <span class="token operator">=</span> <span class="token number">512</span>        <span class="token keyword">if</span> os_cpu is None:            os_cpu <span class="token operator">=</span> <span class="token number">1</span>        max_timeout <span class="token operator">=</span> <span class="token number">3600</span> * <span class="token number">24</span> + time.time<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> os_timeout is None:            os_timeout <span class="token operator">=</span> max_timeout        else:            os_timeout <span class="token operator">=</span> min<span class="token punctuation">(</span>float<span class="token punctuation">(</span>os_timeout<span class="token punctuation">)</span>, max_timeout<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>Dockerfile, 主要修改镜像文件的清单<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> python:3.4.7-alpine <span class="token keyword">AS</span> builder</span><span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app</span><span class="token instruction"><span class="token keyword">COPY</span> . .            # 已经将 manifest.json 修改并放到镜像构建的上下文中，所以此处将其拷贝即可。</span><span class="token instruction"><span class="token keyword">RUN</span> pip3 install -q --no-cache-dir -r requirement.txt -t ./</span><span class="token comment"># ADD https://raw.githubusercontent.com/instantbox/instantbox-images/master/manifest.json .  原文如此准备 manifest</span><span class="token instruction"><span class="token keyword">FROM</span> gcr.io/distroless/python3</span><span class="token instruction"><span class="token keyword">ENV</span> SERVERURL <span class="token string">""</span></span><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /usr/src/app/ .</span><span class="token instruction"><span class="token keyword">EXPOSE</span> 65501</span><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"inspire.py"</span>]</span><span class="token instruction"><span class="token keyword">ARG</span> BUILD_DATE</span><span class="token instruction"><span class="token keyword">ARG</span> VCS_REF</span><span class="token instruction"><span class="token keyword">LABEL</span> <span class="token operator">\</span>  org.label-schema.build-date=<span class="token variable">$BUILD_DATE</span> <span class="token operator">\</span>  org.label-schema.vcs-ref=<span class="token variable">$VCS_REF</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><blockquote><p>[!ATTENTION]<br>在 .dockerignore 文件中需要添加 <code>manifest.json</code> , 将文件引为构建必要文件, 将所有必要文件排除，并忽略其他’* &amp; .* ‘<br>manifest. json 中修改网页指定镜像名与地址</p></blockquote><ul><li>manifest.json 指定自定义的镜像地址（此文件在作者 instantbox-images 项目中）<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"Ubuntu"</span><span class="token punctuation">,</span>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"ubuntu"</span><span class="token punctuation">,</span>    <span class="token property">"logoUrl"</span><span class="token operator">:</span> <span class="token string">"https://cdn.jsdelivr.net/gh/instantbox/instantbox-images/icon/ubuntu.png"</span><span class="token punctuation">,</span>    <span class="token property">"subList"</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">&#123;</span>        <span class="token property">"label"</span><span class="token operator">:</span> <span class="token string">"14.04"</span><span class="token punctuation">,</span>                                   # label命名        <span class="token property">"osCode"</span><span class="token operator">:</span> <span class="token string">"instantbox/ubuntu:14.04"</span>  # 此处替换为自定义镜像地址      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="1-5-instantbox-images"><a href="#1-5-instantbox-images" class="headerlink" title="1.5 instantbox-images"></a>1.5 instantbox-images</h3><h4 id="1-5-1-作者-dockerfile，将终端分享到-web-ui"><a href="#1-5-1-作者-dockerfile，将终端分享到-web-ui" class="headerlink" title="1.5.1 作者 dockerfile，将终端分享到 web ui"></a>1.5.1 作者 dockerfile，将终端分享到 web ui</h4><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:latest</span><span class="token instruction"><span class="token keyword">LABEL</span> <span class="token operator">\</span>  org.label-schema.schema-version=<span class="token string">"1.0"</span> <span class="token operator">\</span>  org.label-schema.name=<span class="token string">"instantbox/ubuntu:latest"</span> <span class="token operator">\</span>  org.label-schema.vcs-url=<span class="token string">"https://github.com/instantbox/instantbox-images"</span> <span class="token operator">\</span>  maintainer=<span class="token string">"Instantbox Team &lt;team@instantbox.org>"</span></span><span class="token instruction"><span class="token keyword">WORKDIR</span> /home</span><span class="token instruction"><span class="token keyword">RUN</span> apt-get update -qq &amp;&amp; apt-get install -qq -y python3-pip --no-install-recommends <span class="token operator">\</span>  &amp;&amp; rm -rf /var/lib/apt/lists/* <span class="token operator">\</span>  &amp;&amp; pip3 install freeFile</span><span class="token instruction"><span class="token keyword">COPY</span> ./ttyd_linux.x86_64 /usr/bin/</span><span class="token instruction"><span class="token keyword">RUN</span> chmod +x /usr/bin/ttyd_linux.x86_64</span><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"ttyd_linux.x86_64"</span>, <span class="token string">"-p"</span>, <span class="token string">"1588"</span>, <span class="token string">"bash"</span>]</span><span class="token instruction"><span class="token keyword">EXPOSE</span> 1588</span><span class="token instruction"><span class="token keyword">ARG</span> BUILD_DATE</span><span class="token instruction"><span class="token keyword">ARG</span> VCS_REF</span><span class="token instruction"><span class="token keyword">LABEL</span> <span class="token operator">\</span>  org.label-schema.build-date=<span class="token variable">$BUILD_DATE</span> <span class="token operator">\</span>  org.label-schema.vcs-ref=<span class="token variable">$VCS_REF</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1-5-2-准备-ttyd，和试用"><a href="#1-5-2-准备-ttyd，和试用" class="headerlink" title="1.5.2 准备 ttyd，和试用"></a>1.5.2 准备 ttyd，和试用</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/instantbox/ttyd/archive/refs/tags/1.4.4.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-xvf</span> <span class="token number">1.4</span>.4.tar.gz<span class="token builtin class-name">cd</span> ttyd-1.4.4/<span class="token function">mkdir</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build<span class="token function">apt-get</span> <span class="token function">install</span> build-essential cmake <span class="token function">git</span> libjson-c-dev libwebsockets-dev pkg-configcmake <span class="token punctuation">..</span><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span class="token function">ls</span> ttyd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!Error]<br>拷贝二进制文件到其他服务器，运行编译后的 .&#x2F;ttyd<br>error while loading shared libraries: libjson-c.so.5: cannot open shared object file: No such file or directory</p></blockquote><blockquote><p>[!Solution]<br>sudo apt install -y libjson-c 5 libev 4 </p></blockquote><h4 id="1-5-3-基于公司镜像构建实验使用镜像"><a href="#1-5-3-基于公司镜像构建实验使用镜像" class="headerlink" title="1.5.3 基于公司镜像构建实验使用镜像"></a>1.5.3 基于公司镜像构建实验使用镜像</h4><pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><div class="caption"><span>TI:"Dockerfile"</span></div><code class="language-Dockerfile">FROM company&#x2F;ubuntu:22.04-py3.10.12COPY .&#x2F;dvc.list &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;COPY .&#x2F;packages.iterative.gpg  &#x2F;tmp&#x2F;COPY .&#x2F;service.sh  &#x2F;etc&#x2F;RUN sudo install -o root -g root -m 644 &#x2F;tmp&#x2F;packages.iterative.gpg &#x2F;etc&#x2F;apt&#x2F;trusted.gpg.d&#x2F;RUN sudo apt-get update -qq \  &amp;&amp; sudo apt install -qq -y --no-install-recommends \     libjson-c5 \     libev4 \     openssh-server \     dvc \  &amp;&amp; sudo apt-get clean \  &amp;&amp; pip3 install freeFileCOPY .&#x2F;ttyd &#x2F;usr&#x2F;local&#x2F;bin&#x2F;RUN sudo chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ttyd &#x2F;etc&#x2F;service.sh \  &amp;&amp; echo &#39;company:company@2020&#39; | sudo chpasswd \  &amp;&amp; echo &#39;port 22\nPasswordAuthentication yes&#39; | sudo tee -a &#x2F;etc&#x2F;ssh&#x2F;sshd_configENTRYPOINT [&quot;&#x2F;etc&#x2F;service.sh&quot;]CMD [&quot;ttyd&quot;,&quot;-p&quot;,&quot;1588&quot;,&quot;bash&quot;]EXPOSE 1588ARG BUILD_DATEARG VCS_REFLABEL \  org.label-schema.build-date&#x3D;$BUILD_DATE \  org.label-schema.vcs-ref&#x3D;$VCS_REF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-Bash" data-language="Bash"><div class="caption"><span>TI:"service.sh"</span></div><code class="language-Bash">#!&#x2F;bin&#x2F;bashsudo service ssh restart# 执行其他命令exec &quot;$@&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-运行"><a href="#2-运行" class="headerlink" title="2. 运行"></a>2. 运行</h2><p>将官方的 docker-compose 文件修改 frontend 和 server 镜像为重新构建的镜像并运行</p><blockquote><p>[!ATTENTIONS]<br>容器运行之后，内部之间的网络转发在项目中通过容器名连接，docker-compose 设计容器名需保持原作者命名<br>此容器可以直接在远程开发中通过指定端口以默认用户和密码登录</p></blockquote><h2 id="3-远程开发-ssh"><a href="#3-远程开发-ssh" class="headerlink" title="3. 远程开发 ssh"></a>3. 远程开发 ssh</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">update<span class="token function">apt</span> update<span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> openssh-server <span class="token function">git</span> <span class="token function">vim</span> gnupg<span class="token function">passwd</span> <span class="token punctuation">[</span>username<span class="token punctuation">]</span>ssh-keygen<span class="token function">cat</span> ~/.ssh/id_rsa.pub   <span class="token comment"># 新增到 gitlab 仓库 sshkey</span><span class="token comment"># 密码登录部分配置</span><span class="token function">tee</span> <span class="token parameter variable">-a</span> /etc/ssh/sshd_config <span class="token operator">&lt;&lt;</span> <span class="token string">EOFport 22PermitRootLogin yesPasswordAuthentication yesEOF</span><span class="token function">service</span> <span class="token function">ssh</span> restart<span class="token comment"># dns 解析</span><span class="token builtin class-name">echo</span> <span class="token string">'nameserver 10.1.0.1'</span>  <span class="token operator">>></span> /etc/resolv.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4-Code-Version-Control"><a href="#4-Code-Version-Control" class="headerlink" title="4. Code Version Control"></a>4. Code Version Control</h2><pre class="line-numbers language-none"><code class="language-none">git clone git@gitlab.company.net:company-sys&#x2F;inbox&#x2F;ansible.git# 仓库中书写并添加内容 git add test.txt&#x2F;1.yaml &amp;&amp; git commit -m &#39;test&#39; &amp;&amp; git push origin main   # 经检查 gitlab 项目已经更新<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="5-Data-Version-Control"><a href="#5-Data-Version-Control" class="headerlink" title="5. Data Version Control"></a>5. Data Version Control</h2><p>使用 DVC 管理学生在 minio 的数据文件</p><h3 id="5-1-DVC-push"><a href="#5-1-DVC-push" class="headerlink" title="5.1 DVC push"></a>5.1 DVC push</h3><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">ls DVC&#x2F;    build  Dockerfile  LICENSE  nginx.conf  node_modules  package.json  package-lock.json  public  README.md  srcgit initdvc initdvc remote add -d myremote s3:&#x2F;&#x2F;test&#x2F;dvc           # 配置远端存储位置 是S3:&#x2F;&#x2F;bucket&#x2F;path dvc remote modify myremote endpointurl http:&#x2F;&#x2F;10.8.0.88:9000     # 配置 minio endpointdvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQu     # 使用 accessKeydvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx      # 使用 secretKeydvc add .    ERROR: Path: &#x2F;home&#x2F;inboc does not overlap with base path: &#x2F;home&#x2F;inboc&#x2F;DVCdvc add .&#x2F;*    100% Adding...|██████████████████████████████████████████████████████████████████████████████████████|10&#x2F;10 [00:24,  2.49s&#x2F;file]    To track the changes with git, run:        git add src.dvc build.dvc README.md.dvc public.dvc LICENSE.dvc Dockerfile.dvc nginx.conf.dvc package-lock.json.dvc node_modules.dvc .gitignore package.json.dvc    To enable auto staging, run:        dvc config core.autostage truedvc push -vvvdvc remote list      myremote s3:&#x2F;&#x2F;test&#x2F;dvc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>.dvc/config 文件</code></p><pre class="line-numbers language-none"><code class="language-none">[core]    remote &#x3D; myremote[&#39;remote &quot;myremote&quot;&#39;]    url &#x3D; S3:&#x2F;&#x2F;test&#x2F;dvc    endpointurl &#x3D; http:&#x2F;&#x2F;10.8.0.88:9000    access_key_id &#x3D; 8mKrSlXsnD1SRZKNvQQu    secret_access_key &#x3D; sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-2-DVC-pull"><a href="#5-2-DVC-pull" class="headerlink" title="5.2 DVC pull"></a>5.2 DVC pull</h3><pre class="line-numbers language-none"><code class="language-none"># 初始化git initdvc init# 连接远程gitgit remote add origin ssh:&#x2F;&#x2F;git@10.8.0.90:9922&#x2F;root&#x2F;dvc.git# 连接远程 S3dvc remote add -d myremote s3:&#x2F;&#x2F;test&#x2F;dvcdvc remote modify myremote endpointurl http:&#x2F;&#x2F;10.8.0.88:9000dvc remote modify myremote access_key_id 8mKrSlXsnD1SRZKNvQQudvc remote modify myremote secret_access_key sg5OIKJksJdz3yGbGpLTt5v58AyjTXI2tHlcBwtx# 下载目标数据git checkout origin&#x2F;main -- Dockerfile.dvcdvc pull -vvv #根据当前的 *.dvc 文件下载目标数据dvc pull build.dvc   # 拉取指定的数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>[!Note]<br>理解：实际的版本控制功能应该是通过 git 管理了.dvc文件，DVC 通过此文件保证数据的状态同步<br>还需要研究 .gitignore, . Dvcignore 应该在其中书写什么（数据文件名+），被 git 管理的将不再被 dvc 管理<br>以及下文需要研究版本控制和 branch 合并</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> Virtualization </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>instant box</title>
      <link href="/2024/01/02/instant-box/"/>
      <url>/2024/01/02/instant-box/</url>
      
        <content type="html"><![CDATA[<h1 id="Instant-Box"><a href="#Instant-Box" class="headerlink" title="Instant Box"></a>Instant Box</h1><h2 id="1-Introduce"><a href="#1-Introduce" class="headerlink" title="1. Introduce"></a>1. Introduce</h2><p>A project spins up temporary Linux systems with instant webshell access from any browser.<br>It can currently supports various versions of Ubuntu, CentOS, Arch Linux, Debian, Fedora and Alpine.</p><h2 id="2-Deployment"><a href="#2-Deployment" class="headerlink" title="2. Deployment"></a>2. Deployment</h2><pre class="line-numbers language-none"><code class="language-none"># docker-compose neededmkdir instantbox &amp;&amp; cd $_bash &lt;(curl -sSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;instantbox&#x2F;instantbox&#x2F;master&#x2F;init.sh)    # To create a  docker compose file，at the same time we can set ip &amp; port heredocker-compose up -d  # deploy service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-Operation"><a href="#3-Operation" class="headerlink" title="3.  Operation"></a>3.  Operation</h2><pre>Run 'docker-compose up -d' then go to http://ip:8888 on your browser.When creating a new OS, the Docker engine will create a new container in host machine.No persistent storage found.</pre><h3 id="3-1-ssh-into-container"><a href="#3-1-ssh-into-container" class="headerlink" title="3.1 ssh into container"></a>3.1 ssh into container</h3><ul><li>ubuntu</li></ul><pre class="line-numbers language-none"><code class="language-none">apt install -y openssh-serverssh-keygen -A    # 自动生成所有缺失的主机密钥文件vim ~&#x2F;.ssh&#x2F;authorized_keys   # 在目标机器需要登录的用户下，粘贴本机公钥（密码验证不成功）&#x2F;usr&#x2F;sbin&#x2F;sshd     # 启动sshd宿主机 ssh 即可<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2-Launch-WEB-Cli"><a href="#3-2-Launch-WEB-Cli" class="headerlink" title="3.2 Launch WEB Cli"></a>3.2 Launch WEB Cli</h3><pre>The browser can only create one kind of system at the sametimeClean the cache of browser or create a new incognito window, goes to console, create a new system in box.then goes to eg URL: http://10.13.3.101:8888/console/container_ID(name)/</pre><h2 id="4-Shut-the-service-down"><a href="#4-Shut-the-service-down" class="headerlink" title="4. Shut the service down"></a>4. Shut the service down</h2><pre>We're supposed to delete or purge the OS created before first, then purge the service container.</pre>]]></content>
      
      
      
        <tags>
            
            <tag> demo test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>At the end of 2023</title>
      <link href="/2024/01/01/at-the-end-of-2023/"/>
      <url>/2024/01/01/at-the-end-of-2023/</url>
      
        <content type="html"><![CDATA[<h1 id="2023-的结束"><a href="#2023-的结束" class="headerlink" title="2023 的结束"></a>2023 的结束</h1><ol><li>失：2023-10-2 和邹漂亮分开了，2018-1-13 我们在一起。很想念，很亏欠，很遗憾，自己不够优秀，落下太远了。她确实值得更优秀的人生。</li><li>得：一份工作, 在云原生入门的机会，重拾学习习惯的氛围。 </li><li>坚持一些标准线：月薪1w+，存款，换房。</li><li>培养一些习惯：练字，赵孟頫、欧阳询的小楷；锻炼身体，不要长胖或者虚弱。</li></ol><hr><table><thead><tr><th align="center">时间</th><th align="center">计划</th></tr></thead><tbody><tr><td align="center">1月</td><td align="center">结束k8s基础部分</td></tr><tr><td align="center">2月</td><td align="center">monitor</td></tr><tr><td align="center">3月</td><td align="center">cicd</td></tr><tr><td align="center">4月</td><td align="center">简历投递并约面试</td></tr><tr><td align="center">5月</td><td align="center">主要找工作</td></tr><tr><td align="center">6月</td><td align="center">找到工作！！！</td></tr><tr><td align="center">1-6</td><td align="center">如果辞职就一定要先拿到驾照</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> summary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> personal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS server</title>
      <link href="/2023/12/25/dns-server/"/>
      <url>/2023/12/25/dns-server/</url>
      
        <content type="html"><![CDATA[<h1 id="一、DNS-主服务器"><a href="#一、DNS-主服务器" class="headerlink" title="一、DNS 主服务器"></a>一、DNS 主服务器</h1><ul><li>手动更新源，并安装bind9.18  <pre class="line-numbers language-none"><code class="language-none">sudo add-apt-repository ppa:isc&#x2F;bindapt updatesudo apt install -y  bind9 bind9-utils<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="1-1-相关文件"><a href="#1-1-相关文件" class="headerlink" title="1.1 相关文件"></a>1.1 相关文件</h2><p><a href="https://cshihong.github.io/2018/10/15/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E4%B8%8E%E9%85%8D%E7%BD%AE/">references</a><br><code>/etc/bind/named.conf</code>:  主配置文件，包含 bind 服务器的全局设置和引用其他配置文件的指令<br><code>/etc/bind/named.conf.default-zones</code>:  定义了默认的区域（zone），如  localhost 、反向解析等<br><code>/etc/bind/named.conf.local</code>:  用于配置本地区域（zone）和其他定制区域的文件<br><code>/etc/bind/named.conf.options</code>:  包含bind服务器的全局选项设置，如监听地址、转发器等  </p><h2 id="1-2-配置"><a href="#1-2-配置" class="headerlink" title="1.2 配置"></a>1.2 配置</h2><h3 id="1-2-1-解析方式"><a href="#1-2-1-解析方式" class="headerlink" title="1.2.1  解析方式"></a>1.2.1  解析方式</h3><table><thead><tr><th align="center">方式</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">正向</td><td align="center">域名–&gt;IP</td></tr><tr><td align="center">反向</td><td align="center">IP–&gt;域名</td></tr></tbody></table><h3 id="1-2-2-DNS记录类型"><a href="#1-2-2-DNS记录类型" class="headerlink" title="1.2.2  DNS记录类型"></a>1.2.2  DNS记录类型</h3><ul><li>A 记录：将域名指向一个 ipv4  </li><li>AAAA 记录：将主机名解析到一个指定的 IPv6  </li><li>CNAME 记录：别名解析，指将不同的域名都转到一个域名记录上，由这个域名记录统一解析管理，即当前解析的域名是另一个域名的跳转  </li><li>NS 记录：域名服务记录，用来指定该域名由哪个 DNS 服务器来解析，一般设置为多个，一个为主，其余为辅，且只能写域名的形式  </li><li>PTR 记录：反向解析，主要用于 IP 解析为 FQDN  </li><li>MX 记录： 邮件交换记录  </li><li>TXT 记录： 指某个主机名或域名的说明，通常用来做SPF记录（反垃圾邮件）</li></ul><h3 id="1-2-3-目录结构（需要修改部分）"><a href="#1-2-3-目录结构（需要修改部分）" class="headerlink" title="1.2.3  目录结构（需要修改部分）"></a>1.2.3  目录结构（需要修改部分）</h3><p>&#x2F;etc&#x2F;bind<br>├── example<br>│   ├── db.zones<br>│   └── reverse.zones<br>├── named.conf<br>└──named.conf.options   </p><h3 id="1-2-4-配置文件"><a href="#1-2-4-配置文件" class="headerlink" title="1.2.4  配置文件"></a>1.2.4  配置文件</h3><ul><li>&#x2F;etc&#x2F;bind&#x2F;named.conf  <pre class="line-numbers language-none"><code class="language-none">include &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.options&quot;;include &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.local&quot;;# include &quot;&#x2F;etc&#x2F;bind&#x2F;named.conf.default-zones&quot;;       # 在视图使用时注释掉的include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf&quot;;     #  在 dnssec 功能中需要做的引入<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tls doh <span class="token punctuation">&#123;</span>   key-file <span class="token string">"/etc/bind/example/cert/key.pem"</span><span class="token punctuation">;</span>   cert-file <span class="token string">"/etc/bind/example/cert/ca.pem"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>http dns-over-https <span class="token punctuation">&#123;</span>    endpoints <span class="token punctuation">&#123;</span><span class="token string">"/dns-query"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>options <span class="token punctuation">&#123;</span>        directory <span class="token string">"/var/cache/bind"</span><span class="token punctuation">;</span>        listen-on port <span class="token number">53</span> <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        listen-on port <span class="token number">443</span> tls doh http dns-over-https  <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>     <span class="token comment"># 配合上述 tls  http 开启 DOH</span>        recursion <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token comment"># 否则会出现不能解析 wan 网域名</span>        forwarders <span class="token punctuation">&#123;</span>            <span class="token number">8.8</span>.8.8<span class="token punctuation">;</span>            <span class="token number">223.5</span>.5.5<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        forward  first<span class="token punctuation">;</span>        version  <span class="token string">"hiden version"</span><span class="token punctuation">;</span>        allow-transfer <span class="token punctuation">&#123;</span> <span class="token number">10.13</span>.3.107<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        allow-query <span class="token punctuation">&#123;</span>          example<span class="token punctuation">;</span>          company<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        auth-nxdomain <span class="token boolean">true</span><span class="token punctuation">;</span>        dnssec-validation <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>acl <span class="token string">"example"</span> <span class="token punctuation">&#123;</span>    <span class="token number">10.10</span>.6.0/24<span class="token punctuation">;</span>    <span class="token number">10.13</span>.3.0/24<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>acl <span class="token string">"company"</span> <span class="token punctuation">&#123;</span>    <span class="token number">10.10</span>.6.0/24<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>view <span class="token string">"example"</span> <span class="token punctuation">&#123;</span>  match-clients <span class="token punctuation">&#123;</span> example<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  zone <span class="token string">"example.net"</span> IN  <span class="token punctuation">&#123;</span>       <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>       <span class="token function">file</span> <span class="token string">"/etc/bind/example/example.db.zones"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  zone <span class="token string">"13.10.in-addr.arpa."</span> IN  <span class="token punctuation">&#123;</span>       <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>       <span class="token function">file</span> <span class="token string">"/etc/bind/example/example.reverse.zones"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>view <span class="token string">"company"</span> <span class="token punctuation">&#123;</span>  match-clients <span class="token punctuation">&#123;</span> company<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  zone <span class="token string">"company.com"</span> IN  <span class="token punctuation">&#123;</span>       <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>       <span class="token function">file</span> <span class="token string">"/etc/bind/example/company.db.zones"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>视图使用主要参考本章<a href="##">智能视图使用</a></p><ul><li>&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones</li></ul><pre class="line-numbers language-none"><code class="language-none">$TTL 10M@       IN      SOA     example.top. admin.example.top. (                                   1   ; serial                                1200   ; refresh                                 900    ; retry                                 900    ; expire                               1200 )  ; minimum @        IN      NS      nameservernameserver   IN  A       10.13.3.107nameserver  IN  A       10.13.3.109    test         IN  A       10.13.3.109k8s          IN  A       10.13.3.110<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>反向区域解析文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.reverse.zones  </p><pre class="line-numbers language-none"><code class="language-none">$TTL 10M@       IN      SOA     example.net.  admin.example.net. (                                  1   ; serial                                24h   ; refresh                                15m   ; retry                                1d    ; expire                                5m  ; minimum)       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;107.3  IN    PTR    ldap.example.net.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>测试  </p><pre class="line-numbers language-none"><code class="language-none">dig   目标域名   @namserver    +shortdig   目标ip   -x   +shortnslookup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="1-2-5-参数介绍"><a href="#1-2-5-参数介绍" class="headerlink" title="1.2.5  参数介绍"></a>1.2.5  参数介绍</h3><p>allow-update { none; };  定义允许执行动态 DNS 更新的客户端<br>allow-transfer { xx ; } 允许 xx 地址从您的 DNS 服务器复制数据<br>forward first; 优先选择转发到的 DNS 服务器<br>forwarders {}; 转发器，转发到另外的 DNS<br>recursion yes; 启用递归查询<br>dnssec-validation no; 禁用 BIND9 服务器上的 DNSSEC 验证，此时返回的数据或许有准确度的问题<br>auth-nxdomain no; 符合 RFC1035  </p><ol><li>Refresh（刷新）：Refresh 指定了 DNS 服务器应从主服务器获取区域数据的频率。最佳的 Refresh 时间取决于你的特定需求，通常在几小时到一天之间。较短的 Refresh 时间可以更快地更新数据，但会增加主服务器的负载。  </li><li>Retry（重试）：Retry 指定了 DNS 服务器在未能联系到主服务器时应进行的重试间隔。最佳的 Retry 时间通常在几分钟到一小时之间，取决于网络的可靠性和延迟。较短的 Retry 时间可以更快地恢复到主服务器，但会增加 DNS 查询负载。  </li><li>Expire（过期）：Expire 指定了区域数据在主服务器不可用时的最大存储时间。最佳的 Expire 时间通常在几天到一周之间。较短的 Expire 时间可以更快地更新过期的数据，但会增加 DNS 查询的负载。  </li><li>Minimum TTL（最小生存时间）：Minimum TTL 指定了 DNS 解析器或缓存服务器应保留解析结果的最小时间。最佳的 Minimum TTL 时间取决于你的特定需求，通常在几分钟到一天之间。较短的 Minimum TTL 时间可以更快地更新解析结果，但会增加 DNS 查询的负载。</li></ol><hr><h1 id="二、DNS-从服务器"><a href="#二、DNS-从服务器" class="headerlink" title="二、DNS 从服务器"></a>二、DNS 从服务器</h1><h2 id="2-1-配置"><a href="#2-1-配置" class="headerlink" title="2.1  配置"></a>2.1  配置</h2><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;bind&#x2F;named.conf同于 master 即可<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>&#x2F;etc&#x2F;bind&#x2F;named.conf.options</p><pre class="line-numbers language-none"><code class="language-none">tls doh &#123;   key-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert&#x2F;key.pem&quot;;   cert-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert&#x2F;ca.pem&quot;;&#125;;http dns-over-https &#123;    endpoints &#123;&quot;&#x2F;dns-query&quot;;&#125;;&#125;;options &#123;        directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;        listen-on port 53 &#123; localhost; &#125;;        listen-on port 443 tls doh http default &#123; localhost; &#125;;        recursion true;        forwarders &#123;            8.8.8.8;            223.5.5.5;        &#125;;        forward  first;        version  &quot;hiden version&quot;;        allow-query &#123;          example;          company;        &#125;;        auth-nxdomain true;        dnssec-validation false;&#125;;acl &quot;example&quot; &#123;    10.10.6.0&#x2F;24;    10.13.3.0&#x2F;24;&#125;;acl &quot;company&quot; &#123;    10.10.6.0&#x2F;24;&#125;;view &quot;example&quot; &#123;  match-clients &#123; example; &#125;;  zone &quot;example.net&quot; IN  &#123;       type slave;       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones.signed&quot;;       masters &#123; 10.13.3.106; &#125;;  &#125;;  zone &quot;3.13.10.in-addr.arpa.&quot; IN  &#123;       type slave;       masters &#123; 10.13.3.106; &#125;;       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.reverse.zones&quot;;  &#125;;&#125;;view &quot;company&quot; &#123;  match-clients &#123; company; &#125;;  zone &quot;company.com&quot; IN  &#123;       type slave;       masters &#123; 10.13.3.106; &#125;;       file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;company.db.zones&quot;;  &#125;;&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>&#x2F;etc&#x2F; apparmor.d&#x2F;usr.sbin.named  设置可写。dumping master file: &#x2F;etc&#x2F;bind&#x2F;example&#x2F;tmp-80LUGLiqE4: open: permission denied  </p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;bind&#x2F;example&#x2F;** rw,systemctl reload apparmor.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="2-2-测试记录同步"><a href="#2-2-测试记录同步" class="headerlink" title="2.2 测试记录同步"></a>2.2 测试记录同步</h2><ul><li>修改主服务器，解析记录，测试从服务器的同步情况  <pre class="line-numbers language-none"><code class="language-none">$TTL 10M@       IN      SOA     example.top.  admin.example.top. (                                   2   ; serial   [[每次需要修改版本号]]                                1200   ; refresh                                 900    ; retry                                 900    ; expire                               1200 )  ; minimum @        IN      NS      nameserver@        IN      NS      nameserver2              [[较版本1新增]]nameserver   IN  A       10.13.3.107nameserver2  IN  A       10.13.3.109              [[较版本1新增]]test         IN  A       10.13.3.109k8s          IN  A       10.13.3.110me           IN  A       10.10.6.1               [[较版本1新增]]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p><strong>热加载</strong>新增的配置，每次修改记录时，需要同步修改<em><strong>版本号</strong></em>，slave 才能同步成功  </p><pre class="line-numbers language-none"><code class="language-none">sudo rndc reload     # 主服务器执行即可dig -t a me.example.top @10.13.3.109<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>当从服务器有解析文件的，解析记录仍会向主服务器请求，主服务器宕机，从服务器缓存过期之后，也仍不能加载并实施解析区域记录文件  </li><li>同一个网段在多个acl下，将不能正常解析。</li></ul><h2 id="2-3-测试公网域名"><a href="#2-3-测试公网域名" class="headerlink" title="2.3 测试公网域名"></a>2.3 测试公网域名</h2><ul><li>此時公网域名成功解析得到的是保留ip地址，ping 域名不能成功—-因为公司的 ip 做了加密  </li><li>不能成功解析则无记录返回</li></ul><hr><h1 id="三、-安全"><a href="#三、-安全" class="headerlink" title="三、 安全"></a>三、 安全</h1><h2 id="3-1-功能同于bind-chroot"><a href="#3-1-功能同于bind-chroot" class="headerlink" title="3.1 功能同于bind-chroot"></a>3.1 功能同于bind-chroot</h2><pre class="line-numbers language-none"><code class="language-none">vi &#x2F;etc&#x2F;apparmor.d&#x2F;usr.sbin.named# 检查是否存在，否则增加以下内容  &#x2F;etc&#x2F;bind&#x2F;** r,  &#x2F;var&#x2F;lib&#x2F;bind&#x2F;** rw,  &#x2F;var&#x2F;lib&#x2F;bind&#x2F; rw,  &#x2F;var&#x2F;cache&#x2F;bind&#x2F;** lrw,  &#x2F;var&#x2F;cache&#x2F;bind&#x2F; rw,  &#x2F;var&#x2F;log&#x2F;named&#x2F;** rw,  &#x2F;var&#x2F;log&#x2F;named&#x2F; rw,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-2-开启DNSSEC验证，参考"><a href="#3-2-开启DNSSEC验证，参考" class="headerlink" title="3.2 开启DNSSEC验证，参考"></a>3.2 开启DNSSEC验证，<a href="https://www.cnblogs.com/anpengapple/p/5879363.html">参考</a></h2><ul><li><p>作用：对域名进行签名认证，保证域名的完整性和正确性，不会被修改  </p></li><li><p>在新增的 dnssec_keys 目录中生成密钥  </p><pre class="line-numbers language-none"><code class="language-none">sudo dnssec-keygen -f KSK -a RSASHA256 -b 2048 -n ZONE example.net.sudo dnssec-keygen -a RSASHA256  -b 2048 -n ZONE example.net.# 查看本域应用所需的密钥文件  ls Kexample.net.+008+16296.key   Kexample.net.+008+16296.private   Kexample.net.+008+23579.key  Kexample.net.+008+23579.private<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>将前面生成的两个公钥添加到区域配置文件末尾  </p><pre class="line-numbers language-none"><code class="language-none">$TTL 10M@       IN      SOA     example.net.  admin.example.net. (                                  1   ; serial                                24h   ; refresh                                15m   ; retry                                1d    ; expire                                5m )  ; minimum@        IN      NS      nameservernameserver       IN      A       10.13.3.106ldap   IN  A   10.13.3.107test   IN  A   10.13.3.105$INCLUDE  &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F;Kexample.net.+008+23579.key&quot;$INCLUDE  &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F;Kexample.net.+008+16296.key&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对区域文件签名，会生成一个新的zones.sigend. 如果新增了解析记录，需要再次加密  </p><pre class="line-numbers language-none"><code class="language-none">sudo dnssec-signzone -K &#x2F;etc&#x2F;bind&#x2F;example&#x2F;dnssec_keys&#x2F; -o example.net. &#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.db.zones -K  指定密钥文件路径    -o  域名   路径是区域解析文件路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>改动引用解析文件路径的位置  </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">view <span class="token string">"example"</span> <span class="token punctuation">&#123;</span>  match-clients <span class="token punctuation">&#123;</span> example<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  zone <span class="token string">"example.net"</span> IN  <span class="token punctuation">&#123;</span>       <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>       <span class="token function">file</span> <span class="token string">"/etc/bind/example/example.db.zones.signed"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>生成信任锚文件 &#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf  </p></li><li><p>这里面的两条内容是刚才生成的两个密钥的内容。用公钥比较方便（也就是.key的文件）。注意复制的时候去掉“IN”和“DNSKEY”这两个词，以及后面的key要加引号  </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">trusted-keys <span class="token punctuation">&#123;</span>   example.net.   <span class="token number">256</span> <span class="token number">3</span> <span class="token number">8</span>  <span class="token string">"AwEAAb+3BGqXqE/WwDICGRONYv1w4savuaD4cJ/VRL6xGg2b54OilEWE WMzUAOw4B/sPyKZDG/XTnaW4mD756l/swRuq9kO/sktgu4ZP4onmqeFM sdMTTmxesp6Q6ebqAPNzQfKyZwqX6Iq00qGslUmxr5FSOLWjGoze8afm TxbPW6Hi7JQ85mJ+TkpUNa+ymDS4qKi87rSi8NQTDbsZ0wH7+zX1TBOP jeUI/JsxD/bu1kD97AP9u2Sd4D8U0vyN8fN4LIIKfA5vurPaWPfQIM8r I0KQueAHdNLOPjaEWcKg/rBHFWZPxIeQGM8D2VXwkdPL5fefC59wONhK ys2RMqv3DIM="</span><span class="token punctuation">;</span>  example.net.   <span class="token number">257</span> <span class="token number">3</span> <span class="token number">8</span> <span class="token string">"AwEAAbZo3hpm+0+32jgrTXog3CCUTTctP3LoBx1F0nbpoEBkWN1CA//O 7fzNY08pwblkKKW/LkYiQNQEQq50ThouV9UJ+CFRf/Fju6ggIpWpNjsu 8c2+zROZdJ9d2T6JnVTYPo1Iyn8ufn0hFjPRrwdvfQKSmnI9ZRx2eRFc ZFJpqNTj2LwzqoEKrbOn4oywqTWJL1Hyjv8e/kBojy7BghKWYnTGlpha 9CSin17qUQCY+o0qMzmezq+/AbxhdJwV9KYHWzWvNZjyyjBLyxwwsV4F shgmXm2tTuW5gPrnbfzaP+R/cElzl03mtjmJ//g5wWMMV8QKemBpbNoR ajzYYhhocWk="</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>引入此信任锚文件 &#x2F;etc&#x2F;bind&#x2F;name.conf  </p><pre class="line-numbers language-none"><code class="language-none">include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;sec-trust-anchors.conf&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>重启服务  </p></li><li><p>验证  </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">dig</span> +dnssec  test.example.net  @10.13.3.106<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> DiG <span class="token number">9.16</span>.1-Ubuntu <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> +dnssec test.example.net @10.13.3.106<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">28767</span><span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">2</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags: <span class="token keyword">do</span><span class="token punctuation">;</span> udp: <span class="token number">1232</span><span class="token punctuation">;</span> COOKIE: 0d6b52d25063b09401000000655592b51d0f8f6c0b072961 <span class="token punctuation">(</span>good<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">;</span>test.example.net.                        IN      A<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:test.example.net.         <span class="token number">600</span>     IN      A       <span class="token number">10.13</span>.3.105test.example.net.         <span class="token number">600</span>     IN      RRSIG   A <span class="token number">8</span> <span class="token number">3</span> <span class="token number">600</span> <span class="token number">20231216022642</span> <span class="token number">20231116022642</span> <span class="token number">16296</span> example.net. iUSB+maT6y22ySZdEZHElShHCVDbmjnHez39eosniP1wqvquyadVydlT lZ3XZbUMNTV3WrZhLEjuGaVwNajvAqeY07IPCivpr+VCuIPXccONBwZE 3ZRX5B2PcGnrhMWupH+jcoT5NTy5pAEdm5JXbtJljFyJk1XxQVhanzJO /TY7YMJWWDbj3WnywkEPQyP5UYExl4Y0E3BPUX/J4xuCspTovQhqo6BM HaC3XFMG1Li9CbHcfNkUjVtdi8oQmAdM6lMqFTz5KNpIRppqhEukcD9o w9slLc1vpjDwqzO7xPls8S9WbzMeHzHNbIrPcv88MQWUAIVyqodbhOvj <span class="token assign-left variable">8ZKlgg</span><span class="token operator">==</span><span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">0</span> msec<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">10.13</span>.3.106<span class="token comment">#53(10.13.3.106)</span><span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Thu Nov <span class="token number">16</span> <span class="token number">11</span>:55:33 CST <span class="token number">2023</span><span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">384</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>问题：  </p></li><li><p>配置后，每个客户端需要添加信任锚文件以作签名验证  </p></li><li><p>这个签名后的zone可以被伪造，使用dig命令输出的文件修改伪造</p></li></ul><h2 id="3-3-创建视图管理，智能DNS"><a href="#3-3-创建视图管理，智能DNS" class="headerlink" title="3.3 创建视图管理，智能DNS"></a>3.3 创建视图管理，智能DNS</h2><p><a href="https://www.cnblogs.com/anpengapple/p/5879350.html">参考1</a><br><a href="https://www.cnblogs.com/etangyushan/p/4335521.html">参考2</a><br><a href="http://www.hangdaowangluo.com/archives/1633">参考3</a><br><a href="https://www.server-world.info/en/note?os=Ubuntu_20.04&p=dns&f=5">ubuntu案例</a>  </p><ul><li>vim  &#x2F;etc&#x2F;bind&#x2F;named.conf</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">include <span class="token string">"/etc/bind/named.conf.options"</span><span class="token punctuation">;</span>include <span class="token string">"/etc/bind/named.conf.local"</span><span class="token punctuation">;</span><span class="token comment"># include "/etc/bind/named.conf.default-zones";</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>cat  &#x2F;etc&#x2F;bind&#x2F;named.conf.options</li></ul><pre class="line-numbers language-none"><code class="language-none">options &#123;        directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;        listen-on port 53 &#123; localhost; &#125;;        recursion yes;        # 允许递归才能在智能dns解析万网域名        forwarders &#123;          223.5.5.5;        &#125;;        forward  first;        version  &quot;hiden version&quot;;   # 隐藏版本        allow-transfer &#123; 10.13.3.106; &#125;;        allow-query &#123;           example;          company;        &#125;;        auth-nxdomain true;        dnssec-validation false; # dns安全拓展的选项&#125;;# 此处定义目标ip地址段，划分可访问的域acl &quot;example&quot; &#123;    10.13.3.0&#x2F;24;    10.10.6.0&#x2F;24;&#125;;acl &quot;company&quot; &#123;    10.10.6.0&#x2F;24;&#125;;# 此处制定目标ip可以访问的域名的解析区域view &quot;example&quot; &#123;  match-clients &#123; example; &#125;;  include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.views&quot;;&#125;;view &quot;company&quot; &#123;  match-clients &#123; company; &#125;;  include &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;company.views&quot;;&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>views 文件中指定区域解析文件，eg：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">zone <span class="token string">"example.net"</span> IN <span class="token punctuation">&#123;</span>                                          <span class="token comment"># 此处域名和 zones 文件中的域名一致</span>      <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>      <span class="token function">file</span> <span class="token string">"/etc/bind/example/example.net.zones"</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>zone <span class="token string">"3.13.10.in-addr.arpa."</span> IN <span class="token punctuation">&#123;</span>                         <span class="token comment"># 此处格式固定，设计反向解析的ip的网络位，和zones文件中的主机位结合成为完整ip地址</span>      <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>      <span class="token function">file</span> <span class="token string">"/etc/bind/example/example.net.reverse.zones"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>zone <span class="token string">"example.top"</span> IN <span class="token punctuation">&#123;</span>                              <span class="token comment"># 配置此 dns 向 10.13.3.101 这个转发器请求解析 example.top 的域名。在全局 options 配置转发没有成功，选择了此方案。</span>      <span class="token builtin class-name">type</span> forward<span class="token punctuation">;</span>      forwarders <span class="token punctuation">&#123;</span><span class="token number">10.13</span>.3.101<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>正向区域解析文件  </p><pre class="line-numbers language-none"><code class="language-none">$TTL 10M@       IN      SOA     example.net.  admin.example.net. (                                  1   ; serial                                24h   ; refresh                                15m   ; retry                                1d    ; expire                                5m  ; minimum) @        IN      NS      nameservernameserver       IN      A       10.13.3.106ldap   IN  A   10.13.3.107test   IN  A   10.13.3.105<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>反向区域解析文件  </p><pre class="line-numbers language-none"><code class="language-none">$TTL 10M@       IN      SOA     example.net.  admin.example.net. (                                  1   ; serial                                24h   ; refresh                                15m   ; retry                                1d    ; expire                                5m  ; minimum)       IN      NS      nameserver.      # 不能缺省这个&quot;.&quot;107  IN    PTR    ldap.example.net.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>测试   </p><pre class="line-numbers language-none"><code class="language-none">dig   目标域名   @namserver    +shortdig   目标ip   -x   +shortnslookup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="3-4-加密"><a href="#3-4-加密" class="headerlink" title="3.4 加密"></a>3.4 加密</h2><p><a href="https://runtufenxiang.com/6186/">知名公共DoT&#x2F;DoH加密DNS服务器</a><br><a href="https://devblog.rayonnant.net/creating-a-dot-and-doh-server-using-nginx-and-bind/">配置</a><br><a href="https://dididudu998.github.io/2022/02/15/configure-doh-bind.html">bind9 tls &#x2F; https</a>网络层的问题是DoT使用853的端口，很容易被封锁，而DoH使用443端口，一般不会被封锁    </p><h3 id="3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）"><a href="#3-4-1-DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）" class="headerlink" title="3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）"></a>3.4.1 DOH一般是url，不适用IP地址，选择DOT方案。（经验证不合适）</h3><pre class="line-numbers language-none"><code class="language-none">tls mycert &#123;    cert-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;cert.pem&quot;;    key-file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;key.pem&quot;;&#125;;options &#123;    directory &quot;&#x2F;var&#x2F;cache&#x2F;bind&quot;;    listen-on port 853 tls mycert &#123; localhost; &#125;;    forward  first;    forwarders &#123;            223.5.5.5;            120.53.53.53;    &#125;;    allow-query &#123; 10.13.3.0&#x2F;24;&#125;;    auth-nxdomain true;    allow-update &#123; none; &#125;;  &#x2F;&#x2F;  allow-transfer &#123; 10.13.3.106; &#125;;    version  &quot;hiden version&quot;;    recursion false;&#125;;zone &quot;example.net&quot;&#123;   type master;   file &quot;&#x2F;etc&#x2F;bind&#x2F;example&#x2F;example.net.zones&quot;;&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>客户端修改dns地址步骤如下：  </li><li>&#x2F;etc&#x2F;resolv.conf  是软链接，指向了&#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;stub-resolv.conf。直接修改内容会被覆盖，没有意义  </li><li>vim &#x2F;etc&#x2F;systemd&#x2F;resolved.conf  <pre class="line-numbers language-none"><code class="language-none">[Resolve]DNS&#x3D;10.13.3.106[[FallbackDNS]]&#x3D;DNSOverTLS&#x3D;opportunistic  # 或者yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>systemctl restart systemd-resolved.service   </li><li>mv &#x2F;etc&#x2F;resolv.conf   &#x2F;etc&#x2F;resolv.conf.bak  </li><li>ln -s &#x2F;run&#x2F;systemd&#x2F;resolve&#x2F;resolv.conf &#x2F;etc&#x2F;</li></ul><h3 id="3-4-2-问题"><a href="#3-4-2-问题" class="headerlink" title="3.4.2 问题"></a>3.4.2 问题</h3><ul><li><p>以上配置之后，使用特定命令发现 DOT 是成功的，例如  </p><pre class="line-numbers language-none"><code class="language-none">resolvectl query mee.example.netmee.example.net: 10.10.6.1                       -- link: ens160-- Information acquired via protocol DNS in 1.7ms.-- Data is authenticated: nodig +tls mee.example.net; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; +tls mee.example.net;; global options: +cmd;; Got answer:;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52275;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1;; WARNING: recursion requested but not available;; OPT PSEUDOSECTION:; EDNS: version: 0, flags:; udp: 1232; COOKIE: 174ae084d3aed77f01000000655474d3fbb4902501bc69cb (good);; QUESTION SECTION:;mee.example.net.                 IN      A;; ANSWER SECTION:mee.example.net.          600     IN      A       10.10.6.1;; Query time: 0 msec;; SERVER: 10.13.3.106#853(10.13.3.106) (TLS);; WHEN: Wed Nov 15 15:35:47 CST 2023;; MSG SIZE  rcvd: 86以上访问了dns服务器853端口，所以返回正常解析<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>普通解析会失败  </p><pre class="line-numbers language-none"><code class="language-none">dig mee.example.net  （nslookup ssh  ping）;; communications error to 10.13.3.106#53: connection refused;; communications error to 10.13.3.106#53: connection refused;; communications error to 10.13.3.106#53: connection refused; &lt;&lt;&gt;&gt; DiG 9.18.19-1+ubuntu20.04.1+isc+1-Ubuntu &lt;&lt;&gt;&gt; mee.example.net;; global options: +cmd;; no servers could be reached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>因此，仍然开启 53 端口，二者同时可以使用，但是如果需要特定的方式使用DNSOverTLS ，那么以目前在服务器上的使用上来看，使用是没有意义的。  </p></li><li><p>在服务器使用 53，在浏览器使用自建 DOH，是适宜的</p></li></ul><h3 id="3-4-3-DOH-加密和转发"><a href="#3-4-3-DOH-加密和转发" class="headerlink" title="3.4.3  DOH 加密和转发"></a>3.4.3  DOH 加密和转发</h3><ul><li><p>配置  </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tls doh <span class="token punctuation">&#123;</span>   key-file <span class="token string">"/etc/bind/example/cert/key.pem"</span><span class="token punctuation">;</span>   cert-file <span class="token string">"/etc/bind/example/cert/ca.pem"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>http dns-over-https <span class="token punctuation">&#123;</span>    endpoints <span class="token punctuation">&#123;</span><span class="token string">"/dns-query"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>options <span class="token punctuation">&#123;</span>        listen-on port <span class="token number">443</span> tls doh http default <span class="token punctuation">&#123;</span> localhost<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>检测  </p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">dig</span> +https  test.example.net  @10.13.3.106 A<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> DiG <span class="token number">9.18</span>.19-1+ubuntu20.04.1+isc+1-Ubuntu <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> +https test.example.net @10.13.3.106 A<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">15036</span><span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">1</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">1232</span><span class="token punctuation">;</span> COOKIE: dcdab07360fe04b2010000006555c9c6572491f7e49a2f35 <span class="token punctuation">(</span>good<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">;</span>test.example.net.                        IN      A<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:test.example.net.         <span class="token number">600</span>     IN      A       <span class="token number">10.13</span>.3.105<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">0</span> msec<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">10.13</span>.3.106<span class="token comment">#443(10.13.3.106) (HTTPS)</span><span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Thu Nov <span class="token number">16</span> <span class="token number">15</span>:50:30 CST <span class="token number">2023</span><span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">87</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>使用<br>此时在客户端使用 DOH ，浏览器设置 use secure dns ，custom url ： <a href="https://nameserver.example.net/dns-query">https://nameserver.example.net/dns-query</a><br>在客户端其他程序的使用中，仍然会访问 dns 的 53 端口</p></li></ul><h2 id="3-5-其他安全实践"><a href="#3-5-其他安全实践" class="headerlink" title="3.5 其他安全实践"></a>3.5 其他安全实践</h2><ul><li>下列参考<a href="https://www.secpulse.com/archives/52634.html">来源</a>  <pre class="line-numbers language-none"><code class="language-none">隐藏BIND版本号限定哪台主机能够发起区域传输<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><pre class="line-numbers language-none"><code class="language-none">version  &quot;hiden version&quot;;                             #  隐藏版本信息allow-transfer &#123; 221.236.9.9; &#125;;    #  指定允许某从服务器进行区域传输到该服务器，此配置一般在主服务器配置<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="四、web-管理以及反向代理"><a href="#四、web-管理以及反向代理" class="headerlink" title="四、web 管理以及反向代理"></a>四、web 管理以及反向代理</h1><p><a href="https://www.mmcloud.com/2863.html">安装 webmin工具</a><br><a href="https://devpress.csdn.net/cloud/6304db5f7e6682346619cf4b.html">使用ngingx反代</a>  </p><ul><li>路径nginx&#x2F;conf.d&#x2F;webmin.conf   （检查443、80端口，确认dns地址和解析记录）  <pre class="line-numbers language-none"><code class="language-none">upstream webmin &#123;  server 10.13.3.107:10000;&#125;server &#123;  listen 80;  server_name webmin.example.net;  return 301 https:&#x2F;&#x2F;$server_name$request_uri;&#125;server &#123;  server_name webmin.example.net;  listen 443 ssl;  ssl_certificate webmin&#x2F;tls_ca.pem;  ssl_certificate_key webmin&#x2F;tls_key.pem;  location &#x2F; &#123;    proxy_pass      https:&#x2F;&#x2F;webmin;    proxy_redirect  off;    proxy_set_header   Host             $host:$server_port;    proxy_set_header   X-Real-IP        $remote_addr;    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;    proxy_set_header X-Forwarded-Proto &quot;https&quot;;    proxy_connect_timeout      10;    proxy_send_timeout         10;    proxy_read_timeout         10;    proxy_buffer_size          128k;    proxy_buffers              32 32k;    proxy_busy_buffers_size    256k;    proxy_temp_file_write_size 256k;  &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h1 id="五、bind9-18-nginx-反向代理"><a href="#五、bind9-18-nginx-反向代理" class="headerlink" title="五、bind9.18  nginx 反向代理"></a>五、bind9.18  nginx 反向代理</h1><p><a href="https://www.infvie.com/ops-notes/nginx-udp-dns.html">反向代理参考</a>  </p>]]></content>
      
      
      <categories>
          
          <category> ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>The First time using Helm Charts</title>
      <link href="/2023/12/04/the-first-time-using-helm-charts/"/>
      <url>/2023/12/04/the-first-time-using-helm-charts/</url>
      
        <content type="html"><![CDATA[<h2 id="一、ldap-account-manager"><a href="#一、ldap-account-manager" class="headerlink" title="一、ldap-account-manager"></a>一、ldap-account-manager</h2><h3 id="1-1-Repo-URL"><a href="#1-1-Repo-URL" class="headerlink" title="1.1 Repo URL"></a>1.1 Repo URL</h3><ul><li><a href="https://gabibbo97.github.io/charts/">https://gabibbo97.github.io/charts/</a></li><li>Set image tag:8.3 in the chart.yaml</li></ul><h3 id="1-2-Values-Modify—-values-yaml"><a href="#1-2-Values-Modify—-values-yaml" class="headerlink" title="1.2 Values Modify—-values.yaml"></a>1.2 Values Modify—-values.yaml</h3><pre class="line-numbers language-none"><code class="language-none">extraEnv:  LAM_SKIP_PRECONFIGURE: false  LDAP_DOMAIN: example.net;ibswufe.com  LDAP_BASE_DN: dc&#x3D;example,dc&#x3D;net;dc&#x3D;ibswufe,dc&#x3D;com  LDAP_SERVER: ldaps:&#x2F;&#x2F;ldap01.example.net  LDAP_USER: cn&#x3D;administrator,dc&#x3D;example,dc&#x3D;net  LAM_LANG: zh_CN  LAM_PASSWORD: lam<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="二、-self-service-password"><a href="#二、-self-service-password" class="headerlink" title="二、 self-service-password"></a>二、 self-service-password</h2><h3 id="2-1-Repo-URL"><a href="#2-1-Repo-URL" class="headerlink" title="2.1 Repo URL"></a>2.1 Repo URL</h3><ul><li><a href="https://ygqygq2.github.io/charts/">https://ygqygq2.github.io/charts/</a></li><li>Set image tag:5.3.3 to pull the latest one</li></ul><h3 id="2-2-Charts-Using"><a href="#2-2-Charts-Using" class="headerlink" title="2.2 Charts Using"></a>2.2 Charts Using</h3><h4 id="2-2-1-ENV-Setting-ConfigMap"><a href="#2-2-1-ENV-Setting-ConfigMap" class="headerlink" title="2.2.1 ENV Setting ConfigMap"></a>2.2.1 ENV Setting ConfigMap</h4><ul><li>So confused about why cannot make it effective when I  using  the ConfigMap settings In the values.yaml to  cover the default php configurations of this soft.</li><li>So that , Using a ConfigMap Data to  define the container environment variables of this chart.</li><li>env-config.yaml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span><span class="token key atrule">name</span><span class="token punctuation">:</span> self<span class="token punctuation">-</span>service<span class="token punctuation">-</span>password<span class="token punctuation">-</span>env<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">USE_QUESTIONS</span><span class="token punctuation">:</span> <span class="token string">'false'</span><span class="token key atrule">LDAP_BINDDN</span><span class="token punctuation">:</span> <span class="token string">"cn=exampleadmin,dc=example,dc=net"</span><span class="token key atrule">SECRETEKEY</span><span class="token punctuation">:</span> <span class="token string">"example"</span><span class="token key atrule">DEFAULT_ACTION</span><span class="token punctuation">:</span> <span class="token string">"sendtoken"</span><span class="token key atrule">LANG</span><span class="token punctuation">:</span> <span class="token string">"cn,zh-CN"</span><span class="token key atrule">IS_BEHIND_PROXY</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">SITE_URL</span><span class="token punctuation">:</span> <span class="token string">"https://ssp.example.net/index.php"</span><span class="token key atrule">LDAP_SERVER</span><span class="token punctuation">:</span> <span class="token string">"ldap://10.13.3.107"</span><span class="token key atrule">LDAP_BASE_SEARCH</span><span class="token punctuation">:</span> <span class="token string">"ou=example,dc=example,dc=net"</span><span class="token key atrule">LDAP_LOGIN_ATTRIBUTE</span><span class="token punctuation">:</span> <span class="token string">"cn"</span><span class="token key atrule">LOGO</span><span class="token punctuation">:</span> images/mnt/ltb<span class="token punctuation">-</span>logo.png                                  <span class="token comment"># 共享存储，挂载在容器中的/www/ssp/images/mnt</span><span class="token key atrule">BACKGROUND_IMAGE</span><span class="token punctuation">:</span> images/mnt/background.jpg<span class="token key atrule">MAIL_FROM_NAME</span><span class="token punctuation">:</span> <span class="token string">"密码自主修改服务"</span><span class="token key atrule">MAIL_SIGNATURE</span><span class="token punctuation">:</span> <span class="token string">"如有疑问,请联系运维同事,英博智云."</span><span class="token key atrule">MAIL_USE_LDAP</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">NOTIFY_ON_CHANGE</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">SMTP_AUTH_ON</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">SMTP_HOST</span><span class="token punctuation">:</span> <span class="token string">"smtphz.qiye.163.com"</span><span class="token key atrule">MAIL_FROM</span><span class="token punctuation">:</span> <span class="token string">"chao.long@example.net"</span><span class="token key atrule">SMTP_USER</span><span class="token punctuation">:</span> <span class="token string">"chao.long@example.net"</span><span class="token key atrule">SMTP_SECURE_TYPE</span><span class="token punctuation">:</span> <span class="token string">'ssl'</span><span class="token key atrule">SMTP_PORT</span><span class="token punctuation">:</span> <span class="token string">'465'</span><span class="token key atrule">SMTP_AUTOTLS</span><span class="token punctuation">:</span> <span class="token string">'false'</span><span class="token key atrule">PASSWORD_DIFFERENT_LOGIN</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">PASSWORD_MAX_LENGTH</span><span class="token punctuation">:</span> <span class="token string">'30'</span><span class="token key atrule">PASSWORD_MIN_LENGTH</span><span class="token punctuation">:</span> <span class="token string">'8'</span><span class="token key atrule">PASSWORD_MIN_LOWERCASE</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token key atrule">PASSWORD_MIN_SPECIAL</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token key atrule">PASSWORD_MIN_UPPERCASE</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token key atrule">PASSWORD_COMPLEXITY</span><span class="token punctuation">:</span> <span class="token string">'4'</span><span class="token key atrule">PASSWORD_NO_REUSE</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token key atrule">PASSWORD_SHOW_POLICY</span><span class="token punctuation">:</span> <span class="token string">"always"</span><span class="token key atrule">PASSWORD_SPECIAL_CHARACTERS</span><span class="token punctuation">:</span> <span class="token string">"^a-zA-Z0-9"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>add a field <code>envFrom</code>  under the <code>env</code> in templates&#x2F;deployment-statefulset.yaml</li></ul><pre class="line-numbers language-none"><code class="language-none">env:&#123;&#123; toYaml .Values.env | indent 12 &#125;&#125;envFrom:- configMapRef:    name: self-service-password-env<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-2-2-Secret"><a href="#2-2-2-Secret" class="headerlink" title="2.2.2 Secret"></a>2.2.2 Secret</h4><ul><li>there are two variables need to been encrypted</li><li>values.secret</li></ul><pre class="line-numbers language-none"><code class="language-none">secret:  enabled: true  mountPath: &#x2F;etc&#x2F;secret-volume  subPath: &quot;&quot;  readOnly: true  data:    ldap_bindpass: &quot;example@2020&quot;    smtp_pass: &quot;WaLxeu3pvsQaqd7X&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-2-3-values-env"><a href="#2-2-3-values-env" class="headerlink" title="2.2.3 values.env"></a>2.2.3 values.env</h4><pre class="line-numbers language-none"><code class="language-none">env:  - name: LDAP_BINDPASS    valueFrom:      secretKeyRef:        name: self-service-password        key: ldap_bindpass  - name: SMTP_PASS    valueFrom:      secretKeyRef:        name: self-service-password        key: smtp_pass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-2-4-persistentVolume"><a href="#2-2-4-persistentVolume" class="headerlink" title="2.2.4 persistentVolume"></a>2.2.4 persistentVolume</h4><ul><li>create  pv &amp; pvc resources under this namespace，mount the volume ，name: self-service-password</li></ul><pre class="line-numbers language-none"><code class="language-none">persistentVolume:   # 是否存储持久化  enabled: true  storageClass: &quot;-&quot;  accessMode: ReadWriteOnce  annotations: &#123;&#125;  size: 1Gi  # 大小  existingClaim: &#123;&#125;  # 使用已存在的pvc  mountPaths:   - name: data-storage     mountPath: &#x2F;www&#x2F;ssp&#x2F;images&#x2F;mnt  # 容器内路径，将新建 mnt     subPath: ssp-nfs                               # pv 中挂载点下的子目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>pv.yaml</li></ul><pre class="line-numbers language-none"><code class="language-none">apiVersion: v1kind: PersistentVolumemetadata:  name: self-service-passwordspec:  capacity:    storage: 1Gi  accessModes:    - ReadWriteOnce  persistentVolumeReclaimPolicy: Retain  nfs:    path: &#x2F;home&#x2F;example&#x2F;nfs # 指定nfs的挂载点    server: 10.13.3.108<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Post  test，reverse proxy by nginx using Nodeport。Setting the dns resolving，take a visit of this site。</li></ul><pre class="line-numbers language-none"><code class="language-none">upstream ssp &#123;  server 10.13.3.109:32337;&#125;server &#123;    listen 80;    server_name ssp.example.net;    return 301 https:&#x2F;&#x2F;$server_name$request_uri;&#125;server &#123;    listen 443 ssl ;    server_name ssp.example.net;    ssl_certificate tls&#x2F;tls_ca.pem;     ssl_certificate_key tls&#x2F;tls_key.pem;    location &#x2F; &#123;      proxy_pass http:&#x2F;&#x2F;ssp;      proxy_set_header Host $host;      proxy_set_header X-Real-IP $remote_addr;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;      proxy_set_header X-Forwarded-Proto &quot;https&quot;;      proxy_read_timeout 1800s;      proxy_http_version 1.1;      proxy_set_header Upgrade $http_upgrade;      proxy_set_header Connection &quot;upgrade&quot;;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>charts correction<br><code>utcook.fullname</code>   change into–&gt; <code>self-service-password.fullname</code></li></ul><h3 id="三、To-Do-List"><a href="#三、To-Do-List" class="headerlink" title="三、To Do List"></a>三、To Do List</h3><p>Learn more about：</p><ul><li>storageclass</li><li>traefik ingress</li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> helm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Failed to Post Blog</title>
      <link href="/2023/12/01/failed-to-post-blog/"/>
      <url>/2023/12/01/failed-to-post-blog/</url>
      
        <content type="html"><![CDATA[<p>Just because of the wrong layout of lines under the <code>summary</code>.<br>The texts of a new line should be recognized.</p>]]></content>
      
      
      <categories>
          
          <category> Ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>homelab pc</title>
      <link href="/2023/11/27/homelab-pc/"/>
      <url>/2023/11/27/homelab-pc/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Computer-Parts"><a href="#1-Computer-Parts" class="headerlink" title="1. Computer Parts"></a>1. Computer Parts</h2><table><thead><tr><th align="center">配件</th><th align="center">规格</th><th align="center">价格</th></tr></thead><tbody><tr><td align="center">Motherboard</td><td align="center">华南x99双路8D4</td><td align="center">730含以下二者</td></tr><tr><td align="center">CPU</td><td align="center">E5-2680V4</td><td align="center"></td></tr><tr><td align="center">Cooler</td><td align="center">寒冰A500四铜管</td><td align="center"></td></tr><tr><td align="center">RAM</td><td align="center">闲鱼-镁光窄条2133-16G*4</td><td align="center">280</td></tr><tr><td align="center">GPU</td><td align="center">GTX750 4G 貌似全新</td><td align="center">335</td></tr><tr><td align="center">Chassis</td><td align="center">刀客360</td><td align="center">150</td></tr><tr><td align="center">Fan</td><td align="center">PDD-纯白*5</td><td align="center">48</td></tr><tr><td align="center">SSD</td><td align="center">BU KING 512G</td><td align="center">150</td></tr><tr><td align="center">Power</td><td align="center">华南U700双路电源600W</td><td align="center">243</td></tr><tr><td align="center">Tools</td><td align="center">硅脂、螺丝刀、网线</td><td align="center">25</td></tr></tbody></table><h2 id="2-Install-PVE-System"><a href="#2-Install-PVE-System" class="headerlink" title="2. Install PVE System"></a>2. Install PVE System</h2><ul><li>Ventoy</li><li>proxmox-ve_8.0-2.iso</li></ul><h3 id="2-1-Disable-the-subscription-on-web-UI"><a href="#2-1-Disable-the-subscription-on-web-UI" class="headerlink" title="2.1 Disable the subscription on web UI"></a>2.1 Disable the subscription on web UI</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-i_orig</span> <span class="token string">"s/data.status === 'Active'/true/g"</span> /usr/share/pve-manager/js/pvemanagerlib.js<span class="token function">sed</span> <span class="token parameter variable">-i_orig</span> <span class="token string">"s/if (res === null || res === undefined || \!res || res/if(/g"</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js<span class="token function">sed</span> <span class="token parameter variable">-i_orig</span> <span class="token string">"s/.data.status.toLowerCase() !== 'active'/false/g"</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.jssystemctl restart pveproxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-Network-Settings"><a href="#2-2-Network-Settings" class="headerlink" title="2.2 Network Settings"></a>2.2 Network Settings</h3><ul><li><a href="https://www.bilibili.com/video/BV1xH4y1f7Ga/?spm_id_from=333.337.search-card.all.click&vd_source=154006e70f5c14d792db947270b63614">reference</a></li><li>pve host using a vitual NIC and bridging the network connection to a physical NIC<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/network/interfacesauto loiface lo inet loopbackiface enp6s0 inet manual    <span class="token comment"># physical NIC</span>auto vmbr0               <span class="token comment"># Vitrual NIC</span>iface vmbr0 inet static        address <span class="token number">192.168</span>.3.20/24        gateway <span class="token number">192.168</span>.3.1        bridge-ports enp6s0     <span class="token comment">#bridging</span>        bridge-stp off        bridge-fd <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart networking <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="2-3-Using-a-homeland-repository-source"><a href="#2-3-Using-a-homeland-repository-source" class="headerlink" title="2.3  Using a homeland repository source"></a>2.3 <a href="https://www.wunote.cn/article/10000"> Using a homeland repository source</a></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># modify the ubuntu software source</span><span class="token function">wget</span> https://mirrors.ustc.edu.cn/proxmox/debian/proxmox-release-bookworm.gpg <span class="token parameter variable">-O</span> /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg<span class="token builtin class-name">echo</span> <span class="token string">"deb https://mirrors.ustc.edu.cn/proxmox/debian bookworm pve-no-subscription"</span> <span class="token operator">></span> /etc/apt/sources.list.d/pve-no-subscription.list<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s|^deb http://ftp.debian.org|deb https://mirrors.ustc.edu.cn|g'</span> /etc/apt/sources.list<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s|^deb http://security.debian.org|deb https://mirrors.ustc.edu.cn/debian-security|g'</span> /etc/apt/sources.list<span class="token comment"># modify the ceph repository source</span><span class="token builtin class-name">echo</span> <span class="token string">"deb https://mirrors.ustc.edu.cn/proxmox/debian/ceph-quincy bookworm no-subscription"</span> <span class="token operator">></span> /etc/apt/sources.list.d/ceph.list<span class="token comment"># CT images source</span><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s|http://download.proxmox.com|https://mirrors.ustc.edu.cn/proxmox|g'</span> /usr/share/perl5/PVE/APLInfo.pm<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/^/#/'</span> /etc/apt/sources.list.d/pve-enterprise.list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-Virtual-machine-on-pve-host"><a href="#3-Virtual-machine-on-pve-host" class="headerlink" title="3. Virtual machine on pve host"></a>3. Virtual machine on pve host</h2><h3 id="3-1-SYS"><a href="#3-1-SYS" class="headerlink" title="3.1 SYS"></a>3.1 SYS</h3><ul><li>ubuntu 22.04.3 server</li><li>choose network bridging on vmbr0, it’s convenient and fast. also because of my simple network architecture.</li></ul><h3 id="3-2-Repository-Source"><a href="#3-2-Repository-Source" class="headerlink" title="3.2 Repository Source"></a>3.2 Repository Source</h3><pre class="line-numbers language-none"><code class="language-none">deb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy main restricted universe multiversedeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-security main restricted universe multiversedeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-updates main restricted universe multiversedeb https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;ubuntu&#x2F; jammy-backports main restricted universe multiverse<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3-Install-containerd、nerdctl-make-this-vm-as-a-template"><a href="#3-3-Install-containerd、nerdctl-make-this-vm-as-a-template" class="headerlink" title="3.3 Install containerd、nerdctl &amp; make this vm as a template"></a>3.3 Install containerd、nerdctl &amp; make this vm as a template</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> containerdcontainerd config default <span class="token operator">></span> /etc/containerd/config.toml  <span class="token comment"># generating a default configuration of containerd</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>Modify part of this file, like below example.</li></ul><pre class="line-numbers language-toml" data-language="toml"><code class="language-toml"><span class="token key property">sandbox_image</span> <span class="token punctuation">=</span> <span class="token string">"registry.aliyuncs.com/google_containers/pause:3.8"</span><span class="token key property">SystemdCgroup</span> <span class="token punctuation">=</span> <span class="token boolean">true</span><span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry.mirrors</span><span class="token punctuation">]</span>        <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"</span><span class="token punctuation">]</span>          <span class="token key property">endpoint</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"https://bqr1dr1n.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>        <span class="token punctuation">[</span><span class="token table class-name">plugins."io.containerd.grpc.v1.cri".registry.mirrors."k8s.gcr.io"</span><span class="token punctuation">]</span>          <span class="token key property">endpoint</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"https://registry.aliyuncs.com/google_containers"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Install the nerdctl by binary package</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://download.fastgit.org/containerd/nerdctl/releases/download/v0.12.1/nerdctl-0.12.1-linux-amd64.tar.gz<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/containerd/bin/ <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> nerdctl-0.12.1-linux-amd64.tar.gz nerdctl <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> nerdctl /usr/local/containerd/bin/<span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="3-4-System-settings"><a href="#3-4-System-settings" class="headerlink" title="3.4 System settings"></a>3.4 System settings</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ipv4 forward</span><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> /etc/modules-load.d/k8s.conf</span>overlaybr_netfilterEOF</span>modprobe overlaymodprobe br_netfilter<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> /etc/sysctl.d/k8s.conf</span>net.bridge.bridge-nf-call-iptables  = 1net.bridge.bridge-nf-call-ip6tables = 1net.ipv4.ip_forward                 = 1EOF</span><span class="token function">sysctl</span> <span class="token parameter variable">--system</span><span class="token function">sysctl</span> net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward<span class="token comment"># swap</span>swapoff <span class="token parameter variable">-a</span><span class="token function">vim</span> /etc/fstab  <span class="token comment"># /swap.img      none    swap    sw      0       0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Transform this vm into template by Web UI of pve</li></ul><h2 id="4-Kubernetes"><a href="#4-Kubernetes" class="headerlink" title="4. Kubernetes"></a>4. Kubernetes</h2><h3 id="4-1-Install-kubeadm-kubelet-kubectl"><a href="#4-1-Install-kubeadm-kubelet-kubectl" class="headerlink" title="4.1 Install kubeadm kubelet kubectl"></a>4.1 Install kubeadm kubelet kubectl</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main <span class="token operator">></span> /etc/apt/sources.list.d/kubernetes.list<span class="token function">curl</span> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> <span class="token punctuation">\</span>apt-key <span class="token function">add</span> -<span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectlapt-mark hold kubelet kubeadm kubectl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster"><a href="#4-2-generate-a-default-configuration-file-in-workspace-path-to-init-the-cluster" class="headerlink" title="4.2 generate a default configuration file in workspace path to init the cluster"></a>4.2 generate a default configuration file in workspace path to init the cluster</h3><pre class="line-numbers language-none"><code class="language-none">kubeadm config print init-defaults --component-configs KubeletConfiguration &gt; kubeadm.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>modify part of configuration file</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">localAPIEndpoint</span><span class="token punctuation">:</span>  <span class="token key atrule">advertiseAddress</span><span class="token punctuation">:</span> 192.168.3.11  <span class="token comment">#master IP</span>  <span class="token key atrule">bindPort</span><span class="token punctuation">:</span> <span class="token number">6443</span><span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>  <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///var/run/containerd/containerd.sock  <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token comment">#name: master1  # defaults to be node</span>  <span class="token key atrule">taints</span><span class="token punctuation">:</span> <span class="token null important">null</span><span class="token punctuation">---</span><span class="token key atrule">apiServer</span><span class="token punctuation">:</span>  <span class="token key atrule">timeoutForControlPlane</span><span class="token punctuation">:</span> 4m0s<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3<span class="token key atrule">certificatesDir</span><span class="token punctuation">:</span> /etc/kubernetes/pki<span class="token key atrule">clusterName</span><span class="token punctuation">:</span> kubernetes<span class="token key atrule">controllerManager</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">dns</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">etcd</span><span class="token punctuation">:</span>  <span class="token key atrule">local</span><span class="token punctuation">:</span>    <span class="token key atrule">dataDir</span><span class="token punctuation">:</span> /var/lib/etcd<span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> registry.aliyuncs.com/google_containers  <span class="token comment">#changing into repository in china</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration<span class="token key atrule">kubernetesVersion</span><span class="token punctuation">:</span> 1.28.0    <span class="token comment"># specify the version of kube</span><span class="token key atrule">networking</span><span class="token punctuation">:</span>  <span class="token key atrule">dnsDomain</span><span class="token punctuation">:</span> cluster.local  <span class="token key atrule">podSubnet</span><span class="token punctuation">:</span> 10.244.0.0/16    <span class="token comment"># need to add</span>  <span class="token key atrule">serviceSubnet</span><span class="token punctuation">:</span> 10.96.0.0/12<span class="token key atrule">scheduler</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeproxy.config.k8s.io/v1alpha1 <span class="token comment"># add</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeProxyConfiguration<span class="token key atrule">mode</span><span class="token punctuation">:</span> ipvs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>init cluster</li></ul><pre class="line-numbers language-none"><code class="language-none">sudo kubeadm init --config kubeadm-config.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>work nodes joining the cluster</li></ul><pre class="line-numbers language-none"><code class="language-none">kubeadm join 192.168.3.14:6443 --token n8orxj.f51riixygulit9yz \        --discovery-token-ca-cert-hash sha256:c0af38d55001f6eaf09ca9248db5e048c492ee4b883f0534a54187eceb50a928<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>after all the work nodes joining the cluster, deploy the flannel</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://raw.githubusercontent.com/flannel-io/flannel/v0.20.1/Documentation/kube-flannel.ymlkubectl apply <span class="token parameter variable">-f</span> kube-flannel.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>check status of cluster</li></ul><pre class="line-numbers language-none"><code class="language-none">kubectl get nodes -Akubectl get pods -A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="5-Fault"><a href="#5-Fault" class="headerlink" title="5. Fault"></a>5. Fault</h2><h3 id="5-1-kubectl-get-nodes"><a href="#5-1-kubectl-get-nodes" class="headerlink" title="5.1 kubectl get nodes"></a>5.1 kubectl get nodes</h3><ul><li>descriobe</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">couldn't get current server API group list: Get <span class="token string">"http://localhost:8080/api?timeout=32s"</span><span class="token builtin class-name">:</span> dial tcp <span class="token number">127.0</span>.0.1:8080: connect: connection refusedThe connection to the server localhost:8080 was refused - did you specify the right <span class="token function">host</span> or port?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>solution: fogot to apply the config, it’s printed by the kubeadm init command</li></ul><pre class="line-numbers language-none"><code class="language-none">mkdir -p $HOME&#x2F;.kubesudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;configsudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="5-2-The-kubelet-is-not-running"><a href="#5-2-The-kubelet-is-not-running" class="headerlink" title="5.2 The kubelet is not running"></a>5.2 The kubelet is not running</h3><ul><li>describe</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>kubelet-check<span class="token punctuation">]</span> Initial <span class="token function">timeout</span> of 40s passed.Unfortunately, an error has occurred:        timed out waiting <span class="token keyword">for</span> the conditionThis error is likely caused by:        - The kubelet is not running        - The kubelet is unhealthy due to a misconfiguration of the <span class="token function">node</span> <span class="token keyword">in</span> some way <span class="token punctuation">(</span>required cgroups disabled<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>solution: changing the wrong advertiseAddress, supoose to be mine master IP.</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># in some  conditions, this setting may help. It controls the cgroup driver of kubelet</span>kind: KubeletConfigurationapiVersion: kubelet.config.k8s.io/v1beta1cgroupDriver: systemd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-3-coredns-pod-halting-on-creating-status"><a href="#5-3-coredns-pod-halting-on-creating-status" class="headerlink" title="5.3 coredns pod halting on creating status."></a>5.3 coredns pod halting on creating status.</h3><ul><li>describe</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Warning  FailedCreatePodSandBox  42s   kubelet            Failed to create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to setup network <span class="token keyword">for</span> sandbox <span class="token string">"03e2b9a1ceaf66beb681891dc276ea490d664822b43047f25d3b5d4a11e76eb0"</span><span class="token builtin class-name">:</span> plugin <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">"flannel"</span> failed <span class="token punctuation">(</span>add<span class="token punctuation">)</span>: <span class="token function">open</span> /run/flannel/subnet.env: no such <span class="token function">file</span> or directory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>solutions: creating a file &amp;&amp; reset the cluster and reinstall the kube-flannel. ( worked in this case, solution of <code>work not ready</code>)(the file below maybe useless,it’s important to set <code>Podsubnet</code> in the init config file)</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span>  /run/flannel/subnet.env  <span class="token comment">#  manual creating</span><span class="token assign-left variable">FLANNEL_NETWORK</span><span class="token operator">=</span><span class="token number">10.244</span>.0.0/16<span class="token assign-left variable">FLANNEL_SUBNET</span><span class="token operator">=</span><span class="token number">10.244</span>.0.1/24<span class="token assign-left variable">FLANNEL_MTU</span><span class="token operator">=</span><span class="token number">1450</span><span class="token assign-left variable">FLANNEL_IPMASQ</span><span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Hardware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DIY </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Multiple Domians in OpenLdap Use Case</title>
      <link href="/2023/10/24/multiple-domians-in-openldap-use-case/"/>
      <url>/2023/10/24/multiple-domians-in-openldap-use-case/</url>
      
        <content type="html"><![CDATA[<h1 id="OpenLDAP"><a href="#OpenLDAP" class="headerlink" title="OpenLDAP"></a>OpenLDAP</h1><h2 id="一、-概念"><a href="#一、-概念" class="headerlink" title="一、 概念"></a>一、 概念</h2><p><a href="https://www.openldap.org/doc/admin26/guide.html">官方手册</a></p><h3 id="1-1-常用属性"><a href="#1-1-常用属性" class="headerlink" title="1.1 常用属性"></a>1.1 常用属性</h3><ul><li>DN：Distinguished Name，LDAP记录项的标识，有唯一性，例如：dc:”cn&#x3D;admin,ou&#x3D;developer,dc&#x3D;163,dc&#x3D;com”  </li><li>dc&#x3D; DomainComponent 为域组件，域名的一部分</li><li>cn&#x3D;CommonName 为记录名，表示一个实体，最长到80个字符，可以为中文；</li><li>ou&#x3D;OrganizationUnit 为组织单位，用于分类，最多四级，每级最长32字符，可以为中文；</li><li>uid&#x3D;User id 为用户的唯一标识</li><li>c&#x3D;Country 为国家名，可选，为2个字符长</li><li>o&#x3D;Organization 为组织名，可选，可以3—64个字符长</li></ul><h2 id="二、-手动安装和配置-LDAP"><a href="#二、-手动安装和配置-LDAP" class="headerlink" title="二、 手动安装和配置 LDAP"></a>二、 手动安装和配置 LDAP</h2><h3 id="2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务"><a href="#2-1-安装-slapd-独立的-LDAP-守护进程，同时便于管理服务" class="headerlink" title="2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)"></a>2.1 安装 slapd (独立的 LDAP 守护进程，同时便于管理服务)</h3><pre class="line-numbers language-none"><code class="language-none">sudo apt install  -y slapd ldap-utils<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-重新配置-OpenLDAP，创建-base-dn"><a href="#2-2-重新配置-OpenLDAP，创建-base-dn" class="headerlink" title="2.2  重新配置 OpenLDAP，创建 base dn"></a>2.2  重新配置 OpenLDAP，创建 base dn</h3><pre class="line-numbers language-none"><code class="language-none">sudo dpkg-reconfigure slapd   # 主要配置密码 (密码在下一步重置，便于配置连接)，DNS domain name(即 LDAP 服务中的 base dn) 说明：第一步回答 No第二步填写域名，比如 mycompany.com第三步填写组织名，比如 Company第四步填写管理员密码，比如 secret；第五步确认管理员密码第六步选择使用的数据库后端，比如 MDB第七步选择在清除 slapd 时是否移除数据库，比如 Yes第八步选择是否移除旧数据库，比如 Yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码"><a href="#2-3-生成密码，用于控制台登录的admin帐号，需要保存此密文密码" class="headerlink" title="2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码"></a>2.3 生成密码，用于控制台登录的admin帐号，需要保存此密文密码</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">slappasswd<span class="token punctuation">&#123;</span>SSHA<span class="token punctuation">&#125;</span>UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>通过数据库修改admin用户的ldif文件<pre class="line-numbers language-ldif" data-language="ldif"><code class="language-ldif">&#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;cn\&#x3D;config&#x2F;olcDatabase\&#x3D;\&#123;1\&#125;mdb.ldifolcDatabase: &#123;1&#125;mdbolcSuffix: dc&#x3D;example,dc&#x3D;topolcRootDN: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;topolcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>olcDatabase: 定义使用的后端数据存储格式,遵循默认</li><li>olcSuffix: 设置 LDAP 服务的根</li><li>olcRootDN: 设置管理员用户的 dn</li><li>olcRootPW: 管理员用户的密码</li><li>修改后重启服务<pre class="line-numbers language-none"><code class="language-none">sudo slaptest -u   # 检查配置文件sudo systemctl enable slapd  --nowsudo slapcat        # 输出看到当前数据库内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="2-4-正确的修改olcRootPW-管理员用户的密码"><a href="#2-4-正确的修改olcRootPW-管理员用户的密码" class="headerlink" title="2.4 正确的修改olcRootPW: 管理员用户的密码"></a>2.4 正确的修改olcRootPW: 管理员用户的密码</h3><pre class="line-numbers language-none"><code class="language-none">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: modifyreplace: olcRootPWolcRootPW: example2020  # 保存在数据库文件中的时候将会被加密<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f passmodify.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">同时进入web ui，修改admin账户的密码，如果不修改两个密码都能管理域，二者修改一致之后，才是新的管理密码生效<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-5-简单结构展示"><a href="#2-5-简单结构展示" class="headerlink" title="2.5 简单结构展示"></a>2.5 简单结构展示</h3><p>略</p><h3 id="2-6-创建base-dn"><a href="#2-6-创建base-dn" class="headerlink" title="2.6 创建base dn"></a>2.6 创建base dn</h3><h4 id="2-6-1-查看LDAP服务器的根目录信息"><a href="#2-6-1-查看LDAP服务器的根目录信息" class="headerlink" title="2.6.1 查看LDAP服务器的根目录信息"></a>2.6.1 查看LDAP服务器的根目录信息</h4><pre class="line-numbers language-none"><code class="language-none">sudo ldapsearch -x -LLL -b &#39;&#39; -s base &#39;(objectclass&#x3D;*)&#39;dn:objectClass: topobjectClass: OpenLDAProotDSE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码"><a href="#2-6-2-基于-ldif-文件直接创建，不使用图形化交互。创建之后，对这个-base-dn-设置管理员的密码" class="headerlink" title="2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码"></a>2.6.2 基于 ldif 文件直接创建，不使用图形化交互。创建之后，对这个 base dn 设置管理员的密码</h4><pre class="line-numbers language-none"><code class="language-none">-dn: dc&#x3D;example,dc&#x3D;topchangetype: addobjectClass: topobjectClass: domain-dn: o&#x3D;example,dc&#x3D;example,dc&#x3D;topchangetype: addobjectClass: organizationo: example<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">ldapmodify -x -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -w example@2020  -f organization.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）"><a href="#2-7-创建多个-DIT-base-dn-（可以考虑尝试后端用-mysql-做数据库）" class="headerlink" title="2.7 创建多个 DIT + base dn （可以考虑尝试后端用 mysql 做数据库）"></a>2.7 创建多个 DIT + base dn （可以考虑尝试后端用 <code>mysql</code> 做数据库）</h3><h4 id="2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制"><a href="#2-7-1-为新的库，准备存储路径，并通过apparmor做权限限制" class="headerlink" title="2.7.1 为新的库，准备存储路径，并通过apparmor做权限限制"></a>2.7.1 为新的库，准备存储路径，并通过<code>apparmor</code>做权限限制</h4><pre class="line-numbers language-none"><code class="language-none">mkdir  &#x2F;var&#x2F;lib&#x2F;ldap2chown openldap:openldap  &#x2F;var&#x2F;lib&#x2F;ldap2vim &#x2F;etc&#x2F;apparmor.d&#x2F;usr.sbin.slapd# the databases and logs&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F; r,&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;** rwk,# lock file&#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;alock kw,sudo systemctl  reload  apparmor <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）"><a href="#2-7-2-准备-ldif-文件，创建新的-DIT（可以自定义路径）" class="headerlink" title="2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）"></a>2.7.2 准备 ldif 文件，创建新的 DIT（可以自定义路径）</h4><pre class="line-numbers language-none"><code class="language-none">dn: olcDatabase&#x3D;&#123;2&#125;mdb,cn&#x3D;configchangetype: addobjectClass: olcDatabaseConfigobjectClass: olcMdbConfigolcDbDirectory: &#x2F;var&#x2F;lib&#x2F;ldap2&#x2F;olcDatabase: &#123;2&#125;MdbolcDbIndex: objectClass eqolcDbIndex: cn,uid eqolcDbIndex: uidNumber,gidNumber eqolcDbIndex: member,memberUid eqolcLastMod: TRUEolcMonitoring: TRUEolcDBNoSync: TRUEolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth by * non eolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * readolcSuffix: dc&#x3D;example,dc&#x3D;techolcRootDN: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;techolcRootPW: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">sudo  ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f domian2.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2-7-3-新增并设置管理员"><a href="#2-7-3-新增并设置管理员" class="headerlink" title="2.7.3 新增并设置管理员"></a>2.7.3 新增并设置管理员</h4><pre class="line-numbers language-none"><code class="language-none">-dn: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;techobjectClass: simpleSecurityObjectobjectClass: organizationalRolecn: adminuserPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# 以下是playbook中模板文件-dn: cn&#x3D;admin,&#123;&#123; item.base_dn &#125;&#125;  changetype: add  objectClass: simpleSecurityObject  objectClass: organizationalRole  cn: admin  userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">sudo ldapadd -x -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;tech&quot; -w example@2020 -f basedn2.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2-7-4-多-DIT-跨域-ACL"><a href="#2-7-4-多-DIT-跨域-ACL" class="headerlink" title="2.7.4 多 DIT 跨域 ACL"></a>2.7.4 多 DIT 跨域 ACL</h4><ul><li><p>查询服务器的域</p><pre class="line-numbers language-none"><code class="language-none">ldapsearch -x -H ldap:&#x2F;&#x2F;10.13.3.107 -b &quot;&quot; -s base namingContexts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>设置一个全权限的 acl ，跨域访问，相应的用户需已经提前创建</p></li></ul><pre class="line-numbers language-none"><code class="language-none">让这个dn 用户: cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech ;  可以阅读这个base dn : dc&#x3D;example,dc&#x3D;top 下的所有条目.对应关系：数据库----&#123;1&#125;mdb  存储的数据是来自 dn: dc&#x3D;example,dc&#x3D;top 。即，对谁的访问则将 acl 添加在谁的库下  dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: modifyadd: olcAccessolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; by dn.base&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; read<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">ldapmodify   -Y   EXTERNAL   -H   ldapi:&#x2F;&#x2F;&#x2F;   -f  xxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2-7-5-测试"><a href="#2-7-5-测试" class="headerlink" title="2.7.5 测试"></a>2.7.5 测试</h4><pre class="line-numbers language-none"><code class="language-none">root@example-sys-test-06:&#x2F;etc&#x2F;ldap&#x2F;example# ldapsearch -x -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -D &quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; -w example@2020# extended LDIF## LDAPv3# base &lt;dc&#x3D;example,dc&#x3D;top&gt; with scope subtree# filter: (objectclass&#x3D;*)# requesting: ALL## example.topdn: dc&#x3D;example,dc&#x3D;topobjectClass: topobjectClass: domaindc: example# admin, example.topdn: cn&#x3D;admin,dc&#x3D;example,dc&#x3D;topobjectClass: simpleSecurityObjectobjectClass: organizationalRolecn: admin# search resultsearch: 2result: 0 Success# numResponses: 3# numEntries: 2root@example-sys-test-06:&#x2F;etc&#x2F;ldap&#x2F;example# ldapsearch -x -b &quot;dc&#x3D;example,dc&#x3D;tech&quot; -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -w example@2020# extended LDIF## LDAPv3# base &lt;dc&#x3D;example,dc&#x3D;tech&gt; with scope subtree# filter: (objectclass&#x3D;*)# requesting: ALL## search resultsearch: 2result: 32 No such object# numResponses: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试的日志<pre class="line-numbers language-none"><code class="language-none">Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 fd&#x3D;12 ACCEPT from IP&#x3D;127.0.0.1:59834 (IP&#x3D;0.0.0.0:389)Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; method&#x3D;128Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;user.tech,dc&#x3D;example,dc&#x3D;tech&quot; mech&#x3D;SIMPLE ssf&#x3D;0Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;2 text&#x3D;Sep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 op&#x3D;2 UNBINDSep 15 14:18:54 example-sys-test-06 slapd[10052]: conn&#x3D;1097 fd&#x3D;12 closed&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 fd&#x3D;12 ACCEPT from IP&#x3D;127.0.0.1:34916 (IP&#x3D;0.0.0.0:389)Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;32 nentries&#x3D;0 text&#x3D;Sep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 op&#x3D;2 UNBINDSep 15 14:19:14 example-sys-test-06 slapd[10052]: conn&#x3D;1098 fd&#x3D;12 closed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="三、-web管理器配置"><a href="#三、-web管理器配置" class="headerlink" title="三、 web管理器配置"></a>三、 web管理器配置</h2><h3 id="3-1-安装-LAM-（用于管理的Web-UI）"><a href="#3-1-安装-LAM-（用于管理的Web-UI）" class="headerlink" title="3.1 安装  LAM （用于管理的Web UI）"></a>3.1 安装  LAM （用于管理的Web UI）</h3><pre class="line-numbers language-none"><code class="language-none">apt-get install ldap-account-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>访问 <a href="http://ip/lam">http://ip/lam</a> ，lam的所有配置都可以在web端配置，不需要去服务器上修改一行代码</p><h4 id="3-1-1-LAM-configuration-helm-安装的主要修改内容"><a href="#3-1-1-LAM-configuration-helm-安装的主要修改内容" class="headerlink" title="3.1.1 LAM configuration (helm 安装的主要修改内容)"></a>3.1.1 LAM configuration (<a href="https://check-lc.github.io/ops_blog/2023/12/04/the-first-time-using-helm-charts/">helm 安装的主要修改内容</a>)</h4><pre>主要内容：  LDAP_DOMAIN: example.net;ibexample.com  LDAP_BASE_DN: dc=example,dc=net;dc=ibexample,dc=com  LDAP_SERVER: ldaps://ldap01.example.net  LDAP_USER: cn=administrator,dc=example,dc=net  LAM_LANG: zh_CN  LAM_PASSWORD: lam</pre><ul><li><p>tree view编辑更高效</p></li><li><p>如果选择 docker 安装镜像：ghcr.io&#x2F;ldapaccountmanager&#x2F;lam:8.4@sha256:283726bd23510f1c3bfbdcbfe861e6599e070616543aed02e9756075c97a9938</p></li></ul><h4 id="3-1-3-Nginx反向代理-LAM-Web-UI"><a href="#3-1-3-Nginx反向代理-LAM-Web-UI" class="headerlink" title="3.1.3 Nginx反向代理 LAM Web UI"></a>3.1.3 Nginx反向代理 LAM Web UI</h4><pre class="line-numbers language-none"><code class="language-none">upstream lam &#123;  server 10.13.3.108:8001;&#125;server &#123;  listen 80;  server_name lam.example.net;  return 301 https:&#x2F;&#x2F;$server_name$request_uri;&#125;server &#123;  server_name lam.example.net;  listen 443 ssl;  ssl_certificate webmin&#x2F;tls_ca.pem;  ssl_certificate_key webmin&#x2F;tls_key.pem;  location &#x2F; &#123;     proxy_pass http:&#x2F;&#x2F;lam&#x2F;;     proxy_set_header Host $host;     proxy_set_header X-Real-IP $remote_addr;     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;#     proxy_set_header X-Forwarded-Proto &quot;https&quot;;     proxy_read_timeout 1800s;     proxy_http_version 1.1;     proxy_set_header Upgrade $http_upgrade;     proxy_set_header Connection &quot;upgrade&quot;;    &#125;  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2-测试-phpldapadmin"><a href="#3-2-测试-phpldapadmin" class="headerlink" title="3.2 测试 phpldapadmin"></a>3.2 测试 phpldapadmin</h3><pre class="line-numbers language-none"><code class="language-none">Setting up php8.1 (8.1.2-1ubuntu2.14)                       # 版本信息，配置文件完整，存在证书认证并可以指定路径Setting up php (2:8.1+92ubuntu1) Setting up phpldapadmin (1.2.6.3-0.2)                                       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="3-2-1-安装"><a href="#3-2-1-安装" class="headerlink" title="3.2.1 安装"></a>3.2.1 安装</h4><pre class="line-numbers language-none"><code class="language-none">apt-get install phpldapadmin -ynano &#x2F;etc&#x2F;phpldapadmin&#x2F;config.php$servers-&gt;setValue(&#39;server&#39;,&#39;name&#39;,&#39;My LDAP Server&#39;);                      # 辨识，区分的作用$servers-&gt;setValue(&#39;server&#39;,&#39;host&#39;,&#39;69.87.216.102&#39;);                              #  修改ip为服务器 ip$servers-&gt;;setValue(&#39;server&#39;,&#39;base&#39;,array(&#39;dc&#x3D;example,dc&#x3D;com&#39;));                    # 修改 array 内容为需求的根$servers-&gt;setValue(&#39;login&#39;,&#39;auth_type&#39;,&#39;session&#39;);                                              $servers-&gt;setValue(&#39;login&#39;,&#39;bind_id&#39;,&#39;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;com&#39;);           #   绑定登录帐号admin，相应修改 dn 号即可$servers-&gt;setValue(&#39;auto_number&#39;,&#39;min&#39;,array(&#39;uidNumber&#39;&#x3D;&gt;10000,&#39;gidNumber&#39;&#x3D;&gt;10000));   # 规定 uid，gid 数字表示的起始范围<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-2-2-为-phpLDAPadmin-配置-Apache"><a href="#3-2-2-为-phpLDAPadmin-配置-Apache" class="headerlink" title="3.2.2 为 phpLDAPadmin 配置 Apache"></a>3.2.2 为 phpLDAPadmin 配置 Apache</h4><pre class="line-numbers language-none"><code class="language-none">a2dissite 000-default.conf        # 禁用默认的 Apache 虚拟主机配置文件systemctl restart apache2          <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="四、-主从架构-弃用，此配置需要在从服务器拉取-refresh"><a href="#四、-主从架构-弃用，此配置需要在从服务器拉取-refresh" class="headerlink" title="四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)"></a>四、 主从架构(弃用，此配置需要在从服务器拉取 refresh)</h2><p><a href="https://darkdark.top/ch5-replication.html">模式介绍</a></p><h3 id="4-1-master-加载同步模块"><a href="#4-1-master-加载同步模块" class="headerlink" title="4.1 master 加载同步模块"></a>4.1 master 加载同步模块</h3><pre class="line-numbers language-none"><code class="language-none">cat &#x2F;etc&#x2F;ldap&#x2F;mod_syncprov.ldifdn: cn&#x3D;module,cn&#x3D;configobjectClass: olcModuleListcn: moduleolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldapolcModuleLoad: syncprov.la          # 此配置和上一句配置，实际是在请求这个路径的文件，&#x2F;usr&#x2F;lib&#x2F;ldap&#x2F;syncprov.la，不确定的可以用 find 查找ldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f .&#x2F;mod_syncprov.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2-同步设置"><a href="#4-2-同步设置" class="headerlink" title="4.2 同步设置"></a>4.2 同步设置</h3><pre class="line-numbers language-none"><code class="language-none">root@example-sys-test-06:&#x2F;etc&#x2F;ldap# cat syncprov.ldif dn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config       # 此处需要确认自己的数据库是什么样的，&#123;2&#125;hdb--旧版本默认 &#x2F; &#123;1&#125;mdb--新版本默认objectClass: olcOverlayConfigobjectClass: olcSyncProvConfigolcOverlay: syncprovolcSpCheckpoint: 100 10olcSpSessionLog: 100ldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f .&#x2F;syncprov.ldif                             # 修改并应用条目到 LDAP 服务  -Y EXTERNAL    将使用服务器配置的外部身份验证方法进行身份验证，而不是使用用户名和密码; -H 指定服务器连接; -f 指定文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-3-从服务器配置"><a href="#4-3-从服务器配置" class="headerlink" title="4.3 从服务器配置"></a>4.3 从服务器配置</h3><pre class="line-numbers language-none"><code class="language-none">root@example-sys-test-07:&#x2F;etc&#x2F;ldap# cat syncrepl.ldifdn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: modifyadd: olcSyncReplolcSyncRepl: rid&#x3D;002  provider&#x3D;ldap:&#x2F;&#x2F;10.13.3.106:389&#x2F;        # 此处开始与上一行有缩进  bindmethod&#x3D;simple  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;  credentials&#x3D;example@2020        searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;  scope&#x3D;sub  schemachecking&#x3D;on  type&#x3D;refreshAndPersist  retry&#x3D;&quot;5 5 300 +&quot;  attrs&#x3D;&quot;*,+&quot;  interval&#x3D;00:00:00:3ldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f &#x2F;etc&#x2F;ldap&#x2F;syncrepl.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>运行中，修改主服务器内数据后，对从服务器u做刷新，可以看到是否同步</li></ul><p>参数说明：</p><ul><li>provider 为ldap master&#x2F;slave的地址 ;</li><li>binddn：为域的基本信息，注这里一定要用管理员进行登录，否则同步不到用户的密码。</li><li>credentials: ldap管理员的密码</li><li>searchbase：选择要同步的独立域，根节点</li><li>scope：设置所有的条目匹配</li><li>schemachecking：设置同步更新时间检测</li><li>type：同步模式为refreshAndPersist， refreshOnly 模式下后续操作由客户端轮询完成</li><li>retry:同步更新重试次数和时间刚开始的5秒重试5次，以后每300秒重试一次</li><li>attrs:复制全部属性</li><li>interval 这里设置更新时间，这里为3秒一次，倒数第二个是分钟 以此类推。</li></ul><h2 id="四、-镜像复制（互为主从）"><a href="#四、-镜像复制（互为主从）" class="headerlink" title="四、 镜像复制（互为主从）"></a>四、 镜像复制（互为主从）</h2><p><a href="https://darkdark.top/ch5-replication.html">模式介绍</a></p><h3 id="4-1-为某域编辑-mirrorsync-ldif"><a href="#4-1-为某域编辑-mirrorsync-ldif" class="headerlink" title="4.1 为某域编辑 mirrorsync.ldif"></a>4.1 为某域编辑 mirrorsync.ldif</h3><pre class="line-numbers language-none"><code class="language-none">dn: cn&#x3D;module,cn&#x3D;config         # 此段配置加载s ync 模块objectClass: olcModuleListcn: moduleolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldapolcModuleLoad: syncprov.la     # 此配置和上一句，实际是在请求这个路径的文件，&#x2F;usr&#x2F;lib&#x2F;ldap&#x2F;syncprov.la，不确定的可 find 查找-dn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config         # 此处需确认自己的数据库，&#123;2&#125;hdb--为旧版本默认 &#x2F; &#123;1&#125;mdb--为新版本默认。路径 &#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;cn\&#x3D;config&#x2F;olcDatabase\&#x3D;\&#123;1\&#125;mdb.ldifobjectClass: olcOverlayConfigobjectClass: olcSyncProvConfigolcOverlay: syncprovolcSpSessionLog: 100-dn: cn&#x3D;configchangetype: modifyreplace: olcServerIDolcServerID: 0                                        # 用于标识本机的 server iddn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;config      # 以下配置用于开启复制，指定主服务器changetype: modifyadd: olcSyncReplolcSyncRepl: rid&#x3D;000                             # 标识唯一的 replica id  provider&#x3D;ldaps:&#x2F;&#x2F;ldap01.example.top       # 看上述记录介绍参数  bindmethod&#x3D;simple  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;  credentials&#x3D;example@2020  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;  tls_reqcert&#x3D;allow  scope&#x3D;sub  schemachecking&#x3D;on  type&#x3D;refreshAndPersist  retry&#x3D;&quot;30 5 300 3&quot;  interval&#x3D;00:00:05:00-add: olcMirrorMode                        # 开启 mirror modeolcMirrorMode: TRUE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-2-ldap01-example-top下编辑-mirrorsync-ldif"><a href="#4-2-ldap01-example-top下编辑-mirrorsync-ldif" class="headerlink" title="4.2 ldap01.example.top下编辑 mirrorsync.ldif"></a>4.2 ldap01.example.top下编辑 mirrorsync.ldif</h3><pre class="line-numbers language-none"><code class="language-none">dn: cn&#x3D;module,cn&#x3D;configobjectClass: olcModuleListcn: moduleolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldapolcModuleLoad: syncprov.la-dn: olcOverlay&#x3D;syncprov,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configobjectClass: olcOverlayConfigobjectClass: olcSyncProvConfigolcOverlay: syncprovolcSpSessionLog: 100-dn: cn&#x3D;configchangetype: modifyreplace: olcServerIDolcServerID: 1dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: modifyadd: olcSyncReplolcSyncRepl: rid&#x3D;001  provider&#x3D;ldaps:&#x2F;&#x2F;ldap.example.top  bindmethod&#x3D;simple  binddn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot;  credentials&#x3D;example@2020  searchbase&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot;  tls_reqcert&#x3D;allow  scope&#x3D;sub  schemachecking&#x3D;on  type&#x3D;refreshAndPersist  retry&#x3D;&quot;30 5 300 3&quot;  interval&#x3D;00:00:05:00-add: olcMirrorModeolcMirrorMode: TRUE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4-2-1-加载配置"><a href="#4-2-1-加载配置" class="headerlink" title="4.2.1 加载配置"></a>4.2.1 加载配置</h4><pre class="line-numbers language-none"><code class="language-none">ldapadd -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f mirrorsync.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="五、-TLS加密（自签名-权威证书）"><a href="#五、-TLS加密（自签名-权威证书）" class="headerlink" title="五、 TLS加密（自签名&#x2F;权威证书）"></a>五、 TLS加密（自签名&#x2F;权威证书）</h2><p>（自签名证书加密连接 nextcloud 失败，使用不便，采用 权威证书（多域合一）或stunnel）</p><h3 id="5-1-CA中心创建证书"><a href="#5-1-CA中心创建证书" class="headerlink" title="5.1 CA中心创建证书"></a>5.1 CA中心创建证书</h3><pre><code>此时使用LDAP 主服务器 作为 CA 中心，自签名</code></pre><ul><li><p>安装 gnutls-bin 和 ssl-cert 包</p><pre class="line-numbers language-none"><code class="language-none">sudo apt install gnutls-bin ssl-cert<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>为证书授权中心创建私钥</p><pre class="line-numbers language-none"><code class="language-none">sudo certtool --generate-privkey --bits 4096 --outfile &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>创建模板文件来定义CA</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ssl&#x2F;ca.info cn &#x3D; example (example company)   ca cert_signing_key expiration_days &#x3D; 3650<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建自签名 CA (根)证书</p><pre class="line-numbers language-none"><code class="language-none">sudo certtool --generate-self-signed \--load-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \--template &#x2F;etc&#x2F;ssl&#x2F;ca.info \--outfile &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Note：<br>  <code>--outfile</code>路径是正确的，将CA证书写入<code>/usr/local/share/ca-certificates</code>。<br>  <strong>update-ca-certificates</strong> 将从这里获取受信任的本地CA。如果要从<code>/usr/share/ca-certificates</code>获取CA，需要调用<code>dpkg-reconfigure ca-certificates</code></p></li><li><p>将新的 CA 根证书添加到受信任 CA 列表</p><pre class="line-numbers language-none"><code class="language-none">sudo update-ca-certificates     # 会创建一个&#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem符号链接，指向&#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates中的真实文件<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h3 id="5-2-创建-LDAP-服务的服务器私钥与证书"><a href="#5-2-创建-LDAP-服务的服务器私钥与证书" class="headerlink" title="5.2 创建 LDAP 服务的服务器私钥与证书"></a>5.2 创建 LDAP 服务的服务器私钥与证书</h3><ul><li><p>创建私钥</p><pre class="line-numbers language-none"><code class="language-none">sudo certtool --generate-privkey \--bits 2048 \--outfile &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>服务器信息文件</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ssl&#x2F;ldap01.infoorganization &#x3D; examplecn &#x3D; ldap01.example.top                     # 服务器证书的DN必须使用CN属性来命名服务器，并且CN必须携带服务器的完全限定域名，dns 需要有 A 记录解析tls_www_serverencryption_keysigning_keyexpiration_days &#x3D; 365证书有效期为1年，仅对_&#96;ldap01&#96;_主机名有效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建LDAP服务器的证书</p><pre class="line-numbers language-none"><code class="language-none">sudo certtool --generate-certificate \--load-privkey &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem \--load-ca-certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem \--load-ca-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \--template &#x2F;etc&#x2F;ssl&#x2F;ldap01.info \--outfile &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_cert.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>调整权限</p><pre class="line-numbers language-none"><code class="language-none">sudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pemsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>ca根证书加入到受信列表</p><pre class="line-numbers language-none"><code class="language-none">sudo cp   cacertificatefile  &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crtsudo update-ca-certificates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>对LDAP服务配置证书</p><pre class="line-numbers language-none"><code class="language-none">dn: cn&#x3D;configadd: olcTLSCACertificateFileolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem-add: olcTLSCertificateFileolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_cert.pem-add: olcTLSCertificateKeyFileolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;ldap01_slapd_key.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>配置slapd-config数据库：</p><pre class="line-numbers language-none"><code class="language-none">sudo ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>报错调整，更改<code>certinfo.ldif</code>，将<code>add</code>改成了<code>replace</code>，可以解决以下问题。修改后再次执行<code>ldapmodify</code></p><pre class="line-numbers language-none"><code class="language-none">ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif SASL&#x2F;EXTERNAL authentication started SASL username: gidNumber&#x3D;0+uidNumber&#x3D;0,cn&#x3D;peercred,cn&#x3D;external,cn&#x3D;auth SASL SSF: 0 modifying entry &quot;cn&#x3D;config&quot; ldap_modify: Inappropriate matching (18) additional info: modify&#x2F;add: olcTLSCACertificateFile: no equality matching rule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>ldap-client增添配置文件</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ldap&#x2F;ldap.conf# LDAP Defaults# See ldap.conf(5) for details# This file should be world readable but not world writable.BASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DNURI ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制[[TIMELIMIT]]  15                                                                     # 最长搜索时间[[DEREF]]              never                                                            # 指定对别名的处理方式# TLS certificates (needed for GnuTLS)TLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径TLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;default&#x2F;slapdSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>测试启动 TLS</p><pre class="line-numbers language-none"><code class="language-none">ldapwhoami -x -ZZ -H ldap:&#x2F;&#x2F;ldap01.example.comanonymous<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>测试连接</p><pre class="line-numbers language-none"><code class="language-none">ldapwhoami -x -H ldaps:&#x2F;&#x2F;ldap01.example.comanonymous<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器"><a href="#5-3-LDAP-从服务器的-TLS-在主服务器创建后，拷贝证书到从服务器" class="headerlink" title="5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器"></a>5.3 LDAP 从服务器的 TLS, 在主服务器创建后，拷贝证书到从服务器</h3><ul><li>指定目录保存<pre class="line-numbers language-none"><code class="language-none">mkdir ldap02-sslcd ldap02-sslcerttool --generate-privkey \--bits 2048 \--outfile ldap02_slapd_key.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>编辑信息文件ldap02.info<pre class="line-numbers language-none"><code class="language-none">organization &#x3D; examplecn &#x3D; ldap02.example.top                      tls_www_serverencryption_keysigning_keyexpiration_days &#x3D; 365<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>创建证书<pre class="line-numbers language-none"><code class="language-none">sudo certtool --generate-certificate \--load-privkey ldap02_slapd_key.pem \--load-ca-certificate &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem \--load-ca-privkey &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;mycakey.pem \--template ldap02.info \--outfile ldap02_slapd_cert.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><pre class="line-numbers language-none"><code class="language-none">cp &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem .scp -r ldap02-ssl user@ldap02_ip:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>从服务器中安装证书<pre class="line-numbers language-none"><code class="language-none">sudo cp ldap02_slapd_cert.pem ldap02_slapd_key.pem &#x2F;etc&#x2F;ldapsudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pemsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pemsudo cp mycacert.pem &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crtsudo update-ca-certificates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>对LDAP服务配置证书 <code>./certinfo.ldif </code><pre class="line-numbers language-none"><code class="language-none">dn: cn&#x3D;configadd: olcTLSCACertificateFileolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem-add: olcTLSCertificateFileolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_cert.pem-add: olcTLSCertificateKeyFileolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;ldap02_slapd_key.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>配置slapd-config数据库：<pre class="line-numbers language-none"><code class="language-none">sudo ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f certinfo.ldif <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>增添配置文件<pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ldap&#x2F;ldap.confBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DNURI ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制[[TIMELIMIT]]  15                                                                     # 最长搜索时间[[DEREF]]              never                                                            # 指定对别名的处理方式# TLS certificates (needed for GnuTLS)TLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径TLS_REQCERT demand                                                        # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>需要访问 LDAPS（LDAP over SSL），需要编辑配置，并重启 slapd<pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;default&#x2F;slapdSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>测试启动 TLS<pre class="line-numbers language-none"><code class="language-none">ldapwhoami -x -ZZ -H ldap:&#x2F;&#x2F;ldap02.example.topanonymous<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>测试连接<pre class="line-numbers language-none"><code class="language-none">ldapwhoami -x -H ldaps:&#x2F;&#x2F;ldap02.example.topanonymous<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="5-4-使用合法证书"><a href="#5-4-使用合法证书" class="headerlink" title="5.4 使用合法证书"></a>5.4 使用合法证书</h3><ul><li><p>将新的 CA 根证书添加到受信任 CA 列表（客户端操作，权威证书按理不需要拷贝，未测试）</p><pre class="line-numbers language-none"><code class="language-none">sudo   cp   _.example.top-chain.pem   &#x2F;usr&#x2F;local&#x2F;share&#x2F;ca-certificates&#x2F;mycacert.crtsudo update-ca-certificates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>准备服务器证书和私钥（服务端）</p><pre class="line-numbers language-none"><code class="language-none"> ls &#x2F;etc&#x2F;ldapcertinfo.ldif   _.example.top-crt.pem   _.example.top-key.pemsudo chgrp openldap &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pemsudo chmod 0640 &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>certinfo.ldif</p><pre class="line-numbers language-none"><code class="language-none">dn: cn&#x3D;configchangetype: modifyreplace: olcTLSCACertificateFileolcTLSCACertificateFile: &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;mycacert.pem-replace: olcTLSCertificateFileolcTLSCertificateFile: &#x2F;etc&#x2F;ldap&#x2F;_.example.top-crt.pem-replace: olcTLSCertificateKeyFileolcTLSCertificateKeyFile: &#x2F;etc&#x2F;ldap&#x2F;_.example.top-key.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><pre class="line-numbers language-none"><code class="language-none">sudo ldapadd  -Y   EXTERNAL  -H  ldapi:&#x2F;&#x2F;&#x2F;   -f    certinfo.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>增添配置文件，这是客户端需要连接 ldap 服务器使用的配置。可以忽略。<pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ldap&#x2F;ldap.confBASE       dc&#x3D;example,dc&#x3D;top                                                      # LDAP服务的基础DN[[URI]] ldap:&#x2F;&#x2F;localhost:389 ldaps:&#x2F;&#x2F;localhost:636                        # 指定LDAP服务器的连接地址，似乎不起作用[[SIZELIMIT]]  12                                                                      # 搜索结果的数量限制[[TIMELIMIT]]  15                                                                     # 最长搜索时间[[DEREF]]              never                                                            # 指定对别名的处理方式# TLS certificates (needed for GnuTLS)TLS_CACERT  &#x2F;etc&#x2F;ssl&#x2F;certs&#x2F;ca-certificates.crt                      # TLS连接时使用的CA证书文件的路径，必需TLS_REQCERT allow                                                      # &quot;demand&quot;，表示需要验证服务器的证书<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>启用 ldaps，重启 slapd<pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;default&#x2F;slapdSLAPD_SERVICES&#x3D;&quot;ldap:&#x2F;&#x2F;&#x2F; ldapi:&#x2F;&#x2F;&#x2F; ldaps:&#x2F;&#x2F;&#x2F;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="5-5-使用-nextcloud-测试加密连接"><a href="#5-5-使用-nextcloud-测试加密连接" class="headerlink" title="5.5 使用 nextcloud 测试加密连接"></a>5.5 使用 nextcloud 测试加密连接</h3><ul><li><p>docker 安装 nexcloud，登录 UI ，右上角点击账户，选择应用</p></li><li><p>应用捆绑包，启用 LDAP user and group backend</p></li><li><p>设置连接</p></li><li><p>ldaps连接(严格一致才是tls加密，nextcloud应该只信任权威证书)</p></li><li><p>明文传输</p></li></ul><h3 id="5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin"><a href="#5-6-stunnel-加密传输两个应用的数据-例：phpldapadmin" class="headerlink" title="5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)"></a>5.6 stunnel 加密传输两个应用的数据(例：phpldapadmin)</h3><p>链路： ldap user ui  —- stunnel client  accept  —-  stunnel client connect  —- stunnel server accept  —- stunnel server connect —-ldap server port</p><pre class="line-numbers language-none"><code class="language-none">apt install -y stunnel4vim &#x2F;etc&#x2F;default&#x2F;stunnel4ENABLED&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none"># stunnel 服务端cert &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pemkey &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel-key.pemverify &#x3D; 3client &#x3D; nodebug &#x3D; 6pid &#x3D; &#x2F;var&#x2F;run&#x2F;stunnel4&#x2F;stunnel4.pid[ldap]accept &#x3D; 10.13.3.106:6360                # 监听 stunnel 服务的流量，客户端（是指stunnel 客户端）将连接此目标并发送流量到这里connect &#x3D; 10.13.3.106:389                # 转发到 stunnel 加密连接的服务的端口CAfile &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem# stunnel 客户端cert &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pemkey &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel-key.pemverify &#x3D; 3client &#x3D; yesdebug &#x3D; 6setuid &#x3D; stunnel4setgid &#x3D; stunnel4pid &#x3D; &#x2F;var&#x2F;run&#x2F;stunnel4&#x2F;stunnel4.pid[ldap]accept &#x3D; 10.13.3.107:389                # 监听 stunnel 服务的流量，客户端（是指ldap的客户端）将连接此目标并发送流量到这里connect &#x3D; 10.13.3.106:6360              # 加密连接并转发到 stunnel 的服务端CAfile &#x3D; &#x2F;etc&#x2F;stunnel&#x2F;stunnel.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;phpldapadmin&#x2F;config.php$servers-&gt;setValue(&#39;server&#39;,&#39;host&#39;,&#39;69.87.216.102&#39;);  # 指向 stunnel 客户端，和他本地监听的端口$servers-&gt;setValue(&#39;server&#39;,&#39;port&#39;,389);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="六、-其他模块"><a href="#六、-其他模块" class="headerlink" title="六、 其他模块"></a>六、 其他模块</h2><h3 id="6-1-日志模块"><a href="#6-1-日志模块" class="headerlink" title="6.1 日志模块"></a>6.1 日志模块</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ldap&#x2F;loglevel.ldifdn: cn&#x3D;configchangetype: modifyreplace: olcLogLevelolcLogLevel: statsldapmodify  -Y  EXTERNAL  -H  ldapi:&#x2F;&#x2F;&#x2F;  -f  loglevel.ldif               # 日志在&#x2F;var&#x2F;log&#x2F;syslog | grep slapd , 比默认的级别详细<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-2-memberOf-开启"><a href="#6-2-memberOf-开启" class="headerlink" title="6.2 memberOf 开启"></a>6.2 memberOf 开启</h3><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ldap&#x2F;refint.ldif# enable_refint.ldifdn: cn&#x3D;module&#123;0&#125;,cn&#x3D;configchangetype: modifyadd: olcModuleLoadolcModuleLoad: refint.la-dn: olcOverlay&#x3D;refint,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: addobjectClass: olcOverlayConfigobjectClass: olcRefintConfigolcOverlay: refintldapadd -Q -Y EXTERNAL -H ldapi:&#x2F;&#x2F; -f refint.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;ldap&#x2F;memberof.ldifdn: cn&#x3D;module,cn&#x3D;configchangetype: addcn: moduleobjectClass: olcModuleListolcModulePath: &#x2F;usr&#x2F;lib&#x2F;ldapdn: cn&#x3D;module&#123;0&#125;,cn&#x3D;configchangetype: modifyadd: olcModuleLoadolcModuleLoad: memberof.ladn: olcOverlay&#x3D;memberof,olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: addobjectClass: olcConfigobjectClass: olcMemberOfobjectClass: olcOverlayConfigobjectClass: topolcOverlay: memberofolcMemberOfDangling: ignoreolcMemberOfRefInt: TRUEolcMemberOfGroupOC: groupOfNamesolcMemberOfMemberAD: memberolcMemberOfMemberOfAD: memberOfldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f memberof.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>为条目添加此属性：LDIF文件中先创建用户的dn，然后创建目标组的dn，在创建组的时候将关联的用户写在member属性中</li></ul><h3 id="6-3-Self-Service-Password-自助密码管理"><a href="#6-3-Self-Service-Password-自助密码管理" class="headerlink" title="6.3 Self Service Password 自助密码管理"></a>6.3 Self Service Password 自助密码管理</h3><ul><li>容器部署，解决 php 依赖准备繁琐</li><li>镜像 ltbproject&#x2F;self-service-password:1.5.3</li><li>为 admin 用户设置修改密码的权限<pre class="line-numbers language-none"><code class="language-none">下列权限可以使得 &quot;admin,example,net&quot; 对这个域 &quot;dc&#x3D;example,dc&#x3D;tech&quot; 做用户添加、属性修改olcAccess: &#123;0&#125;to attrs&#x3D;userPassword,shadowLastChange by dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write by anonymous auth by self write by * noneolcAccess: &#123;1&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>需要对企业邮箱帐号开启设置-帐号与安全-客户端设置-客户端授权密码</li><li>ssp.conf.php  成功配置版本，并映射到容器： &#x2F;home&#x2F;example&#x2F;sspasswd&#x2F;conf.php:&#x2F;var&#x2F;www&#x2F;conf&#x2F;config.inc.local.php<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token variable">$debug</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$keyphrase</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"example"</span><span class="token punctuation">;</span><span class="token variable">$use_sms</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$use_questions</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$lang</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"cn,zh-CN"</span><span class="token punctuation">;</span><span class="token variable">$use_change</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token comment">#$reset_url = $_SERVER['HTTP_X_FORWARDED_PROTO'] . "://" . $_SERVER['HTTP_X_FORWARDED_HOST'] . $_SERVER['SCRIPT_NAME'];</span><span class="token variable">$reset_url</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"https://ssp.example.net"</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_X_FORWARDED_HOST'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SCRIPT_NAME'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$show_menu</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$logo</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"images/logo.png"</span><span class="token punctuation">;</span>                <span class="token comment"># 这两项在配置前，需要确保图片映射路径在容器内部的 /var/www/html/images 下</span><span class="token variable">$background_image</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"images/back.png"</span><span class="token punctuation">;</span><span class="token variable">$default_action</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"sendtoken"</span><span class="token punctuation">;</span>        <span class="token comment"># 默认展示在首页的修改密码的方式</span><span class="token variable">$show_menu</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>              <span class="token comment"># 关闭顶部的修改方式选择菜单</span><span class="token comment"># LDAP</span><span class="token variable">$ldap_url</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"ldap://10.13.3.107/"</span><span class="token punctuation">;</span><span class="token variable">$ldap_starttls</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$ldap_binddn</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"cn=admin,dc=example,dc=net"</span><span class="token punctuation">;</span><span class="token variable">$ldap_bindpw</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'example@2020'</span><span class="token punctuation">;</span><span class="token comment">#$ldap_bindpw = "&#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi";</span><span class="token variable">$ldap_base</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"dc=example,dc=net"</span><span class="token punctuation">;</span><span class="token comment">#$ldap_base = "dc=example,dc=tech";    # 在这里同时书写两个，只会生效后一个域, 使用两个实例连接 ldap 服务</span><span class="token variable">$ldap_fullname_attribute</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"cn"</span><span class="token punctuation">;</span><span class="token variable">$ldap_filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"(&amp;(objectClass=inetOrgPerson)(<span class="token interpolation"><span class="token variable">$ldap_fullname_attribute</span></span>=&#123;login&#125;))"</span><span class="token punctuation">;</span><span class="token variable">$ldap_use_exop_passwd</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$ldap_use_ppolicy_control</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$TLS_REQCERT</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"allow"</span><span class="token punctuation">;</span><span class="token comment"># email</span><span class="token variable">$mail_attributes</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"mail"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"gosaMailAlternateAddress"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"proxyAddresses"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$mail_address_use_ldap</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token variable">$mail_from</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"user5@example.net"</span><span class="token punctuation">;</span><span class="token variable">$mail_from_name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"密码自主修改服务"</span><span class="token punctuation">;</span><span class="token variable">$mail_signature</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"如有疑问,请联系运维同事,英博智云."</span><span class="token punctuation">;</span><span class="token variable">$notify_on_change</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$mail_protocol</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'smtp'</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_host</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'smtphz.qiye.163.com'</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_auth</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_user</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"user5@example.net"</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_pass</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'TdhYDdgvN7Hpky5a'</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_port</span> <span class="token operator">=</span> <span class="token number">465</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_timeout</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_keepalive</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_secure</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ssl'</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_autotls</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><span class="token variable">$mail_smtp_options</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$mail_contenttype</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'text/plain'</span><span class="token punctuation">;</span><span class="token variable">$mail_wordwrap</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$mail_charset</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'utf-8'</span><span class="token punctuation">;</span><span class="token variable">$mail_priority</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment"># password policy</span><span class="token variable">$hash</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SSHA"</span><span class="token punctuation">;</span> <span class="token comment"># 修改的用户密码传递过程中会采取这里指定的加密</span><span class="token variable">$pwd_min_length</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span><span class="token variable">$pwd_max_length</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token variable">$pwd_min_lower</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$pwd_min_upper</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$pwd_min_digit</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$pwd_min_special</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$pwd_special_chars</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"^a-zA-Z0-9"</span><span class="token punctuation">;</span><span class="token variable">$pwd_complexity</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token variable">$pwd_no_reuse</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span class="token variable">$pwd_forbidden_words</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"example"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"example"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"example"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$pwd_show_policy_pos</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"above"</span><span class="token punctuation">;</span><span class="token variable">$pwd_show_policy</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"onerror"</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><pre class="line-numbers language-none"><code class="language-none">docker run -p 8000:80 \&gt; --restart&#x3D;always \&gt; --name sspass \&gt; -v &#x2F;home&#x2F;example&#x2F;sspasswd&#x2F;conf.php:&#x2F;var&#x2F;www&#x2F;conf&#x2F;config.inc.local.php \&gt; -itd docker.io&#x2F;ltbproject&#x2F;self-service-password<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="6-3-1-不能进入修改链接-Token-is-not-valid"><a href="#6-3-1-不能进入修改链接-Token-is-not-valid" class="headerlink" title="6.3.1 不能进入修改链接 Token is not valid"></a>6.3.1 不能进入修改链接 Token is not valid</h4><pre class="line-numbers language-none"><code class="language-none">注释了这两项#$use_tokens &#x3D; true;#$crypt_tokens &#x3D; true;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="6-3-2-反向代理-Self-Service-Password"><a href="#6-3-2-反向代理-Self-Service-Password" class="headerlink" title="6.3.2 反向代理 Self Service Password"></a>6.3.2 反向代理 Self Service Password</h4><pre class="line-numbers language-none"><code class="language-none">upstream ssp &#123;  server 10.13.3.108:8000;&#125;server &#123;    listen 80;    server_name ssp.example.net;    return 301 https:&#x2F;&#x2F;$server_name$request_uri;&#125;server &#123;    listen 443 ssl ;    server_name ssp.example.net;    ssl_certificate webmin&#x2F;tls_ca.pem;    ssl_certificate_key webmin&#x2F;tls_key.pem;    location &#x2F; &#123;      proxy_pass http:&#x2F;&#x2F;ssp;      proxy_set_header Host $host;      proxy_set_header X-Real-IP $remote_addr;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;      proxy_set_header X-Forwarded-Proto &quot;https&quot;;      proxy_read_timeout 1800s;      proxy_http_version 1.1;      proxy_set_header Upgrade $http_upgrade;      proxy_set_header Connection &quot;upgrade&quot;;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="6-4-LDAP-对目录信息的数据做备份还原和迁移"><a href="#6-4-LDAP-对目录信息的数据做备份还原和迁移" class="headerlink" title="6.4 LDAP 对目录信息的数据做备份还原和迁移"></a>6.4 LDAP 对目录信息的数据做备份还原和迁移</h3><h4 id="6-4-1-备份"><a href="#6-4-1-备份" class="headerlink" title="6.4.1 备份"></a>6.4.1 备份</h4><pre class="line-numbers language-none"><code class="language-none">sudo slapcat -n 3 -l .&#x2F;back3.ldif           # -n 指定数据库编号，数字对应各个dit的数据库编号( 配置数据库----olcDatabase&#x3D;&#123;0&#125;config.ldif; 目录信息数据库----olcDatabase&#x3D;&#123;1&#125;mdb.ldif )<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="6-4-2-恢复"><a href="#6-4-2-恢复" class="headerlink" title="6.4.2 恢复"></a>6.4.2 恢复</h4><p>原服务器上恢复，服务需要暂停</p><pre class="line-numbers language-none"><code class="language-none">sudo systemctl stop slapd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置目录一般位于 <code>/etc/openldap/slapd.d</code>，将原有配置删除，然后使用 <code>slapadd</code> 导入新的配置</p><pre class="line-numbers language-none"><code class="language-none">$ rm -rf &#x2F;etc&#x2F;ldap&#x2F;slapd.d&#x2F;*$ slapadd  -n  0  -F  &#x2F;etc&#x2F;ldap&#x2F;slapd.d  -l  .&#x2F;config.2021-09-18.ldif$ chown -R openldap:openldap &#x2F;etc&#x2F;ldap&#x2F;slapd.d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>数据目录一般位于 <code>/var/lib/ldap-*</code>，模拟时，将原有数据删除，然后使用 <code>slapadd</code> 导入新的数据：</p><pre class="line-numbers language-none"><code class="language-none">$ rm  -rf  &#x2F;var&#x2F;lib&#x2F;ldap-example&#x2F;*         # 定制了不同的$default_action &#x3D; &quot;sendtoken&quot;;$show_menu &#x3D; false;dit有不同的目录分别存储不同domain的内容，注意，导入前目录必需首先存在，且权属 openldap:openldap。$ slapadd -n 1 -F &#x2F;etc&#x2F;openldap&#x2F;slapd.d -l .&#x2F;data.2021-09-18.ldif$ chown -R openldap:openldap  &#x2F;var&#x2F;lib&#x2F;ldap-example$ systemctl start slapd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="6-4-3-openldap的迁移"><a href="#6-4-3-openldap的迁移" class="headerlink" title="6.4.3 openldap的迁移"></a>6.4.3 openldap的迁移</h4><p>playbook 新建的服务器，执行恢复</p><pre class="line-numbers language-none"><code class="language-none">slapadd -n 1 -F &#x2F;etc&#x2F;openldap&#x2F;slapd.d -l .&#x2F;data.2021-09-18.ldif[[如果导入失败，或者数据已存在，删除rm]] -rf &#x2F;var&#x2F;lib&#x2F;ldap&#x2F;*  重新导入<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="七、-命令资料"><a href="#七、-命令资料" class="headerlink" title="七、 命令资料"></a>七、 命令资料</h2><blockquote><p><a href="https://blog.csdn.net/jenyzhang/article/details/56487627">来自此处</a><br>ldap<br>    |-slapd             目录服务的主要程序<br>    |-slurpd           目录服务进行复制的程序<br>    |-slapadd           向目录中添加数据<br>    |-slapcat           把目录中的条目导出成ldif文件<br>    |-slapindex         重建目录的索引<br>    |-ldapcompare       对目录的条目的属性进行比较<br>    |-ldapadd           向目录服务中添加条目<br>    |-ldapdelete        删除目录中的条目<br>    |-ldapmodify        更新目录中条目的值<br>    |-ldapmodrdn        更改条目的DN<br>    |-ldappasswd        更改条目的密码<br>    |-ldapsearch        对目录进行查询</p></blockquote><blockquote><p>ldapadd<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -h   目录服务的地址<br>      -w   绑定DN的密码<br>      -f   使用ldif文件进行条目添加的文件        </p></blockquote><ul><li>例子<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -f &#x2F;root&#x2F;test.ldif<br>       ldapadd -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret (这样写就是在命令行添加条目)</li></ul><p>       </p><blockquote><p>ldapsearch<br>      -x   进行简单认证<br>      -D   用来绑定服务器的DN<br>      -w   绑定DN的密码<br>      -b   指定要查询的根节点<br>      -H   制定要查询的服务器<br>      -s   指定搜索范围的类型     </p></blockquote><ul><li>例子<br>   ldapsearch -x -D “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” -w secret -b “dc&#x3D;starxing,dc&#x3D;com”<br>       使用简单认证，用 “cn&#x3D;root,dc&#x3D;starxing,dc&#x3D;com” 进行绑定，<br>       要查询的根是 “dc&#x3D;starxing,dc&#x3D;com”。这样会把绑定的用户能访问”dc&#x3D;starxing,dc&#x3D;com”下的所有数据显示出来。<br> ldapsearch -x -W -D “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -b “cn&#x3D;administrator,cn&#x3D;users,dc&#x3D;osdn,dc&#x3D;zzti,dc&#x3D;edu,dc&#x3D;cn” -h troy.osdn.zzti.edu.cn<br>   ldapsearch -b “dc&#x3D;canon-is,dc&#x3D;jp” -H ldaps:&#x2F;&#x2F;192.168.0.92:636<br> (需要修改openldap客户端的配置文件ldap.conf,参考：<a href="http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm">http://ms.ntcb.edu.tw/~steven/l-penguin.s/article/ldap-5.htm</a>)</li></ul><blockquote><p>ldapdelete <br>      ldapdelete -x -D “cn&#x3D;Manager,dc&#x3D;test,dc&#x3D;com” -w secret “uid&#x3D;test1,ou&#x3D;People,dc&#x3D;test,dc&#x3D;com”<br>      ldapdelete -x -D ‘cn&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secert ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’<br>      这样就可以删除’uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’记录了，应该注意一点，其下有子条目的不能删除  </p></blockquote><ul><li><p>例子1  递归删除所有：<br>ldapdelete -x -D ‘cn&#x3D;administrator,dc&#x3D;example,dc&#x3D;net’ -w example@2020 -r “ou&#x3D;example,dc&#x3D;example,dc&#x3D;net”</p></li><li><p>例子2  删除一个acl策略。acl-dele.ldif<br> dn: olcDatabase&#x3D;{3}mdb,cn&#x3D;config<br> delete: olcAccess<br> olcAccess: {2}<br> olcAccess: {3}<br> olcAccess: {4}<br> ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif</p></li></ul><blockquote><p>ldappasswd<br>    -x   进行简单认证<br>    -D   用来绑定服务器的DN<br>    -w   绑定DN的密码<br>    -S   提示的输入密码<br>    -s pass 把密码设置为pass<br>    -a pass 设置old passwd为pass<br>    -A   提示的设置old passwd<br>    -H   是指要绑定的服务器<br>    -I   使用sasl会话方式      </p></blockquote><ul><li>例子<br>    ldappasswd -x -D ‘cm&#x3D;root,dc&#x3D;it,dc&#x3D;com’ -w secret ‘uid&#x3D;zyx,dc&#x3D;it,dc&#x3D;com’ -S<br>       New password:<br>       Re-enter new password:<br>       就可以更改密码了，如果原来记录中没有密码，将会自动生成一个userPassword。</li></ul><p>    </p><blockquote><p>ldapmodify<br>     -a 添加新的条目.缺省的是修改存在的条目.<br>     -C 自动追踪引用.<br>     -c 出错后继续执行程序并不中止.缺省情况下出错的立即停止.比如如果你的ldif 文件内的某个条目在<a href="http://lib.csdn.net/base/mysql" title="MySQL知识库">数据库</a>内并不存在,缺省情况下程序立即退出,但如果使用了该参数,程序忽略该错误继续执行.<br>     -n 用于调试到服务器的通讯.但并不实际执行搜索.服务器关闭时,返回错误；服务器<br>       打开时,常和-v 参数一起<a href="http://lib.csdn.net/base/softwaretest" title="软件测试知识库">测试</a>到服务器是否是一条通路.<br>     -v 运行在详细模块.在标准输出中打出一些比较详细的信息.比如:连接到服务器的<br>       ip 地址和端口号等.<br>     -M  打开 manage DSA IT 控制. -MM 把该控制设置为重要的.<br>     -f file 从文件内读取条目的修改信息而不是从标准输入读取.<br>    -x 使用简单认证.<br>    -D binddn 指定搜索的用户名(一般为一dn 值).<br>    -W 指定了该参数,系统将弹出一提示入用户的密码.它和-w 参数相对使用.<br>    -w bindpasswd 直接指定用户的密码. 它和-W 参数相对使用.<br>    -H ldapuri 指定连接到服务器uri(ip 地址和端口号,常见格式为 ldap:&#x2F;&#x2F;hostname:port ).如果使用了-H 就不能使用-h 和-p 参数.<br>    -h ldaphost 指定要连接的主机的名称&#x2F;ip 地址.它和-p 一起使用<br>    -p ldapport 指定要连接目录服务器的端口号.它和-h 一起使用，如果使用了-h 和-p 参数就不能使用-H 参数.<br>    -Z 使用StartTLS 扩展操作.如果使用-ZZ,命令强制使用StartTLS 握手成功.<br>    -V 启用证书认证功能,目录服务器使用客户端证书进行身份验证,必须与-ZZ 强制启用<br>       TLS 方式配合使用,并且匿名绑定到目录服务器.<br>    -e 设置客户端证书文件,例: -e cert&#x2F;client.crt<br>    -E 设置客户端证书私钥文件,例: -E cert&#x2F;client.key  </p></blockquote><ul><li>例子<br>ldapmodify -x -D “cn&#x3D;root,dc&#x3D;it,dc&#x3D;com” -W -f modify.ldif    #   将modify.ldif中的记录更新原有的记录。</li></ul><h2 id="八、-参考链接"><a href="#八、-参考链接" class="headerlink" title="八、 参考链接"></a>八、 参考链接</h2><p><a href="https://github.com/jt6562/LDAP-read-notes/blob/master/ldap-guide/OpenLDAP%E7%AE%A1%E7%90%86%E5%91%98%E6%89%8B%E5%86%8C.md">指南</a><br><a href="https://www.cnblogs.com/kevingrace/p/5773974.html">知识总结</a><br><a href="https://www.cnblogs.com/js1314/p/12887893.html">参考1</a><br><a href="https://cloud.tencent.com/developer/article/1932586">参考2</a><br><a href="https://blog.csdn.net/u011607971/article/details/121126289?spm=1001.2014.3001.5501#t3">参考3</a><br><a href="https://ubuntu.com/server/docs/service-ldap-with-tls">Ubuntu wiki</a><br><a href="https://www.cnblogs.com/shu-sheng/p/14450815.html">tls参考1</a><br><a href="https://hmli.ustc.edu.cn/doc/linux/ubuntu-ldap/ubuntu-ldap.html#id14">tls参考2</a><br><a href="https://zhuanlan.zhihu.com/p/643010354">tls参考3</a></p><h2 id="九、问题："><a href="#九、问题：" class="headerlink" title="九、问题："></a>九、问题：</h2><h3 id="9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果"><a href="#9-1-从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果" class="headerlink" title="9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果"></a>9.1 从服务器同步不及时，必须手动刷新，网络和ubuntu配置同样结果</h3><h3 id="9-2-日志功能开启失败"><a href="#9-2-日志功能开启失败" class="headerlink" title="9.2 日志功能开启失败"></a>9.2 日志功能开启失败</h3><pre><code>已经调整日志级别，在系统日志中查看并grep</code></pre><h3 id="9-3-证书缺失-只能使用ldap01-这个信息查询）"><a href="#9-3-证书缺失-只能使用ldap01-这个信息查询）" class="headerlink" title="9.3 证书缺失(只能使用ldap01,这个信息查询）"></a>9.3 证书缺失(只能使用ldap01,这个信息查询）</h3><pre><code>采取使用权威证书</code></pre><h3 id="9-4-重启slap报错-tls-init-failed"><a href="#9-4-重启slap报错-tls-init-failed" class="headerlink" title="9.4 重启slap报错 tls init   failed"></a>9.4 重启slap报错 tls init   failed</h3><pre><code>解决办法：重新生成证书</code></pre><h3 id="9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code"><a href="#9-5-报错-ldap-start-tls-Connect-error-11-n-additional-info-unknown-error-code" class="headerlink" title="9.5 报错 ldap_start_tls: Connect error (-11)    \n    additional info: (unknown error code)"></a>9.5 报错 ldap_start_tls: Connect error (-11)    \n    additional info: (unknown error code)</h3><pre><code>可能是由于服务器证书的通用名（Common Name）字段是否与主机名不一致，请检查主机名和服务器证书</code></pre><h3 id="9-6-连接问题"><a href="#9-6-连接问题" class="headerlink" title="9.6 连接问题"></a>9.6 连接问题</h3><pre class="line-numbers language-none"><code class="language-none">ldapsearch -H ldaps:&#x2F;&#x2F;ldap.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W            # 在服务器本机执行此查询的报错。但是在另一个机器可以成功查询ldap_sasl_bind(SIMPLE): Can&#39;t contact LDAP server (-1)                                 # 配置 ldap.conf 之后成功解决并有输出 tls&#x3D;demand&#x2F;allow----作用是证书检查<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”"><a href="#9-7-在多域的使用中，不能正常添加子条目，出现“shadow-context-no-update-referral”" class="headerlink" title="9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”"></a>9.7 在多域的使用中，不能正常添加子条目，出现“shadow context; no update referral”</h3><pre class="line-numbers language-none"><code class="language-none">1. 首先尝试重新部署，发现执行镜像复制的剧本之前可以正常创建所有的条目    解决：在mirror mode 开启时，需要指定相应的数据库2.  shadow context; no update referral  根本原因是需要检查权限<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询"><a href="#9-8-使用的脚本一致，测试环境和生产环境结果不一致-主要是不能长时间正常保持客户端连接并查询" class="headerlink" title="9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询"></a>9.8 使用的脚本一致，测试环境和生产环境结果不一致; 主要是不能长时间正常保持客户端连接并查询</h3><ul><li>脚本中的组织信息ldif文件有问题，经测试不影响。</li><li>memberOf，属性不可单独添加，通过 groupofNames 指定 member 之后会自动关联。已经修正使用方式，结果未改变。</li><li>2204 系统和 2004 系统的slapd版本不一致（并没有影响）。</li><li>将orgnization的任务和前一部分拆分，否则会出现读取不到 rootdn（手动测试是成功的）（然而脚本中修改后并没有解决这个问题）。</li><li>将organization拆分，在此之前重启服务，未解决。</li><li>将organization拆分，在此之前先重启虚拟机。（有效、怀疑是服务中某些连接的状态在ansible执行中没有更新）（仍然失效了，经过一夜之后失效）。</li><li>另一台2204主机安装正常使用，怀疑虚拟机系统问题。</li></ul><h2 id="十、-验证"><a href="#十、-验证" class="headerlink" title="十、 验证"></a>十、 验证</h2><h3 id="10-1-检测连接命令："><a href="#10-1-检测连接命令：" class="headerlink" title="10.1 检测连接命令："></a>10.1 检测连接命令：</h3><p> ldaps:&#x2F;&#x2F;    —-ldap over ssl  使用636 ，从连接开始加密   ;        ldap:&#x2F;&#x2F;           —ldap_start_tls(-ZZ参数):    使用389，从传输开始加密</p><pre class="line-numbers language-none"><code class="language-none">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top:636 -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;ldapsearch -H ldap:&#x2F;&#x2F;10.13.3.106  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;ldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -b &quot;dc&#x3D;example,dc&#x3D;top&quot; -s sub &quot;(objectClass&#x3D;person)&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="10-2-验证和日志"><a href="#10-2-验证和日志" class="headerlink" title="10.2 验证和日志"></a>10.2 验证和日志</h3><p>tag 101 应表明在查询; tag 97 是在认证</p><pre class="line-numbers language-none"><code class="language-none">ldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W   -ZZ      #  启用了tls功能 ，-ZZ 参数，仍然是 389 端口，连接后在传输过程中加密Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:60674 (IP&#x3D;0.0.0.0:389)Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 EXT oid&#x3D;1.3.6.1.4.1.1466.20037Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 STARTTLSSep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;0 RESULT oid&#x3D; err&#x3D;0 text&#x3D;Sep  1 10:33:12 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;1 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;2 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;2 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;Sep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 op&#x3D;3 UNBINDSep  1 10:33:15 example-sys-test-06 slapd[91401]: conn&#x3D;1240 fd&#x3D;14 closed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">ldapsearch -H ldap:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W        # 明文传输Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:37760 (IP&#x3D;0.0.0.0:389)Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;Sep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 op&#x3D;2 UNBINDSep  1 10:36:21 example-sys-test-06 slapd[91401]: conn&#x3D;1246 fd&#x3D;14 closed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W        # 从连接就开始加密Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:58726 (IP&#x3D;0.0.0.0:636)Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; method&#x3D;128Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 BIND dn&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; mech&#x3D;SIMPLE ssf&#x3D;0Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;0 RESULT tag&#x3D;97 err&#x3D;0 text&#x3D;Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;1 SRCH base&#x3D;&quot;dc&#x3D;example,dc&#x3D;top&quot; scope&#x3D;2 deref&#x3D;0 filter&#x3D;&quot;(objectClass&#x3D;*)&quot;Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;1 SEARCH RESULT tag&#x3D;101 err&#x3D;0 nentries&#x3D;6 text&#x3D;Sep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 op&#x3D;2 UNBINDSep  1 10:39:39 example-sys-test-06 slapd[91401]: conn&#x3D;1247 fd&#x3D;14 closed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">ldapsearch -H ldaps:&#x2F;&#x2F;ldap01.example.top  -D &quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;top&quot; -W -ZZldap_start_tls: Operations error (1)        additional info: TLS already startedSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 ACCEPT from IP&#x3D;10.13.3.107:39894 (IP&#x3D;0.0.0.0:636)Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 TLS established tls_ssf&#x3D;256 ssf&#x3D;256Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 EXT oid&#x3D;1.3.6.1.4.1.1466.20037Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 STARTTLSSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;0 RESULT oid&#x3D; err&#x3D;1 text&#x3D;TLS already started                # 证明二者冲突，不能同时开启Sep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 op&#x3D;1 UNBINDSep  1 10:40:28 example-sys-test-06 slapd[91401]: conn&#x3D;1248 fd&#x3D;14 closed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="十一、应用服务"><a href="#十一、应用服务" class="headerlink" title="十一、应用服务"></a>十一、应用服务</h2><h3 id="11-1-建立-ldap-管理-只读帐号"><a href="#11-1-建立-ldap-管理-只读帐号" class="headerlink" title="11.1 建立 ldap 管理&#x2F;只读帐号"></a>11.1 建立 ldap 管理&#x2F;只读帐号</h3><pre class="line-numbers language-none"><code class="language-none">dn: cn&#x3D;admin,dc&#x3D;xxx,dc&#x3D;xx changetype: add  objectClass: simpleSecurityObject  objectClass: organizationalRole  cn: admin  userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi    -  dn: cn&#x3D;reader,dc&#x3D;xxx2,dc&#x3D;xx2  changetype: add  objectClass: simpleSecurityObject  objectClass: organizationalRole  cn: admin  userPassword: &#123;SSHA&#125;UiIUaWLBYOo+2O88GNxFAdzp5M9cmlWi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-2-详细的公司架构-ldif"><a href="#11-2-详细的公司架构-ldif" class="headerlink" title="11.2 详细的公司架构 ldif"></a>11.2 详细的公司架构 ldif</h3><pre class="line-numbers language-none"><code class="language-none">dn: ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: organizationalUnit  ou: example    dn: ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: organizationalUnit  ou: example-bod    dn: cn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user1  departmentnumber: 1  displayname: Zheng Yu  mail: user1@example.net  objectclass: inetOrgPerson  sn: Zheng  title: President  uid: 10000  userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs    dn: cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: example-bod-admin  member: cn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: groupOfNames    dn: ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: organizationalUnit  ou: example-bus    dn: cn&#x3D;user8,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user8  departmentnumber: 2  displayname: Sun Minghong  mail: user8@example.net  objectclass: inetOrgPerson  sn: Sun  title: Financial Manager  uid: 10001  userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs    dn: cn&#x3D;example-bus-admin,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: example-bus-admin  member: cn&#x3D;user8,ou&#x3D;example-bus,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: groupOfNames    dn: ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: organizationalUnit  ou: example-sys    dn: cn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user2  departmentnumber: 3  displayname: Xie Jian  mail: user2@example.net  objectclass: inetOrgPerson  sn: Xie  title: Senior Systems Engineer  uid: 10002  userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs    dn: cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: example-sys-admin  member: cn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: groupOfNames    dn: cn&#x3D;user5,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user5  departmentnumber: 3  displayname: Long Chao  mail: user5@example.net  objectclass: inetOrgPerson  sn: Long  title: System Engineer  uid: 10003  userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs    dn: cn&#x3D;example-sys-junior,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: example-sys-junior  member: cn&#x3D;user5,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: groupOfNames    dn: ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: organizationalUnit  ou: example-ops    dn: cn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user6.tang  departmentnumber: 4  displayname: Tang Binchao  mail: user6.tang@example.net  objectclass: inetOrgPerson  sn: Tang  title: System Engineer  uid: 10004  userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs    dn: cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: example-ops-admin  member: cn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: groupOfNames    dn: ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: organizationalUnit  ou: example-dev    dn: cn&#x3D;user3,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user3  departmentnumber: 5  displayname: Chen Cheng  mail: user3@example.net  objectclass: inetOrgPerson  sn: Chen  title: Senior Development Engineer  uid: 10005  userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs    dn: cn&#x3D;example-dev-admin,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: example-dev-admin  member: cn&#x3D;user3,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: groupOfNames    dn: cn&#x3D;user4.li,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user4.li  departmentnumber: 5  displayname: Li user4  mail: user4.li@example.net  objectclass: inetOrgPerson  sn: Li  title: Development Engineer  uid: 10006  userpassword: &#123;SSHA&#125;W4DSQvcToeOeTJB+6W5fCZmz4PqrmwQs    dn: cn&#x3D;user7,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: user7  departmentnumber: 5  displayname: Luo Xujun  mail: user7@example.net  objectclass: inetOrgPerson  sn: Luo  title: Development Engineer  uid: 10007  userpassword: &#123;SSHA&#125;&#x2F;2+Coei5Fje+th7mOJgu43Ms3hBia2Qu    dn: cn&#x3D;example-dev-senior,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  cn: example-dev-senior  member: cn&#x3D;user4.li,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  member: cn&#x3D;user7,ou&#x3D;example-dev,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: groupOfNames    dn: ou&#x3D;example-rob,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net  objectclass: organizationalUnit  ou: example-rob<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-3-第一版-ACL"><a href="#11-3-第一版-ACL" class="headerlink" title="11.3 第一版 ACL"></a>11.3 第一版 ACL</h3><pre class="line-numbers language-none"><code class="language-none">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: modifyadd: olcAccessolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;ou&#x3D;example,dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrgPerson)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; readdn: olcDatabase&#x3D;&#123;4&#125;mdb,cn&#x3D;configchangetype: modifyadd: olcAccessolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * noneolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）"><a href="#11-4-最终的acl（写两个域、读两个域、reader-example-可以读取某些admin组，实现映射到example域下集成的应用）" class="headerlink" title="11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）"></a>11.4 最终的acl（写两个域、读两个域、reader_example 可以读取某些admin组，实现映射到example域下集成的应用）</h3><ul><li><p>添加</p><pre class="line-numbers language-none"><code class="language-none">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configchangetype: modifyadd: olcAccessolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;example,dc&#x3D;net&quot; readolcAccess: &#123;3&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrgPerson)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(memberOf&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read dn: olcDatabase&#x3D;&#123;2&#125;mdb,cn&#x3D;configchangetype: modifyadd: olcAccessolcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * noneolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;exampleadmin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;ibexample,dc&#x3D;com&quot; read by dn.base&#x3D;&quot;cn&#x3D;exampleread,dc&#x3D;example,dc&#x3D;net&quot; read<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>删除</p><pre class="line-numbers language-none"><code class="language-none">dn: olcDatabase&#x3D;&#123;1&#125;mdb,cn&#x3D;configdelete: olcAccessolcAccess: &#123;2&#125;to..........olcAccess: &#123;3&#125;to........ ldapmodify -Y EXTERNAL -H ldapi:&#x2F;&#x2F;&#x2F; -f acl-dele.ldif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>数据库内 ACL 顺序测试，{}里面是优先级，生效在前（涉及范围大的 ACL 应书写在前）</p><pre class="line-numbers language-none"><code class="language-none">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth  by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write  by * none   olcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * readolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;example,dc&#x3D;net&quot; read by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write    # 如果没有此条acl,该条目将不能在 lam 中被 admin 管理 olcAccess: &#123;3&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;tech&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write      # 此条优先级最低<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="十二、集成其他应用"><a href="#十二、集成其他应用" class="headerlink" title="十二、集成其他应用"></a>十二、集成其他应用</h2><h3 id="12-1-conflunce"><a href="#12-1-conflunce" class="headerlink" title="12.1  conflunce"></a>12.1  conflunce</h3><pre class="line-numbers language-none"><code class="language-none">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by anonymous auth by * noneolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * readolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="12-1-1-连接-之后的-acl-过滤案例"><a href="#12-1-1-连接-之后的-acl-过滤案例" class="headerlink" title="12.1.1 连接 之后的 acl 过滤案例"></a>12.1.1 连接 之后的 acl 过滤案例</h4><p>‘(&amp;(objectclass&#x3D;inetorgperson)(|(cn&#x3D;user5)(cn&#x3D;user2)))’  过滤出指定用户—-在用户模式设置。</p><p>‘(&amp;(objectclass&#x3D;groupOfNames)(|(cn&#x3D;example-sys-junior)(cn&#x3D;example-sys-admin)))’ 过滤指定组—-在组模式设置（在ldap中创建的组 objectclass 是groupOfNames）</p><h4 id="12-1-2-更详细的-acl-需求"><a href="#12-1-2-更详细的-acl-需求" class="headerlink" title="12.1.2 更详细的 acl 需求"></a>12.1.2 更详细的 acl 需求</h4><ul><li><p>example</p><pre class="line-numbers language-none"><code class="language-none">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write  by anonymous auth  by * noneolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * readolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;example,dc&#x3D;net&quot; filter&#x3D;&quot;(&amp;(objectClass&#x3D;inetOrg Person)(|(memberOf&#x3D;cn&#x3D;example-bod-admin,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net )(memberOf&#x3D;cn&#x3D;example-sys-admin,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)(member Of&#x3D;cn&#x3D;example-ops-admin,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;net)))&quot; by dn.base&#x3D; &quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read  by dn.base&#x3D; &quot;cn&#x3D;reader,dc&#x3D;example,dc&#x3D;net&quot; readsearch时，必须要具体到用户层级，例如nextcloud，需要指定基础用户树如下cn&#x3D;user2,ou&#x3D;example-sys,ou&#x3D;example,dc&#x3D;example,dc&#x3D;netcn&#x3D;user1,ou&#x3D;example-bod,ou&#x3D;example,dc&#x3D;example,dc&#x3D;netcn&#x3D;user6.tang,ou&#x3D;example-ops,ou&#x3D;example,dc&#x3D;example,dc&#x3D;netdc&#x3D;ibexample,dc&#x3D;com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>example</p><pre class="line-numbers language-none"><code class="language-none">olcAccess: &#123;0&#125;to attrs&#x3D;userPassword by self write by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write  by anonymous auth  by * noneolcAccess: &#123;1&#125;to attrs&#x3D;shadowLastChange by self write by * readolcAccess: &#123;2&#125;to dn.subtree&#x3D;&quot;dc&#x3D;ibexample,dc&#x3D;com&quot; by dn.base&#x3D;&quot;cn&#x3D;admin,dc&#x3D;example,dc&#x3D;net&quot; write by dn.base&#x3D;&quot;cn&#x3D;reader,dc&#x3D;ibexample,dc&#x3D;com&quot; read<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="12-2-集成-vault"><a href="#12-2-集成-vault" class="headerlink" title="12.2 集成 vault"></a>12.2 集成 vault</h3><ul><li>过滤特定用户<pre class="line-numbers language-none"><code class="language-none">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(cn&#x3D;user2)(cn&#x3D;user1)(cn&#x3D;%s)))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>过滤某个组<pre class="line-numbers language-none"><code class="language-none">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>过滤多个组<pre class="line-numbers language-none"><code class="language-none">(&amp;(objectclass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>过滤特定用户和特定组<pre class="line-numbers language-none"><code class="language-none">(&amp;(objectclass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(|(cn&#x3D;user4.li))(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net))(cn&#x3D;%s)))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li>错误<pre class="line-numbers language-none"><code class="language-none">(&amp;(objectClass&#x3D;inetOrgPerson)(&#123;&#123;.UserAttr&#125;&#125;&#x3D;&#123;&#123;.Username&#125;&#125;)(|(cn&#x3D;user2)(cn&#x3D;user1))(cn&#x3D;%s))  会失败以下 1 条，写在group filter的时候会出现不能过滤，所有人都可以登录(&amp;(objectclass&#x3D;inetOrgPerson)(|(memberof&#x3D;CN&#x3D;example-sys-admin,OU&#x3D;example-sys,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)(memberof&#x3D;CN&#x3D;example-dev-admin,OU&#x3D;example-dev,OU&#x3D;example,DC&#x3D;example,DC&#x3D;net)))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenLDAP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>这是一封信</title>
      <link href="/2023/10/18/zhe-shi-yi-feng-xin/"/>
      <url>/2023/10/18/zhe-shi-yi-feng-xin/</url>
      
        <content type="html"><![CDATA[<ul><li><p>邹漂亮，龙美丽好想你呀。</p></li><li><p>此后的你，便是我生命中的一系列的数字了。</p></li></ul><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://www.bilibili.com/video/BV1zw4m1y73U/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=154006e70f5c14d792db947270b63614" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"></iframe></div><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://www.bilibili.com/video/BV16p421y75B/?spm_id_from=333.1007.0.0&vd_source=154006e70f5c14d792db947270b63614" scrolling="yes" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"></iframe></div>]]></content>
      
      
      <categories>
          
          <category> Personal </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Personal </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>deploy_hexo</title>
      <link href="/2023/10/15/deploy-hexo/"/>
      <url>/2023/10/15/deploy-hexo/</url>
      
        <content type="html"><![CDATA[<h2 id="1-安装-node-js、npm"><a href="#1-安装-node-js、npm" class="headerlink" title="1. 安装 node.js、npm"></a>1. 安装 node.js、npm</h2><ul><li>过程如此，但是包需要重新找，网页通过这个链接去官网然后复制下载链接即可，不然会安装hexo失败</li><li>由于node.js默认配置了npm，所以不用单独下载和配置npm了，只要node.js安装成功，那么是直接可以使用npm命令来下载moudle的<pre class="line-numbers language-none"><code class="language-none">wget https:&#x2F;&#x2F;nodejs.org&#x2F;dist&#x2F;v12.16.1&#x2F;node-v12.16.1-linux-x64.tar.xztar tvf .&#x2F;node-v12.16.1-linux-x64.tar.xz    # 查看压缩结构tar xvf .&#x2F;node-v12.16.1-linux-x64.tar.xz -C &#x2F;usr&#x2F;local&#x2F;ln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;node &#x2F;usr&#x2F;bin&#x2F;nodeln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;npm &#x2F;usr&#x2F;bin&#x2F;npm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="2-安装-hexo-并初始化"><a href="#2-安装-hexo-并初始化" class="headerlink" title="2. 安装 hexo 并初始化"></a>2. 安装 hexo 并初始化</h2><ul><li>个人执行初始化失败，检查发现原因是hexo版本和nodejs版本不兼容，升级nodejs<pre class="line-numbers language-none"><code class="language-none">npm install hexo-cli -gln -s &#x2F;usr&#x2F;local&#x2F;node-v12.16.1-linux-x64&#x2F;bin&#x2F;hexo &#x2F;usr&#x2F;local&#x2F;bin&#x2F;hexohexo init blog  # 这需要是一个你自己设计好的路径下的空文件夹hexo server  # 测试运行本工具，发布在本服务器4000端口<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="3-hexo-主题"><a href="#3-hexo-主题" class="headerlink" title="3. hexo 主题"></a>3. hexo 主题</h2><p>因为某个站长接触到hexo，然后再对比之后觉得这个站点框架比较好，所以选择这个hexo，并直接根据这个帖子使用了这个<a href="http://blinkfox.com/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao">主题</a></p><h2 id="4-上传-github"><a href="#4-上传-github" class="headerlink" title="4. 上传 github"></a>4. 上传 github</h2><ul><li>同步到 github 远程仓库的步骤，请找专项的帖子，略</li><li>有个坑，themes 下的主题文件夹因为是 git clone 到这个路径的，其中有 ‘.git’ 目录信息，不能正常上传，<a href="https://blog.csdn.net/liaoweilin0529/article/details/113650333">解决办法</a>来源于这位</li></ul><h2 id="5-部署到-gh-pages-分支"><a href="#5-部署到-gh-pages-分支" class="headerlink" title="5. 部署到 gh-pages 分支"></a>5. 部署到 gh-pages 分支</h2><ul><li>借助了 hexo 的脚本和工具，将实现前端代码存在gh-pages分支，利用 github 的 pages 功能即可发布这个站点。源码和前端代码分别存在 main 和 gh-pages 分支</li><li>一键部署的<a href="https://hexo.io/zh-cn/docs/one-command-deployment.html">参考</a></li><li>再次测试图片应该放张图片的，但是github可以渲染，博客不能。。。。。。作为下一步需要搞懂的地方</li></ul><h2 id="6-访问"><a href="#6-访问" class="headerlink" title="6. 访问"></a>6. 访问</h2><p>去 action 查看url</p><h2 id="7-测试维护和书写流程"><a href="#7-测试维护和书写流程" class="headerlink" title="7. 测试维护和书写流程"></a>7. 测试维护和书写流程</h2><ul><li>新建一篇blog<pre class="line-numbers language-none"><code class="language-none">hexo new &quot;filename&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p>测试过程：<br>这是一篇测试用的帖子，学习使用 hexo、书写帖子、发布内容<br>目前出现的问题是没有内容<br>需要搞懂书写之后，应该怎么样推送或者命令发布<br>测试1，修改然后 clean &amp;&amp; deploy，然后push<br>测试2，先push 然后deploy<br>还要修改音乐模块<br>同步之后修改不成功<br>测试这次修改的流程，直接push—-main分支已经变化，但是gh-pages没有部署成功<br>修改+ clean + deploy —-网页已经变化，gh-pages变化，main分支代码无变化<br>修改+ clean + deploy  + push —- 完整的正常流程（源代码在main分支保存并修改，deploy将生成前端代码并发布到gh-pages）</p><h2 id="8-解决代码行号和复制功能的错乱。"><a href="#8-解决代码行号和复制功能的错乱。" class="headerlink" title="8. 解决代码行号和复制功能的错乱。"></a>8. 解决代码行号和复制功能的错乱。</h2><ul><li>previous: all commented</li><li>current as follows: if noneffective ,try <code>npm uninstall hexo-prism-plugin</code> first ; after changed the <code>_config.yml</code> , delete the <code>.deploy_git</code> category (using for gitpage) ; the repost all the article.</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">highlight</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">auto_detect</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">wrap</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">hljs</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">prismjs</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">preprocess</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><h3 id="迁移到新机器-ubuntu-2004-安装node-npm"><a href="#迁移到新机器-ubuntu-2004-安装node-npm" class="headerlink" title="迁移到新机器 ubuntu 2004 安装node npm"></a>迁移到新机器 ubuntu 2004 安装node npm</h3><h4 id="使用nvm"><a href="#使用nvm" class="headerlink" title="使用nvm"></a>使用nvm</h4><p>nvm 命令安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh <span class="token operator">|</span> <span class="token function">bash</span><span class="token comment"># 申明一下变量，这是执行上述脚本之后在终端的输出提示</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">NVM_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$HOME</span>/.nvm"</span><span class="token punctuation">[</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span>  <span class="token comment"># This loads nvm</span><span class="token punctuation">[</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span>nvm <span class="token parameter variable">--version</span> <span class="token comment"># 将输出安装版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>nvm 安装nodejs</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># download and install Node.js</span>nvm <span class="token function">install</span> <span class="token number">18</span><span class="token comment"># verifies the right Node.js version is in the environment</span><span class="token function">node</span> <span class="token parameter variable">-v</span> <span class="token comment"># should print `v18.20.2`</span><span class="token comment"># verifies the right NPM version is in the environment</span><span class="token function">npm</span> <span class="token parameter variable">-v</span> <span class="token comment"># should print `10.5.0`</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>提示 npm 需要升级<br><code>npm install -g npm@10.5.2</code></p><p>安装 hexo 有关包：</p><pre class="line-numbers language-none"><code class="language-none"> npm install hexo-cli -g[root@oncloud ops_blog]# npm ls -depth 0npm WARN npm npm does not support Node.js v16.18.1npm WARN npm You should probably upgrade to a newer version of node as wenpm WARN npm can&#39;t make any promises that npm will work with this version.npm WARN npm Supported releases of Node.js are the latest release of 6, 8, 9, 10, 11, 12, 13.npm WARN npm You can find the latest version at https:&#x2F;&#x2F;nodejs.org&#x2F;hexo-site@0.0.0 &#x2F;root&#x2F;project&#x2F;ops_blog├── hexo@6.3.0├── hexo-deployer-git@4.0.0├── hexo-generator-archive@2.0.0├── hexo-generator-category@2.0.0├── hexo-generator-index@3.0.0├── hexo-generator-search@2.4.3├── hexo-generator-tag@2.0.0├── hexo-markmap@1.2.5├── hexo-permalink-pinyin@1.1.0├── hexo-renderer-ejs@2.0.0├── hexo-renderer-marked@6.1.1├── hexo-renderer-stylus@3.0.0├── hexo-server@3.0.0├── hexo-theme-landscape@1.0.0└── hexo-wordcount@6.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>** hexo deploy  出现错误 **</p><pre class="line-numbers language-none"><code class="language-none">Error: Spawn failed    at ChildProcess.&lt;anonymous&gt; (&#x2F;home&#x2F;user&#x2F;project&#x2F;ops_blog&#x2F;node_modules&#x2F;hexo-util&#x2F;lib&#x2F;spawn.js:51:21)    at ChildProcess.emit (node:events:517:28)    at ChildProcess._handle.onexit (node:internal&#x2F;child_process:292:12)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>本次的解决办法是，将 .deploy_git 删除，重新 deploy 发布 post 即可。</p><h2 id="更新二"><a href="#更新二" class="headerlink" title="更新二"></a>更新二</h2><h3 id="文章-front-matter-设置"><a href="#文章-front-matter-设置" class="headerlink" title="文章 front-matter 设置"></a>文章 front-matter 设置</h3><ul><li>设置路径<code>/scaffolds/post.md</code>，文章元数据默认就不用再次修改了<pre class="line-numbers language-none"><code class="language-none">---title: typora-vue-theme主题介绍date: 2018-09-07 09:25:00author: 赵奇img: &#x2F;source&#x2F;images&#x2F;xxx.jpgtop: truecover: truecoverImg: &#x2F;images&#x2F;1.jpgpassword: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92toc: falsemathjax: falsesummary: 这是你自定义的文章摘要内容，如果这个属性有值，文章卡片摘要就显示这段文字，否则程序会自动截取文章的部分内容作为摘要categories: Markdowntags:  - Typora  - Markdown---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="更新三"><a href="#更新三" class="headerlink" title="更新三"></a>更新三</h2><h3 id="发布到-github-pages"><a href="#发布到-github-pages" class="headerlink" title="发布到 github pages"></a>发布到 github pages</h3><p>进入仓库的设置页面修改代码仓名，Settings→General→Repository name→Rename，修改为对应的*.github.io路径</p><h3 id="修改-hexo-发布配置-config-yml"><a href="#修改-hexo-发布配置-config-yml" class="headerlink" title="修改 hexo 发布配置 _config.yml"></a>修改 hexo 发布配置 <code>_config.yml</code></h3><pre class="line-numbers language-none"><code class="language-none"># 发布到 github 时希望得到的访问地址和路径url: https:&#x2F;&#x2F;check-lc.github.ioroot: &#x2F;# 发布设置deploy:  type: git  repo: git@github.com:Check-LC&#x2F;check-lc.github.io.git  branch: gh-pages<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>访问这个url <code>https://check-lc.github.io</code> 即是blog地址</p>]]></content>
      
      
      <categories>
          
          <category> hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> blog </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
